# 공사코드 할당 룰셋 조건에서 일람부호 속성 참조 기능 추가

**날짜**: 2025-10-29
**작업 분류**: 룰셋 시스템 개선 (공사코드 할당 룰셋)

---

## 문제 상황

### 기존 동작
- **수량계산식**에서는 일람부호 속성을 대괄호 표기법 `[속성명]`으로 참조 가능
  ```json
  {
    "수량": "[내측수직근간격]"
  }
  ```
  ✅ 이 부분은 정상 작동

### 문제점
- **적용조건**에서는 일람부호 속성을 대괄호 표기법으로 참조 불가
  ```json
  [
    {
      "parameter": "[내측수직근종류]",
      "operator": "equals",
      "value": "H10"
    }
  ]
  ```
  ❌ 조건 평가 시 `[내측수직근종류]` 속성을 찾을 수 없음

### 요구사항
공사코드 할당 룰셋(CostCodeAssignmentRule)의 **적용조건**에서 수량산출부재와 연관된 일람부호(MemberMark)의 속성 값을 참조하여 조건 비교를 하고 싶음.

---

## 원인 분석

### 1. 조건 평가 메커니즘
- `evaluate_conditions()` 함수가 `combined_properties` 딕셔너리에서 속성을 검색
- `combined_properties`는 다음 항목들을 포함:
  - QuantityMember의 properties
  - RawElement의 raw_data (BIM원본.*)
  - classification_tag_name
  - **member_mark_name** (일람부호 이름만 포함)

### 2. 누락된 데이터
- 일람부호의 **이름(mark)**만 추가되고, **속성(properties)**은 추가되지 않음
  ```python
  # 기존 코드
  if member.member_mark:
      combined_properties['member_mark_name'] = member.member_mark.mark
      # ← 일람부호의 properties는 추가되지 않음!
  ```

### 3. 처리 순서 문제
공사코드 할당 룰셋 적용 순서:
```
1. combined_properties 구성 (초기)
2. 일람부호 할당 룰셋 적용 → member_mark 변경 가능
3. 공사코드 할당 룰셋 적용 ← 여기서 일람부호 속성 필요!
```

만약 2단계에서 일람부호가 변경되면, 3단계에서 사용할 `combined_properties`가 최신 일람부호 속성을 반영하지 못함.

---

## 해결 방법

### 수정 1: combined_properties에 일람부호 속성 추가

**파일**: `connections/views.py`

**위치 1**: 1423-1429줄 (`auto_create_cost_items_view` 함수 - 산출항목 자동생성)
**위치 2**: 1602-1608줄 (`auto_assign_quantity_member_view` 함수 - 수량산출부재 일괄 할당)

```python
if member.member_mark:
    combined_properties['member_mark_name'] = member.member_mark.mark
    # ▼▼▼ [추가] 일람부호 속성을 대괄호 형태로 추가하여 조건에서 참조 가능하게 함 ▼▼▼
    if member.member_mark.properties and isinstance(member.member_mark.properties, dict):
        for k, v in member.member_mark.properties.items():
            combined_properties[f'[{k}]'] = v
    # ▲▲▲ [추가] 여기까지 ▲▲▲
```

### 수정 2: 일람부호 변경 시 combined_properties 업데이트

**파일**: `connections/views.py`
**위치**: 1627-1632줄 (`auto_assign_quantity_member_view` 함수)

일람부호 할당 룰셋에 의해 member_mark가 변경된 경우, combined_properties를 업데이트하여 이후 공사코드 할당 룰셋이 최신 일람부호 속성을 사용할 수 있도록 수정:

```python
if mark_expr:
    evaluated_mark_value = evaluate_member_properties_expression(mark_expr, combined_properties)
    if evaluated_mark_value and str(evaluated_mark_value).strip():
        mark_obj, created = MemberMark.objects.get_or_create(...)
        if member.member_mark != mark_obj:
            member.member_mark = mark_obj
            member.save(update_fields=['member_mark'])
            updated_mark_count += 1

            # ▼▼▼ [추가] 일람부호가 변경되었으므로 combined_properties 업데이트 ▼▼▼
            combined_properties['member_mark_name'] = mark_obj.mark
            if mark_obj.properties and isinstance(mark_obj.properties, dict):
                for k, v in mark_obj.properties.items():
                    combined_properties[f'[{k}]'] = v
            # ▲▲▲ [추가] 여기까지 ▲▲▲
```

---

## 추가 버그 수정: is_active 필터 누락

### 문제
산출항목 자동생성 시 **비활성화된 수량산출부재(is_active=False)**도 포함되어 처리됨.

**증상**:
- 활성 수량산출부재: 1개
- 비활성 수량산출부재: 7개 (분할된 원본 등)
- 공사코드 3개 할당
- **결과**: 산출항목 24개 생성 (8개 부재 × 3개 공사코드)
- **기대**: 산출항목 3개 생성 (1개 부재 × 3개 공사코드)

### 해결

**파일**: `connections/views.py` (2곳 수정)

**위치 1**: 1390-1392줄 (`create_cost_items_auto_view`)
```python
members_qs = QuantityMember.objects.filter(
    project=project,
    is_active=True  # ← 추가!
).select_related(...)
```

**위치 2**: 1577줄 (`auto_assign_quantity_member_view`)
```python
members_qs = QuantityMember.objects.filter(
    project=project,
    is_active=True  # ← 추가!
).select_related(...)
```

---

## 사용 예시

### 1. 일람부호 생성 (일람부호 관리 탭)
- **일람부호 마크**: `C1`
- **속성(properties)**:
  ```json
  {
    "내측수직근종류": "H10",
    "내측수직근간격": 200,
    "외측수직근종류": "H13"
  }
  ```

### 2. 공사코드 할당 룰셋 생성 (관리 탭 → 공사코드 할당 룰셋)

**룰셋 1**: H10 철근
```json
{
  "name": "test-H10철근",
  "conditions": [
    {
      "parameter": "[내측수직근종류]",
      "operator": "equals",
      "value": "H10"
    }
  ],
  "cost_code_expressions": {
    "code": "Z0001113",
    "name": "이형철근(고강도강),SD60"
  }
}
```

**룰셋 2**: H13 철근
```json
{
  "name": "test-H13철근",
  "conditions": [
    {
      "parameter": "[외측수직근종류]",
      "operator": "equals",
      "value": "H13"
    }
  ],
  "cost_code_expressions": {
    "code": "Z0001114",
    "name": "이형철근(고강도강),H13"
  }
}
```

### 3. 수량산출부재에 일람부호 할당
- 수동으로 할당하거나
- 일람부호 할당 룰셋으로 자동 할당

### 4. 공사코드 할당 룰셋 적용
- 관리 탭 → 룰셋 → "수량산출부재 일괄 할당" 버튼 클릭

### 5. 결과 확인
- 일람부호 C1이 할당된 수량산출부재에:
  - `[내측수직근종류] = "H10"` 조건 매칭 → Z0001113 공사코드 할당 ✅
  - `[외측수직근종류] = "H13"` 조건 매칭 → Z0001114 공사코드 할당 ✅

---

## 데이터 흐름

### Before (수정 전)
```
QuantityMember
  ├─ properties: {...}
  ├─ member_mark: MemberMark
  │    ├─ mark: "C1"
  │    └─ properties: {"내측수직근종류": "H10", ...}  ← 접근 불가!
  └─ raw_element: RawElement

combined_properties = {
  ...QuantityMember.properties,
  ...RawElement.raw_data (as BIM원본.*),
  'member_mark_name': "C1"  ← 이름만 포함
}

evaluate_conditions(combined_properties, rule.conditions)
  → "[내측수직근종류]" 키를 찾을 수 없음 ❌
```

### After (수정 후)
```
QuantityMember
  ├─ properties: {...}
  ├─ member_mark: MemberMark
  │    ├─ mark: "C1"
  │    └─ properties: {"내측수직근종류": "H10", "내측수직근간격": 200}
  └─ raw_element: RawElement

combined_properties = {
  ...QuantityMember.properties,
  ...RawElement.raw_data (as BIM원본.*),
  'member_mark_name': "C1",
  '[내측수직근종류]': "H10",        ← 추가됨!
  '[내측수직근간격]': 200,          ← 추가됨!
  '[외측수직근종류]': "H13"         ← 추가됨!
}

evaluate_conditions(combined_properties, rule.conditions)
  → "[내측수직근종류]" 키를 찾을 수 있음 ✅
  → 값 "H10"과 조건 값 "H10" 비교 → True ✅
```

---

## 처리 순서 개선

### 수정 전
```
1. combined_properties 구성 (초기)
   - member_mark 속성 없음 ❌
2. 일람부호 할당 룰셋 적용
   - member_mark 변경
3. 공사코드 할당 룰셋 적용
   - 변경된 member_mark 속성이 반영되지 않음 ❌
```

### 수정 후
```
1. combined_properties 구성 (초기)
   - member_mark 속성 포함 ✅
2. 일람부호 할당 룰셋 적용
   - member_mark 변경
   - combined_properties 즉시 업데이트 ✅
3. 공사코드 할당 룰셋 적용
   - 최신 member_mark 속성 사용 가능 ✅
```

---

## 테스트 결과

### 테스트 시나리오
- 수량산출부재: 1개 (활성)
- 일람부호 C1 할당: `{"내측수직근종류": "H10", "외측수직근종류": "H13"}`
- 공사코드 할당 룰셋: 4개
  - 3CCAB020 (조건: `classification_tag_name contains "골조_"`)
  - 3CCAB250 (조건: `classification_tag_name contains "골조_"`)
  - ai001 (조건: `classification_tag_name contains "골조_슬라브_"`)
  - test (조건: `[내측수직근종류] equals "H10"`) ← 테스트 대상

### 결과
✅ **공사코드 할당**: 3개 (3CCAB020, 3CCAB250, Z0001113)
✅ **산출항목 생성**: 3개 (수량산출부재 1개 × 공사코드 3개)
✅ **비활성 부재 제외**: 7개의 비활성 부재는 처리되지 않음

---

## 파일 수정 요약

### connections/views.py
- **1423-1429줄**: `auto_create_cost_items_view` - 일람부호 속성 추가 (산출항목 생성 시)
- **1390-1392줄**: `auto_create_cost_items_view` - is_active 필터 추가
- **1577줄**: `auto_assign_quantity_member_view` - is_active 필터 추가
- **1602-1608줄**: `auto_assign_quantity_member_view` - 일람부호 속성 추가 (초기)
- **1627-1632줄**: `auto_assign_quantity_member_view` - 일람부호 변경 시 속성 업데이트

---

## 영향 범위

### 영향을 받는 기능
1. **공사코드 할당 룰셋** - 일람부호 속성 기반 조건 평가 가능
2. **공사코드 룰셋** (CostCodeRule) - 일람부호 속성 기반 수량계산식 적용 가능
3. **산출항목 자동생성** - 비활성 부재 제외로 정확한 항목 수 생성

### 하위 호환성
✅ **완전 하위 호환** - 기존 룰셋은 영향 없음
- 대괄호 표기법을 사용하지 않는 기존 조건은 그대로 작동
- 추가된 키 `[속성명]`는 기존 키와 충돌하지 않음

---

## 향후 개선 가능 사항

1. **디버깅 로그 추가**
   - `views.py` 422줄 주석 해제 시 조건 평가 과정 확인 가능
   ```python
   print(f"    - 조건 평가: '{p}' ({o}) '{v}' | 실제값: '{actual_v_str}' -> 결과: {result}")
   ```

2. **UI 개선**
   - 룰셋 편집 UI에서 일람부호 속성 자동완성 기능
   - 조건 테스트 기능 (룰셋 저장 전 검증)

3. **성능 최적화**
   - 일람부호 속성이 많을 경우 combined_properties 크기 증가
   - 필요한 속성만 선택적으로 추가하는 옵션 검토

---

## 관련 문서
- `connections/models.py` - MemberMark, QuantityMember, CostCodeAssignmentRule 모델
- `connections/views.py` - evaluate_conditions() 함수 (365줄)
- `workings/38_2025-10-29_분할_객체_Volume_계산_및_산출항목_표시_오류_수정.md` - is_active 필드 추가 배경
