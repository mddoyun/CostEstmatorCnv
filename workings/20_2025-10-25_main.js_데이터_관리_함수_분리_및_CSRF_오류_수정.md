# 20_2025-10-25_main.js_데이터_관리_함수_분리_및_CSRF_오류_수정.md

## 대화 요약

사용자는 `main.js` 파일의 모듈화 작업을 계속 진행하기를 원했습니다. 이번에는 "데이터 관리(Data Management)" 관련 기능들을 분리하는 작업을 진행했습니다. 작업 도중 사용자가 보고한 "토큰 관련 에러"를 진단하고 수정하는 과정도 포함되었습니다.

## 수행한 작업

1.  **데이터 관리 함수 식별**: `main.js`에서 BIM 원본 데이터를 가져오고, 테이블에 렌더링하며, 사용자와 상호작용하는 다음 함수들을 식별했습니다.
    *   `setupDataManagementListeners`
    *   `fetchDataFromClient`
    *   `getSelectionFromClient`
    *   `selectInClient`
    *   `handleViewTabClick`
    *   `clearSelectionFilter`
    *   `assignTagsToSelection`
    *   `clearTagsFromSelection`
    *   `handleColumnFilter`
    *   `handleTableClick`
    *   `handleRowSelection`
    *   `addGroupingLevel`
    *   `handleLeftPanelTabClick`

2.  **`data_management_handlers.js` 파일 생성**: `connections/static/connections/data_management_handlers.js` 파일을 새로 생성하고, 위에서 식별한 함수들을 모두 이 파일로 이동시켰습니다.

3.  **`main.js` 업데이트**: `main.js`에서 해당 함수들을 모두 제거했습니다.

4.  **CSRF 토큰 오류 수정**:
    *   **문제 진단**: 리팩토링으로 인해 분리된 JavaScript 파일들이 전역 `csrftoken` 변수에 접근할 수 없어 AJAX 요청 시 토큰 오류가 발생하는 것을 확인했습니다.
    *   **`csrf_token.js` 파일 생성**: 이 문제를 근본적으로 해결하기 위해, CSRF 토큰을 가져오는 로직을 `connections/static/connections/csrf_token.js`라는 별도 파일로 분리했습니다.
    *   **`main.js`에서 토큰 로직 제거**: 기존 `main.js`에 있던 CSRF 토큰 관련 코드를 삭제했습니다.
    *   **`revit_control.html` 업데이트**: `connections/templates/revit_control.html` 파일을 수정하여, `csrf_token.js`가 다른 모든 커스텀 스크립트보다 먼저 로드되도록 스크립트 태그 순서를 조정했습니다. 이를 통해 모든 모듈이 `csrftoken` 변수를 공유할 수 있게 되었습니다.

## 테스트

사용자가 직접 서버를 실행하여 데이터 관리 관련 기능의 정상 작동 여부를 테스트하기로 했습니다.
