# 38. ë¶„í•  ê°ì²´ Volume ê³„ì‚° ë° ì‚°ì¶œí•­ëª© í‘œì‹œ ì˜¤ë¥˜ ìˆ˜ì •

**ì‘ì„±ì¼**: 2025-10-29
**ì‘ì—… ë²”ìœ„**: 3D Viewer ë¶„í•  ê¸°ëŠ¥ì˜ Volume ê³„ì‚° ì •í™•ë„ ê°œì„  ë° ì‚°ì¶œí•­ëª© í‘œì‹œ ì˜¤ë¥˜ í•´ê²°

---

## ğŸ¯ ì‘ì—… ê°œìš”

3D Viewerì˜ ê°ì²´ ë¶„í• (Split) ê¸°ëŠ¥ì—ì„œ ë°œìƒí•œ ë‘ ê°€ì§€ í•µì‹¬ ë¬¸ì œë¥¼ í•´ê²°:
1. **Volume ê³„ì‚° ì˜¤ë¥˜**: ë¶„í• ëœ ê°ì²´ë¥¼ ì¬ë¶„í• í•  ë•Œ volumeì´ ë¶€ì •í™•í•˜ê²Œ ê³„ì‚°ë˜ëŠ” ë¬¸ì œ
2. **ì‚°ì¶œí•­ëª© í‘œì‹œ ì˜¤ë¥˜**: ë¶„í• ëœ ê°ì²´ ì„ íƒ ì‹œ ë‹¤ë¥¸ ê°ì²´ì˜ ì‚°ì¶œí•­ëª©ê¹Œì§€ í•¨ê»˜ í‘œì‹œë˜ëŠ” ë¬¸ì œ

---

## ğŸ“‹ ë°œê²¬ëœ ë¬¸ì œë“¤

### 1. Volume ê³„ì‚° ì˜¤ë¥˜ (World Space Geometry)

**ì¦ìƒ**:
```
ì²« ë²ˆì§¸ split: 1.575 â†’ 0.7875 + 0.7875 (100% ë³´ì¡´) âœ“
ë‘ ë²ˆì§¸ split: 0.7875 â†’ 0.525 + 0.525 (133% ì¦ê°€!) âœ—
```

**ì›ì¸**:
- DBì—ì„œ ë¡œë“œëœ split ê°ì²´ëŠ” world space ì¢Œí‘œê³„ë¥¼ ì‚¬ìš©
- Volume ê³„ì‚° í•¨ìˆ˜ê°€ origin (0,0,0) ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ ì›ì ì—ì„œ ë¨¼ geometryëŠ” ë¶€ì •í™•
- ì˜ˆ:
  - Local space: (0, 0, 0) ~ (10.5, 0.05, 3) â†’ ì •í™•
  - World space: (-2.3, 1.5, 4.9) ~ (-1.4, 3, -5.4) â†’ ë¶€ì •í™•

**ìœ„ì¹˜**: `connections/static/connections/three_d_viewer.js`

### 2. Capping ë©´ì˜ Basis Vector ì„ íƒ ì˜¤ë¥˜

**ì›ì¸**:
- planeNormalì˜ x ì„±ë¶„ë§Œ ê²€ì‚¬í•˜ì—¬ tempVec ì„ íƒ
- íŠ¹ì • ì¶• ì¡°í•©ì—ì„œ ìˆ˜ì¹˜ì  ë¶ˆì•ˆì •ì„± ë°œìƒ

```javascript
// ê¸°ì¡´ (ë¬¸ì œ)
if (Math.abs(planeNormal.x) < 0.9) {
    tempVec = new THREE.Vector3(1, 0, 0);
} else {
    tempVec = new THREE.Vector3(0, 1, 0);
}
```

### 3. splitElementId ì„¤ì • ì˜¤ë¥˜

**ì¦ìƒ**:
- Split ì™„ë£Œ í›„ ê°ì²´ ì„ íƒ ì‹œ "ë¶„í•  ì •ë³´ ì €ì¥ ì¤‘..." ë©”ì‹œì§€ê°€ ê³„ì† í‘œì‹œ
- `splitElementId: undefined` ìƒíƒœ ìœ ì§€

**ì›ì¸**:
- `split_saved` WebSocket ë©”ì‹œì§€ ë„ì°© ì‹œ sceneì—ì„œ meshë¥¼ ì°¾ì§€ ëª»í•¨
- Nested split ì‹œ ë¶€ëª¨ì˜ splitElementIdê°€ ë³µì‚¬ë˜ì–´ ì¶©ëŒ

### 4. ì‚°ì¶œí•­ëª© í‘œì‹œ í•„í„°ë§ ì˜¤ë¥˜

**ì¦ìƒ**:
- ë¶„í• ëœ ê°ì²´ ì„ íƒ ì‹œ 2ê°œ í•­ëª©ë§Œ í‘œì‹œë˜ì–´ì•¼ í•˜ëŠ”ë° 4ê°œ í‘œì‹œ

**ì›ì¸**:
- splitElementIdê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ì›ë³¸ BIM ê°ì²´ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒ
- ë™ì¼í•œ raw_element_idë¥¼ ê°€ì§„ ëª¨ë“  QuantityMember ë°˜í™˜

---

## ğŸ”§ í•´ê²° ë°©ë²•

### 1. Volume ê³„ì‚° í•¨ìˆ˜ ê°œì„ 

**íŒŒì¼**: `connections/static/connections/three_d_viewer.js:2823-2862`

**ë³€ê²½ ì‚¬í•­**:
- Centroid(ë¬´ê²Œì¤‘ì‹¬) ê¸°ì¤€ ìƒëŒ€ ì¢Œí‘œ ê³„ì‚°ìœ¼ë¡œ ë³€ê²½
- ìˆ˜ì¹˜ì  ì•ˆì •ì„± ëŒ€í­ í–¥ìƒ

```javascript
function calculateGeometryVolume(geometry, debug = false) {
    // Centroid ê³„ì‚°
    let cx = 0, cy = 0, cz = 0;
    const vertexCount = positions.length / 3;
    for (let i = 0; i < vertexCount; i++) {
        cx += positions[i * 3];
        cy += positions[i * 3 + 1];
        cz += positions[i * 3 + 2];
    }
    cx /= vertexCount;
    cy /= vertexCount;
    cz /= vertexCount;

    // Centroid ê¸°ì¤€ ìƒëŒ€ ì¢Œí‘œë¡œ volume ê³„ì‚°
    for (let i = 0; i < indices.length; i += 3) {
        const v0x = positions[i0 * 3] - cx;
        const v0y = positions[i0 * 3 + 1] - cy;
        const v0z = positions[i0 * 3 + 2] - cz;
        // ... ë‚˜ë¨¸ì§€ ê³„ì‚°
    }
}
```

**íš¨ê³¼**:
- World space geometryë„ ì •í™•í•œ volume ê³„ì‚° ê°€ëŠ¥
- Volume ë³´ì¡´ìœ¨ 100% ë‹¬ì„±

### 2. Capping Basis Vector ì„ íƒ ê°œì„ 

**íŒŒì¼**: `connections/static/connections/three_d_viewer.js:2527-2533`

**ë³€ê²½ ì‚¬í•­**:
- planeNormalì˜ ëª¨ë“  ì„±ë¶„(x, y, z) ê²€ì‚¬
- ê°€ì¥ ì§êµí•˜ëŠ” ì¶•ì„ tempVecìœ¼ë¡œ ì„ íƒ

```javascript
const absX = Math.abs(planeNormal.x);
const absY = Math.abs(planeNormal.y);
const absZ = Math.abs(planeNormal.z);

if (absX <= absY && absX <= absZ) {
    tempVec = new THREE.Vector3(1, 0, 0);
} else if (absY <= absX && absY <= absZ) {
    tempVec = new THREE.Vector3(0, 1, 0);
} else {
    tempVec = new THREE.Vector3(0, 0, 1);
}
```

**íš¨ê³¼**:
- ëª¨ë“  ì¶• ì¡°í•©ì—ì„œ ìˆ˜ì¹˜ì ìœ¼ë¡œ ì•ˆì •ì ì¸ capping ë©´ ìƒì„±

### 3. splitElementId ì„¤ì • ë©”ì»¤ë‹ˆì¦˜ ê°œì„ 

#### 3-1. Split ì‹œ userData ì´ˆê¸°í™”

**íŒŒì¼**: `connections/static/connections/three_d_viewer.js:2133, 2148`

```javascript
bottomMesh.userData = {
    ...selectedObject.userData,
    splitElementId: undefined,  // ìƒˆë¡œìš´ splitì´ë¯€ë¡œ ì´ˆê¸°í™”
    splitPartType: 'bottom',
    parentSplitId: parentSplitId,
    // ...
};
```

#### 3-2. Pending Split Meshes Map ë„ì…

**íŒŒì¼**: `connections/static/connections/three_d_viewer.js:2252-2264`

```javascript
// Split ì™„ë£Œ ì‹œ meshë“¤ì„ ì „ì—­ Mapì— ì €ì¥
if (!window.pendingSplitMeshes) {
    window.pendingSplitMeshes = new Map();
}
const bottomKey = `${rawElementId}:${splitPartType}`;
window.pendingSplitMeshes.set(bottomKey, bottomMesh);
```

#### 3-3. 2ë‹¨ê³„ ê²€ìƒ‰ ì „ëµ

**íŒŒì¼**: `connections/static/connections/websocket.js:521-580`

```javascript
// 1ì°¨: pendingSplitMeshes Mapì—ì„œ ì§ì ‘ ê²€ìƒ‰ (100% ì •í™•)
const meshKey = `${data.raw_element_id}:${data.split_part_type}`;
if (window.pendingSplitMeshes.has(meshKey)) {
    targetMesh = window.pendingSplitMeshes.get(meshKey);
    foundMesh = true;
}

// 2ì°¨: Scene traverse (fallback)
if (!foundMesh && window.scene) {
    window.scene.traverse((object) => {
        // ... ê²€ìƒ‰ ë¡œì§
    });
}

// splitElementId ì„¤ì • ë° Mapì—ì„œ ì œê±°
if (foundMesh && targetMesh) {
    targetMesh.userData.splitElementId = data.split_id;
    window.pendingSplitMeshes.delete(meshKey);
}
```

**íš¨ê³¼**:
- split_saved ë©”ì‹œì§€ ë„ì°© ì‹œ í•­ìƒ ì˜¬ë°”ë¥¸ mesh ì°¾ê¸° ê°€ëŠ¥
- splitElementId ì¦‰ì‹œ ì„¤ì •ë˜ì–´ ì‚°ì¶œí•­ëª© í‘œì‹œ ì •í™•

### 4. ì‚°ì¶œí•­ëª© í‘œì‹œ ë¡œì§ ê°•í™”

**íŒŒì¼**: `connections/static/connections/three_d_viewer.js:1530-1540`

```javascript
if (object.userData.splitElementId) {
    // splitElementIdê°€ ìˆìœ¼ë©´ split ê°ì²´ë¡œ ì²˜ë¦¬
    quantityMembers = findQuantityMembersBySplitElementId(object.userData.splitElementId);
} else if (object.userData.isSplitPart || object.userData.isSplitElement) {
    // split ê°ì²´ì¸ë° splitElementIdê°€ ì—†ìœ¼ë©´ ëŒ€ê¸°
    tableContainer.innerHTML = '<p>ë¶„í•  ì •ë³´ ì €ì¥ ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”</p>';
    return;
} else {
    // ì›ë³¸ BIM ê°ì²´
    quantityMembers = findQuantityMembersByRawElementId(bimObjectId);
}
```

**íš¨ê³¼**:
- ì„ íƒëœ ê°ì²´ì˜ í•­ëª©ë§Œ ì •í™•í•˜ê²Œ í‘œì‹œ
- splitElementId ëŒ€ê¸° ì¤‘ ëª…í™•í•œ í”¼ë“œë°± ì œê³µ

### 5. í•¨ìˆ˜ ì „ì—­ ë…¸ì¶œ ë° ìë™ ê°±ì‹ 

**íŒŒì¼**: `connections/static/connections/three_d_viewer.js:1672-1675`

```javascript
window.displayQuantityMembersForObject = displayQuantityMembers;
window.displayCostItemsForObject = displayCostItems;
```

**íŒŒì¼**: `connections/static/connections/websocket.js:577-587`

```javascript
window.splitDataReloadTimer = setTimeout(() => {
    // ë°ì´í„° ê°±ì‹ 
    window.loadQuantityMembersForViewer();
    window.loadCostItemsWithPrices();

    // ì„ íƒëœ ê°ì²´ í‘œì‹œ ê°±ì‹ 
    if (window.selectedObject && window.scene) {
        window.displayQuantityMembersForObject(window.selectedObject);
        window.displayCostItemsForObject(window.selectedObject);
    }
}, 50);
```

**íš¨ê³¼**:
- Split ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ì‚°ì¶œí•­ëª© ê°±ì‹ 
- ì‚¬ìš©ìê°€ ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì´ë™í•˜ì§€ ì•Šì•„ë„ ì •í™•í•œ ì •ë³´ í‘œì‹œ

---

## ğŸ“Š ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

1. **connections/static/connections/three_d_viewer.js**
   - `calculateGeometryVolume()`: Centroid ê¸°ì¤€ ê³„ì‚° (2823-2862)
   - `splitGeometryByPlane()`: Basis vector ì„ íƒ ê°œì„  (2527-2533)
   - `splitSelectedObject()`: userData ì´ˆê¸°í™” (2133, 2148)
   - `splitSelectedObject()`: Pending meshes Map ì €ì¥ (2252-2264)
   - `displayCostItems()`: ë¡œì§ ê°•í™” ë° ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ (1511-1553)
   - í•¨ìˆ˜ ì „ì—­ ë…¸ì¶œ (1672-1675)

2. **connections/static/connections/websocket.js**
   - `split_saved` í•¸ë“¤ëŸ¬: 2ë‹¨ê³„ ê²€ìƒ‰ ì „ëµ (521-580)
   - Split ì™„ë£Œ í›„ ìë™ ê°±ì‹  (577-587)

---

## âœ… í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì—°ì† Split (Load ì—†ì´)
```
1. Load Geometry
2. ê°ì²´ ì„ íƒ â†’ Zì¶• 50% split
3. ë¶„í• ëœ ê°ì²´ ì„ íƒ â†’ í™•ì¸
   - Volume: 0.7875 (50%)
   - ì‚°ì¶œí•­ëª©: 2ê°œ (ì„ íƒëœ ê°ì²´ë§Œ)
4. ë‹¤ì‹œ Zì¶• 50% split
5. ë¶„í• ëœ ê°ì²´ ì„ íƒ â†’ í™•ì¸
   - Volume: 0.39375 (25%)
   - ì‚°ì¶œí•­ëª©: 2ê°œ (ì„ íƒëœ ê°ì²´ë§Œ)
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: Load í›„ Split
```
1. Load Geometry
2. ê°ì²´ ì„ íƒ â†’ split
3. Load Geometry (ì¬ë¡œë“œ)
4. Splitëœ ê°ì²´ ì„ íƒ â†’ ë‹¤ì‹œ split
   - Volume ê³„ì‚° ì •í™•
   - ì‚°ì¶œí•­ëª© ì •í™•
```

### ì˜ˆìƒ ê²°ê³¼
- âœ… Volume ë³´ì¡´ìœ¨: 100% (ëª¨ë“  ë‹¨ê³„)
- âœ… ì‚°ì¶œí•­ëª© í‘œì‹œ: ì„ íƒëœ ê°ì²´ì˜ í•­ëª©ë§Œ (2ê°œ)
- âœ… "ë¶„í•  ì •ë³´ ì €ì¥ ì¤‘..." ë©”ì‹œì§€: í‘œì‹œë˜ì§€ ì•ŠìŒ (ë˜ëŠ” 0.1ì´ˆ ë¯¸ë§Œ)
- âœ… ê°ì²´ ê²¹ì¹¨: ì—†ìŒ (ì›ë³¸ ê°ì²´ ìë™ ìˆ¨ê¹€)

---

## ğŸ” ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€

### ì½˜ì†” ë¡œê·¸ ì˜ˆì‹œ
```javascript
[WebSocket] ========================================
[WebSocket] Split saved successfully: xxx-xxx-xxx
[WebSocket] âœ“ Found mesh in pendingSplitMeshes Map
[WebSocket] âœ“ Set splitElementId on mesh

[3D Viewer] ========================================
[3D Viewer] displayCostItems called
[3D Viewer] Object userData: {splitElementId: "xxx", ...}
[3D Viewer] âœ“ Split object selected (splitElementId exists)
[3D Viewer] Found quantity members: 1
```

---

## ğŸ“ ì£¼ìš” ê°œë…

### Centroid ê¸°ì¤€ Volume ê³„ì‚°
- Signed volume formulaëŠ” originì„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
- Geometryê°€ originì—ì„œ ë©€ìˆ˜ë¡ ìˆ˜ì¹˜ ì˜¤ì°¨ ì¦ê°€
- Centroidë¥¼ originìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ í•­ìƒ ì •í™•

### Pending Split Meshes Map
- Split ì§í›„ ìƒì„±ëœ meshì˜ ì§ì ‘ ì°¸ì¡° ì €ì¥
- Key: `"raw_element_id:split_part_type"`
- Value: Mesh object
- split_saved ì‹œ 100% ì •í™•í•œ ë§¤ì¹­ ë³´ì¥

### 2ë‹¨ê³„ ê²€ìƒ‰ ì „ëµ
1. **1ì°¨**: Mapì—ì„œ ì§ì ‘ ê²€ìƒ‰ (ì¦‰ì‹œ, ì •í™•)
2. **2ì°¨**: Scene traverse (fallback, í˜¸í™˜ì„±)

---

## ğŸ“ ë°°ìš´ ì 

1. **ìˆ˜ì¹˜ì  ì•ˆì •ì„±ì˜ ì¤‘ìš”ì„±**
   - ì¢Œí‘œê³„ ì„ íƒì´ ê³„ì‚° ì •í™•ë„ì— í° ì˜í–¥
   - í•­ìƒ ìƒëŒ€ ì¢Œí‘œë¡œ ê³„ì‚°í•˜ëŠ” ê²ƒì´ ì•ˆì „

2. **ë¹„ë™ê¸° ì²˜ë¦¬ì˜ ë³µì¡ì„±**
   - WebSocket ë©”ì‹œì§€ì™€ UI ìƒíƒœ ë™ê¸°í™” ì–´ë ¤ì›€
   - ì§ì ‘ ì°¸ì¡° ì €ì¥ìœ¼ë¡œ ê·¼ë³¸ì  í•´ê²°

3. **ë””ë²„ê¹… ë¡œê·¸ì˜ ê°€ì¹˜**
   - ìƒì„¸í•œ ë¡œê·¸ê°€ ë¬¸ì œ ì§„ë‹¨ ì‹œê°„ ë‹¨ì¶•
   - ì‚¬ìš©ì ì œê³µ ë¡œê·¸ë¡œ ì •í™•í•œ ì›ì¸ íŒŒì•… ê°€ëŠ¥

---

## ğŸ“Œ ë‹¤ìŒ ì‘ì—… ì˜ˆì •

í˜„ì¬ ì™„ë£Œëœ ìƒíƒœì´ë©°, ì¶”ê°€ í…ŒìŠ¤íŠ¸ í•„ìš” ì‹œ:
1. ë‹¤ì–‘í•œ ì¶• ì¡°í•© í…ŒìŠ¤íŠ¸ (X, Y, Z)
2. 3ë‹¨ê³„ ì´ìƒ ì¤‘ì²© split í…ŒìŠ¤íŠ¸
3. ëŒ€ìš©ëŸ‰ geometry split ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

---

**ì‘ì„±ì**: Claude Code
**ê²€í† **: ì‚¬ìš©ì í”¼ë“œë°± ê¸°ë°˜ ìˆ˜ì • ì™„ë£Œ
