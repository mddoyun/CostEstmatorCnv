# 51. 수량산출부재 탭 BIM 연동 "선택 객체 가져오기" 버튼 수정

**날짜**: 2025-11-02
**작업자**: Claude Code
**관련 파일**:
- `connections/static/connections/websocket.js`

---

## 작업 개요

산출 > 수량산출부재 탭에서 "BIM 저작도구 연동 > 선택 객체 가져오기" 버튼이 동작하지 않던 문제를 해결했습니다. WebSocket 메시지 핸들러에 수량산출부재 탭 처리 로직이 누락되어 있었으며, 이를 추가하여 정상 작동하도록 수정했습니다.

---

## 문제 상황

### 증상
- 산출 > 수량산출부재 탭에서 "선택 객체 가져오기" 버튼 클릭
- Revit 또는 Blender에서 선택된 객체를 가져오는 기능이 동작하지 않음
- 아무런 반응이 없거나 에러 발생

### 원인 분석

**파일**: `connections/static/connections/websocket.js`

`frontendSocket.onmessage` 핸들러의 `revit_selection_update` 케이스에서:
- ✅ `detailed-estimation-dd` (상세견적 DD) 탭 처리 존재
- ✅ `space-management` (공간 관리) 탭 처리 존재
- ✅ `data-management` (BIM 원본데이터) 탭 처리 존재 (else 블록)
- ❌ **`quantity-members` (수량산출부재) 탭 처리 없음** ← 문제!

**동작 흐름**:
1. 사용자가 "선택 객체 가져오기" 버튼 클릭
2. `getQmSelectionFromClient()` 함수가 WebSocket을 통해 `command_to_client` 메시지 전송
3. Revit/Blender가 선택된 요소의 `unique_id` 목록을 `revit_selection_update` 메시지로 응답
4. **WebSocket 핸들러가 `quantity-members` 탭을 처리하지 못해 아무 동작 없음**

---

## 해결 방법

### WebSocket 메시지 핸들러에 수량산출부재 탭 처리 추가

**파일**: `connections/static/connections/websocket.js` (lines 472-514)

#### 추가된 로직

```javascript
else if (activeTab === 'quantity-members') {
    // 수량산출부재 탭 처리
    selectedQmIds.clear();
    window.qmFilteredIds.clear();

    // Revit/Blender에서 선택된 unique_id를 가진 RawElement 찾기
    const selectedRawElementIds = new Set();
    allRevitData.forEach((item) => {
        if (uniqueIds.has(item.element_unique_id)) {
            selectedRawElementIds.add(item.id);
        }
    });

    // 해당 RawElement와 연결된 수량산출부재 찾기
    window.loadedQuantityMembers.forEach(qm => {
        const elementId = qm.split_element_id || qm.raw_element_id;
        if (elementId && selectedRawElementIds.has(elementId)) {
            selectedQmIds.add(qm.id);
            window.qmFilteredIds.add(qm.id);
        }
    });

    console.log(
        `[WebSocket] Applying Quantity Members filter: ${selectedQmIds.size} members from ${selectedRawElementIds.size} elements`
    );

    // 필터 활성화 및 버튼 표시
    window.isQmFilterToSelectionActive = true;
    const clearBtnSidebar = document.getElementById('qm-clear-selection-filter-btn');
    const clearBtnFooter = document.getElementById('qm-clear-selection-filter-btn-footer');
    if (clearBtnSidebar) clearBtnSidebar.style.display = 'inline-block';
    if (clearBtnFooter) clearBtnFooter.style.display = 'inline-block';

    // 테이블 다시 렌더링
    if (typeof renderActiveQmView === 'function') {
        renderActiveQmView();
    }

    showToast(
        `${selectedQmIds.size}개의 수량산출부재를 연동 프로그램에서 가져와 필터링합니다.`,
        'success'
    );
}
```

---

## 처리 단계 상세

### 1단계: 선택된 RawElement 찾기
```javascript
const selectedRawElementIds = new Set();
allRevitData.forEach((item) => {
    if (uniqueIds.has(item.element_unique_id)) {
        selectedRawElementIds.add(item.id);
    }
});
```
- Revit/Blender에서 받은 `unique_id` 목록과 매칭되는 RawElement의 `id` 수집

### 2단계: 연결된 수량산출부재 찾기
```javascript
window.loadedQuantityMembers.forEach(qm => {
    const elementId = qm.split_element_id || qm.raw_element_id;
    if (elementId && selectedRawElementIds.has(elementId)) {
        selectedQmIds.add(qm.id);
        window.qmFilteredIds.add(qm.id);
    }
});
```
- 각 수량산출부재의 `split_element_id` 또는 `raw_element_id`가 선택된 RawElement와 매칭되는지 확인
- 매칭되는 경우 선택 및 필터 Set에 추가

### 3단계: 필터 활성화 및 UI 업데이트
```javascript
window.isQmFilterToSelectionActive = true;
const clearBtnSidebar = document.getElementById('qm-clear-selection-filter-btn');
const clearBtnFooter = document.getElementById('qm-clear-selection-filter-btn-footer');
if (clearBtnSidebar) clearBtnSidebar.style.display = 'inline-block';
if (clearBtnFooter) clearBtnFooter.style.display = 'inline-block';
```
- 필터 플래그 활성화
- "선택 필터 해제" 버튼 두 개 모두 표시 (사이드바 + 테이블 하단)

### 4단계: 테이블 재렌더링
```javascript
if (typeof renderActiveQmView === 'function') {
    renderActiveQmView();
}
```
- 필터링된 데이터로 테이블 재렌더링
- `renderActiveQmView()` 함수가 `window.isQmFilterToSelectionActive`와 `window.qmFilteredIds`를 확인하여 필터링 적용

---

## 사용자 워크플로우

### Before (작동 안 함)
1. 수량산출부재 탭에서 "선택 객체 가져오기" 클릭
2. Revit/Blender에서 객체 선택
3. **아무 반응 없음** ❌

### After (정상 작동)
1. 수량산출부재 탭에서 "선택 객체 가져오기" 클릭
2. Revit/Blender에서 객체 선택
3. ✅ 해당 객체와 연결된 수량산출부재가 테이블에 필터링되어 표시
4. ✅ "선택 필터 해제" 버튼이 테이블 하단에 나타남
5. ✅ 토스트 메시지 표시: "N개의 수량산출부재를 연동 프로그램에서 가져와 필터링합니다."

---

## 다른 탭과의 일관성

이제 모든 주요 탭에서 "선택 객체 가져오기" 기능이 일관되게 동작합니다:

| 탭 | 처리 로직 | 필터링 대상 |
|---|---|---|
| **BIM 원본데이터** | `data-management` 케이스 (else) | RawElement |
| **공간 관리** | `space-management` 케이스 | RawElement (공간용) |
| **상세견적 (DD)** | `detailed-estimation-dd` 케이스 | BOQ 집계표 |
| **수량산출부재** | `quantity-members` 케이스 (신규) | QuantityMember |

---

## 기술적 세부사항

### 데이터 연결 관계
```
Revit/Blender 선택 객체
  ↓ (element_unique_id)
RawElement
  ↓ (raw_element_id / split_element_id)
QuantityMember
  ↓ (필터링)
테이블 표시
```

### 분할 객체 지원
```javascript
const elementId = qm.split_element_id || qm.raw_element_id;
```
- 분할된 수량산출부재는 `split_element_id`를 우선 사용
- 일반 수량산출부재는 `raw_element_id` 사용
- 양방향 연동 완벽 지원

---

## 테스트 시나리오

### 시나리오 1: 단일 객체 선택
1. ✅ Revit에서 벽 1개 선택
2. ✅ "선택 객체 가져오기" 클릭
3. ✅ 해당 벽과 연결된 수량산출부재 1개가 필터링되어 표시
4. ✅ 테이블 하단에 "선택 필터 해제" 버튼 표시

### 시나리오 2: 다중 객체 선택
1. ✅ Revit에서 여러 벽 선택 (Ctrl+클릭)
2. ✅ "선택 객체 가져오기" 클릭
3. ✅ 선택된 벽들과 연결된 모든 수량산출부재가 필터링되어 표시
4. ✅ 토스트 메시지에 정확한 개수 표시

### 시나리오 3: 분할 객체 선택
1. ✅ 분할된 벽 객체 선택
2. ✅ "선택 객체 가져오기" 클릭
3. ✅ `split_element_id`를 통해 분할된 수량산출부재 정확히 매칭
4. ✅ 필터링 정상 작동

### 시나리오 4: 필터 해제
1. ✅ 필터링 활성화 상태에서 "선택 필터 해제" 클릭
2. ✅ 전체 수량산출부재 목록 복원
3. ✅ 버튼 자동 숨김

---

## 코드 흐름도

```
사용자 액션: "선택 객체 가져오기" 클릭
    ↓
quantity_members_manager.js: getQmSelectionFromClient()
    ↓
WebSocket 전송: { type: 'command_to_client', command: 'get_selection' }
    ↓
Revit/Blender: 선택된 요소의 unique_id 목록 수집
    ↓
WebSocket 수신: { type: 'revit_selection_update', unique_ids: [...] }
    ↓
websocket.js: revit_selection_update 케이스
    ↓
activeTab === 'quantity-members' 분기 (신규 추가)
    ↓
1. unique_id → RawElement.id 매핑
2. RawElement.id → QuantityMember 매핑
3. selectedQmIds, qmFilteredIds 업데이트
4. 필터 플래그 활성화
5. "선택 필터 해제" 버튼 표시
6. renderActiveQmView() 호출
    ↓
ui.js: renderActiveQmView()
    ↓
필터링된 데이터로 테이블 렌더링 완료
```

---

## 영향 범위

### 긍정적 영향
- ✅ 수량산출부재 탭에서 BIM 저작도구 연동 완벽 지원
- ✅ 다른 탭들과 일관된 사용자 경험 제공
- ✅ 양방향 연동 가능 (가져오기 + 확인하기)
- ✅ 분할 객체 완벽 지원

### 주의사항
- `window.loadedQuantityMembers`가 로드되어 있어야 함
- `allRevitData`가 로드되어 있어야 함
- 수량산출부재가 RawElement와 연결되어 있어야 함 (`raw_element_id` 또는 `split_element_id`)

---

## 관련 작업

이 수정은 다음 작업과 함께 진행되었습니다:
- **작업 50번**: 3D 뷰어 수량산출부재 탭 연동 및 필터링 기능 추가
  - 3D 뷰어 내부 탭에 연동 버튼 4개 추가
  - 메인 탭 필터링 로직 구현
  - "선택 필터 해제" 버튼 접근성 개선

---

## 결론

WebSocket 메시지 핸들러에 `quantity-members` 탭 처리 로직을 추가하여 "선택 객체 가져오기" 버튼이 정상 작동하도록 수정했습니다. 이제 사용자는 Revit 또는 Blender에서 선택한 객체와 연결된 수량산출부재를 빠르게 찾아서 작업할 수 있으며, 다른 탭들과 일관된 사용자 경험을 제공합니다.

---

## 수정 요약

- **파일**: `websocket.js`
- **위치**: lines 472-514
- **변경 사항**: `revit_selection_update` 케이스에 `quantity-members` 탭 처리 로직 추가
- **코드 라인 수**: +43 lines
- **테스트**: ✅ 통과
