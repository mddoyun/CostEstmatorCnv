# 76. 3D 뷰포트 속성 탭 통일 및 상속 체계 완성 (2025-11-05)

## 작업 개요

이번 작업에서는 3D 뷰포트 하단의 4개 탭(BIM 속성, 수량산출부재, 산출항목, 액티비티)의 속성 표시 방식을 메인 탭과 동일하게 통일하고, 전체 속성 상속 체계를 완성했습니다.

## 주요 변경사항

### 1. 수량산출부재 탭 (displayQuantityMemberDetails)

**파일**: `connections/static/connections/three_d_viewer.js`

**변경 위치**: Line 3784-3960

**주요 개선 사항**:

1. **통일된 그룹핑 시스템 적용**
   - 기존의 하드코딩된 HTML 생성 방식 제거
   - `groupFieldsByPrefix()` 및 `getSectionDefinitions()` 사용
   - 메인 수량산출부재 탭과 완전히 동일한 구조

2. **속성 접두어 수정**
   - `Space.name` → `SC.System.name`으로 수정
   - 표준 접두어 규칙 준수

3. **split_element_id 추가**
   - `QM.System.split_element_id` 속성 추가
   - 분할된 객체의 추적 지원

4. **BIM 데이터 접근 방식 개선**
   - `qm.raw_element` 대신 `window.allRevitData.find()` 사용
   - `split_element_id` 우선 사용, 없으면 `raw_element_id` 사용
   - 분할 객체의 BIM 데이터 정확한 참조

5. **완전한 속성 상속**
   - QM (System, Properties)
   - MM (System, Properties)
   - SC (System)
   - BIM (System, Attributes, Parameters, TypeParameters, 동적 속성)
   - CC (System - 할당된 공사코드)

**구현 코드 구조**:
```javascript
// BIM 원본 요소 찾기
const elementId = qm.split_element_id || qm.raw_element_id;
const fullBimObject = elementId && window.allRevitData ?
    window.allRevitData.find(item => item.id === elementId) : null;

// 모든 속성 수집
const allProperties = [];
// QM, MM, SC, BIM, CC 속성 수집...

// 그룹핑 및 렌더링
const groupedProperties = window.groupFieldsByPrefix(allProperties);
const sectionDefs = window.getSectionDefinitions();
// 각 섹션별로 정렬하여 표시
```

### 2. 산출항목 탭 (displayCostItemDetails)

**파일**: `connections/static/connections/three_d_viewer.js`

**변경 위치**: Line 4046-4284

**주요 개선 사항**:

1. **통일된 그룹핑 시스템 적용**
   - 메인 코스트아이템 탭의 `renderCiSelectedProperties` 구조 따라감
   - 동일한 속성 수집 및 표시 로직

2. **SC 속성 추가**
   - 기존에 누락되어 있던 공간분류 속성 추가
   - `SC.System.name` 표시

3. **BIM 속성 완전 추가**
   - QuantityMember를 통한 BIM 속성 상속
   - System, Attributes, Parameters, TypeParameters 모두 표시
   - 동적 속성(QuantitySet 등) 포함

4. **CC 상세 속성 추가**
   - 기존: code, name만 표시
   - 추가: detail_code, description, category, product_name, spec, unit, note, ai_sd_enabled, dd_enabled
   - CostCode의 모든 필드 표시

5. **완전한 속성 상속 체계**
   - CI (System)
   - CC (System - 상세)
   - QM (System, Properties)
   - MM (System, Properties)
   - SC (System)
   - BIM (System, Attributes, Parameters, TypeParameters, 동적 속성)

6. **QuantityMember 없는 경우 처리**
   - CI와 CC만 표시하고 안내 메시지 출력

### 3. 액티비티 탭 (displayActivityDetails)

**파일**: `connections/static/connections/three_d_viewer.js`

**변경 위치**: Line 4405-4641

**주요 개선 사항**:

1. **통일된 그룹핑 시스템 적용**
   - 메인 액티비티객체 탭의 `renderAoPropertiesPanel` 구조 따라감

2. **QM 전체 속성 추가**
   - 기존: id, name만 표시
   - 추가: System (classification_tag, is_active, raw_element_id, split_element_id)
   - 추가: Properties (모든 사용자 정의 속성)

3. **MM 속성 추가**
   - 완전히 새로 추가
   - MM.System.mark
   - MM.Properties.* (모든 일람부호 속성)

4. **SC 속성 추가**
   - 완전히 새로 추가
   - SC.System.name (공간분류명)

5. **BIM 속성 추가**
   - 완전히 새로 추가
   - System (id, element_unique_id, geometry_volume, classification_tags)
   - Attributes (기본 속성들)
   - Parameters (모든 매개변수)
   - TypeParameters (모든 유형 매개변수)
   - 동적 속성 (QuantitySet 등)

6. **CC 상세 속성 추가**
   - 기존: code, name, detail_code, note만 표시
   - 추가: description, category, product_name, spec, unit

7. **완전한 속성 상속 체계**
   - AO (System)
   - AC (System - Activity Code)
   - CI (System)
   - CC (System - 상세)
   - QM (System, Properties)
   - MM (System, Properties)
   - SC (System)
   - BIM (System, Attributes, Parameters, TypeParameters, 동적 속성)

8. **QuantityMember 참조 개선**
   - `ao.quantity_member` 우선 사용
   - 없으면 `ao.cost_item.quantity_member_id`로 조회
   - `window.loadedQuantityMembers`에서 검색

## 기술적 세부사항

### 속성 상속 체계

전체 시스템에서 완벽하게 통일된 상속 구조:

```
BIM 원본 데이터 (BIM.*)
  ↓ 모든 BIM 속성 상속
수량산출부재 (QM.* + BIM.* + MM.* + SC.*)
  ↓ 모든 속성 상속
코스트아이템 (CI.* + CC.* + QM.* + BIM.* + MM.* + SC.*)
  ↓ 모든 속성 상속
액티비티 객체 (AO.* + AC.* + CI.* + CC.* + QM.* + BIM.* + MM.* + SC.*)
```

### 통일된 렌더링 패턴

모든 탭에서 동일한 패턴 사용:

```javascript
// 1. 모든 속성을 배열에 수집
const allProperties = [];
// 각 접두어별로 속성 수집...

// 2. 첫 번째 접두어로 그룹핑
const groupedProperties = window.groupFieldsByPrefix(allProperties);
const sectionDefs = window.getSectionDefinitions();

// 3. 섹션 순서대로 렌더링
sectionDefs.forEach(section => {
    const properties = groupedProperties[section.key];
    if (properties && properties.length > 0) {
        // 섹션 헤더 (색상, 아이콘)
        // 정렬된 속성 테이블
        const sortedProps = properties.sort((a, b) =>
            a.label.localeCompare(b.label, 'ko'));
    }
});
```

### 섹션 정의 (getSectionDefinitions)

```javascript
const sections = [
    { key: 'AO', title: '📅 액티비티 객체 기본 속성', color: '#6a1b9a' },
    { key: 'AC', title: '⚙️ 액티비티 코드 속성', color: '#d84315' },
    { key: 'CI', title: '📊 산출항목 속성', color: '#1976d2' },
    { key: 'CC', title: '💰 공사코드 속성', color: '#c62828' },
    { key: 'QM', title: '📌 수량산출부재 속성', color: '#0288d1' },
    { key: 'MM', title: '📋 일람부호', color: '#7b1fa2' },
    { key: 'SC', title: '🏢 공간 속성', color: '#558b2f' },
    { key: 'BIM', title: '🏗️ BIM 속성', color: '#00796b' }
];
```

### BIM 데이터 접근

분할 객체 지원을 위한 개선:

```javascript
// split_element_id 우선, 없으면 raw_element_id 사용
const elementId = member.split_element_id || member.raw_element_id;

// window.allRevitData에서 실제 객체 찾기
const fullBimObject = elementId && window.allRevitData ?
    window.allRevitData.find(item => item.id === elementId) : null;

if (fullBimObject && fullBimObject.raw_data) {
    // BIM 속성 수집...
}
```

## 사용자 경험 개선

### 1. 일관된 UI/UX
- 3D 뷰포트 탭과 메인 탭이 완전히 동일한 구조
- 동일한 색상, 아이콘, 섹션 순서
- 사용자가 어디서든 같은 방식으로 속성 확인

### 2. 완전한 정보 제공
- 모든 상속된 속성이 누락 없이 표시
- BIM 원본 데이터까지 모두 접근 가능
- 속성 출처를 접두어로 명확히 표시

### 3. 정렬 및 그룹핑
- 각 섹션 내 속성이 한글 오름차순 정렬
- 논리적인 그룹 순서 (AO → AC → CI → CC → QM → MM → SC → BIM)
- 쉬운 속성 검색

### 4. 분할 객체 지원
- split_element_id를 통한 분할 객체의 BIM 데이터 정확한 참조
- 원본 요소와 분할 요소 구분 가능

## 영향 받는 파일

### 수정된 파일

1. **connections/static/connections/three_d_viewer.js**
   - Line 3784-3960: displayQuantityMemberDetails() 완전 재구성
   - Line 4046-4284: displayCostItemDetails() 완전 재구성
   - Line 4405-4641: displayActivityDetails() 완전 재구성

## 비교: 변경 전후

### 수량산출부재 탭

**변경 전**:
- 하드코딩된 HTML 생성
- Space.name 잘못된 접두어
- split_element_id 누락
- qm.raw_element에서 직접 BIM 데이터 접근 (제한적)

**변경 후**:
- groupFieldsByPrefix() 사용
- SC.System.name 올바른 접두어
- split_element_id 포함
- window.allRevitData 사용 (완전한 BIM 데이터)
- 완전한 속성 상속

### 산출항목 탭

**변경 전**:
- CI 기본 속성만 표시
- CC code, name만 표시
- QM 일부 속성만 표시
- MM 기본만 표시
- SC 누락
- BIM 누락

**변경 후**:
- CI 전체 System 속성
- CC 모든 상세 속성
- QM 전체 (System + Properties)
- MM 전체 (System + Properties)
- SC 추가 (System)
- BIM 완전 추가 (System + Attributes + Parameters + TypeParameters + 동적 속성)

### 액티비티 탭

**변경 전**:
- AO 기본 속성
- Activity 기본 속성
- CI id, quantity만
- CC code, name만
- QM id, name만
- MM 누락
- SC 누락
- BIM 누락

**변경 후**:
- AO 전체 System 속성
- AC(Activity) 전체 System 속성
- CI 전체 System 속성
- CC 전체 상세 속성
- QM 전체 (System + Properties)
- MM 완전 추가 (System + Properties)
- SC 완전 추가 (System)
- BIM 완전 추가 (System + Attributes + Parameters + TypeParameters + 동적 속성)

## 테스트 시나리오

### 1. 수량산출부재 탭 테스트
1. 3D 뷰포트에서 BIM 객체 선택
2. 하단 "수량산출부재" 탭 클릭
3. 리스트에서 부재 선택
4. 우측 속성 패널 확인:
   - QM, MM, SC, BIM 섹션 모두 표시
   - 각 섹션 색상 및 아이콘 확인
   - 속성이 한글 오름차순 정렬
   - split_element_id 표시 여부 확인

### 2. 산출항목 탭 테스트
1. 3D 뷰포트에서 BIM 객체 선택
2. 하단 "산출항목" 탭 클릭
3. 리스트에서 산출항목 선택
4. 우측 속성 패널 확인:
   - CI, CC, QM, MM, SC, BIM 섹션 모두 표시
   - CC 상세 속성 모두 표시 (detail_code, category, product_name 등)
   - SC 섹션 추가 확인
   - BIM 속성 전체 표시 확인

### 3. 액티비티 탭 테스트
1. 3D 뷰포트에서 BIM 객체 선택
2. 하단 "액티비티" 탭 클릭
3. 리스트에서 액티비티 객체 선택
4. 우측 속성 패널 확인:
   - AO, AC, CI, CC, QM, MM, SC, BIM 섹션 모두 표시
   - QM 전체 속성 표시 (System + Properties)
   - MM 섹션 추가 확인
   - SC 섹션 추가 확인
   - BIM 섹션 추가 확인

### 4. 분할 객체 테스트
1. 3D 뷰포트에서 객체 분할 (Sketch Mode)
2. 분할된 객체 선택
3. 각 탭에서 split_element_id 표시 확인
4. BIM 속성이 분할된 부분의 정보를 정확히 표시하는지 확인

### 5. 메인 탭과 3D 뷰포트 탭 비교
1. 메인 탭에서 부재/산출항목/액티비티 선택하여 속성 확인
2. 동일한 항목을 3D 뷰포트에서 선택하여 속성 확인
3. 두 곳의 속성 표시가 완전히 동일한지 확인:
   - 섹션 구조
   - 색상 및 아이콘
   - 속성 목록
   - 정렬 순서

## 결론

이번 작업으로 3D 뷰포트 하단 4개 탭의 속성 표시 방식이 메인 탭과 완전히 통일되었습니다. 모든 탭에서 일관된 속성 상속 체계를 따르며, 사용자는 어디서든 동일한 방식으로 완전한 속성 정보에 접근할 수 있습니다.

### 주요 성과

1. **완전한 속성 상속**: BIM → QM → CI → AO의 모든 단계에서 속성이 누락 없이 전달
2. **통일된 UI**: 메인 탭과 3D 뷰포트 탭이 완전히 동일한 구조와 표현
3. **분할 객체 지원**: split_element_id를 통한 정확한 데이터 참조
4. **개선된 사용자 경험**: 일관된 인터페이스로 학습 곡선 감소

### 기술적 의의

- `groupFieldsByPrefix()` 및 `getSectionDefinitions()` 패턴의 성공적인 재사용
- 코드 중복 제거 및 유지보수성 향상
- 향후 새로운 속성 추가 시 자동으로 모든 탭에 반영
