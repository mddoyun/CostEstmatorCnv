# 분할 객체 수량산출부재 중복 생성 문제 해결

**날짜**: 2025-10-30
**작업자**: Claude Code

## 문제 상황

다음 시나리오에서 수량산출부재가 중복 생성되는 문제가 발생:

1. BIM 데이터 가져오기 → 자동생성 → 3개 생성
2. 3D 뷰어에서 객체 분할 → 4개로 증가 (원본 비활성화, 분할된 2개 활성화)
3. **BIM 데이터 재가져오기** (파일 변경 없음) → 자동생성
4. **5개로 증가** (기대: 4개 유지)

## 원인 분석

### 분할 프로세스

`connections/consumers.py:db_save_split_element()`에서:

1. 원본 QuantityMember는 `is_active=False`로 비활성화
2. 분할된 2개의 새 QuantityMember 생성 (`split_element` 참조, `is_active=True`)
3. 원본 CostItem도 `is_active=False`로 비활성화

### 자동생성 로직의 문제 (1차 수정 시도)

**기존 코드:**
```python
member, created = QuantityMember.objects.update_or_create(
    project=project,
    raw_element=element,
    classification_tag=tag,
    split_element__isnull=True,
    defaults={
        'name': ...,
        'is_active': True  # ← 문제: 비활성화된 원본을 재활성화
    }
)
```

**1차 수정 시도 (실패):**
```python
member, created = QuantityMember.objects.update_or_create(
    ...,
    is_active=True,  # ← 문제: 조건에 추가
    defaults={...}
)
```

- `is_active=True`인 것을 찾으면 업데이트
- `is_active=True`인 것이 **없으면 새로 생성** ← 중복 발생!

## 해결 방법 (2차 수정)

존재 여부를 먼저 확인한 후 상태에 따라 처리하도록 로직 변경:

```python
# 1. 먼저 존재 여부 확인 (is_active 무관)
existing_member = QuantityMember.objects.filter(
    project=project,
    raw_element=element,
    classification_tag=tag,
    split_element__isnull=True
).first()

# 2. 상태에 따라 처리
if existing_member:
    if existing_member.is_active:
        # 활성화됨 → 업데이트
        existing_member.name = f"{element.raw_data.get('Name', 'Unnamed')}_{tag.name}"
        member = existing_member
        updated_count += 1
    else:
        # 비활성화됨 (분할됨) → 건너뜀
        print(f"[DEBUG] 비활성화된 원본 부재 발견 (분할됨), 건너뜀: {existing_member.id}")
        continue
else:
    # 존재하지 않음 → 새로 생성
    member = QuantityMember.objects.create(
        project=project,
        raw_element=element,
        classification_tag=tag,
        name=f"{element.raw_data.get('Name', 'Unnamed')}_{tag.name}",
        is_active=True
    )
    created_count += 1
```

### 삭제 로직도 수정

```python
deletable_members = QuantityMember.objects.filter(
    project=project,
    raw_element__isnull=False,
    split_element__isnull=True,
    is_active=True  # 활성화된 것만 삭제 (비활성화된 원본 보존)
).exclude(id__in=valid_member_ids)
```

### 변경된 파일

- `connections/views.py:create_quantity_members_auto_view()`

## 결과

### 정상 동작 시나리오

1. ✅ BIM 데이터 가져오기 → 자동생성 → **3개** 생성
2. ✅ 3D 뷰어에서 객체 분할 → **4개** (원본 1개 비활성화 + 분할된 2개 활성화)
3. ✅ BIM 데이터 재가져오기
4. ✅ 자동생성 → **여전히 4개 유지**
5. ✅ 콘솔에 "비활성화된 원본 부재 발견 (분할됨), 건너뜀" 메시지 출력

### 핵심 개선

- 비활성화된 원본 QuantityMember는 재활성화하지 않음
- 비활성화된 원본 QuantityMember는 삭제하지 않음
- 분할된 객체들은 BIM 데이터 재가져오기 후에도 안정적으로 유지
- 물량 계산의 정확성 유지

## 커밋

- Commit 1 (실패한 시도): 686debf
- Commit 2 (최종 해결): 1e05479
- 파일: 1개 변경 (28 insertions, 14 deletions)
