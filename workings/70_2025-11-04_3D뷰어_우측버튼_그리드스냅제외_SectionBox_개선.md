# 70. 3D 뷰어 우측 버튼 배치 및 Section Box 개선 (2025-11-04)

## 작업 개요
3D 뷰어의 UI 레이아웃을 개선하고 Section Box 기능의 안정성과 사용성을 향상시켰습니다.

## 주요 변경사항

### 1. 단면/측정 버튼을 우측으로 이동
**파일**: `connections/templates/three_d_viewer.html`, `connections/static/connections/style.css`

**변경 내용**:
- 우측 세로 버튼 그룹 (`.viewer-controls-right`) 추가
- 단면 그룹: 단면 ON/OFF, 맞춤 버튼
- 단면 회전 컨트롤: 회전축, 각도 조절 (향후 사용)
- 측정 그룹: 측정 ON/OFF, 측정삭제, 단위(mm/m) 버튼
- 하단 렌더링 바에서 단면/측정 버튼 제거

**CSS 추가** (`style.css` 라인 3351-3361):
```css
.viewer-controls-right {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 10;
    max-width: 120px;
}
```

### 2. 스냅에서 그리드 제외
**파일**: `connections/static/connections/three_d_viewer.js` (라인 2311-2318)

**변경 내용**:
- 측정 모드에서 raycaster 교차 객체 필터링
- `GridHelper`, `AxesHelper`, `Line`, `LineSegments` 제외
- 실제 3D 오브젝트만 스냅 대상으로 선택

**코드**:
```javascript
const validIntersects = intersects.filter(intersect => {
    if (intersect.object instanceof THREE.GridHelper) return false;
    if (intersect.object instanceof THREE.AxesHelper) return false;
    if (intersect.object instanceof THREE.Line) return false;
    if (intersect.object instanceof THREE.LineSegments) return false;
    return true;
});
```

### 3. 오래된 Clipping Plane 코드 제거
**파일**: `connections/static/connections/three_d_viewer.js`

**변경 내용**:
- `isDraggingClippingPlane` 관련 드래그 코드 제거 (라인 2053-2095)
- 단일 clipping plane 함수 주석 처리 (라인 12094-12106)
  - `window.setClippingAxis()` - DEPRECATED
  - `window.moveClippingPlane()` - DEPRECATED
- Section Box 시스템으로 완전히 대체됨

### 4. Section Box 변수명 통일
**파일**: `connections/static/connections/three_d_viewer.js` (라인 2172)

**변경 내용**:
- `clippingEnabled` → `sectionBoxEnabled`
- `[clippingPlane]` → `sectionBoxPlanes`
- hover material에 Section Box 적용

### 5. Section Box 핸들 드래그 구현
**파일**: `connections/static/connections/three_d_viewer.js` (라인 2006-2072)

**변경 내용**:
- 카메라 방향 기반 평면을 사용한 자연스러운 드래그
- 각 핸들(+X, -X, +Y, -Y, +Z, -Z)을 드래그하여 Section Box 크기 조정
- Ray-Plane 교차점 계산으로 정확한 위치 추적
- 최소 크기 보장 (min + 1, max - 1)

**핵심 로직**:
```javascript
const cameraDirection = new THREE.Vector3();
camera.getWorldDirection(cameraDirection);
const plane = new THREE.Plane().setFromNormalAndCoplanarPoint(
    cameraDirection.negate(),
    handlePosition
);
```

### 6. Section Box 자동 맞춤 기능
**파일**: `connections/static/connections/three_d_viewer.js` (라인 12098-12100)

**변경 내용**:
- `toggleSectionBox()` 함수에서 처음 활성화 시 자동으로 `fitSectionBox()` 호출
- 모든 geometry의 bounding box 계산하여 크기 자동 조정
- 초기화 순서 수정: `initializeSectionBoxPlanes()` → `fitSectionBox()`

### 7. Section Box 모든 상태에서 적용
**파일**: `connections/static/connections/three_d_viewer.js`

**문제**: Section Box가 hover 시에만 적용되고 일반/선택 상태에서는 적용되지 않음

**해결 방법**:

#### (1) applyRenderingModeToMesh 수정 (라인 11948-11953)
```javascript
// 모든 렌더링 모드 적용 후 Section Box clipping planes 추가
if (sectionBoxEnabled && sectionBoxPlanes.length > 0) {
    mesh.material.clippingPlanes = sectionBoxPlanes;
    mesh.material.needsUpdate = true;
}
```

#### (2) toggleSectionBox 개선 (라인 12139-12151)
```javascript
// Section Box 활성화 시
window.applyRenderingModeToScene(); // 모든 mesh에 clipping planes 적용

// Section Box 비활성화 시
window.applyRenderingModeToScene(); // clipping planes 제거
```

### 8. 선택된 객체에 Section Box 적용
**파일**: `connections/static/connections/three_d_viewer.js`

**변경 내용**:
- 모든 `highlightMaterial` 생성 시 clipping planes 추가
- 약 6군데의 highlight material 생성 코드 수정

**수정 예시**:
```javascript
const highlightMaterial = new THREE.MeshStandardMaterial({
    color: 0xff8800,
    emissive: 0xff6600,
    emissiveIntensity: 0.5,
    metalness: 0.0,
    roughness: 1.0,
    flatShading: true,
    transparent: true,
    opacity: 0.7,
    side: THREE.DoubleSide,
    clippingPlanes: sectionBoxEnabled ? sectionBoxPlanes : []  // 추가
});
```

### 9. 선(Edges)에 Section Box 적용
**파일**: `connections/static/connections/three_d_viewer.js` (라인 11967-11980)

**변경 내용**:
- `LineBasicMaterial` 생성 시 clipping planes 추가
- 기존 선 업데이트 시에도 clipping planes 반영

**코드**:
```javascript
// 선 생성 시
const lineMaterial = new THREE.LineBasicMaterial({
    color: isSelected ? 0xffff00 : 0x000000,
    linewidth: 1,
    clippingPlanes: sectionBoxEnabled ? sectionBoxPlanes : []
});

// 선 업데이트 시
mesh.userData.edgesLine.material.clippingPlanes = sectionBoxEnabled ? sectionBoxPlanes : [];
mesh.userData.edgesLine.material.needsUpdate = true;
```

## 기술적 세부사항

### Section Box 작동 원리
1. **6개의 Clipping Planes**: +X, -X, +Y, -Y, +Z, -Z 방향
2. **자동 초기화**: 처음 활성화 시 모든 객체를 포함하도록 자동 크기 조정
3. **드래그 방식**: 카메라 뷰 방향에 수직인 평면 사용으로 직관적인 조작
4. **통합 적용**: 모든 material에 일관되게 적용

### Material 적용 흐름
```
객체 상태 변경 (hover/select/mode change)
    ↓
applyRenderingModeToMesh() 호출
    ↓
새 material 생성
    ↓
Section Box 활성화 여부 확인
    ↓
clippingPlanes 적용
    ↓
material.needsUpdate = true
```

## 파일 변경 목록
- `connections/templates/three_d_viewer.html`: 우측 버튼 그룹 추가
- `connections/static/connections/style.css`: `.viewer-controls-right` 스타일 추가
- `connections/static/connections/three_d_viewer.js`:
  - 그리드 스냅 제외
  - 오래된 코드 제거/주석
  - Section Box 드래그 구현
  - 모든 상태에서 clipping planes 적용
  - 선택/edges에 clipping planes 적용

## 테스트 결과
✅ 단면/측정 버튼이 우측에 표시됨
✅ 스냅이 그리드에 반응하지 않음
✅ Section Box 핸들 드래그 작동
✅ Section Box 자동 맞춤 작동
✅ 일반 상태에서 Section Box 적용
✅ 선택된 객체에 Section Box 적용
✅ 선(edges) ON 시 Section Box 적용
✅ 에러 없이 정상 작동

## 향후 개선 사항
- [ ] Section Box 회전 기능 활성화 (UI는 준비됨)
- [ ] Section Box 크기 수치 입력 기능
- [ ] Section Box 프리셋 저장/불러오기
- [ ] 다중 Section Box 지원

## 관련 커밋
- 우측 버튼 배치 및 CSS 추가
- 그리드 스냅 제외 및 오래된 코드 정리
- Section Box 드래그 및 자동 맞춤 구현
- Section Box 모든 상태 적용 수정
- 선택/edges에 clipping planes 적용

---

**작업자**: Claude Code
**날짜**: 2025-11-04
**소요 시간**: 약 2시간
**난이도**: ⭐⭐⭐⭐ (복잡한 material 관리 및 통합 작업)
