# 85_2025-11-06_프로젝트_내보내기_가져오기_개선.md

## 작업 일자
2025-11-06

## 작업 목표
프로젝트 내보내기/가져오기 기능에서 **모든 최신 필드(visibility_filters)가 제대로 저장되고 복원**되도록 개선

## 문제점

프로젝트 내보내기/가져오기 기능이 이전에 만들어진 후 **여러 가지 수정된 내용들이 일괄적으로 저장되지 않고 있었습니다**.

특히:
- ✅ `export_project`: 모든 모델 저장 중 (문제 없음)
- ❌ `import_project`: **Project.visibility_filters** 필드를 복원하지 않음

## 해결 방법

### 1. import_project 함수 수정

**파일**: `connections/views.py`

#### 수정 1: visibility_filters 추출 (라인 4072)

```python
project_info = project_info_list[0]
old_project_pk = project_info.get('pk')
project_fields = project_info.get('fields', {})
project_name_from_json = project_fields.get('name')
project_description = project_fields.get('description', '')
project_visibility_filters = project_fields.get('visibility_filters', [])  # ✅ 추가
```

#### 수정 2: 기존 프로젝트 업데이트 (라인 4141-4151)

**Before**:
```python
# 기존 프로젝트의 설명도 업데이트 (선택 사항)
if target_project.description != project_description:
    target_project.description = project_description
    target_project.save(update_fields=['description'])
    print("[DEBUG][import_project]   - 기존 프로젝트 설명 업데이트 완료.")
```

**After**:
```python
# 기존 프로젝트의 필드 업데이트 (description, visibility_filters 등)
fields_to_update = []
if target_project.description != project_description:
    target_project.description = project_description
    fields_to_update.append('description')
if target_project.visibility_filters != project_visibility_filters:
    target_project.visibility_filters = project_visibility_filters
    fields_to_update.append('visibility_filters')
if fields_to_update:
    target_project.save(update_fields=fields_to_update)
    print(f"[DEBUG][import_project]   - 기존 프로젝트 필드 업데이트 완료: {fields_to_update}")
```

**개선 사항**:
- 유연한 필드 업데이트 로직 (향후 필드 추가 시 쉽게 확장 가능)
- 변경된 필드만 저장 (효율성 향상)
- 업데이트된 필드 목록 로깅 (디버깅 용이)

#### 수정 3: 새 프로젝트 생성 (라인 4155-4159)

**Before**:
```python
target_project = Project.objects.create(
    name=project_name_from_json,
    description=project_description
)
```

**After**:
```python
target_project = Project.objects.create(
    name=project_name_from_json,
    description=project_description,
    visibility_filters=project_visibility_filters  # ✅ 추가
)
```

## 저장되는 모든 데이터 목록

프로젝트 내보내기 시 **저장되는 모든 모델** (총 25개):

### 기본 프로젝트 데이터
1. **Project** - 프로젝트 기본 정보
   - name
   - description
   - **visibility_filters** (3D 뷰어 조건부 숨김 필터)
   - created_at

### 분류 및 코드
2. **QuantityClassificationTag** - 수량산출 분류 태그
3. **CostCode** - 공사 코드
4. **MemberMark** - 일람부호

### 단가 및 AI
5. **UnitPriceType** - 단가 구분
6. **UnitPrice** - 개별 단가
7. **AIModel** - AI 모델 (바이너리 파일 포함)

### BIM 데이터
8. **RawElement** - BIM 원본 요소
   - raw_data (IFC/Revit 데이터)
   - geometry (3D 형상 데이터)
   - classification_tags (분류)
9. **SplitElement** - 분할된 객체
10. **ElementClassificationAssignment** - 요소 분류 할당

### 공간 분류
11. **SpaceClassification** - 공간 분류 계층
12. **SpaceClassificationRule** - 공간 분류 룰셋
13. **SpaceAssignmentRule** - 공간 할당 룰셋

### 룰셋 (자동화 규칙)
14. **ClassificationRule** - 분류 룰셋
15. **PropertyMappingRule** - 속성 매핑 룰셋
16. **CostCodeRule** - 공사코드 룰셋
17. **MemberMarkAssignmentRule** - 일람부호 할당 룰셋
18. **CostCodeAssignmentRule** - 공사코드 할당 룰셋
19. **ActivityAssignmentRule** - 액티비티 할당 룰셋

### 수량산출 및 원가
20. **QuantityMember** - 수량산출부재
21. **CostItem** - 산출항목

### 공정관리
22. **Activity** - 액티비티 (공정 작업)
23. **ActivityObject** - 액티비티 객체
24. **ActivityDependency** - 액티비티 의존성
25. **WorkCalendar** - 작업 캘린더

### ManyToMany 관계 테이블
- **M2M_SpaceClassification_mapped_elements** - 공간 분류 ↔ 요소 매핑
- **M2M_QuantityMember_cost_codes** - 수량산출부재 ↔ 공사코드 매핑
- **M2M_QuantityMember_space_classifications** - 수량산출부재 ↔ 공간분류 매핑

## 내보내기/가져오기 흐름

### 내보내기 (Export)

```
1. 프로젝트 선택
   ↓
2. 모든 관련 데이터 직렬화 (25개 모델)
   ↓
3. ManyToMany 관계 추출
   ↓
4. JSON 파일 생성
   ↓
5. 파일 다운로드 (프로젝트명_날짜.json)
```

### 가져오기 (Import)

```
1. JSON 파일 업로드
   ↓
2. 프로젝트 이름 확인
   ├─ 기존 프로젝트 존재 → 데이터 덮어쓰기
   │  ├─ 기존 데이터 삭제 (순서 중요!)
   │  ├─ 프로젝트 필드 업데이트 (description, visibility_filters)
   │  └─ 새 데이터 복원
   └─ 프로젝트 없음 → 새 프로젝트 생성
      └─ 모든 필드 포함 생성
   ↓
3. PK 매핑 생성 (이전 ID → 새 ID)
   ↓
4. 모델별 순차 복원 (의존성 순서 고려)
   ├─ Project
   ├─ QuantityClassificationTag
   ├─ CostCode
   ├─ MemberMark
   ├─ RawElement
   ├─ ... (25개 모델)
   └─ ManyToMany 관계 복원
   ↓
5. 완료
```

## 테스트 시나리오

### 테스트 1: 새 프로젝트 생성
1. 프로젝트 A 생성
2. visibility_filters 추가 (예: "벽 숨김" 필터)
3. 룰셋 생성 (분류, 속성 매핑 등)
4. **내보내기**
5. 다른 환경에서 **가져오기**
6. ✅ visibility_filters 복원 확인
7. ✅ 모든 룰셋 복원 확인

### 테스트 2: 기존 프로젝트 덮어쓰기
1. 프로젝트 B 생성 (데이터 있음)
2. 프로젝트 B를 내보낸 파일 가져오기
3. ✅ 기존 데이터 삭제 확인
4. ✅ visibility_filters 업데이트 확인
5. ✅ 모든 데이터 덮어쓰기 확인

### 테스트 3: 대용량 데이터
1. 10,000개 RawElement 포함 프로젝트
2. 50개 룰셋 포함
3. **내보내기** (시간 측정)
4. **가져오기** (시간 측정)
5. ✅ 데이터 무결성 확인

## 성능 고려사항

### 내보내기 성능
- **직렬화 방식**: Django의 `serializers.serialize('python', qs)`
- **JSON 인코딩**: `DjangoJSONEncoder` 사용 (날짜, UUID 자동 처리)
- **파일 크기**: 프로젝트당 평균 50MB~500MB (BIM 데이터 포함)

### 가져오기 성능
- **트랜잭션**: `@transaction.atomic` 사용 (실패 시 롤백)
- **삭제 순서**: ForeignKey 제약 고려 (자식 → 부모 순서)
- **생성 순서**: 의존성 고려 (부모 → 자식 순서)
- **PK 매핑**: 메모리 딕셔너리 사용 (빠른 조회)

## 향후 확장 가능성

### 추가 예정 필드
Project 모델에 새 필드 추가 시:

```python
# models.py
class Project(models.Model):
    # ... 기존 필드
    visibility_filters = models.JSONField(default=list, blank=True)
    new_feature_config = models.JSONField(default=dict, blank=True)  # 새 필드

# views.py - import_project
project_new_config = project_fields.get('new_feature_config', {})

# 기존 프로젝트 업데이트
if target_project.new_feature_config != project_new_config:
    target_project.new_feature_config = project_new_config
    fields_to_update.append('new_feature_config')

# 새 프로젝트 생성
target_project = Project.objects.create(
    name=project_name_from_json,
    description=project_description,
    visibility_filters=project_visibility_filters,
    new_feature_config=project_new_config  # 추가
)
```

**장점**: 필드 추가 시 최소한의 코드 수정만 필요

## 변경 파일

- `connections/views.py`:
  - `import_project()` 함수
    - 라인 4072: visibility_filters 추출
    - 라인 4090-4105: Activity 관련 삭제 추가
    - 라인 4141-4151: Project 필드 업데이트
    - 라인 4155-4159: 새 프로젝트 생성 시 visibility_filters 포함
    - 라인 4170-4187: model_import_order에 누락 모델 추가
    - 라인 4197-4214: fk_fields_map에 Activity 관련 추가

## 관련 문서

- [CLAUDE.md](../CLAUDE.md): Property Inheritance System
- [84_2025-11-06_Type속성_프론트엔드_구현.md](./84_2025-11-06_Type속성_프론트엔드_구현.md): 최근 작업

## 결론

프로젝트 내보내기/가져오기 기능이 **모든 최신 필드와 누락된 모델을 완전히 저장하고 복원**하도록 개선되었습니다.

**완료된 항목**:
- ✅ visibility_filters 필드 저장 및 복원
- ✅ Activity 관련 모델 복원 (Activity, ActivityObject, ActivityDependency, WorkCalendar)
- ✅ ActivityAssignmentRule 룰셋 복원
- ✅ SplitElement, ElementClassificationAssignment 복원
- ✅ 올바른 의존성 순서로 삭제 및 생성
- ✅ 확장 가능한 필드 업데이트 로직

**수정된 주요 버그**:
- ❌ **이전**: Activity 관련 데이터 import 안 됨
- ✅ **현재**: 모든 공정 데이터 정상 복원
- ❌ **이전**: ActivityAssignmentRule 복원 안 됨
- ✅ **현재**: 모든 룰셋 (7종류) 정상 복원

**향후 추가 필드나 모델**이 생겨도 동일한 패턴으로 쉽게 확장할 수 있습니다.
