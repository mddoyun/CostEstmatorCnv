# 2025-11-01 룰셋 UI 개선 - 조건 빌더 및 헬퍼 패널

## 작업 개요
룰셋 관리 UI를 사용자 친화적으로 개선하는 작업을 진행했습니다. JSON textarea 입력 방식을 조건 빌더(Condition Builder)로 변경하고, BIM 원본 데이터 탭에 룰셋 작성 도우미 패널을 추가했습니다.

## 1. 속성 맵핑 룰셋 테이블 개선

### 문제점
- 테이블 열의 폭이 너무 좁아서 내용을 읽기 어려움
- 좌우 스크롤 없이 모든 내용을 보려다 보니 각 열이 압축됨

### 해결 방법
**파일**: `connections/static/connections/ruleset_property_mapping_handlers.js`

1. **고정 열 너비 설정** (lines 52-62)
   - 각 열에 고정 픽셀 너비와 min-width 설정
   - 이름: 150px, 설명: 200px, 대상 분류: 150px
   - 객체 조건: 350px, 맵핑 스크립트: 350px
   - 우선순위: 80px, 작업: 120px

2. **스크롤 래퍼 추가** (lines 201-206)
   ```javascript
   const scrollWrapper = document.createElement('div');
   scrollWrapper.style.overflowX = 'auto';
   scrollWrapper.style.width = '100%';
   scrollWrapper.appendChild(table);
   ```

3. **테이블 최소 너비 설정**
   ```javascript
   table.style.minWidth = '1400px';
   ```

## 2. BIM 원본 데이터 탭 - 룰셋 작성 도우미 패널

### 문제점
- 속성 맵핑 룰셋 작성 시 BIM 객체의 실제 속성명을 참고할 방법이 없음
- 사용자가 어떤 속성명을 사용해야 하는지 알기 어려움

### 해결 방법
**파일**: `connections/templates/revit_control.html` (lines 299-378)

1. **Split Layout 구조 추가**
   ```html
   <div class="main-split-layout">
       <div class="table-area">...</div>
       <div class="details-panel">
           <div id="raw-data-helper-properties-container">...</div>
       </div>
   </div>
   ```

2. **도우미 패널 렌더링 함수** (`data_management_handlers.js`, lines 408-531)
   - 선택한 BIM 객체의 속성을 테이블 형식으로 표시
   - 시스템 속성 (Category, Family, Type, Level)
   - Parameters.* 속성들
   - TypeParameters.* 속성들
   - 룰셋에 사용 가능한 형태로 표시: `{Category}`, `{Parameters.속성명}`

3. **데이터 접근 개선**
   - `raw_data` 필드에서 JSON 파싱
   - 여러 ID 필드명 시도 (db_id, dbId, DB_ID, id)
   - String 변환 비교로 안정성 향상

4. **테이블 스타일링**
   - 속성명 열: 40% 너비, 회색 배경
   - 값 열: 60% 너비, 흰색 배경
   - 최대 높이 600px, 수직 스크롤

## 3. 공사코드 룰셋 UI 개선

### 문제점
- JSON textarea 형식으로 조건과 맵핑 스크립트를 입력해야 함
- 사용자가 JSON 문법을 이해해야 하고 실수하기 쉬움
- 읽기 전용 모드에서도 JSON이 그대로 노출되어 가독성이 떨어짐

### 해결 방법

#### 3.1 조건 빌더 UI 적용 (`ui.js`, lines 1468-1520)
**편집 모드:**
```javascript
// 조건 빌더 UI 생성
const conditions = rule.conditions || [];
let conditionsHtml = '<div class="conditions-builder" style="max-height: 250px; overflow-y: auto;">';

conditions.forEach((cond, idx) => {
    conditionsHtml += renderConditionRowForQM(cond, idx);
});

conditionsHtml += `
    <button type="button" class="add-condition-btn">
        + 조건 추가
    </button>
</div>`;
```

- `renderConditionRowForQM()`: QuantityMember 속성 기반 조건 (name, classification_tag, properties.*, MM.*, RE.*)
- 드롭다운으로 속성, 연산자, 값 선택
- "조건 추가" 버튼으로 동적으로 조건 추가/삭제

**읽기 전용 모드:** (lines 1522-1530)
```javascript
let conditionsDisplay = '';
if (rule.conditions && rule.conditions.length > 0) {
    conditionsDisplay = rule.conditions.map(c =>
        `<div style="padding: 2px 0;">${c.property} ${c.operator} "${c.value}"</div>`
    ).join('');
} else {
    conditionsDisplay = '<em style="color: #999;">조건 없음</em>';
}
```

이전: `{"property": "name", "operator": "==", "value": "벽"}`
개선: `name == "벽"`

#### 3.2 맵핑 빌더 UI 적용 (`ui.js`, lines 1484-1499)
**편집 모드:**
```javascript
const mappingScript = rule.quantity_mapping_script || {};
let mappingsHtml = '<div class="mappings-builder" style="max-height: 250px; overflow-y: auto;">';

const mappingEntries = Object.entries(mappingScript);
if (mappingEntries.length > 0) {
    mappingEntries.forEach(([key, value], idx) => {
        mappingsHtml += renderMappingRow(key, value, idx);
    });
} else {
    mappingsHtml += renderMappingRow('', '', 0);
}

mappingsHtml += `
    <button type="button" class="add-mapping-btn">
        + 맵핑 추가
    </button>
</div>`;
```

**읽기 전용 모드:** (lines 1532-1539)
```javascript
let mappingDisplay = '';
if (rule.quantity_mapping_script && Object.keys(rule.quantity_mapping_script).length > 0) {
    mappingDisplay = Object.entries(rule.quantity_mapping_script).map(([key, value]) =>
        `<div style="padding: 2px 0;"><strong>${key}:</strong> ${value}</div>`
    ).join('');
} else {
    mappingDisplay = '<em style="color: #999;">맵핑 없음</em>';
}
```

이전: JSON 원문 노출
개선:
```
길이: {Parameters.길이}
높이: {Parameters.높이}
```

#### 3.3 저장 로직 업데이트 (`ruleset_cost_code_handlers.js`, lines 58-101)
```javascript
// 조건 빌더에서 조건 수집
const conditionRows = ruleRow.querySelectorAll('.condition-row');
const conditions = [];
conditionRows.forEach(row => {
    const property = row.querySelector('.condition-property').value;
    const operator = row.querySelector('.condition-operator').value;
    const value = row.querySelector('.condition-value').value;
    if (property && operator && value) {
        conditions.push({ property, operator, value });
    }
});

// 맵핑 빌더에서 수량 계산식 수집
const mappingRows = ruleRow.querySelectorAll('.mapping-row');
const quantity_mapping_script = {};
mappingRows.forEach(row => {
    const key = row.querySelector('.mapping-key-input').value.trim();
    const value = row.querySelector('.mapping-value-input').value.trim();
    if (key && value) {
        quantity_mapping_script[key] = value;
    }
});
```

#### 3.4 테이블 레이아웃 개선 (`ui.js`)

**고정 열 너비 및 스크롤** (lines 1457-1464)
```javascript
let tableHtml = `<table class="ruleset-table" style="min-width: 1400px;"><thead>
    <tr>
        <th style="width: 80px; min-width: 80px;">우선순위</th>
        <th style="width: 200px; min-width: 200px;">이름/설명</th>
        <th style="width: 200px; min-width: 200px;">대상 공사코드</th>
        <th style="width: 400px; min-width: 400px;">적용 조건</th>
        <th style="width: 400px; min-width: 400px;">수량 계산식</th>
        <th style="width: 120px; min-width: 120px;">작업</th>
    </tr>
</thead><tbody>`;
```

**스크롤 래퍼** (lines 1569-1576)
```javascript
const scrollWrapper = document.createElement('div');
scrollWrapper.style.overflowX = 'auto';
scrollWrapper.style.width = '100%';
scrollWrapper.innerHTML = tableHtml;

container.innerHTML = '';
container.appendChild(scrollWrapper);
```

**내용 침범 방지** (lines 1548-1549)
```javascript
<td style="word-wrap: break-word; vertical-align: top;">${conditionsDisplay}</td>
<td style="word-wrap: break-word; vertical-align: top;">${mappingDisplay}</td>
```

## 4. 버그 수정

### 4.1 속성 맵핑 룰셋 헬퍼 패널 에러
**문제**: `updateMappingHelperPanel()` 함수가 존재하지 않는 DOM 요소를 참조

**해결**: `ruleset_property_mapping_handlers.js` (lines 18-22)에서 함수 호출 제거
```javascript
// 제거된 코드
// updateMappingHelperPanel(); // 도우미 패널 업데이트
```

## 5. 영향받은 파일 목록

### JavaScript 파일
1. `connections/static/connections/ruleset_property_mapping_handlers.js`
   - 테이블 레이아웃 개선
   - 헬퍼 패널 함수 호출 제거

2. `connections/static/connections/data_management_handlers.js`
   - `renderRawDataHelperPanel()` 함수 추가
   - `handleTableClick()` 수정

3. `connections/static/connections/ui.js`
   - `renderCostCodeRulesetTable()` 대폭 수정
   - 조건 빌더 및 맵핑 빌더 적용
   - 읽기 전용 모드 표시 개선

4. `connections/static/connections/ruleset_cost_code_handlers.js`
   - 저장 로직 수정 (조건 및 맵핑 수집 방식 변경)

### HTML 파일
1. `connections/templates/revit_control.html`
   - BIM 원본 데이터 탭에 split layout 추가
   - 룰셋 작성 도우미 패널 구조 추가

## 6. 사용자 경험 개선 효과

### Before (이전)
- JSON textarea에 직접 입력: `[{"parameter": "Category", "operator": "==", "value": "벽"}]`
- 문법 오류 발생 가능
- 속성명을 외우거나 추측해야 함
- 읽기 전용 모드에서도 JSON 노출

### After (개선)
- 드롭다운으로 속성 선택
- 연산자 선택 (==, !=, contains, startsWith, endsWith 등)
- 값 입력 (문법 검사 불필요)
- BIM 원본 데이터 탭에서 실제 속성명 확인 가능
- 읽기 전용 모드: `Category == "벽"` (사람이 읽기 쉬운 형태)

## 7. 기술적 패턴

### 조건 빌더 패턴
```javascript
// 1. 렌더링
renderConditionRowForQM(condition, index)
renderConditionRowForRE(condition, index)

// 2. 이벤트 리스너
setupConditionBuilderListeners()
- .add-condition-btn 클릭 시 새 행 추가
- .remove-condition-btn 클릭 시 행 제거

// 3. 데이터 수집
conditionRows.forEach(row => {
    const property = row.querySelector('.condition-property').value;
    const operator = row.querySelector('.condition-operator').value;
    const value = row.querySelector('.condition-value').value;
    conditions.push({ property, operator, value });
});
```

### 맵핑 빌더 패턴
```javascript
// 1. 렌더링
renderMappingRow(key, value, index)

// 2. 이벤트 리스너
setupConditionBuilderListeners() // 맵핑 버튼도 함께 처리
- .add-mapping-btn 클릭 시 새 행 추가
- .remove-mapping-btn 클릭 시 행 제거

// 3. 데이터 수집
const mapping_script = {};
mappingRows.forEach(row => {
    const key = row.querySelector('.mapping-key-input').value.trim();
    const value = row.querySelector('.mapping-value-input').value.trim();
    mapping_script[key] = value;
});
```

## 8. 향후 작업 고려사항

1. **다른 룰셋에도 적용**
   - 분류 할당 룰셋
   - 일람부호 할당 룰셋
   - 공사코드 할당 룰셋
   - 공간 분류/할당 룰셋

2. **검증 로직 강화**
   - 중복 조건 체크
   - 순환 참조 방지
   - 속성명 유효성 검사

3. **UI/UX 개선**
   - 조건 그룹화 (AND/OR 로직)
   - 조건 복사/붙여넣기
   - 룰셋 테스트 기능

## 9. 결론

이번 작업으로 룰셋 관리 UI가 크게 개선되었습니다:
- ✅ 사용자 친화적인 조건 입력 방식
- ✅ 실제 BIM 데이터 속성 참조 가능
- ✅ JSON 문법 오류 가능성 제거
- ✅ 가독성 높은 읽기 전용 표시
- ✅ 테이블 레이아웃 개선으로 내용 확인 용이

사용자는 이제 복잡한 JSON 문법을 몰라도 직관적으로 룰셋을 작성할 수 있습니다.
