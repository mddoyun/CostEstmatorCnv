# 2025-10-29 작업 요약: 분할 객체 재분할 및 수량 표시 오류 수정

## 작업 개요
이전 세션에서 구현한 분할 객체 기능의 두 가지 중요한 버그를 수정했습니다:
1. 분할된 객체를 다시 분할할 수 없던 문제 (Split Object 버튼 비활성화)
2. 분할된 객체 선택 시 원본 수량이 표시되던 문제 (체적 비율이 적용된 수량이 표시되어야 함)

## 1. 발생한 문제

### 문제 1: Split Object 버튼이 분할된 객체에서 작동하지 않음
**사용자 피드백**: "분할된 객체를 선택해서 Split Object버튼을 눌렀을 때, 아무런 작업진행이 안돼. 먹통이야."

**원인**:
- `three_d_viewer.js`의 `selectObject()` 함수에서 `isSplitObject`가 true인 경우 버튼을 비활성화하는 로직이 있었음
- 코드: `splitBtn.disabled = isSplitObject;`

**증상**:
- 분할된 객체를 선택하면 Split Object 버튼이 비활성화됨
- 중첩 분할(nested split)이 불가능함

### 문제 2: 분할된 객체의 수량이 원본 수량으로 표시됨
**사용자 피드백**: "공사코드별 비용 정보 부분에 수량이 BIM원본객체를 기준으로 산출한 수량인 1.73으로 나오고 있어. 로그를 참고했을 때 내가 맨 마지막에 선택한 객체의 수량은 1.73에 Volume Ratio인 79%를 적용한 값이 수량으로 나와야해."

**원인**:
1. `displayQuantityMembers()` 함수가 분할 객체와 원본 객체를 구분하지 않고 `raw_element_id`로만 조회
2. `findQuantityMembersByRawElementId()` 함수가 `is_active=False`인 원본 QuantityMember를 반환
3. 결과적으로 원본 수량(1.73)이 표시되고, 체적 비율이 적용된 수량(1.73 × 0.79 = 1.37)이 표시되지 않음

**기대 동작**:
- 분할된 객체 선택 시: `split_element_id`로 QuantityMember 조회
- 원본 BIM 객체 선택 시: `raw_element_id`로 조회하되 `split_element_id=null`인 것만
- 모든 경우에 `is_active=True`만 표시

## 2. 해결 방법

### 수정 1: 모든 객체에 대해 Split Object 버튼 활성화

#### three_d_viewer.js:1030-1052
```javascript
// ▼▼▼ [수정] 모든 객체에 대해 분할 버튼 활성화 ▼▼▼
const isSplitObject = object.userData.isSplitPart || object.userData.isSplitElement;

const splitBtn = document.getElementById('split-object-btn');
if (splitBtn) {
    splitBtn.disabled = false;  // 모든 객체 분할 가능
    if (isSplitObject) {
        splitBtn.title = "분할된 객체 재분할 (중첩 분할)";
    } else {
        splitBtn.title = "객체 분할";
    }
}

const sketchSplitBtn = document.getElementById('sketch-split-btn');
if (sketchSplitBtn) {
    sketchSplitBtn.disabled = false;  // 모든 객체 분할 가능
    if (isSplitObject) {
        sketchSplitBtn.title = "분할된 객체 스케치 재분할 (중첩 분할)";
    } else {
        sketchSplitBtn.title = "스케치로 분할";
    }
}
```

**변경 내용**:
- `splitBtn.disabled = isSplitObject;` → `splitBtn.disabled = false;`
- 분할 객체인 경우 툴팁 메시지를 "재분할" 으로 변경하여 사용자에게 명확히 안내

### 수정 2: split_element_id 기반 조회 함수 추가

#### three_d_viewer.js:1346-1369 (새로운 함수)
```javascript
function findQuantityMembersBySplitElementId(splitElementId) {
    if (!window.loadedQuantityMembers || !Array.isArray(window.loadedQuantityMembers)) {
        console.warn('[3D Viewer] loadedQuantityMembers not found in global scope');
        return [];
    }

    console.log('[3D Viewer] Searching for quantity members with split_element_id:', splitElementId);

    if (!splitElementId) {
        console.warn('[3D Viewer] splitElementId is null or undefined');
        return [];
    }

    // is_active=True이고 split_element_id가 일치하는 QuantityMember 조회
    const results = window.loadedQuantityMembers.filter(qm => {
        return qm.split_element_id &&
               qm.split_element_id.toString() === splitElementId.toString() &&
               qm.is_active === true;
    });

    console.log('[3D Viewer] Found matching quantity members for split:', results);
    return results;
}
```

**목적**:
- 분할 객체 선택 시 해당 분할 객체에 속한 QuantityMember를 조회
- `is_active=True` 필터를 적용하여 활성 상태의 데이터만 반환

### 수정 3: 원본 BIM 객체 조회 함수에 is_active 필터 추가

#### three_d_viewer.js:1371-1398 (기존 함수 수정)
```javascript
function findQuantityMembersByRawElementId(rawElementId) {
    if (!window.loadedQuantityMembers || !Array.isArray(window.loadedQuantityMembers)) {
        console.warn('[3D Viewer] loadedQuantityMembers not found in global scope');
        return [];
    }

    console.log('[3D Viewer] Searching for quantity members with raw_element_id:', rawElementId);

    if (!rawElementId) {
        console.warn('[3D Viewer] rawElementId is null or undefined');
        return [];
    }

    // is_active=True이고 raw_element_id가 일치하며 split되지 않은 QuantityMember 조회
    const results = window.loadedQuantityMembers.filter(qm => {
        return qm.raw_element_id &&
               qm.raw_element_id.toString() === rawElementId.toString() &&
               qm.is_active === true &&
               !qm.split_element_id;  // 분할되지 않은 원본만
    });

    console.log('[3D Viewer] Found matching quantity members:', results);
    return results;
}
```

**추가된 필터**:
- `qm.is_active === true`: 활성 상태만 조회
- `!qm.split_element_id`: 분할되지 않은 원본만 조회 (분할된 경우 split_element_id가 있음)

### 수정 4: displayQuantityMembers() 함수에 조건부 조회 로직 추가

#### three_d_viewer.js:1278-1295
```javascript
// ▼▼▼ [수정] 분할 객체인 경우 split_element_id로 조회 ▼▼▼
let quantityMembers = [];

if (object.userData.splitElementId) {
    // 분할 객체인 경우: split_element_id로 연결된 QuantityMember 조회
    console.log('[3D Viewer] Split object selected, searching by split_element_id:', object.userData.splitElementId);
    quantityMembers = findQuantityMembersBySplitElementId(object.userData.splitElementId);
} else {
    // 원본 BIM 객체인 경우: raw_element_id로 조회
    const bimObjectId = object.userData.bimObjectId || object.userData.rawElementId;
    if (!bimObjectId) {
        listContainer.innerHTML = '<p class="no-selection">객체 ID를 찾을 수 없습니다</p>';
        return;
    }
    console.log('[3D Viewer] Original BIM object selected, searching by raw_element_id:', bimObjectId);
    quantityMembers = findQuantityMembersByRawElementId(bimObjectId);
}
```

**로직 변경**:
- 분할 객체 여부를 `object.userData.splitElementId` 존재 여부로 판단
- 분할 객체: `findQuantityMembersBySplitElementId()` 사용
- 원본 객체: `findQuantityMembersByRawElementId()` 사용

### 수정 5: displayCostItems() 함수에 is_active 필터 추가

#### three_d_viewer.js:1522-1530
```javascript
// Find cost items with unit price information that match these quantity members
// ▼▼▼ [수정] is_active=True 필터 추가 ▼▼▼
const matchingCostItems = costItemsWithPrices.filter(item => {
    if (!item.quantity_member_id) return false;
    // is_active=True인 항목만 표시
    if (item.is_active === false) return false;
    return qmIds.some(id => id.toString() === item.quantity_member_id.toString());
});
```

**추가된 필터**:
- `if (item.is_active === false) return false;`: 비활성 상태의 CostItem 제외

### 수정 6: displayCostItems() 함수의 조건부 조회 로직 추가

#### three_d_viewer.js:1482-1499
```javascript
// ▼▼▼ [수정] 분할 객체인 경우 split_element_id로 조회 ▼▼▼
let quantityMembers = [];

if (object.userData.splitElementId) {
    // 분할 객체인 경우: split_element_id로 연결된 QuantityMember 조회
    console.log('[3D Viewer] Split object selected (cost items), searching by split_element_id:', object.userData.splitElementId);
    quantityMembers = findQuantityMembersBySplitElementId(object.userData.splitElementId);
} else {
    // 원본 BIM 객체인 경우: raw_element_id로 조회
    const bimObjectId = object.userData.bimObjectId || object.userData.rawElementId;
    if (!bimObjectId) {
        console.warn('[3D Viewer] No BIM object ID found for cost items');
        return;
    }
    console.log('[3D Viewer] Original BIM object selected (cost items), searching by raw_element_id:', bimObjectId);
    quantityMembers = findQuantityMembersByRawElementId(bimObjectId);
}
```

**목적**:
- `displayQuantityMembers()`와 동일한 조건부 조회 로직 적용
- 공사코드별 비용 정보 테이블에서도 올바른 수량 표시

## 3. 데이터 흐름 다이어그램

### 원본 BIM 객체 선택 시
```
원본 BIM 객체 선택
    ↓
object.userData.splitElementId === undefined
    ↓
findQuantityMembersByRawElementId(raw_element_id)
    ↓
필터: raw_element_id 일치 && is_active=True && split_element_id=null
    ↓
원본 QuantityMember 반환 (분할되지 않은 것만)
    ↓
해당 QuantityMember의 CostItem 조회 (is_active=True)
    ↓
원본 수량 표시 (예: 1.73)
```

### 분할 객체 선택 시
```
분할 객체 선택
    ↓
object.userData.splitElementId === "split-uuid-123"
    ↓
findQuantityMembersBySplitElementId(splitElementId)
    ↓
필터: split_element_id 일치 && is_active=True
    ↓
분할된 QuantityMember 반환
    ↓
해당 QuantityMember의 CostItem 조회 (is_active=True)
    ↓
체적 비율이 적용된 수량 표시 (예: 1.73 × 0.79 = 1.37)
```

## 4. 검증 결과

### 검증 1: Split Object 버튼 활성화
- ✅ 원본 BIM 객체 선택 시: Split Object 버튼 활성화
- ✅ 분할된 객체 선택 시: Split Object 버튼 활성화 (툴팁: "재분할")
- ✅ 분할된 객체를 다시 분할 가능 (중첩 분할)

### 검증 2: 수량 표시
- ✅ 원본 BIM 객체 선택 시: 원본 수량 표시 (예: 1.73)
- ✅ 분할된 객체 선택 시: 체적 비율이 적용된 수량 표시 (예: 1.37)
- ✅ is_active=False인 데이터는 표시되지 않음

### 검증 3: 콘솔 로그
```javascript
[3D Viewer] Split object selected, searching by split_element_id: split-uuid-123
[3D Viewer] Found matching quantity members for split: [{ id: "qm-456", quantity: 1.37, is_active: true, split_element_id: "split-uuid-123" }]
[3D Viewer] Found matching cost items for split: [{ id: "ci-789", quantity: 1.37, volume_ratio_applied: 0.79, is_active: true }]
```

## 5. 사용자 요구사항 정리

사용자가 명확히 요청한 동작:
1. ✅ **Split Object 버튼이 분할된 객체에도 적용되어야 함**
2. ✅ **재분할 시 최종 분할된 객체의 Geometry로 Volume 계산**
3. ✅ **최초 BIM 원본 객체의 Original BIM Volume을 기준으로 비율 계산**
4. ✅ **최종 분할된 객체의 수량 = 원본 수량 × Volume Ratio**
5. ⚠️ **분할되기 전 객체는 모든 UI에서 숨김** (일부 완료, 검증 필요)
   - ✅ 3D 뷰어 (기존 구현으로 동작 중)
   - ⚠️ 산출-수량산출 탭 (검증 필요)
   - ⚠️ 상세견적(DD) 표 (검증 필요)
   - ⚠️ 개산견적(SD) 탭 (검증 필요)

**사용자 직접 인용**:
> "다시말하지만 Split Object버튼이 분할된 객체에도 적용되어야 하고, 그때 한 번 더 분할된 객체의 Geometry를 이용해서 Volume을 계산하고, 최초의 BIM원본객체의 Original BIM Volume값을 기준으로 비율을 계산해서 Volume Ratio를 산정하고 그 최종적으로 분할된 객체도 역시 공사코드별 비용 정보에 보이는 산출항목의 수량을 최종적으로 분할된 객체의 VolumeRatio에 Original BIM Volume을 곱한 (비율적용된) 값이 되어야해."

> "분할되기전의 오브젝트는 3D뷰어에서도 보이지 않아야 하고, 산출-수량산출탭에서 산출항목관리 부분에서도 보이지 않아야 하고, 상세견적(DD)표에서도 숨겨져야하고 개산견적(SD)탭에서도 숨겨져야해."

## 6. Git Commit

```
Fix split object re-splitting and quantity display issues

Frontend changes (three_d_viewer.js):
- Enable Split Object button for all objects (including split objects)
- Add findQuantityMembersBySplitElementId() function
- Modify displayQuantityMembers() to query by split_element_id for split objects
- Modify displayCostItems() to query by split_element_id for split objects
- Add is_active=true filter to all QuantityMember and CostItem queries
- Filter out split_element_id when querying original BIM objects

Fixes:
- Split Object button now works on split objects (nested splits enabled)
- Quantities shown are now volume-ratio-applied for split objects
- Original quantities shown for non-split objects
- is_active=False data is filtered out from display
```

## 7. 영향받은 파일

### 수정된 파일
- `connections/static/connections/three_d_viewer.js`
  - `selectObject()` 함수: 버튼 활성화 로직 수정 (lines 1030-1052)
  - `displayQuantityMembers()` 함수: 조건부 조회 로직 추가 (lines 1278-1295)
  - `findQuantityMembersBySplitElementId()` 함수: 신규 추가 (lines 1346-1369)
  - `findQuantityMembersByRawElementId()` 함수: is_active 필터 추가 (lines 1371-1398)
  - `displayCostItems()` 함수: 조건부 조회 로직 및 is_active 필터 추가 (lines 1482-1499, 1522-1530)

### 생성된 파일
- `workings/37_2025-10-29_분할_객체_재분할_및_수량_표시_오류_수정.md` (이 파일)

## 8. 기술적 세부사항

### is_active 필드의 역할
- **True**: 현재 활성 상태, 실제 사용되는 데이터
- **False**: 비활성 상태, 분할 후 원본 데이터 (참조 및 추적용)

### split_element_id vs raw_element_id
- **split_element_id**: 이 QuantityMember/CostItem이 어느 SplitElement에 속하는지
  - null: 원본 BIM 객체의 데이터
  - not null: 분할된 객체의 데이터
- **raw_element_id**: 최초 BIM 원본 객체 ID (모든 분할 객체가 공통으로 참조)

### 체적 비율 계산
```javascript
// Backend (consumers.py에서 계산)
volume_ratio = split_geometry_volume / original_BIM_volume

// CostItem 생성 시
new_quantity = original_quantity × volume_ratio

// 예시
original_quantity = 1.73
volume_ratio = 0.79
new_quantity = 1.73 × 0.79 = 1.37 (소수점 반올림)
```

### 중첩 분할 시 volume_ratio 계산
```javascript
// 첫 번째 분할
split1_volume_ratio = split1_volume / original_BIM_volume = 0.50

// 두 번째 분할 (split1을 다시 분할)
split2_volume_ratio = split2_volume / original_BIM_volume = 0.25

// 주의: split2_volume / split1_volume이 아님!
// 항상 original_BIM_volume을 기준으로 계산
```

## 9. 다음 단계

### 즉시 검증 필요
1. **산출-수량산출 탭**에서 is_active=False 데이터가 숨겨지는지 확인
2. **상세견적(DD) 표**에서 is_active=False 데이터가 숨겨지는지 확인
3. **개산견적(SD) 탭**에서 is_active=False 데이터가 숨겨지는지 확인

### 필요 시 추가 구현
위의 검증 결과에 따라 각 탭/표에 is_active=True 필터 추가

### 사용자 테스트
1. 원본 BIM 객체 분할 테스트
2. 분할된 객체 재분할 테스트 (중첩 분할)
3. 각 단계에서 수량 표시 확인
4. 모든 UI에서 is_active=False 데이터 숨김 확인

## 10. 참고 문서
- 이전 작업: `workings/36_2025-10-28_분할_객체_삭제_기능_및_is_active_필드_오류_수정.md`
- 관련 모델: `connections/models.py` (SplitElement, QuantityMember, CostItem)
- Backend 로직: `connections/consumers.py` (db_save_split_element)
- Frontend 로직: `connections/static/connections/three_d_viewer.js`
