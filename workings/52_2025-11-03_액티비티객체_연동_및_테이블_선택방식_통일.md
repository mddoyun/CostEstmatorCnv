# 2025-11-03 액티비티 객체 연동 기능 개선 및 테이블 행 선택 방식 통일

## 작업 개요
액티비티 객체 탭의 3D 뷰어 및 BIM 저작도구 연동 기능을 수정하고, 테이블 행 선택 방식을 전체 탭에 통일하여 사용성을 개선했습니다.

## 주요 변경 사항

### 1. Activity Objects 탭 - 3D 선택 기능 수정

**문제**: "3D 선택 객체 가져오기" 버튼을 클릭했을 때 ActivityObject가 매칭되지 않는 문제

**원인**: CostItem의 `quantity_member` 필드가 객체일 때와 문자열 ID일 때를 구분하지 못함

**해결 방법**:
- `activity_object_manager.js` (lines 1494-1518) 수정
- `quantity_member` 필드의 타입을 체크하여 세 가지 케이스 모두 처리:
  - 객체일 경우: `ci.quantity_member.id`
  - 문자열일 경우: `ci.quantity_member`
  - 별도 필드일 경우: `ci.quantity_member_id`

```javascript
// QuantityMember ID → CostItem ID 매핑
let qmId = null;
if (ci.quantity_member) {
    if (typeof ci.quantity_member === 'object' && ci.quantity_member.id) {
        qmId = ci.quantity_member.id;
    } else if (typeof ci.quantity_member === 'string') {
        qmId = ci.quantity_member;
    }
} else if (ci.quantity_member_id) {
    qmId = ci.quantity_member_id;
}
```

### 2. Activity Objects 탭 - BIM 저작도구 연동 기능 추가

**문제**: BIM 저작도구(Revit/Blender)에서 "선택 객체 가져오기" 버튼이 작동하지 않음

**원인**: WebSocket 메시지 핸들러에 ActivityObject 탭 처리 로직 누락

**해결 방법**:
- `websocket.js` (lines 557-644)에 ActivityObject 탭 처리 추가
- 데이터 체인 매핑 구현:
  1. Revit/Blender unique_id → RawElement ID
  2. RawElement ID → QuantityMember ID
  3. QuantityMember ID → CostItem ID
  4. CostItem ID → ActivityObject

```javascript
else if (activeTab === 'activity-objects') {
    // 1. Revit/Blender unique_id → RawElement
    const selectedRawElementIds = new Set();
    allRevitData.forEach((item) => {
        if (uniqueIds.has(item.element_unique_id)) {
            selectedRawElementIds.add(item.id);
        }
    });

    // 2. RawElement → QuantityMember
    const qmIds = new Set();
    // ... (매핑 로직)

    // 3. QuantityMember → CostItem
    const ciIds = new Set();
    // ... (매핑 로직)

    // 4. CostItem → ActivityObject
    // ... (최종 매핑 및 필터링)
}
```

### 3. 테이블 행 선택 방식 통일

**요구사항**: Activity Objects 탭의 클릭-토글 방식을 다른 탭에도 적용

**변경된 탭**:
1. **Cost Items 탭** (`cost_item_manager.js:234-273`)
2. **Quantity Members 탭** (`quantity_members_manager.js:322-360`)
3. **BIM Raw Data 탭** (`data_management_handlers.js:347-383`)

**변경 내용**:
- 기존: Ctrl 키를 눌러야 다중 선택 가능
- 개선: 단순 클릭으로 토글 (클릭하면 선택/해제)
- Shift+클릭 범위 선택 기능은 유지

**구현**:
```javascript
if (event.shiftKey && lastSelectedRowIndex > -1) {
    // Shift+클릭: 범위 선택
    const start = Math.min(lastSelectedRowIndex, clickedRowIndex);
    const end = Math.max(lastSelectedRowIndex, clickedRowIndex);
    if (!event.ctrlKey) selectedIds.clear();
    for (let i = start; i <= end; i++) {
        const rowId = allVisibleRows[i].dataset.id;
        if (rowId) selectedIds.add(rowId);
    }
} else {
    // 단순 클릭: 토글 (Activity Objects 방식)
    if (selectedIds.has(itemId)) {
        selectedIds.delete(itemId);
    } else {
        selectedIds.add(itemId);
    }
}
```

## 수정된 파일

1. `connections/static/connections/activity_object_manager.js`
   - Line 1494-1518: 3D 선택 기능 - CostItem quantity_member 타입 체크 추가

2. `connections/static/connections/websocket.js`
   - Line 557-644: ActivityObject 탭 BIM 저작도구 연동 처리 추가

3. `connections/static/connections/cost_item_manager.js`
   - Line 234-273: 행 선택 방식을 클릭-토글로 변경

4. `connections/static/connections/quantity_members_manager.js`
   - Line 322-360: 행 선택 방식을 클릭-토글로 변경
   - 선택된 행 시각적 표시 업데이트 추가

5. `connections/static/connections/data_management_handlers.js`
   - Line 347-383: 행 선택 방식을 클릭-토글로 변경

6. `connections/static/connections/style.css`
   - 테이블 행 pointer cursor 스타일 추가 (이전 작업에서 이미 적용됨)

## 사용자 경험 개선

### 선택 방식
- **단순 클릭**: 행을 클릭하면 선택/해제 토글
- **Shift+클릭**: 이전 선택부터 현재까지 범위 선택
- **시각적 피드백**:
  - 마우스 오버 시 pointer cursor 표시
  - 선택된 행은 'selected-row' 클래스로 하이라이트

### 워크플로우 통일
모든 탭(Cost Items, Quantity Members, BIM Raw Data, Activity Objects)에서 동일한 방식으로 행을 선택할 수 있어 학습 곡선이 감소하고 일관된 사용자 경험을 제공합니다.

## 테스트 시나리오

1. **3D 선택 연동 테스트**:
   - 3D 뷰어에서 객체 선택
   - "3D 선택 객체 가져오기" 버튼 클릭
   - ActivityObject가 올바르게 필터링되는지 확인

2. **BIM 연동 테스트**:
   - Revit/Blender에서 객체 선택
   - "선택 객체 가져오기" 버튼 클릭
   - ActivityObject가 올바르게 매칭되는지 확인

3. **행 선택 테스트**:
   - 각 탭에서 행을 클릭하여 선택/해제 토글 확인
   - Shift+클릭으로 범위 선택 확인
   - 선택된 항목의 속성 패널 업데이트 확인

## 기술적 세부사항

### 데이터 체인 매핑
ActivityObject 연동은 4단계 매핑을 거칩니다:
1. BIM 저작도구의 unique_id를 RawElement로 변환
2. RawElement의 ID를 사용하여 QuantityMember 찾기
3. QuantityMember를 참조하는 CostItem 찾기
4. CostItem을 참조하는 ActivityObject 찾기

이 과정에서 각 단계마다 Set을 사용하여 고유한 ID만 유지하고, 최종적으로 필터링 기능에 활용합니다.

### 타입 안전성
`quantity_member` 필드는 Django 직렬화 방식에 따라 객체나 문자열로 반환될 수 있습니다. 이를 처리하기 위해 타입 체크를 추가하여 모든 경우에 올바르게 작동하도록 보장합니다.

## 향후 개선 사항

- [ ] 다른 탭들도 동일한 데이터 체인 매핑 패턴 적용 고려
- [ ] 선택된 항목 수를 표시하는 상태 표시줄 추가 검토
- [ ] 키보드 단축키(Ctrl+A 전체 선택 등) 추가 검토
