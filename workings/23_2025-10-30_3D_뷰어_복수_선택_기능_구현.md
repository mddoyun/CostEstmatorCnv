# 3D 뷰어 복수 선택 기능 구현

**날짜**: 2025-10-30
**작업자**: Claude Code

## 개요

3D 뷰어에 복수 객체 선택 기능을 추가했습니다. 사용자가 여러 객체를 선택하고 이를 BOQ 필터링에 활용할 수 있습니다.

## 구현된 기능

### 1. 박스 선택 (Box Selection)

윈도우 탐색기처럼 마우스 좌클릭 드래그로 영역을 지정하여 여러 객체를 선택할 수 있습니다.

**동작 방식:**
- 마우스 좌클릭 + 드래그 → 선택 박스 표시
- 5px 이상 드래그 시 박스 선택 모드 활성화
- 선택 박스 내의 모든 객체가 선택됨
- 시각적 피드백: 녹색 점선 테두리 박스

**구현 세부사항:**
```javascript
// 선택 박스 UI 요소 생성
selectionBox = document.createElement('div');
selectionBox.style.border = '2px dashed #4CAF50';
selectionBox.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';

// 박스 내 객체 감지 (스크린 좌표 투영 방식)
const screenPos = worldPos.clone().project(camera);
const x = (screenPos.x * 0.5 + 0.5) * rect.width;
const y = ((-screenPos.y) * 0.5 + 0.5) * rect.height;

if (x >= minX && x <= maxX && y >= minY && y <= maxY) {
    objectsInBox.push(mesh);
}
```

### 2. Ctrl+클릭 복수 선택

Ctrl (Windows) 또는 Cmd (Mac) 키를 누른 채로 클릭하면 개별 객체를 선택에 추가하거나 제거할 수 있습니다.

**동작 방식:**
- Ctrl+클릭 → 선택 토글 (추가/제거)
- 이미 선택된 객체를 Ctrl+클릭 → 선택 해제
- 일반 클릭 → 기존 선택 해제 후 단일 선택

**구현 세부사항:**
```javascript
const isCtrlKey = event.ctrlKey || event.metaKey;
if (isCtrlKey) {
    toggleSingleObject(clickedObject);
} else {
    selectObject(clickedObject);
}
```

### 3. 일반 클릭 (단일 선택)

기존 동작 유지: 일반 클릭 시 하나의 객체만 선택됩니다.

### 4. Ctrl+드래그 (누적 박스 선택)

Ctrl 키를 누른 채로 드래그하면 기존 선택에 추가되는 방식으로 박스 선택을 할 수 있습니다.

**동작 방식:**
- Ctrl+드래그 → 박스 내 객체를 현재 선택에 추가/제거
- 이미 선택된 객체는 제거, 아닌 객체는 추가

## 시각적 피드백

### 선택된 객체 표시

복수 선택된 객체들은 **주황색 반투명 하이라이트**로 표시됩니다:

```javascript
const highlightMaterial = new THREE.MeshStandardMaterial({
    color: 0xff8800,           // Orange
    emissive: 0xff6600,        // Orange glow
    emissiveIntensity: 0.5,
    metalness: 0.0,
    roughness: 1.0,
    flatShading: true,
    transparent: true,
    opacity: 0.7,
    side: THREE.DoubleSide
});
```

### 속성 패널

복수 선택 시 속성 패널 상단에 선택된 객체 수가 표시됩니다:

```
┌────────────────────────────┐
│ 복수 선택                  │
│ 선택된 객체 수: 5          │
│ 아래는 첫 번째 객체의      │
│ 속성입니다.                │
└────────────────────────────┘
```

## BOQ 통합

### 복수 선택 객체 필터링

"뷰어 선택 가져오기" 버튼 클릭 시 선택된 모든 객체를 기준으로 BOQ가 필터링됩니다.

**구현 세부사항:**
```javascript
const selectedObjects = window.getViewerSelectedObjects();

selectedObjects.forEach(obj => {
    if (obj.userData.splitElementId) {
        window.boqFilterSplitElementIds.add(splitElementId);
    } else {
        boqFilteredRawElementIds.add(rawElementId);
    }
});
```

**메시지 표시:**
- 1개 선택: "선택된 객체를 기준으로 필터링되었습니다"
- 복수 선택: "5개 객체를 기준으로 필터링되었습니다"

## 기술적 세부사항

### 이벤트 핸들러 구조

기존의 `click` 이벤트를 `pointerdown`, `pointermove`, `pointerup`으로 변경하여 드래그와 클릭을 구분합니다:

```javascript
canvas.addEventListener('pointerdown', onPointerDown, false);
canvas.addEventListener('pointermove', onPointerMove, false);
canvas.addEventListener('pointerup', onPointerUp, false);
```

**드래그 판별 로직:**
- 포인터 다운 시점 기록 (`pointerDownTime`)
- 5px 이상 이동 시 `isDragging = true`
- 100ms 이상 경과 + 드래그 → 박스 선택
- 그 외 → 클릭 선택

### 객체 상태 관리

```javascript
let selectedObject = null;        // 단일 선택 (하위 호환)
let selectedObjects = [];         // 복수 선택 배열
let originalMaterials = new Map(); // 원본 재질 저장
```

### 새로운 API 함수

```javascript
// 복수 선택 객체 배열 반환
window.getViewerSelectedObjects = function() {
    return selectedObjects.length > 0
        ? selectedObjects
        : (selectedObject ? [selectedObject] : []);
};
```

## 변경된 파일

### 1. `connections/static/connections/three_d_viewer.js`

**추가된 변수:**
- `isDragging`, `dragStart`, `dragCurrent`, `selectionBox`, `pointerDownTime`

**추가된 함수:**
- `onPointerDown()` - 포인터 다운 이벤트 핸들러
- `onPointerMove()` - 포인터 이동 이벤트 핸들러
- `onPointerUp()` - 포인터 업 이벤트 핸들러
- `updateSelectionBoxUI()` - 선택 박스 UI 업데이트
- `performBoxSelection()` - 박스 선택 수행
- `performClickSelection()` - 클릭 선택 수행 (기존 로직)
- `toggleSingleObject()` - 단일 객체 토글
- `toggleMultipleObjects()` - 복수 객체 토글
- `window.getViewerSelectedObjects()` - 선택된 객체 배열 API

**수정된 함수:**
- `displayObjectProperties()` - 복수 선택 정보 표시 추가
- `deselectAllObjects()` - 복수 선택 지원

### 2. `connections/static/connections/boq_detailed_estimation_handlers.js`

**수정된 함수:**
- `handleBoqGetFromViewer()` - 복수 선택 객체 처리 지원

```javascript
// 기존: 단일 객체만 처리
const selectedObject = window.getViewerSelectedObject();

// 변경: 복수 객체 처리
const selectedObjects = window.getViewerSelectedObjects();
selectedObjects.forEach(obj => {
    // 각 객체를 필터에 추가
});
```

## 사용 방법

### 박스 선택
1. 3D 뷰어에서 마우스 좌클릭 후 드래그
2. 녹색 점선 박스가 표시됨
3. 마우스를 놓으면 박스 내의 모든 객체 선택

### Ctrl+클릭
1. 객체를 하나 선택
2. Ctrl (또는 Cmd) 키를 누른 채로 다른 객체 클릭
3. 여러 객체가 주황색으로 하이라이트됨

### Ctrl+드래그
1. 일부 객체를 선택한 상태에서
2. Ctrl 키를 누른 채로 드래그
3. 박스 내 객체가 현재 선택에 추가됨

### BOQ 필터링
1. 3D 뷰어에서 여러 객체 선택
2. 상세견적(DD) 탭으로 이동
3. "뷰어 선택 가져오기" 버튼 클릭
4. 선택된 객체들과 연관된 산출항목만 표시됨

## 테스트 시나리오

### 시나리오 1: 박스 선택
1. ✅ 드래그 시 녹색 박스 표시
2. ✅ 박스 내 객체들이 주황색으로 하이라이트
3. ✅ 속성 패널에 선택된 객체 수 표시

### 시나리오 2: Ctrl+클릭
1. ✅ 객체 A 클릭 → A 선택
2. ✅ Ctrl+클릭으로 B 추가 → A, B 선택
3. ✅ Ctrl+클릭으로 A 클릭 → B만 선택

### 시나리오 3: BOQ 필터링
1. ✅ 3개 객체 선택
2. ✅ BOQ "뷰어 선택 가져오기" 클릭
3. ✅ 3개 객체 관련 항목만 표시
4. ✅ 메시지: "3개 객체를 기준으로 필터링되었습니다"

### 시나리오 4: 분할 객체 복수 선택
1. ✅ 원본 객체 1개 + 분할 객체 2개 선택
2. ✅ BOQ 필터링 시 올바르게 구분 처리
3. ✅ 콘솔 로그: "원본=1, 분할=2, 총=3"

## 제약사항 및 향후 개선 방향

### 현재 제약사항
- 박스 선택은 객체의 중심점 기준으로 판별 (바운딩 박스 교차 검사 아님)
- 겹친 객체가 많을 경우 박스 선택 성능 영향 가능성
- 속성 패널은 첫 번째 객체만 표시

### 향후 개선 방향
- 바운딩 박스 기반 교차 검사로 정확도 향상
- 복수 선택 시 공통 속성 표시
- Shift+클릭으로 범위 선택 추가
- 선택 객체 목록 패널 추가

## 성능 고려사항

- 박스 선택 시 `scene.traverse()`로 모든 메시 검색 (O(n))
- 스크린 좌표 투영은 GPU 가속 활용
- 선택된 객체 수가 많아도 렌더링 성능에 큰 영향 없음
- 재질 변경은 메모리 효율적 (Map으로 원본 재질 저장)

## 커밋

- Commit: 9f05249
- 파일: 2개 변경 (358 insertions, 40 deletions)
- Push: origin/main

## 참고

- Three.js 좌표계: NDC (Normalized Device Coordinates) 사용
- 스크린 좌표 투영: `vector.project(camera)`
- 포인터 이벤트: 터치 스크린과 호환성 향상
