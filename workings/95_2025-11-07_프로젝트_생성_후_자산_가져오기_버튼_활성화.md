# 2025-11-07: 프로젝트 생성 후 자산 가져오기 버튼 활성화

## 작업 개요
홈 탭에서 새 프로젝트를 생성한 직후 관리 탭의 "자산 가져오기" 버튼이 비활성화 상태로 유지되어 클릭할 수 없던 문제를 해결했습니다.

## 문제 상황

### 증상
1. 홈 탭에서 프로젝트 이름 입력
2. "새 프로젝트" 버튼 클릭
3. 프로젝트 생성 성공
4. 관리 탭으로 이동
5. "자산 가져오기" 버튼 클릭 시도 → **클릭되지 않음** ❌

**사용자 보고**:
> "홈탭에서 프로젝트 이름을 입력하고 새 프로젝트 버튼을 클릭한 다음 바로 관리탭에 들어가서 바로 '자산 가져오기' 버튼을 누르면 클릭 자체가 안 돼."

### 원인 분석

#### 1. 버튼 초기 상태
**파일**: `connections/templates/revit_control.html` Line 176-178

```html
<button id="import-management-data-btn" class="sub-nav-button"
        style="background: #28a745; color: white;" disabled>
    📥 자산 가져오기
</button>
```

버튼이 `disabled` 속성으로 시작하여 비활성화 상태.

#### 2. 버튼 활성화 조건
**파일**: `connections/static/connections/project_management_handlers.js` Line 261-272

```javascript
function enableManagementDataButtons() {
    const exportBtn = document.getElementById('export-management-data-btn');
    const importBtn = document.getElementById('import-management-data-btn');
    const hasProject = currentProjectId != null && currentProjectId !== '';

    if (exportBtn) {
        exportBtn.disabled = !hasProject;
    }
    if (importBtn) {
        importBtn.disabled = !hasProject;
    }
}
```

`currentProjectId`가 설정되어 있어야 버튼이 활성화됨.

#### 3. 기존 활성화 타이밍
**파일**: `connections/static/connections/home_tab_handlers.js` Line 140-142

```javascript
// 홈 탭에서 프로젝트 선택 시 호출됨
if (typeof enableManagementDataButtons === 'function') {
    enableManagementDataButtons();
}
```

홈 탭의 프로젝트 목록에서 프로젝트를 **선택**할 때만 호출됨.

#### 4. 프로젝트 생성 플로우
**파일**: `connections/static/connections/home_tab_handlers.js` Line 256-278 (수정 전)

```javascript
if (data.status === 'success') {
    showToast(`프로젝트 '${data.project_name}' 생성 완료.`, 'success');

    // 입력 필드 초기화
    nameInput.value = '';

    // 프로젝트 셀렉터에 새 프로젝트 추가
    const projectSelector = document.getElementById('project-selector');
    if (projectSelector) {
        const newOption = new Option(
            data.project_name,
            data.project_id,
            true,
            true
        );
        projectSelector.add(newOption, projectSelector.options[1]);
        projectSelector.dispatchEvent(new Event('change'));  // change 이벤트 발생
    }

    // 프로젝트 목록 새로고침
    setTimeout(() => {
        loadHomeProjectList();
    }, 100);

    // ❌ enableManagementDataButtons() 호출 없음!
}
```

**문제점**:
- 프로젝트 셀렉터의 `change` 이벤트를 발생시키지만, 이 이벤트가 `enableManagementDataButtons()`를 호출하지 않음
- 프로젝트 생성 직후에는 `currentProjectId`가 설정되어 있지만 버튼 활성화 함수가 호출되지 않음
- 결과: 버튼이 `disabled` 상태로 유지됨

### 데이터 흐름 (수정 전)

```
1. 사용자: 프로젝트 이름 입력 → "새 프로젝트" 클릭
   ↓
2. handleHomeCreateProject() 실행
   ↓
3. 서버에 POST /connections/create-project/
   ↓
4. 서버: 프로젝트 생성 성공
   ↓
5. 클라이언트: currentProjectId = data.project_id 설정
   ↓
6. 프로젝트 셀렉터에 새 옵션 추가
   ↓
7. projectSelector.dispatchEvent(new Event('change'))
   ↓
8. (change 이벤트 핸들러가 enableManagementDataButtons()를 호출하지 않음)
   ↓
9. 사용자: 관리 탭으로 이동
   ↓
10. import-management-data-btn.disabled = true 유지 ❌
    ↓
11. 사용자: "자산 가져오기" 버튼 클릭 시도
    ↓
12. 버튼이 disabled 상태이므로 클릭 안 됨 ❌
```

## 해결 방법

### 수정: 프로젝트 생성 후 enableManagementDataButtons() 호출

**파일**: `connections/static/connections/home_tab_handlers.js`
**위치**: Line 280-283

```javascript
// 약간의 지연 후 홈 탭 프로젝트 목록 새로고침
setTimeout(() => {
    loadHomeProjectList();
}, 100);

// ▼▼▼ [추가] 관리 데이터 버튼 활성화 ▼▼▼
if (typeof enableManagementDataButtons === 'function') {
    enableManagementDataButtons();
}
// ▲▲▲ [추가] 여기까지 ▲▲▲
```

### 데이터 흐름 (수정 후)

```
1. 사용자: 프로젝트 이름 입력 → "새 프로젝트" 클릭
   ↓
2. handleHomeCreateProject() 실행
   ↓
3. 서버에 POST /connections/create-project/
   ↓
4. 서버: 프로젝트 생성 성공
   ↓
5. 클라이언트: currentProjectId = data.project_id 설정
   ↓
6. 프로젝트 셀렉터에 새 옵션 추가
   ↓
7. projectSelector.dispatchEvent(new Event('change'))
   ↓
8. loadHomeProjectList() 호출 (setTimeout)
   ↓
9. ✓ enableManagementDataButtons() 호출 [신규 추가]
   ├─ hasProject = currentProjectId != null && currentProjectId !== ''
   ├─ hasProject = true ✓
   └─ importBtn.disabled = false ✓
   ↓
10. 사용자: 관리 탭으로 이동
    ↓
11. import-management-data-btn.disabled = false ✓
    ↓
12. 사용자: "자산 가져오기" 버튼 클릭
    ↓
13. 버튼 클릭 성공! ✓✓✓
```

## 영향받는 파일

### `connections/static/connections/home_tab_handlers.js`

**변경 위치**: Line 280-283

**변경 내용**:
```javascript
// 기존
setTimeout(() => {
    loadHomeProjectList();
}, 100);

// 수정
setTimeout(() => {
    loadHomeProjectList();
}, 100);

// 관리 데이터 버튼 활성화 (자산 가져오기/내보내기)
if (typeof enableManagementDataButtons === 'function') {
    enableManagementDataButtons();
}
```

## 테스트 결과

### ✅ 성공 시나리오

**테스트 1: 새 프로젝트 생성 후 즉시 자산 가져오기**
```
1. 홈 탭에서 프로젝트 이름 "테스트프로젝트" 입력
2. "새 프로젝트" 버튼 클릭
3. 토스트 메시지: "프로젝트 '테스트프로젝트' 생성 완료." ✓
4. 관리 탭 클릭
5. "자산 가져오기" 버튼 활성화 확인 ✓
6. "자산 가져오기" 버튼 클릭
7. 파일 선택 다이얼로그 열림 ✓
```

**테스트 2: 기존 프로젝트 선택**
```
1. 홈 탭에서 기존 프로젝트 선택
2. 관리 탭 클릭
3. "자산 가져오기" 버튼 활성화 확인 ✓
4. 버튼 클릭 정상 작동 ✓
```

**테스트 3: 프로젝트 미선택 상태**
```
1. 프로젝트 셀렉터에서 "프로젝트 선택" 선택
2. 관리 탭 클릭
3. "자산 가져오기" 버튼 비활성화 확인 ✓ (정상)
```

## 기술적 세부사항

### enableManagementDataButtons 함수 동작

```javascript
function enableManagementDataButtons() {
    const exportBtn = document.getElementById('export-management-data-btn');
    const importBtn = document.getElementById('import-management-data-btn');

    // currentProjectId는 전역 변수 (app_core.js에서 정의)
    const hasProject = currentProjectId != null && currentProjectId !== '';

    if (exportBtn) {
        exportBtn.disabled = !hasProject;
        // hasProject = true이면 disabled = false (활성화)
    }
    if (importBtn) {
        importBtn.disabled = !hasProject;
        // hasProject = true이면 disabled = false (활성화)
    }
}
```

### 호출 시점 정리

**이제 `enableManagementDataButtons()`가 호출되는 모든 시점**:

1. **홈 탭에서 프로젝트 선택 시** (기존)
   - 파일: `home_tab_handlers.js` Line 140-142
   - 함수: `updateHomeProjectListSelection()`

2. **새 프로젝트 생성 후** (신규 추가)
   - 파일: `home_tab_handlers.js` Line 280-283
   - 함수: `handleHomeCreateProject()`

3. **기타 프로젝트 변경 시** (기존)
   - 프로젝트 셀렉터 change 이벤트를 통해 간접 호출

## 관련 기능

### 자산 가져오기 버튼
- **ID**: `import-management-data-btn`
- **기능**: JSON 파일을 선택하여 관리 데이터(룰셋, 태그, 코드 등) 가져오기
- **활성화 조건**: `currentProjectId`가 설정되어 있어야 함
- **이벤트 핸들러**: `handleImportManagementData()`

### 자산 내보내기 버튼
- **ID**: `export-management-data-btn`
- **기능**: 현재 프로젝트의 관리 데이터를 JSON 파일로 내보내기
- **활성화 조건**: `currentProjectId`가 설정되어 있어야 함
- **이벤트 핸들러**: `handleExportManagementData()`

## 향후 개선사항

1. **이벤트 기반 버튼 활성화**:
   - `currentProjectId` 변경 시 자동으로 `enableManagementDataButtons()` 호출
   - Proxy 또는 Setter를 사용하여 자동화

   ```javascript
   // 예시
   let _currentProjectId = null;
   Object.defineProperty(window, 'currentProjectId', {
       get: () => _currentProjectId,
       set: (value) => {
           _currentProjectId = value;
           if (typeof enableManagementDataButtons === 'function') {
               enableManagementDataButtons();
           }
       }
   });
   ```

2. **버튼 상태 동기화**:
   - 모든 프로젝트 변경 지점에서 일관되게 버튼 상태 업데이트
   - `MutationObserver`를 사용하여 프로젝트 셀렉터 변경 감지

3. **툴팁 추가**:
   - 버튼이 비활성화된 이유를 사용자에게 알림
   ```html
   <button ... disabled title="프로젝트를 먼저 선택하세요">
   ```

## 관련 이슈

- Project management button state
- UI state synchronization
- Project creation workflow

## 작업 시간
- 날짜: 2025-11-07
- 소요 시간: 약 15분
- 작업자: Claude Code (Anthropic)
- 이슈: 프로젝트 생성 후 자산 가져오기 버튼 비활성화
