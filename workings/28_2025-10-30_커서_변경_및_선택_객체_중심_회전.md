# 커서 변경 및 선택 객체 중심 회전 피벗 설정

**날짜**: 2025-10-30
**작업자**: Claude Code

## 개요

3D 뷰어의 사용자 경험을 개선하기 위해 두 가지 기능을 구현했습니다:
1. 마우스 커서를 손가락 모양에서 기본 화살표로 변경
2. 선택된 객체의 중심을 회전 피벗으로 설정

## 변경 사항 1: 마우스 커서 변경

### Before (변경 전)

```css
#three-d-canvas {
    cursor: pointer;  /* 손가락 모양 */
}
```

**문제점:**
- 3D 뷰어 전체가 손가락 모양 커서 표시
- 클릭 가능한 UI 요소와 혼동
- 3D 뷰어는 드래그/회전이 주 기능이므로 손가락 커서가 부적절

### After (변경 후)

```css
#three-d-canvas {
    cursor: default;  /* 기본 화살표 */
}
```

**개선 효과:**
- ✅ 자연스러운 기본 커서
- ✅ 3D 공간 네비게이션에 적합
- ✅ 다른 3D 소프트웨어와 일관된 경험

## 변경 사항 2: 선택 객체 중심 회전 피벗

### 문제 상황

**Before (변경 전):**
- 회전 피벗이 항상 원점(0, 0, 0) 고정
- 멀리 떨어진 객체를 선택해도 원점 중심으로 회전
- 선택한 객체를 자세히 보기 어려움

```
Camera
  ↓ 회전
  ● ← 원점 (0,0,0) 고정

         멀리 떨어진
         선택된 객체 □
         (회전하면 화면 밖으로!)
```

### 해결 방법

**After (변경 후):**
- 객체 선택 시 자동으로 해당 객체 중심을 피벗으로 설정
- 선택된 객체를 중심으로 카메라가 회전
- 여러 객체 선택 시 평균 중심점 사용

```
Camera
  ↓ 회전
      ● ← 선택된 객체 중심
      □   (피벗 자동 설정)
```

### 구현: updateOrbitTarget() 함수

#### 전체 로직

```javascript
function updateOrbitTarget() {
    if (!controls) return;

    // 1. 선택된 객체들 가져오기
    let targetObjects = selectedObjects.length > 0
        ? selectedObjects
        : (selectedObject ? [selectedObject] : []);

    if (targetObjects.length === 0) return;

    // 2. 모든 선택된 객체의 중심점 합산
    let centerSum = new THREE.Vector3(0, 0, 0);

    targetObjects.forEach(obj => {
        const center = new THREE.Vector3();

        // Bounding box 계산
        if (!obj.geometry.boundingBox) {
            obj.geometry.computeBoundingBox();
        }

        const bbox = obj.geometry.boundingBox;
        if (bbox) {
            // 로컬 좌표계에서 중심 계산
            center.x = (bbox.min.x + bbox.max.x) / 2;
            center.y = (bbox.min.y + bbox.max.y) / 2;
            center.z = (bbox.min.z + bbox.max.z) / 2;

            // World 좌표로 변환
            center.applyMatrix4(obj.matrixWorld);
        }

        centerSum.add(center);
    });

    // 3. 평균 중심점 계산
    centerSum.divideScalar(targetObjects.length);

    // 4. OrbitControls의 target 업데이트
    controls.target.copy(centerSum);
    controls.update();

    console.log('[3D Viewer] Orbit target updated to:', centerSum);
}
```

#### 좌표 변환 과정

```
Local Space (객체 좌표계)
    ↓ computeBoundingBox()
Bounding Box Min/Max
    ↓ 중심점 계산: (min + max) / 2
Local Center Point
    ↓ applyMatrix4(matrixWorld)
World Center Point
    ↓ 평균 계산 (여러 객체 시)
Average World Center
    ↓ controls.target.copy()
Orbit Pivot Point
```

### 호출 위치

`updateOrbitTarget()` 함수는 모든 선택 함수에서 호출됩니다:

#### 1. selectObject() - 단일 객체 선택

```javascript
function selectObject(object) {
    // ... 선택 로직

    // Update visibility control buttons
    updateVisibilityControlButtons();

    // ✅ 회전 피벗 업데이트
    updateOrbitTarget();
}
```

#### 2. toggleSingleObject() - Ctrl+클릭 토글

```javascript
function toggleSingleObject(object) {
    // ... 토글 로직

    updateVisibilityControlButtons();
    showToast(`${selectedObjects.length}개 객체 선택됨`, 'info');

    // ✅ 회전 피벗 업데이트
    updateOrbitTarget();
}
```

#### 3. toggleMultipleObjects() - 박스 선택 토글

```javascript
function toggleMultipleObjects(objects) {
    // ... 복수 토글 로직

    updateVisibilityControlButtons();
    console.log(`[3D Viewer] Toggled ${objects.length} objects`);

    // ✅ 회전 피벗 업데이트
    updateOrbitTarget();
}
```

## 사용 시나리오

### 시나리오 1: 단일 객체 선택 후 회전

**과정:**
1. 사용자가 객체 클릭
2. 객체가 주황색으로 하이라이트
3. `updateOrbitTarget()` 자동 호출
4. 회전 피벗이 객체 중심으로 설정
5. 우클릭 드래그로 회전 → 해당 객체 중심으로 회전

**효과:**
```
Before: 원점 중심 회전 (객체가 화면 밖으로)
After: 객체 중심 회전 (객체를 모든 각도에서 확인 가능)
```

### 시나리오 2: 여러 객체 선택 후 회전

**과정:**
1. 박스 선택 또는 Ctrl+클릭으로 여러 객체 선택
2. 모든 객체가 주황색으로 하이라이트
3. `updateOrbitTarget()` 자동 호출
4. 모든 객체의 평균 중심점을 피벗으로 설정
5. 우클릭 드래그로 회전 → 그룹 중심으로 회전

**효과:**
```
Before: 원점 중심 회전 (그룹이 화면에서 벗어남)
After: 그룹 중심 회전 (그룹 전체를 모든 각도에서 확인)
```

### 시나리오 3: 멀리 떨어진 객체

**과정:**
1. 화면 한쪽 구석의 객체 선택
2. 피벗이 자동으로 해당 위치로 이동
3. 회전 시 객체를 중심으로 카메라가 회전
4. 객체를 항상 화면 중앙 근처에서 확인 가능

**Before:**
```
[Camera] ← 회전 중심 (0,0,0)
                                    [Object] (화면 밖으로)
```

**After:**
```
[Camera]                → 회전 중심 [Object]
                          (객체 주변을 공전)
```

## 기술적 세부사항

### 1. Bounding Box 중심 계산

```javascript
const bbox = obj.geometry.boundingBox;

// 로컬 좌표계에서 중심
const localCenter = new THREE.Vector3(
    (bbox.min.x + bbox.max.x) / 2,
    (bbox.min.y + bbox.min.y) / 2,
    (bbox.min.z + bbox.max.z) / 2
);
```

### 2. World 좌표 변환

```javascript
// 객체의 월드 변환 행렬 적용
const worldCenter = localCenter.applyMatrix4(obj.matrixWorld);
```

**필요성:**
- 객체는 로컬 좌표계에서 정의됨
- 씬에서는 이동, 회전, 스케일이 적용된 World 좌표가 필요
- `matrixWorld`는 모든 변환을 누적한 행렬

### 3. 여러 객체의 평균 중심

```javascript
// 모든 중심점 합산
centerSum.add(worldCenter);

// 평균 계산
centerSum.divideScalar(targetObjects.length);
```

**효과:**
- 선택된 모든 객체를 고려한 균형잡힌 피벗
- 그룹을 전체적으로 조망하기 좋은 위치

### 4. OrbitControls 업데이트

```javascript
controls.target.copy(centerSum);  // 타겟 설정
controls.update();                 // 즉시 적용
```

**OrbitControls.target:**
- 카메라가 바라보는 중심점
- 회전 시 이 점을 중심으로 공전
- Pan 시 이 점도 함께 이동

## 변경된 파일

### 1. `connections/static/connections/style.css`

**변경 내역:**
```diff
 #three-d-canvas {
     width: 100%;
     height: 100%;
     flex-grow: 1;
     display: block;
-    cursor: pointer;
+    cursor: default;
 }
```

### 2. `connections/static/connections/three_d_viewer.js`

**추가된 함수:**
- `updateOrbitTarget()` - 회전 피벗 업데이트 (42 lines)

**수정된 함수:**
- `selectObject()` - updateOrbitTarget() 호출 추가
- `toggleSingleObject()` - updateOrbitTarget() 호출 추가
- `toggleMultipleObjects()` - updateOrbitTarget() 호출 추가

**변경 통계:**
```
connections/static/connections/style.css:  1 insertion,  1 deletion
connections/static/connections/three_d_viewer.js: 55 insertions
```

## OrbitControls 설정 참고

현재 OrbitControls 설정:

```javascript
controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.25;
controls.screenSpacePanning = false;
controls.minDistance = 1;
controls.maxDistance = 500;

// 마우스 버튼 매핑
controls.mouseButtons = {
    LEFT: null,                    // 좌클릭: 박스 선택 전용
    MIDDLE: THREE.MOUSE.PAN,       // 중간: 이동
    RIGHT: THREE.MOUSE.ROTATE      // 우클릭: 회전
};
```

**회전 방법:**
- **우클릭 + 드래그**: 선택된 객체 중심으로 카메라 회전
- **중간 버튼 + 드래그**: 카메라 이동 (피벗도 함께 이동)
- **스크롤 휠**: 줌인/줌아웃

## 사용자 경험 개선

### Before (변경 전)

❌ 손가락 커서가 3D 뷰어 전체에 표시
❌ 회전 중심이 항상 원점 고정
❌ 멀리 있는 객체를 선택해도 원점 중심으로 회전
❌ 객체를 자세히 보려면 Pan + Zoom 반복 필요
❌ 직관적이지 않은 카메라 조작

### After (변경 후)

✅ 자연스러운 기본 커서
✅ 선택된 객체가 자동으로 회전 중심
✅ 객체를 중심으로 모든 각도에서 확인 가능
✅ 한 번의 회전으로 객체 전체 조망
✅ 직관적이고 예측 가능한 카메라 동작
✅ 다른 3D 소프트웨어와 유사한 경험

## 다른 3D 소프트웨어와 비교

| 소프트웨어 | 회전 피벗 | 본 구현 |
|-----------|----------|---------|
| **Blender** | 선택 객체 중심 | ✅ 동일 |
| **3ds Max** | 선택 객체 중심 | ✅ 동일 |
| **Maya** | 선택 객체 중심 | ✅ 동일 |
| **SketchUp** | 선택 객체 중심 | ✅ 동일 |
| **Revit** | 선택 객체 중심 | ✅ 동일 |

이제 업계 표준과 일치하는 직관적인 회전 동작을 제공합니다!

## 테스트 시나리오

### 테스트 1: 단일 객체 선택 및 회전

**단계:**
1. 객체 하나 클릭
2. 콘솔에서 "Orbit target updated to:" 메시지 확인
3. 우클릭 드래그로 회전
4. 객체가 화면 중앙 근처를 유지하는지 확인

**예상 결과:**
- ✅ 객체 중심으로 회전
- ✅ 객체가 항상 시야에 유지

### 테스트 2: 복수 객체 박스 선택

**단계:**
1. 오른쪽→왼쪽 드래그로 여러 객체 선택
2. 콘솔에서 피벗 좌표 확인
3. 우클릭 드래그로 회전
4. 그룹 전체가 화면에 잘 보이는지 확인

**예상 결과:**
- ✅ 그룹의 평균 중심으로 회전
- ✅ 모든 객체가 시야에 유지

### 테스트 3: Ctrl+클릭 추가 선택

**단계:**
1. 객체 A 클릭
2. Ctrl+클릭으로 객체 B 추가
3. 콘솔에서 피벗 업데이트 확인
4. 우클릭 회전

**예상 결과:**
- ✅ A와 B의 중간 지점으로 피벗 이동
- ✅ 두 객체 모두 화면에 유지

### 테스트 4: 멀리 떨어진 객체

**단계:**
1. 화면 가장자리의 객체 선택
2. 우클릭 회전
3. 객체가 화면에서 벗어나지 않는지 확인

**예상 결과:**
- ✅ 객체를 중심으로 회전
- ✅ 360도 모든 각도에서 확인 가능

## 알려진 제한사항

1. **선택 해제 시 피벗**
   - 현재: 선택 해제 시 피벗은 마지막 위치에 유지
   - 향후: 선택 해제 시 원점으로 복귀 옵션 검토

2. **대형 객체**
   - 바운딩 박스 중심이 실제 시각적 중심과 다를 수 있음
   - 대부분의 경우 문제없이 작동

3. **중첩된 분할 객체**
   - 복잡한 중첩 구조에서도 정확히 작동
   - matrixWorld가 모든 변환을 반영

## 향후 개선 방향

1. **피벗 표시**
   - 현재 회전 피벗 위치를 화면에 시각적으로 표시
   - 작은 아이콘이나 십자선으로 표현

2. **피벗 수동 조정**
   - 사용자가 직접 피벗 위치 변경 가능
   - Shift+우클릭으로 피벗 이동 등

3. **피벗 초기화 버튼**
   - "피벗 원점으로" 버튼 추가
   - 선택 해제 없이 피벗만 리셋

4. **애니메이션**
   - 피벗 변경 시 부드러운 전환 애니메이션
   - 카메라가 서서히 새 위치로 이동

## 커밋 정보

- **Commit**: 4dd600d
- **메시지**: "Change cursor to default and add orbit pivot to selected object center"
- **파일**: 2개 변경 (56 insertions, 1 deletion)
- **Push**: origin/main

## 참고

- **OrbitControls**: Three.js의 카메라 컨트롤러
- **OrbitControls.target**: 회전 중심점 (Vector3)
- **matrixWorld**: 객체의 월드 변환 행렬
- **Bounding Box**: 객체를 감싸는 최소 직육면체

## 결론

이번 업데이트로 3D 뷰어의 사용성이 크게 개선되었습니다:

1. **커서 변경**
   - ✅ 자연스러운 UI
   - ✅ 다른 3D 소프트웨어와 일관된 경험

2. **회전 피벗 자동 설정**
   - ✅ 선택된 객체 중심으로 회전
   - ✅ 직관적이고 예측 가능한 동작
   - ✅ 업계 표준 준수
   - ✅ 객체 탐색 효율 대폭 향상

사용자는 이제 객체를 선택하고 우클릭 드래그만으로 모든 각도에서 쉽게 확인할 수 있습니다!
