# 54. 액티비티 객체 삭제 UI 업데이트 수정

**날짜**: 2025-11-04
**작업자**: Claude Code
**관련 이슈**: 마지막 액티비티 객체 삭제 시 UI가 업데이트되지 않는 문제

## 작업 개요

액티비티 객체 탭에서 마지막 남은 액티비티 객체를 삭제할 때, 서버에서는 정상적으로 삭제되지만 UI가 업데이트되지 않아 테이블에 행이 그대로 남아있는 문제를 수정했습니다.

## 문제 분석

### 증상

**사용자 보고**:
- 액티비티 객체 탭에서 마지막 하나 남은 객체의 '삭제' 버튼 클릭
- 서버에서는 삭제가 성공함 (재로드 시 삭제되어 있음)
- 그러나 화면에는 테이블 행이 그대로 남아있음
- 속성 패널에도 삭제된 객체의 정보가 계속 표시됨

**콘솔 로그 분석**:
```
[DEBUG][deleteActivityObject] Called with aoId: 3d8d9464...
[DEBUG][deleteActivityObject] Current loadedActivityObjects count: 1
[DEBUG][deleteActivityObject] Sending DELETE request...
[DEBUG][deleteActivityObject] Response status: 200
[DEBUG][deleteActivityObject] Response result: {message: "액티비티 객체가 삭제되었습니다."}
[DEBUG][deleteActivityObject] Reloading activity objects...

[connections.views] Loaded 0 active ActivityObjects for project...
[DEBUG][loadActivityObjects] Loaded 0 activity objects from server
[DEBUG][loadActivityObjects] Setting window.loadedActivityObjects to 0 items
```

서버 로그를 보면:
- 삭제 요청이 성공 (status: 200)
- `loadActivityObjects()` 재로드 시 0개 로드됨
- 그러나 UI는 업데이트되지 않음

### 원인 분석

**파일**: `connections/static/connections/activity_object_manager.js`

**문제 위치**: Line 658-661

```javascript
function renderActivityObjectsTable(activityObjects) {
    const container = document.getElementById('ao-table-container');
    if (!container) return;

    if (!activityObjects || activityObjects.length === 0) {
        container.innerHTML = '<p>액티비티 객체가 없습니다.</p>';
        return; // ← 문제: 빈 메시지만 표시하고 반환
    }
    // ...
}
```

**문제점**:
1. **속성 패널 미클리어**: 빈 배열일 때 테이블 컨테이너만 업데이트하고 속성 패널(`ao-properties-content`)은 그대로 남김
2. **선택 상태 미클리어**: `selectedAoIds` Set이 클리어되지 않아 삭제된 객체 ID가 남아있음
3. **시각적 불일치**: 테이블은 "액티비티 객체가 없습니다"를 표시하지만, 속성 패널에는 여전히 삭제된 객체의 정보가 표시됨

**예상 동작 흐름**:
```
1. 사용자가 '삭제' 버튼 클릭
   → deleteActivityObject(aoId) 호출

2. 서버에 DELETE 요청 전송
   → response.ok = true

3. loadActivityObjects() 재로드
   → window.loadedActivityObjects = [] (0개)

4. renderActivityObjectsTable([]) 호출
   → container에 빈 메시지 표시
   → ❌ 속성 패널은 그대로
   → ❌ selectedAoIds는 그대로

5. 결과
   → 테이블: "액티비티 객체가 없습니다" ✅
   → 속성 패널: 삭제된 객체 정보 표시 ❌
   → 선택 상태: 삭제된 객체 ID 남아있음 ❌
```

## 수정 내용

### JavaScript: renderActivityObjectsTable() 함수 수정

**파일**: `connections/static/connections/activity_object_manager.js`

**변경 위치**: Line 658-672

**변경사항**:
```javascript
// BEFORE: 빈 메시지만 표시
if (!activityObjects || activityObjects.length === 0) {
    container.innerHTML = '<p>액티비티 객체가 없습니다.</p>';
    return;
}

// AFTER: 속성 패널과 선택 상태도 함께 클리어
if (!activityObjects || activityObjects.length === 0) {
    container.innerHTML = '<p>액티비티 객체가 없습니다.</p>';

    // Clear property panel
    const propertyPanel = document.getElementById('ao-properties-content');
    if (propertyPanel) {
        propertyPanel.innerHTML = '<p>선택된 액티비티 객체가 없습니다.</p>';
    }

    // Clear selection state
    selectedAoIds.clear();

    console.log('[DEBUG][renderActivityObjectsTable] Cleared property panel and selection state due to empty array');
    return;
}
```

**주요 개선사항**:
1. **속성 패널 클리어**: `ao-properties-content` 요소를 빈 상태 메시지로 업데이트
2. **선택 상태 클리어**: `selectedAoIds` Set을 완전히 비워서 삭제된 객체 ID 제거
3. **디버그 로그 추가**: 클리어 작업이 수행되었음을 로그로 기록
4. **일관된 UI 상태**: 테이블, 속성 패널, 선택 상태가 모두 빈 상태로 동기화됨

## 테스트 시나리오

### 마지막 액티비티 객체 삭제 테스트

**사전 조건**:
- 프로젝트에 액티비티 객체가 1개만 존재
- 액티비티 객체 탭이 열려있음

**테스트 절차**:
1. 테이블에서 유일한 액티비티 객체 행의 '삭제' 버튼 클릭
2. 삭제 확인 대화상자에서 '확인' 클릭

**예상 결과** ✅:
- 테이블 영역: "액티비티 객체가 없습니다" 메시지 표시
- 속성 패널: "선택된 액티비티 객체가 없습니다" 메시지 표시
- 콘솔 로그: `[DEBUG][renderActivityObjectsTable] Cleared property panel and selection state due to empty array` 출력
- 선택 상태: `selectedAoIds.size === 0`

### 여러 객체 중 하나 삭제 테스트

**사전 조건**:
- 프로젝트에 액티비티 객체가 2개 이상 존재

**테스트 절차**:
1. 테이블에서 임의의 액티비티 객체 행의 '삭제' 버튼 클릭
2. 삭제 확인 대화상자에서 '확인' 클릭

**예상 결과** ✅:
- 삭제된 행은 테이블에서 제거됨
- 나머지 행들은 정상적으로 표시됨
- 삭제된 객체가 선택되어 있었다면 선택 해제됨
- 속성 패널은 현재 선택된 객체 표시 (선택이 없으면 빈 상태)

### 프로젝트 재로드 후 확인

**테스트 절차**:
1. 마지막 액티비티 객체 삭제 후
2. 다른 탭으로 이동했다가 액티비티 객체 탭으로 재진입

**예상 결과** ✅:
- 테이블: "액티비티 객체가 없습니다" 메시지 유지
- 속성 패널: "선택된 액티비티 객체가 없습니다" 메시지 유지
- 데이터 일관성 유지

## 영향 범위

### 수정된 파일
1. `connections/static/connections/activity_object_manager.js` - `renderActivityObjectsTable()` 함수 수정

### 영향받는 기능
- ✅ 액티비티 객체 삭제 기능
- ✅ 액티비티 객체 테이블 렌더링
- ✅ 속성 패널 상태 관리
- ✅ 선택 상태 관리

### 호환성
- 기존 액티비티 객체 생성/편집 기능: 영향 없음
- 필터링/그룹핑 기능: 영향 없음
- 3D 뷰포트/BIM 저작도구 연동: 영향 없음

## 기술적 세부사항

### 관련 DOM 요소

```javascript
// 테이블 컨테이너
const container = document.getElementById('ao-table-container');
// → 액티비티 객체 테이블이 렌더링되는 영역

// 속성 패널
const propertyPanel = document.getElementById('ao-properties-content');
// → 선택된 액티비티 객체의 상세 정보를 표시하는 패널
// → 좌측 패널의 "속성" 탭 내부 컨텐츠
```

### 삭제 흐름 (수정 후)

```
1. 사용자: '삭제' 버튼 클릭
   ↓
2. deleteActivityObject(aoId)
   ↓
3. fetch DELETE /connections/api/activity-objects/{projectId}/{aoId}/
   ↓
4. 서버: is_active=False 설정 (soft delete)
   ↓
5. loadActivityObjects() 재로드
   ↓
6. 서버: is_active=True인 객체만 반환 (0개)
   ↓
7. window.loadedActivityObjects = [] 설정
   ↓
8. renderActivityObjectsTable([])
   ├─→ container.innerHTML = '빈 메시지'
   ├─→ propertyPanel.innerHTML = '빈 메시지' ✅ [추가]
   ├─→ selectedAoIds.clear() ✅ [추가]
   └─→ console.log 출력 ✅ [추가]
   ↓
9. 결과: 완전한 UI 초기화 ✅
```

### 속성 패널 구조 (HTML)

```html
<!-- revit_control.html 내부 -->
<div id="activity-objects" class="content-section">
    <div class="data-management-container">
        <!-- 좌측 패널 -->
        <div class="left-panel">
            <div class="left-panel-tabs">
                <button class="left-panel-tab-button" data-tab="ao-properties">속성</button>
                <!-- ... -->
            </div>
            <div class="left-panel-content">
                <div id="ao-properties-content" class="left-panel-tab-content">
                    <!-- ← 이곳에 선택된 객체의 속성이 표시됨 -->
                </div>
            </div>
        </div>

        <!-- 메인 컨텐츠 (테이블 영역) -->
        <div class="main-content">
            <div id="ao-table-container">
                <!-- ← 이곳에 테이블이 렌더링됨 -->
            </div>
        </div>
    </div>
</div>
```

### Set 자료구조 관리

```javascript
// 전역 선택 상태 관리
let selectedAoIds = new Set();

// 체크박스 선택 시 추가
checkbox.addEventListener('change', (e) => {
    if (e.target.checked) {
        selectedAoIds.add(aoId);
    } else {
        selectedAoIds.delete(aoId);
    }
});

// 빈 배열 렌더링 시 전체 클리어
selectedAoIds.clear(); // ← 수정 사항
```

## 관련 커밋

- 이전 작업: 53_2025-11-04_시뮬레이션_탭_재생버튼_및_초기화_기능_수정.md
- 관련 기능: 액티비티 객체 관리, 데이터 테이블 렌더링, UI 상태 관리

## 추가 개선 사항 제안

1. **일관된 빈 상태 처리**: 다른 데이터 관리 탭들(RawElement, QuantityMember 등)에도 동일한 패턴 적용
2. **애니메이션 효과**: 삭제 시 fade-out 효과 추가로 UX 개선
3. **실행 취소 기능**: 삭제 후 일정 시간 내 복구 가능하도록 토스트 메시지에 "취소" 버튼 추가
4. **일괄 삭제**: 여러 객체를 선택하여 한번에 삭제하는 기능 추가

## 참고 사항

- 이 수정으로 액티비티 객체 삭제 시 UI가 완전히 초기화됩니다
- Soft delete 패턴을 사용하므로 데이터베이스에서는 `is_active=False`로 유지됩니다
- 다른 데이터 관리 모듈(cost_item_manager.js, quantity_members_manager.js 등)에도 유사한 패턴 적용 검토 필요
- 디버그 로그는 향후 제거하거나 조건부로 활성화할 수 있습니다
