# 2025-11-07: 대시보드 간트차트 자동 로드 및 중복 실행 방지

## 작업 개요
홈 탭 대시보드에서 프로젝트를 처음 선택할 때 공정계획 기간이 정확하게 표시되도록 간트차트를 자동으로 로드하고, 중복 실행 문제를 해결했습니다.

## 문제 상황

### 1차 문제: async 함수 선언 누락
**증상**: 홈 탭의 프로젝트 목록이 전혀 로드되지 않음

**원인**:
```javascript
// home_tab_handlers.js line 633
function calculateScheduleDatesFromGantt() {  // async 키워드 누락
    // ...
    await window.loadProjectCalendars(window.currentProjectId);  // await 사용
    // ...
}
```

`calculateScheduleDatesFromGantt` 함수 내에서 `await`를 사용했지만 함수가 `async`로 선언되지 않아 JavaScript 문법 에러 발생.

**영향**:
- `home_tab_handlers.js` 파일 전체가 로드되지 않음
- `loadHomeProjectList()`, `setupHomeTabListeners()` 등 모든 함수가 작동하지 않음
- 브라우저 콘솔에 `SyntaxError: await is only valid in async functions` 에러

**해결**:
```javascript
// line 633
async function calculateScheduleDatesFromGantt() {
    // ...
}

// line 613 (호출하는 곳)
const scheduleData = await calculateScheduleDatesFromGantt();
```

### 2차 문제: 공정계획 기간 계산 불일치
**증상**:
- 처음 홈 탭에서 프로젝트 선택: "데이터 없음" 또는 잘못된 날짜 (22일 또는 31일)
- 공정계획 탭 방문 후 홈 탭으로 돌아옴: 정확한 날짜 (53일) 표시

**원인 분석**:
1. 대시보드는 `window.ganttMinDate`와 `window.ganttMaxDate`를 우선 사용
2. 이 값들은 간트차트 탭을 방문해야만 설정됨
3. 간트차트를 방문하지 않으면 대시보드가 직접 계산을 시도하지만:
   - 프로젝트 캘린더가 로드되지 않음
   - `calculateTaskDates()`가 제대로 작동하지 않음
   - 단순 duration 합산만 되어 잘못된 결과

**사용자 요청**:
> "처음 접속할때 그냥 공정계획 카드를 클릭한 효과를 줘버리면 안되나??? 클릭하고 들어갔다 나오면 바로 반영되어있는데?"

### 3차 문제: 간트차트 자동 로드 시 무한 루프
**시도한 해결책**:
```javascript
async function loadHomeDashboardData(projectId) {
    // 간트차트 날짜가 없으면 간트차트 먼저 로드
    if (!window.ganttMinDate || !window.ganttMaxDate) {
        await window.loadGanttChart();  // 간트차트 로드
    }
    // ...
}
```

**문제점**:
```
loadHomeDashboardData()
  → loadGanttChart()
    → (간트차트 완료 후) loadHomeDashboardData()
      → loadGanttChart()
        → (무한 루프...)
```

간트차트 핸들러가 완료 후 자동으로 `loadHomeDashboardData()`를 호출하므로 무한 루프 발생 가능.

### 4차 문제: 중복 실행 방지 플래그 오작동
**시도한 해결책**:
```javascript
let dashboardLoading = false;

async function loadHomeDashboardData(projectId, skipGanttLoad = false) {
    if (dashboardLoading) {
        return;  // 중복 실행 방지
    }
    dashboardLoading = true;

    if (!skipGanttLoad && !window.ganttMinDate) {
        await window.loadGanttChart();
        dashboardLoading = false;
        return;
    }
    // ...
}
```

**문제점**:
```
1. 홈 탭 로드 → loadHomeDashboardData(id, false) 호출
   → dashboardLoading = true
2. 간트차트 로드 시작...
3. (다른 곳에서) loadHomeDashboardData() 호출 → dashboardLoading=true이므로 스킵
4. 간트차트 로드 완료 → loadHomeDashboardData(id, true) 호출
   → dashboardLoading=true이므로 스킵!  ❌
```

간트차트 완료 후 호출(`skipGanttLoad=true`)도 플래그 때문에 스킵되어 대시보드가 업데이트되지 않음.

**로그 증거**:
```
[Dashboard] Loading dashboard data for project: "..." skipGanttLoad: false
[Dashboard] Gantt dates not available, loading gantt chart first...
[Dashboard] Loading dashboard data for project: "..." skipGanttLoad: false
[Dashboard] Already loading, skipping duplicate call
[Dashboard] Loading dashboard data for project: "..." skipGanttLoad: false
[Dashboard] Already loading, skipping duplicate call
[Gantt Chart] Rendered successfully with 4 tasks
[Gantt Chart] Triggering dashboard update after gantt load
[Dashboard] Loading dashboard data for project: "..." skipGanttLoad: true
[Dashboard] Already loading, skipping duplicate call  ❌ 문제!
```

## 최종 해결 방법

### 수정 1: async/await 문법 수정
**파일**: `connections/static/connections/home_tab_handlers.js`

```javascript
// Line 633: 함수 선언에 async 추가
async function calculateScheduleDatesFromGantt() {
    // ...
}

// Line 613: 호출 시 await 추가
const scheduleData = await calculateScheduleDatesFromGantt();
```

### 수정 2: 간트차트 자동 로드 및 skipGanttLoad 플래그
**파일**: `connections/static/connections/home_tab_handlers.js`
**위치**: Line 588-620

```javascript
// 대시보드 로드 중 플래그 (간트차트와의 무한 루프 방지)
let dashboardLoading = false;

async function loadHomeDashboardData(projectId, skipGanttLoad = false) {
    console.log('[Dashboard] Loading dashboard data for project:', projectId, 'skipGanttLoad:', skipGanttLoad);

    if (!projectId) {
        console.warn('[Dashboard] No project ID provided');
        return;
    }

    // ▼▼▼ [핵심 수정] skipGanttLoad=true인 경우는 플래그 무시 ▼▼▼
    // 이미 로딩 중이고 skipGanttLoad가 아니면 중복 실행 방지
    // skipGanttLoad=true인 경우는 간트차트 완료 후 호출이므로 실행해야 함
    if (dashboardLoading && !skipGanttLoad) {
        console.log('[Dashboard] Already loading (and not from gantt), skipping duplicate call');
        return;
    }
    // ▲▲▲ [핵심 수정] 여기까지 ▲▲▲

    dashboardLoading = true;

    try {
        // 0. 간트차트가 아직 로드되지 않았으면 먼저 로드
        if (!skipGanttLoad && (!window.ganttMinDate || !window.ganttMaxDate)) {
            console.log('[Dashboard] Gantt dates not available, loading gantt chart first...');
            if (typeof window.loadGanttChart === 'function') {
                await window.loadGanttChart();
                console.log('[Dashboard] Gantt chart loaded, now ganttMinDate and ganttMaxDate are available');
                // 간트차트 로드가 완료되면 대시보드도 다시 호출되므로 여기서는 종료
                dashboardLoading = false;
                return;
            }
        } else if (skipGanttLoad) {
            console.log('[Dashboard] Called from gantt chart completion, proceeding with dashboard update');
        }

        // 1. ActivityObjects 로드...
        // 2. 비용 데이터 로드...
        // 3. 공정 기간 계산...
        // ...
    } catch (error) {
        console.error('[Dashboard] Error loading dashboard data:', error);
        showToast('대시보드 데이터 로드 중 오류가 발생했습니다.', 'error');
    } finally {
        dashboardLoading = false;
    }
}
```

### 수정 3: 간트차트에서 대시보드 호출 시 skipGanttLoad=true 전달
**파일**: `connections/static/connections/gantt_chart_handlers.js`
**위치**: Line 249-253

```javascript
// 간트차트 로드 후 대시보드 업데이트 (홈 탭의 공정계획 카드 업데이트)
if (typeof window.loadHomeDashboardData === 'function') {
    console.log('[Gantt Chart] Triggering dashboard update after gantt load');
    window.loadHomeDashboardData(currentProjectId, true); // skipGanttLoad=true (무한 루프 방지)
}
```

## 데이터 흐름

### 최종 성공 플로우

```
1. 홈 탭 로드
   ↓
2. loadHomeDashboardData(projectId, false) 호출
   ├─ dashboardLoading = true
   └─ window.ganttMinDate 없음 확인
   ↓
3. window.loadGanttChart() 호출 (await)
   ├─ 프로젝트 캘린더 로드
   ├─ ActivityObjects 로드
   ├─ generateGanttData() 실행
   ├─ calculateTaskDates() 실행
   │  ├─ 선행관계 계산
   │  ├─ lag 적용
   │  └─ offset 전파
   ├─ window.ganttMinDate, ganttMaxDate 설정 ✓
   └─ 간트차트 렌더링
   ↓
4. [간트차트 완료 후] loadHomeDashboardData(projectId, true) 호출
   ├─ skipGanttLoad = true
   ├─ dashboardLoading = true이지만 skipGanttLoad=true이므로 통과 ✓
   └─ dashboardLoading = true (재설정)
   ↓
5. calculateScheduleDatesFromGantt() 호출
   ├─ window.ganttMinDate 확인 → 있음! ✓
   └─ 간트차트에서 계산된 정확한 날짜 사용
   ↓
6. updateDashboardUI(data)
   └─ 공정계획 카드: "2025. 11. 7. ~ 2025. 12. 30. (53일)" ✓
   ↓
7. dashboardLoading = false (finally)
```

### 중복 호출 방지 로직

```
시나리오 1: 홈 탭에서 최초 로드
  → loadHomeDashboardData(id, false)
    → dashboardLoading=false이므로 실행 ✓
    → gantt 날짜 없음 → loadGanttChart() 호출
    → (간트차트 로드 중...)

시나리오 2: 로드 중 다른 곳에서 호출 (중복)
  → loadHomeDashboardData(id, false)
    → dashboardLoading=true && skipGanttLoad=false
    → 중복 실행 방지로 스킵 ✓

시나리오 3: 간트차트 완료 후 호출
  → loadHomeDashboardData(id, true)
    → dashboardLoading=true이지만 skipGanttLoad=true
    → 플래그 체크 통과하여 실행 ✓✓✓
    → 정확한 날짜로 대시보드 업데이트
```

## 영향받는 파일

### 1. `connections/static/connections/home_tab_handlers.js`

#### 변경 1: async 함수 선언 (Line 633)
```javascript
// 기존
function calculateScheduleDatesFromGantt() {

// 수정
async function calculateScheduleDatesFromGantt() {
```

#### 변경 2: await 호출 (Line 613)
```javascript
// 기존
const scheduleData = calculateScheduleDatesFromGantt();

// 수정
const scheduleData = await calculateScheduleDatesFromGantt();
```

#### 변경 3: skipGanttLoad 파라미터 및 플래그 로직 (Line 581-620)
- `dashboardLoading` 플래그 추가
- `skipGanttLoad` 파라미터 추가
- 간트차트 자동 로드 로직 추가
- `skipGanttLoad=true`일 때 플래그 무시 로직 추가
- `finally` 블록에서 플래그 리셋

### 2. `connections/static/connections/gantt_chart_handlers.js`

#### 변경: skipGanttLoad=true 전달 (Line 252)
```javascript
// 기존
window.loadHomeDashboardData(currentProjectId);

// 수정
window.loadHomeDashboardData(currentProjectId, true); // skipGanttLoad=true (무한 루프 방지)
```

## 테스트 결과

### ✅ 성공 시나리오

**시나리오 1: 최초 홈 탭 로드**
```
1. 브라우저 접속 → 홈 탭 표시
2. 프로젝트 선택
3. 자동으로 간트차트 로드 시작
4. 간트차트 로드 완료
5. 대시보드 업데이트
6. 공정계획 카드: "2025. 11. 7. ~ 2025. 12. 30. (53일)" ✓
```

**시나리오 2: 공정계획 탭 방문 후 홈 탭**
```
1. 공정계획 탭 클릭
2. 간트차트 로드 완료
3. 홈 탭 클릭
4. 대시보드 로드 시 window.ganttMinDate 이미 있음
5. 간트차트 재로드 없이 바로 날짜 사용
6. 공정계획 카드: "2025. 11. 7. ~ 2025. 12. 30. (53일)" ✓
```

**시나리오 3: 프로젝트 전환**
```
1. 프로젝트 A 선택 → 간트차트 로드 → 대시보드 업데이트
2. 프로젝트 B 선택 → 간트차트 로드 → 대시보드 업데이트
3. 각 프로젝트별 정확한 기간 표시 ✓
```

### ✅ 중복 실행 방지 확인

**로그 분석**:
```
[Dashboard] Loading dashboard data for project: "..." skipGanttLoad: false
[Dashboard] Gantt dates not available, loading gantt chart first...
[Dashboard] Loading dashboard data for project: "..." skipGanttLoad: false
[Dashboard] Already loading (and not from gantt), skipping duplicate call  ✓ 중복 방지
[Dashboard] Loading dashboard data for project: "..." skipGanttLoad: false
[Dashboard] Already loading (and not from gantt), skipping duplicate call  ✓ 중복 방지
[Gantt Chart] Calendars loaded: 2 calendars
[Gantt Chart] Rendered successfully with 4 tasks
[Gantt Chart] Triggering dashboard update after gantt load
[Dashboard] Loading dashboard data for project: "..." skipGanttLoad: true
[Dashboard] Called from gantt chart completion, proceeding with dashboard update  ✓ 실행됨!
[Dashboard] Calculating schedule dates from gantt chart logic...
[Dashboard] Using existing gantt dates: Fri Nov 07 2025 ~ Tue Dec 30 2025
[Dashboard] Setting schedule text: "2025. 11. 7. ~ 2025. 12. 30. (53일)"  ✓✓✓
```

## 기술적 세부사항

### skipGanttLoad 플래그의 역할

1. **false (기본값)**: 일반적인 대시보드 로드
   - 간트차트 날짜가 없으면 자동으로 간트차트 로드
   - 다른 곳에서 동시 호출 시 중복 실행 방지

2. **true**: 간트차트 완료 후 호출
   - 중복 실행 방지 플래그를 무시
   - 반드시 대시보드 업데이트 실행
   - 무한 루프 방지 (간트차트를 다시 로드하지 않음)

### 플래그 상태 다이어그램

```
dashboardLoading = false
skipGanttLoad = false
  ↓ loadHomeDashboardData(id, false)
dashboardLoading = true
skipGanttLoad = false
  ↓ if (!skipGanttLoad && !ganttMinDate)
  ↓ loadGanttChart()
  ↓ (간트차트 로드 중...)
dashboardLoading = true (유지)
  ↓ (다른 곳에서 호출)
  ↓ loadHomeDashboardData(id, false)
  ↓ if (dashboardLoading && !skipGanttLoad) → return
dashboardLoading = true (유지)
  ↓ (간트차트 완료)
  ↓ loadHomeDashboardData(id, true)
  ↓ if (dashboardLoading && !skipGanttLoad) → false!
  ↓ 실행 ✓
dashboardLoading = true (재설정)
  ↓ (대시보드 업데이트 완료)
  ↓ finally
dashboardLoading = false
```

## 관련 이슈

- [93_2025-11-07_대시보드_공정계획_기간_업데이트_수정.md](./93_2025-11-07_대시보드_공정계획_기간_업데이트_수정.md) - 대시보드 공정계획 기간 계산 수정
- [92_2025-11-06_간트차트_기간_계산_수정.md](./92_2025-11-06_간트차트_기간_계산_수정.md) - 간트차트 기간 계산 로직 수정
- Gantt chart auto-loading on dashboard
- Dashboard schedule calculation
- Async/await error handling
- Duplicate execution prevention

## 교훈 및 개선사항

### 교훈

1. **async/await 문법 준수**: `await`를 사용하는 함수는 반드시 `async`로 선언해야 함
2. **플래그 기반 중복 방지의 함정**: 플래그가 의도치 않게 필요한 호출까지 막을 수 있음
3. **컨텍스트 기반 플래그 체크**: 호출 컨텍스트(skipGanttLoad)를 고려하여 플래그를 선별적으로 적용
4. **무한 루프 방지**: 상호 호출하는 함수들 사이에 명확한 종료 조건 필요

### 향후 개선사항

1. **이벤트 기반 아키텍처**: CustomEvent를 사용하여 간트차트 완료 이벤트 발행
   ```javascript
   // 간트차트 완료 시
   window.dispatchEvent(new CustomEvent('ganttChartLoaded', {
       detail: { minDate, maxDate }
   }));

   // 대시보드에서 리스닝
   window.addEventListener('ganttChartLoaded', (e) => {
       updateDashboardSchedule(e.detail.minDate, e.detail.maxDate);
   });
   ```

2. **Promise 기반 중복 실행 방지**: 플래그 대신 Promise를 캐싱
   ```javascript
   let dashboardLoadPromise = null;

   async function loadHomeDashboardData(projectId) {
       if (dashboardLoadPromise) {
           return dashboardLoadPromise;
       }

       dashboardLoadPromise = (async () => {
           // 실제 로드 로직
       })();

       try {
           return await dashboardLoadPromise;
       } finally {
           dashboardLoadPromise = null;
       }
   }
   ```

3. **디버깅 로그 제거**: 프로덕션 배포 전 디버그 로그 제거 또는 조건부 처리

4. **에러 처리 강화**: 간트차트 로드 실패 시 폴백 로직

## 작업 시간
- 날짜: 2025-11-07
- 소요 시간: 약 2시간
- 작업자: Claude Code (Anthropic)
- 이슈: async/await 문법 에러, 중복 실행 방지 플래그 오작동
