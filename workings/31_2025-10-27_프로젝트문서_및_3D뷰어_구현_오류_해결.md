# 작업 요약: 프로젝트 문서화 및 3D 뷰어 구현 완료

**작업 날짜:** 2025-10-27
**주요 목표:**
1. Claude Code를 위한 프로젝트 컨텍스트 문서 작성
2. 3D 뷰어 탭 구현 및 JavaScript 모듈 오류 해결

---

## 1. 프로젝트 문서화 (CLAUDE.md)

### 1.1 작업 내용
- **CLAUDE.md** (영문) 및 **CLAUDE_KOR.md** (한글) 파일 생성
- 프로젝트 구조, 아키텍처, 개발 규칙을 체계적으로 문서화

### 1.2 문서 구성
1. **프로젝트 개요**
   - Django 5.2+ 기반 AEC 비용 추정 웹 애플리케이션
   - Blender 및 Revit 통합 (WebSocket 통신)
   - TensorFlow/Keras를 이용한 AI 기반 비용 추정

2. **개발 환경 설정**
   - 서버 실행: `python manage.py runserver` 또는 `python run_server.py`
   - 의존성 설치: `pip install -r requirements.txt`
   - PyInstaller 빌드 명령어 (macOS/Windows)

3. **아키텍처 설명**
   - Django 앱 구조 (aibim_quantity_takeoff_web, connections)
   - 데이터베이스 모델 (UUID 기반 스키마)
   - WebSocket 통신 프로토콜 (3개 엔드포인트)
   - 프론트엔드 구조 (26개 모듈형 vanilla JS 파일)
   - 외부 통합 (Blender 애드온, Revit 애드인)

4. **개발 규칙 및 패턴**
   - Python/Django 규칙
   - JavaScript 패턴 (전역 변수, 이벤트 위임)
   - WebSocket 메시징 규칙
   - 룰셋 시스템 설명

---

## 2. JavaScript 모듈 오류 해결

### 2.1 발견된 문제들
1. **app_core.js 구문 오류**
   - 중복된 DOMContentLoaded 이벤트 리스너 (97-236줄, 443-582줄)
   - 잘못된 ES6 import 문 (IIFE 내부에서 사용)
   - IIFE 외부에 선언된 `loadDataForActiveTab()` 함수

2. **navigation.js 모듈 문제**
   - ES6 import 문으로 인한 "Cannot use import statement outside a module" 오류
   - 함수들이 전역 스코프에 노출되지 않아 다른 파일에서 접근 불가

3. **three_d_viewer.js 모듈 로딩 오류**
   - "Failed to resolve module specifier 'three'" 오류
   - ES6 모듈과 일반 스크립트 혼용으로 인한 브라우저 캐시 문제

### 2.2 해결 방법

#### app_core.js 수정
```javascript
// ❌ 제거됨: 95번째 줄의 잘못된 import
// import { initThreeDViewer } from './three_d_viewer.js';

// ❌ 제거됨: 중복된 DOMContentLoaded 블록 (443-582줄)

// ❌ 제거됨: IIFE 외부의 loadDataForActiveTab() 함수 정의
// navigation.js로 이동됨
```

#### navigation.js 수정
```javascript
// ❌ 제거됨: ES6 import
// import { initThreeDViewer } from './three_d_viewer.js';

// ✅ 모든 함수를 window 객체에 노출
window.handleMainNavClick = function handleMainNavClick(e) { ... }
window.handleSubNavClick = function handleSubNavClick(e) { ... }
window.loadDataForActiveTab = function loadDataForActiveTab() { ... }
window.loadSpecificRuleset = function loadSpecificRuleset(rulesetType) { ... }
window.clearAllTabData = function clearAllTabData() { ... }
window.clearContainer = function clearContainer(id, message) { ... }
```

#### 조건부 함수 호출
```javascript
// app_core.js에서 모듈 로드 대기
if (typeof window.setupThreeDViewerListeners === 'function') {
    window.setupThreeDViewerListeners();
} else {
    console.log("[DEBUG] setupThreeDViewerListeners not yet loaded...");
}
```

#### 브라우저 캐시 무효화
```html
<!-- HTML 헤더에 캐시 제어 메타 태그 추가 -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<!-- 스크립트 파일에 캐시 버스터 추가 -->
<script src="{% static 'connections/navigation.js' %}?v=2"></script>
<script src="{% static 'connections/three_d_viewer.js' %}?v=4"></script>
<script src="{% static 'connections/app_core.js' %}?v=2"></script>
```

---

## 3. 3D 뷰어 구현

### 3.1 Three.js 모듈 방식 변경

#### 기존 방식 (실패)
```javascript
// ES6 모듈 방식 - 브라우저 캐시 문제 및 호환성 이슈
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
```

#### 최종 방식 (성공)
```html
<!-- HTML 헤더에서 글로벌 스크립트로 로드 -->
<script src="https://cdn.jsdelivr.net/npm/three@0.140.0/build/three.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.140.0/examples/js/controls/OrbitControls.js"></script>
```

**선택 이유:**
- Three.js r140: OrbitControls를 완벽하게 지원하는 안정 버전
- 글로벌 스크립트 방식: 브라우저 호환성 및 캐시 문제 해결
- r149+에서는 글로벌 스크립트 deprecated, r160에서는 완전 제거 예정

### 3.2 three_d_viewer.js 구현

#### 주요 기능
```javascript
(function() {
    // 1. 3D 뷰어 초기화
    window.initThreeDViewer = function() {
        // Scene, Camera, Renderer, OrbitControls 초기화
        // Lighting, Grid, Axes Helper 추가
        // 애니메이션 루프 시작
    };

    // 2. 플레이스홀더 geometry 로드
    function loadPlaceholderGeometry() {
        // 녹색 큐브 생성 (테스트용)
    }

    // 3. Scene 클리어
    window.clearScene = function() {
        // 모든 Mesh 제거 및 메모리 해제
        // Essential elements (조명, 축, 그리드) 재추가
    };

    // 4. 이벤트 리스너 설정
    window.setupThreeDViewerListeners = function() {
        // Load Geometry 버튼 이벤트
        // Clear Scene 버튼 이벤트
    };

    // 5. BIM geometry 로드 (핵심 기능)
    window.loadBimGeometry = function(geometryData) {
        // BIM 데이터에서 geometry 추출
        // vertices, faces 배열로 BufferGeometry 생성
        // 각 객체에 랜덤 색상 적용
        // userData에 BIM 정보 저장
        // 카메라를 geometry 중심으로 이동
    };
})();
```

#### BIM 데이터 로드 예시
```javascript
// raw_data에 geometry 속성이 있는 객체 필터링
const geometryObjects = window.allRevitData
    .filter(obj => obj.raw_data && obj.raw_data.geometry)
    .map(obj => ({
        id: obj.id,
        geometry: obj.raw_data.geometry  // { vertices: [...], faces: [...] }
    }));

// 3D 뷰어에 로드
window.loadBimGeometry(geometryObjects);
```

### 3.3 CSS 스타일 추가

```css
/* 3D Viewer 컨테이너 */
.three-d-viewer-container {
    position: relative;
    width: 100%;
    height: 100%;
    min-height: 600px;
    background-color: #cccccc;
}

/* Canvas */
#three-d-canvas {
    width: 100%;
    height: 100%;
    display: block;
}

/* 컨트롤 버튼 */
.viewer-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 10px;
    z-index: 10;
}

.viewer-controls button {
    padding: 10px 15px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
```

---

## 4. 파일 변경 사항 요약

### 생성된 파일
- `CLAUDE.md` - 프로젝트 컨텍스트 문서 (영문)
- `CLAUDE_KOR.md` - 프로젝트 컨텍스트 문서 (한글)

### 수정된 파일
1. **connections/static/connections/app_core.js**
   - 중복 코드 제거
   - import 문 제거
   - 조건부 함수 호출 추가

2. **connections/static/connections/navigation.js**
   - ES6 import 제거
   - 모든 함수를 window 객체에 노출
   - loadDataForActiveTab() 함수 이동

3. **connections/static/connections/three_d_viewer.js**
   - 완전히 재작성 (ES6 모듈 → 글로벌 스크립트)
   - BIM geometry 로드 기능 구현
   - OrbitControls 통합

4. **connections/templates/revit_control.html**
   - Three.js CDN 추가 (r140)
   - 캐시 제어 메타 태그 추가
   - 스크립트 캐시 버스터 추가 (?v=2, ?v=3, ?v=4)

5. **connections/static/connections/style.css**
   - 3D 뷰어 스타일 추가 (약 50줄)

---

## 5. 테스트 결과

### 성공적으로 해결된 문제
✅ "Cannot use import statement outside a module" 오류 해결
✅ "Failed to resolve module specifier 'three'" 오류 해결
✅ "handleMainNavClick is not defined" 오류 해결
✅ "setupThreeDViewerListeners is not defined" 오류 해결
✅ "THREE.OrbitControls is not a constructor" 오류 해결

### 3D 뷰어 기능 테스트
✅ 3D 뷰어 탭 활성화 시 초기화 성공
✅ 축(X,Y,Z) 및 그리드 표시
✅ 마우스 드래그로 회전 (OrbitControls)
✅ 마우스 휠로 줌 인/아웃
✅ "Load Geometry" 버튼: 녹색 큐브 생성
✅ "Clear Scene" 버튼: geometry 제거

### 향후 작업
- BIM 데이터의 geometry 속성 구조 확인 필요
- geometry 데이터를 가진 실제 BIM 객체로 테스트
- 데이터 관리 탭에 "3D로 보기" 버튼 추가 고려
- 선택된 객체만 3D 뷰어에 표시하는 기능 추가 고려

---

## 6. 학습 내용

### JavaScript 모듈 시스템
- ES6 모듈 vs 글로벌 스크립트의 차이점
- 브라우저 호환성 및 캐시 문제
- type="module"과 일반 script의 실행 순서 차이

### Three.js 버전 관리
- r140: 글로벌 스크립트 지원
- r150+: 글로벌 스크립트 deprecated
- r160+: ES6 모듈만 지원

### 브라우저 캐시 전략
- 메타 태그를 통한 캐시 제어
- 쿼리 파라미터를 이용한 캐시 버스터
- 강력 새로고침 (Ctrl+Shift+R)

---

**작업 완료 상태:** ✅ 성공
**다음 단계:** BIM geometry 데이터 구조 확인 및 실제 데이터 로드 테스트
