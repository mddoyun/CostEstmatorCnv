# 55. 코스트아이템 액티비티별 뷰 그룹핑 수정

**날짜**: 2025-11-04
**작업자**: Claude Code
**관련 이슈**: 액티비티별 뷰와 코스트아이템 뷰 간 전환 및 그룹핑 문제

## 작업 개요

코스트아이템 탭에서 액티비티별 뷰와 코스트아이템 뷰를 전환할 때 발생하는 두 가지 그룹핑 관련 버그를 수정했습니다:

1. **뷰 전환 시 그룹핑 값 잔존**: 액티비티별 뷰 → 코스트아이템 뷰 전환 시 `Activity.code` 값이 "값없음"으로 표시되는 문제
2. **그룹 토글 시 데이터 손실**: 액티비티별 뷰에서 그룹 헤더 클릭 시 `Activity.code: 값없음`으로 데이터가 변경되는 문제

## 문제 분석

### 1. 뷰 전환 시 그룹핑 값 잔존 문제

**증상**:
- 액티비티별 뷰에서 작업 후 코스트아이템 뷰로 전환
- 그룹핑이 `Activity.code`로 자동 적용됨
- 테이블에 "Activity.code: 값없음 (2개)" 같은 그룹이 표시됨

**원인 분석**:
```javascript
// handleCiViewTabClick() 함수 내부
if (viewType === 'cost-item-view') {
    window.ciGroupingLevels = []; // ← 내부 상태는 초기화됨
    console.log('[DEBUG] window.ciGroupingLevels reset to:', window.ciGroupingLevels);
    renderCostItemsTable(window.loadedCostItems);
}
```

**문제점**:
1. `window.ciGroupingLevels` 배열은 빈 배열로 초기화됨 ✅
2. 그러나 DOM의 그룹핑 컨트롤(`<select class="group-by-select">`)의 `value`는 그대로 "Activity.code" 유지됨 ❌
3. `applyGrouping()` 호출 시 DOM에서 select 값을 다시 읽어옴:
```javascript
function applyGrouping() {
    const selects = document.querySelectorAll('.group-by-select');
    window.ciGroupingLevels = Array.from(selects)
        .map(s => s.value)
        .filter(v => v); // ← DOM의 "Activity.code" 값이 다시 읽혀짐
}
```
4. 결과: `window.ciGroupingLevels = ["Activity.code"]`로 재설정됨 ❌

**데이터 흐름**:
```
1. 액티비티별 뷰 활성화
   → ciGroupingLevels = ['Activity.code', ...] 설정
   → DOM select.value = 'Activity.code'

2. 코스트아이템 뷰로 전환
   → ciGroupingLevels = [] 초기화 ✅
   → DOM select.value = 'Activity.code' 그대로 ❌

3. 테이블 렌더링 중 applyGrouping() 호출
   → DOM에서 select.value 읽기
   → ciGroupingLevels = ['Activity.code'] 재설정 ❌

4. loadedCostItems에는 Activity.code 필드 없음
   → Activity.code: undefined로 그룹핑
   → "Activity.code: 값없음" 표시
```

### 2. 그룹 토글 시 데이터 손실 문제

**증상**:
- 액티비티별 뷰에서 "Activity.code: ㅇㅇ (2개)" 같은 그룹 헤더 클릭
- 갑자기 "Activity.code: 값없음 (2개)"으로 변경됨
- 확장된 데이터가 원본 데이터로 되돌아감

**원인 분석**:
```javascript
// handleCostItemActions() 함수 내부
if (groupHeader && /* ... */) {
    const groupPath = groupHeader.dataset.groupPath;
    ciCollapsedGroups[groupPath] = !ciCollapsedGroups[groupPath];
    renderCostItemsTable(window.loadedCostItems); // ← 문제: 원본 데이터 사용
    return;
}
```

**문제점**:
1. 액티비티별 뷰는 `expandedItems`를 사용하여 렌더링됨:
```javascript
// renderCostItemsByActivityView() 내부
const expandedItems = [];
activities.forEach(activity => {
    costItems.forEach(ci => {
        if (ci.activity_object?.activity?.id === activity.id) {
            expandedItems.push({
                ...ci,
                'Activity.code': activity.code, // ← 확장된 필드 추가
                'Activity.name': activity.name,
                // ...
            });
        }
    });
});
renderCostItemsTable(expandedItems); // ← 확장 데이터로 렌더링
```

2. 그룹 토글 핸들러는 항상 `window.loadedCostItems` 사용:
```javascript
// window.loadedCostItems는 원본 데이터 (Activity.code 필드 없음)
renderCostItemsTable(window.loadedCostItems); // ← Activity.code: undefined
```

3. 결과: 확장 필드가 사라지고 "Activity.code: 값없음"으로 표시됨 ❌

**데이터 구조 비교**:
```javascript
// window.loadedCostItems (원본)
[
    {
        id: "uuid1",
        name: "코스트아이템1",
        activity_object: {
            id: "ao-uuid",
            activity: {
                id: "act-uuid",
                code: "ㅇㅇ",
                name: "액티비티1"
            }
        }
        // Activity.code 필드 없음 ❌
    }
]

// expandedItems (확장 데이터)
[
    {
        id: "uuid1",
        name: "코스트아이템1",
        activity_object: { ... },
        'Activity.code': "ㅇㅇ", // ← 확장 필드 ✅
        'Activity.name': "액티비티1",
        'Activity.start_date': "2025-11-01",
        // ...
    }
]
```

## 수정 내용

### 1. JavaScript: handleCiViewTabClick() 함수 수정

**파일**: `connections/static/connections/cost_item_manager.js`

**변경 위치**: Line 2961-2970

**변경사항**:
```javascript
// BEFORE: 내부 상태만 초기화
if (viewType === 'cost-item-view') {
    window.ciGroupingLevels = [];
    console.log('[DEBUG] window.ciGroupingLevels reset to:', window.ciGroupingLevels);
    renderCostItemsTable(window.loadedCostItems);
}

// AFTER: DOM 컨트롤도 함께 초기화
if (viewType === 'cost-item-view') {
    window.ciGroupingLevels = [];
    console.log('[DEBUG] window.ciGroupingLevels reset to:', window.ciGroupingLevels);

    // ▼▼▼ [추가] DOM 그룹핑 컨트롤도 초기화 ▼▼▼
    const groupingControls = document.querySelectorAll('#ci-grouping-controls .group-by-select');
    groupingControls.forEach(select => {
        select.value = '';
    });
    console.log('[DEBUG] DOM grouping controls cleared:', groupingControls.length, 'selects');
    // ▲▲▲

    console.log('[DEBUG] Rendering with loadedCostItems count:', window.loadedCostItems.length);
    renderCostItemsTable(window.loadedCostItems);
}
```

**효과**:
- 내부 상태(`window.ciGroupingLevels`)와 DOM 상태(select 값)가 동기화됨
- 뷰 전환 후 `applyGrouping()`이 호출되어도 빈 배열 유지
- "Activity.code: 값없음" 문제 해결

### 2. JavaScript: renderCostItemsByActivityView() 함수 수정

**파일**: `connections/static/connections/cost_item_manager.js`

**변경 위치**: Line 3054-3059

**변경사항**:
```javascript
// BEFORE: 확장 데이터를 로컬에서만 사용
function renderCostItemsByActivityView() {
    // ...
    const expandedItems = [];
    // 데이터 확장 로직...

    window.ciGroupingLevels = ['Activity.code', ...userGroupingLevels];
    renderCostItemsTable(expandedItems); // ← 확장 데이터 사용
    // 그러나 expandedItems는 함수 종료 후 소멸됨 ❌
}

// AFTER: 확장 데이터를 글로벌 변수에 저장
function renderCostItemsByActivityView() {
    // ...
    const expandedItems = [];
    // 데이터 확장 로직...

    window.ciGroupingLevels = ['Activity.code', ...userGroupingLevels];

    // ▼▼▼ [추가] 확장된 데이터를 글로벌 변수에 저장 ▼▼▼
    window.expandedCostItemsForActivityView = expandedItems;
    console.log('[DEBUG] Saved expandedItems to window.expandedCostItemsForActivityView');
    // ▲▲▲

    renderCostItemsTable(expandedItems);
}
```

**효과**:
- 확장 데이터가 `window.expandedCostItemsForActivityView`에 저장됨
- 그룹 토글 핸들러에서 재사용 가능
- 데이터 확장 작업을 반복하지 않아 성능 향상

### 3. JavaScript: handleCostItemActions() 함수 수정

**파일**: `connections/static/connections/cost_item_manager.js`

**변경 위치**: Line 281-292

**변경사항**:
```javascript
// BEFORE: 항상 원본 데이터 사용
if (groupHeader && /* ... */) {
    const groupPath = groupHeader.dataset.groupPath;
    ciCollapsedGroups[groupPath] = !ciCollapsedGroups[groupPath];
    renderCostItemsTable(window.loadedCostItems); // ← 원본 데이터
    return;
}

// AFTER: 뷰 타입에 따라 적절한 데이터 사용
if (groupHeader && /* ... */) {
    const groupPath = groupHeader.dataset.groupPath;
    ciCollapsedGroups[groupPath] = !ciCollapsedGroups[groupPath];

    // ▼▼▼ [수정] 액티비티별 뷰일 때는 확장된 데이터 사용 ▼▼▼
    if (window.activeCiView === 'activity-view' && window.expandedCostItemsForActivityView) {
        console.log('[DEBUG] Using expandedCostItemsForActivityView for group toggle');
        renderCostItemsTable(window.expandedCostItemsForActivityView);
    } else {
        renderCostItemsTable(window.loadedCostItems);
    }
    // ▲▲▲

    return;
}
```

**효과**:
- 액티비티별 뷰에서는 확장 데이터 유지
- 코스트아이템 뷰에서는 원본 데이터 사용
- 그룹 접기/펼치기 시 데이터 손실 없음

## 테스트 시나리오

### 1. 뷰 전환 테스트

**테스트 절차**:
1. 코스트아이템 탭 클릭
2. "액티비티별 뷰" 서브탭 클릭
3. 테이블에서 "Activity.code: ㅇㅇ (2개)" 같은 그룹 확인
4. "코스트아이템 뷰" 서브탭 클릭

**예상 결과** ✅:
- 테이블이 원본 코스트아이템 데이터로 표시됨
- 그룹핑이 초기 상태로 리셋됨 (그룹핑 없음 또는 기본 그룹핑)
- "Activity.code: 값없음" 같은 잘못된 그룹이 표시되지 않음
- 콘솔 로그: `DOM grouping controls cleared: N selects` 출력

### 2. 그룹 토글 테스트 (액티비티별 뷰)

**테스트 절차**:
1. "액티비티별 뷰" 서브탭 클릭
2. 테이블에서 "Activity.code: ㅇㅇ (2개)" 그룹 헤더 클릭 (펼치기/접기)
3. 그룹 헤더의 텍스트 확인

**예상 결과** ✅:
- 그룹이 펼쳐지거나 접힘 (토글 동작)
- 그룹 헤더가 "Activity.code: ㅇㅇ (2개)"로 유지됨
- "Activity.code: 값없음"으로 변경되지 않음
- 콘솔 로그: `Using expandedCostItemsForActivityView for group toggle` 출력

### 3. 그룹 토글 테스트 (코스트아이템 뷰)

**테스트 절차**:
1. "코스트아이템 뷰" 서브탭 클릭
2. 그룹핑 적용 (예: "name"으로 그룹핑)
3. 그룹 헤더 클릭 (펼치기/접기)

**예상 결과** ✅:
- 그룹이 정상적으로 토글됨
- 원본 데이터 기반으로 그룹핑 유지
- `window.loadedCostItems` 사용 (확장 데이터 불필요)

### 4. 복합 시나리오 테스트

**테스트 절차**:
1. 액티비티별 뷰 → 그룹 토글 → 코스트아이템 뷰 → 다시 액티비티별 뷰
2. 각 단계마다 그룹핑 상태 확인

**예상 결과** ✅:
- 각 뷰가 독립적인 그룹핑 상태 유지
- 뷰 전환 시 적절한 데이터로 리렌더링
- 데이터 손실이나 오염 없음

## 영향 범위

### 수정된 파일
1. `connections/static/connections/cost_item_manager.js`
   - `handleCiViewTabClick()` 함수 (line 2961-2970)
   - `renderCostItemsByActivityView()` 함수 (line 3054-3059)
   - `handleCostItemActions()` 함수 (line 281-292)

### 영향받는 기능
- ✅ 코스트아이템 뷰 ↔ 액티비티별 뷰 전환
- ✅ 액티비티별 뷰 그룹핑
- ✅ 그룹 접기/펼치기 (토글)
- ✅ 코스트아이템 테이블 렌더링

### 호환성
- 기존 코스트아이템 CRUD 기능: 영향 없음
- 필터링 기능: 영향 없음
- 다른 그룹핑 옵션: 영향 없음
- 단가 연동 기능: 영향 없음

## 기술적 세부사항

### 글로벌 상태 관리

```javascript
// 뷰 타입 추적
window.activeCiView = 'cost-item-view' | 'activity-view' | 'tree-view';

// 그룹핑 레벨
window.ciGroupingLevels = ['Activity.code', 'classification_tag', ...];

// 확장 데이터 (액티비티별 뷰 전용)
window.expandedCostItemsForActivityView = [
    {
        ...costItem,
        'Activity.code': '...',
        'Activity.name': '...',
        // ...
    }
];

// 원본 데이터
window.loadedCostItems = [
    {
        id: '...',
        name: '...',
        activity_object: { activity: { code: '...', name: '...' } }
    }
];
```

### 데이터 확장 패턴

```javascript
// 1단계: 액티비티 목록 추출
const activityIds = new Set();
costItems.forEach(ci => {
    if (ci.activity_object?.activity?.id) {
        activityIds.add(ci.activity_object.activity.id);
    }
});

// 2단계: 액티비티 정보 가져오기
const activities = Array.from(activityIds).map(id => {
    const ci = costItems.find(c => c.activity_object?.activity?.id === id);
    return ci.activity_object.activity;
});

// 3단계: 데이터 확장
const expandedItems = [];
activities.forEach(activity => {
    costItems.forEach(ci => {
        if (ci.activity_object?.activity?.id === activity.id) {
            expandedItems.push({
                ...ci,
                'Activity.code': activity.code,
                'Activity.name': activity.name,
                'Activity.start_date': activity.start_date,
                'Activity.end_date': activity.end_date,
                'Activity.duration': activity.duration,
                'Activity.progress': activity.progress,
            });
        }
    });
});

// 4단계: 글로벌 저장 (그룹 토글 시 재사용)
window.expandedCostItemsForActivityView = expandedItems;
```

### DOM과 상태 동기화 패턴

```javascript
// Anti-pattern (수정 전)
function resetGrouping() {
    window.ciGroupingLevels = []; // ← 내부 상태만 변경
    // DOM은 그대로 유지됨 ❌
}

// Best practice (수정 후)
function resetGrouping() {
    // 1. 내부 상태 초기화
    window.ciGroupingLevels = [];

    // 2. DOM도 함께 초기화
    const selects = document.querySelectorAll('.group-by-select');
    selects.forEach(select => {
        select.value = '';
    });

    // 3. 내부 상태 ↔ DOM 완전 동기화 ✅
}
```

## 관련 커밋

- 이전 작업: 54_2025-11-04_액티비티객체_삭제_UI_업데이트_수정.md
- 관련 기능: 코스트아이템 관리, 액티비티 연동, 테이블 그룹핑

## 추가 개선 사항 제안

1. **뷰별 상태 관리 객체화**: 각 뷰의 상태를 객체로 관리하여 더 명확한 분리
```javascript
const ciViewStates = {
    'cost-item-view': {
        data: window.loadedCostItems,
        grouping: [],
        collapsed: {}
    },
    'activity-view': {
        data: window.expandedCostItemsForActivityView,
        grouping: ['Activity.code', ...],
        collapsed: {}
    }
};
```

2. **데이터 확장 캐싱**: 액티비티 데이터가 변경되지 않았으면 확장 작업 스킵

3. **뷰 전환 애니메이션**: 부드러운 전환 효과로 UX 개선

4. **그룹핑 프리셋**: 자주 사용하는 그룹핑 조합을 프리셋으로 저장

## 참고 사항

- 이 수정으로 코스트아이템 탭의 뷰 전환과 그룹핑 기능이 안정화되었습니다
- 액티비티별 뷰는 원본 데이터를 변경하지 않고 확장된 복사본을 사용합니다
- DOM 상태와 내부 상태를 동기화하는 패턴은 다른 모듈에도 적용 가능합니다
- 디버그 로그는 향후 제거하거나 조건부로 활성화할 수 있습니다
