# 2025-11-04: 필드명 표준화 - BIM., QM., MM. 접두어 통일

## 작업 개요

상세견적(DD)과 개산견적(SD) 탭의 필드명을 코스트아이템 탭에서 사용하는 접두어 형식과 동일하게 표준화했습니다.
모든 탭에서 `BIM.`, `QM.`, `MM.` 접두어를 일관되게 사용하도록 통일했습니다.

## 변경 사항

### 1. 백엔드 API 수정 (`connections/views.py`)

**파일**: `connections/views.py`
**함수**: `get_boq_grouping_fields_api` (lines 2395-2469)

**변경 내용**:
- 기존: 한글 설명 형식 (예: "부재속성 - 체적", "일람부호 속성 - 주철근종류", "BIM원본 - Category")
- 변경: 접두어 형식 (예: "QM.properties.체적", "MM.properties.주철근종류", "BIM.Attributes.Category")

**구체적 변경**:

1. **QuantityMember 필드**:
   ```python
   # 이전
   add_field('quantity_member__name', '산출부재 - 이름')
   add_field('quantity_member__classification_tag__name', '산출부재 - 수량산출분류')

   # 변경 후
   add_field('quantity_member__name', 'QM.name')
   add_field('quantity_member__classification_tag__name', 'QM.classification_tag')
   ```

2. **QuantityMember properties**:
   ```python
   # 이전
   add_field(f'quantity_member__properties__{key}', f'부재속성 - {key}')

   # 변경 후
   add_field(f'quantity_member__properties__{key}', f'QM.properties.{key}')
   ```

3. **MemberMark 필드**:
   ```python
   # 이전
   add_field('quantity_member__member_mark__mark', '일람부호 - 부호명')
   add_field(f'quantity_member__member_mark__properties__{key}', f'일람부호 속성 - {key}')

   # 변경 후
   add_field('quantity_member__member_mark__mark', 'MM.mark')
   add_field(f'quantity_member__member_mark__properties__{key}', f'MM.properties.{key}')
   ```

4. **BIM 원본 데이터** (구조화):
   - 이전: 3가지 레벨을 "BIM원본", "BIM원본 (타입)", "BIM원본 (인스턴스)"로 구분
   - 변경 후: `BIM.Attributes.*`, `BIM.Parameters.*`, `BIM.TypeParameters.*`로 명확히 구분

   ```python
   # 이전 코드
   source_map = {
       'BIM원본': raw_data,
       'BIM원본 (타입)': raw_data.get('TypeParameters', {}),
       'BIM원본 (인스턴스)': raw_data.get('Parameters', {})
   }

   # 변경 후 코드
   # BIM.Attributes.* - 기본 속성
   basic_attrs = ['Category', 'Family', 'Type', 'Level', 'Name']
   for attr in basic_attrs:
       if attr in raw_data and not isinstance(raw_data[attr], (dict, list)):
           add_field(f'quantity_member__raw_element__raw_data__{attr}', f'BIM.Attributes.{attr}')

   # BIM.Parameters.* - 인스턴스 파라미터
   if 'Parameters' in raw_data and isinstance(raw_data['Parameters'], dict):
       for key in raw_data['Parameters'].keys():
           if key != 'Geometry' and not isinstance(raw_data['Parameters'][key], (dict, list)):
               add_field(f'quantity_member__raw_element__raw_data__Parameters__{key}', f'BIM.Parameters.{key}')

   # BIM.TypeParameters.* - 타입 파라미터
   if 'TypeParameters' in raw_data and isinstance(raw_data['TypeParameters'], dict):
       for key in raw_data['TypeParameters'].keys():
           if not isinstance(raw_data['TypeParameters'][key], (dict, list)):
               add_field(f'quantity_member__raw_element__raw_data__TypeParameters__{key}', f'BIM.TypeParameters.{key}')
   ```

### 2. 프론트엔드 자동 적용

**영향을 받는 탭**:
- **상세견적(DD)** 탭
  - 필드 선택 체크박스 (`boq-display-fields-container`)
  - 그룹핑 드롭다운 (`.boq-group-by-select`)
- **개산견적(SD)** 탭
  - 그룹핑 드롭다운 (`.sd-group-by-select`)

**자동 적용 원리**:
- 두 탭 모두 `availableBoqFields` 전역 배열을 공유
- `loadBoqGroupingFields()` 함수가 `/connections/api/boq/grouping-fields/{project_id}/` API를 호출하여 필드 목록 가져옴
- 백엔드 API가 변경된 형식으로 반환하므로 프론트엔드는 자동으로 새 형식 사용

**관련 함수**:
1. `loadBoqGroupingFields()` - BOQ 필드 목록 로드 (boq_detailed_estimation_handlers.js:56)
2. `renderBoqDisplayFieldControls(fields)` - DD 필드 선택 체크박스 렌더링 (boq_detailed_estimation_handlers.js:1568)
3. `addBoqGroupingLevel()` - DD 그룹핑 레벨 추가 (boq_detailed_estimation_handlers.js:110)
4. `addSdGroupingLevel()` - SD 그룹핑 레벨 추가 (schematic_estimation_handlers.js:748)

## 필드명 형식 통일

### 코스트아이템 (CI) 필드
- 형식: `CI.{field_name}`
- 예시: `CI.id`, `CI.description`, `CI.quantity`

### 수량산출부재 (QM) 필드
- 기본 필드: `QM.{field_name}`
  - 예시: `QM.id`, `QM.name`, `QM.classification_tag`
- 속성 필드: `QM.properties.{property_name}`
  - 예시: `QM.properties.체적`, `QM.properties.길이`

### 일람부호 (MM) 필드
- 기본 필드: `MM.mark`
- 속성 필드: `MM.properties.{property_name}`
  - 예시: `MM.properties.주철근종류`, `MM.properties.주철근간격`

### BIM 원본 데이터 필드
- 기본 속성: `BIM.Attributes.{attribute_name}`
  - 예시: `BIM.Attributes.Category`, `BIM.Attributes.Family`, `BIM.Attributes.Type`
- 인스턴스 파라미터: `BIM.Parameters.{parameter_name}`
  - 예시: `BIM.Parameters.면적`, `BIM.Parameters.체적`
- 타입 파라미터: `BIM.TypeParameters.{parameter_name}`
  - 예시: `BIM.TypeParameters.두께`, `BIM.TypeParameters.재질`
- 시스템 속성: `BIM.System.{system_property}`
  - 예시: `BIM.System.id`, `BIM.System.element_unique_id`, `BIM.System.geometry_volume`

## 장점

1. **일관성**: 모든 탭에서 동일한 필드명 형식 사용
2. **명확성**: 접두어로 데이터 출처 즉시 파악 가능
3. **유지보수**: 한 곳에서 필드명 형식 관리 (백엔드 API)
4. **확장성**: 새로운 필드 추가 시 명확한 네이밍 규칙 존재

## 테스트 방법

1. 프로젝트 선택
2. **상세견적(DD)** 탭으로 이동
   - 좌측 패널 "필드 선택" 탭 확인
   - 체크박스 레이블이 `QM.properties.*`, `MM.properties.*`, `BIM.Attributes.*` 등으로 표시되는지 확인
   - 그룹핑 추가 버튼 클릭 후 드롭다운 옵션 확인
3. **개산견적(SD)** 탭으로 이동
   - 그룹핑 추가 버튼 클릭 후 드롭다운 옵션 확인
4. **작업** 탭 > **코스트아이템** 탭으로 이동
   - 좌측 하단 "필드 선택" 탭에서 동일한 접두어 형식 사용 확인

## 관련 파일

- `connections/views.py`: 백엔드 API 수정 (lines 2395-2469)
- `connections/static/connections/boq_detailed_estimation_handlers.js`: DD 탭 로직
- `connections/static/connections/schematic_estimation_handlers.js`: SD 탭 로직
- `connections/static/connections/cost_item_manager.js`: 코스트아이템 탭 필드명 참조 (접두어 형식 원본)

## 주의사항

- 기존에 저장된 그룹핑 설정은 내부 `value` 값으로 저장되므로 영향 없음
- 사용자에게 보이는 `label`만 변경되어 기존 데이터 호환성 유지
- 백엔드 API에서 반환하는 `value` 필드는 그대로 유지 (예: `quantity_member__properties__체적`)
- `label` 필드만 사용자 친화적인 접두어 형식으로 변경
