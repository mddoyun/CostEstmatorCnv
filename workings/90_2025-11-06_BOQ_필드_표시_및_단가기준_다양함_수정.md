# 2025-11-06: BOQ 집계표 필드 표시 및 단가기준 "다양함" 수정

## 작업 개요
상세견적(BOQ) 탭의 집계표에서 필드 값이 표시되지 않는 문제와 그룹핑 레벨별 단가기준 "다양함" 표시 문제를 해결했습니다.

## 문제 상황

### 1. 집계표 필드 값 미표시
- **증상**: 필드 선택(필드선택)에서 BIM 속성을 선택해도 집계표에 값이 표시되지 않음
- **원인**:
  - 클라이언트와 서버 간 필드 이름 변환 불일치
  - 컬럼 ID와 `display_values` 키 매칭 실패

### 2. BIM 속성 필드 그룹핑 불가
- **증상**: `BIM.Attributes.IfcClass`로 그룹핑은 되지만 다른 필드는 그룹핑 안 됨
- **원인**:
  - 서버의 `get_value_from_path` 함수가 `Attributes.*`, `QuantitySet.*` prefix를 처리하지 못함
  - raw_data에 `Attributes.Name`, `QuantitySet.XXX` 형식으로 저장되어 있으나 읽기 로직 누락

### 3. 마지막 그룹 레벨 단가기준 "다양함" 미표시
- **증상**: 3단계 그룹핑 시 1~2단계는 "다양함" 표시되나 3단계(마지막)는 표시 안 됨
- **원인**:
  - 서버는 `unit_price_type_id = 'various'` 반환
  - 클라이언트는 `value="diverse"` 사용
  - 값 불일치로 인한 옵션 선택 실패

## 수정 내용

### 1. 필드 값 표시 수정 (`boq_detailed_estimation_handlers.js`)

#### 컬럼 ID 변환 로직 수정 (line 1623-1636)
```javascript
// 기존: cb.value.replace(/__/g, "_")
// 문제: 클라이언트 형식(BIM.XXX)을 그대로 사용

// 수정: 서버 형식으로 변환 후 프론트엔드 키 형식으로 변환
const serverFormat = convertClientFieldToServerFormat(originalValue);
const frontendKey = serverFormat.replace(/__/g, "_");
```

**예시:**
- 입력: `BIM.QuantitySet.Qto_WallBaseQuantities__Length`
- 서버 형식: `quantity_member__raw_element__raw_data__QuantitySet__Qto_WallBaseQuantities__Length`
- 프론트엔드 키: `quantity_member_raw_element_raw_data_QuantitySet_Qto_WallBaseQuantities__Length`

#### BIM.Attributes 필드 변환 수정 (line 42-46)
```javascript
// 기존: quantity_member__raw_element__raw_data__${attrName}
// 수정: quantity_member__raw_element__raw_data__Attributes__${attrName}
```

raw_data에 `Attributes.Name` 형식으로 저장되어 있으므로 중간에 `Attributes__` 추가

### 2. 서버 측 필드 읽기 로직 수정 (`views.py`)

#### Attributes, QuantitySet 처리 추가 (line 2847-2855)
```python
# Attributes, QuantitySet는 raw_data에 "Prefix.Key" 형식으로 저장됨
if first_key in ('Attributes', 'QuantitySet') and len(key_path) > 1:
    # "Prefix.Key" 형식으로 키 조회
    suffix = '__'.join(key_path[1:])
    full_key = f"{first_key}.{suffix}"
    return raw_data_dict.get(full_key)
```

**처리 예시:**
- 경로: `['Attributes', 'IfcClass']` → 키: `Attributes.IfcClass`
- 경로: `['QuantitySet', 'Qto_WallBaseQuantities', 'Length']` → 키: `QuantitySet.Qto_WallBaseQuantities__Length`

### 3. 단가기준 "다양함" 표시 수정

#### 서버-클라이언트 값 통일 (line 2212, 2301-2308, 517)
```javascript
// 1. 드롭다운 옵션 값 수정
// 기존: <option value="diverse">다양함</option>
// 수정: <option value="various">다양함</option>

// 2. 그룹 행 처리 간소화
// 기존: loadedDdCostItems에서 수동 계산
// 수정: 서버가 계산한 item.unit_price_type_id 직접 사용
let selectedValue = item.unit_price_type_id || "";

// 3. "다양함" 선택 방지 로직 수정
// 기존: if (newTypeId === "diverse")
// 수정: if (newTypeId === "various")
```

## 영향받는 파일

### 클라이언트
- `connections/static/connections/boq_detailed_estimation_handlers.js`
  - Line 42-46: BIM.Attributes 필드 변환 수정
  - Line 517: "다양함" 선택 방지 값 수정
  - Line 1623-1636: 컬럼 ID 변환 로직 수정
  - Line 2094-2105: renderBoqTable 내 동일 로직 수정
  - Line 2212: "다양함" 옵션 value 수정
  - Line 2301-2308: 그룹 행 단가기준 처리 간소화

### 서버
- `connections/views.py`
  - Line 2847-2855: Attributes, QuantitySet 필드 읽기 로직 추가
  - Line 3030-3041: 필드 변환 디버깅 로그 추가

## 디버깅 로그 추가

### 클라이언트
```javascript
// 필드 변환 로그
console.log(`[DEBUG] Field conversion: "${field}" → "${converted}"`);

// 샘플 데이터 로그
console.log('[DEBUG] Sample report item:', data.report[0]);
console.log('[DEBUG] Sample display_values keys:', Object.keys(data.report[0].display_values));

// 단가기준 로그
console.log(`[DEBUG][Unit Price] Group row unit_price_type_id: "${selectedValue}"`);
```

### 서버
```python
# BIM 필드 변환 로그
if field.startswith('quantity_member__raw_element__raw_data'):
    print(f"[DEBUG] Field conversion: {field} -> {frontend_key}, value: {value}")
```

## 테스트 결과

### 필드 표시 기능
✅ `BIM.Attributes.Name` - 그룹핑/표시 정상 작동
✅ `BIM.Attributes.IfcClass` - 그룹핑/표시 정상 작동
✅ `BIM.QuantitySet.Qto_WallBaseQuantities__Length` - 그룹핑/표시 정상 작동
✅ `BIM.Parameters.XXX` - 기존 기능 유지
✅ `BIM.TypeParameters.XXX` - 기존 기능 유지

### 단가기준 "다양함" 표시
✅ 1단계 그룹: 하위 항목 단가기준 다르면 "다양함" 표시
✅ 2단계 그룹: 하위 항목 단가기준 다르면 "다양함" 표시
✅ 3단계 그룹 (마지막): 하위 항목 단가기준 다르면 "다양함" 표시
✅ 사용자가 "다양함" 선택 시도 시 경고 메시지 표시

## 기술적 세부사항

### Property Inheritance Chain
```
RawElement (BIM)
  ↓ raw_data 구조
  {
    "Name": "...",           // 직접 접근
    "Attributes.Name": "...", // Prefix.Key 형식
    "QuantitySet.Qto_XXX__YYY": "...",
    "Parameters": { ... },    // Dict 형식
    "TypeParameters": { ... }
  }
  ↓
QuantityMember (QM)
  ↓
CostItem (CI)
```

### 필드 변환 파이프라인
```
클라이언트 UI 필드
  ↓ convertClientFieldToServerFormat()
Django ORM 필드 경로 (double underscore)
  ↓ get_value_from_path()
실제 값 추출
  ↓ field.replace('__', '_')
프론트엔드 키 (single underscore)
  ↓ display_values[key]
테이블 렌더링
```

## 향후 개선 사항

1. **디버깅 로그 정리**: 프로덕션 배포 전 디버그 로그 제거 또는 조건부 처리
2. **에러 처리 강화**: 필드 변환 실패 시 명확한 에러 메시지
3. **성능 최적화**: 대량 데이터 처리 시 필드 변환 캐싱 고려
4. **테스트 자동화**: 필드 변환 로직에 대한 단위 테스트 추가

## 관련 이슈

- Property inheritance system (CLAUDE.md 참조)
- Field selection and display system
- BOQ grouping and aggregation
- Unit price type management

## 작업 시간
- 날짜: 2025-11-06
- 소요 시간: 약 2시간
- 작업자: Claude Code (Anthropic)
