# 2025-11-04: DD 탭 스플릿바 및 우측 패널 토글 구현

## 작업 개요

상세견적(DD) 탭에 좌측-중간, 중간-우측 영역 사이에 드래그 가능한 스플릿바를 추가하고, 우측 패널 접기/펴기 기능을 구현했습니다.

## 요구사항

1. **좌측-중간 스플릿바**: 드래그하여 좌측 패널 크기 조정 가능
2. **중간-우측 스플릿바**: 드래그하여 우측 패널 크기 조정 가능
3. **최소/최대 폭 제한**: 각 패널 250px ~ 600px 범위 내에서 조정
4. **우측 패널 토글**: 접기/펴기 버튼으로 우측 패널 숨기기/보이기
5. **부드러운 애니메이션**: 패널 접기/펴기 시 transition 효과

## 구현 내용

### 1. HTML 구조 변경 (revit_control.html)

**파일**: `connections/templates/revit_control.html` (lines 1640-1722)

**추가된 요소**:

1. **좌측-중간 스플릿바** (line 1641):
```html
<!-- 좌측-중간 스플릿바 -->
<div class="boq-split-bar" data-target="left"></div>
```

2. **중간-우측 스플릿바** (line 1700):
```html
<!-- 중간-우측 스플릿바 -->
<div class="boq-split-bar" data-target="right"></div>
```

3. **우측 패널 토글 버튼** (lines 1716-1722):
```html
<button
    id="boq-right-panel-toggle-btn"
    class="panel-toggle-btn"
    title="오른쪽 패널 접기/펴기"
>
    ▶
</button>
```

### 2. CSS 스타일 추가 (style.css)

**파일**: `connections/static/connections/style.css`

#### 2.1 컨테이너 및 패널 스타일 업데이트 (lines 1702-1720, 2622-2630)

```css
.boq-container {
    padding: 20px;
    height: 100%;
    display: flex;
    flex-direction: row;
    gap: 0; /* 스플릿바 사용으로 gap 제거 */
}

.boq-left-panel {
    width: 320px;
    min-width: 250px;
    max-width: 600px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 15px;
    transition: width 0.3s ease; /* 접기/펴기 애니메이션 */
}

.boq-bim-object-summary-panel {
    width: 320px;
    min-width: 250px;
    max-width: 600px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    transition: width 0.3s ease; /* 접기/펴기 애니메이션 */
}
```

#### 2.2 스플릿바 스타일 (lines 2655-2685)

```css
/* ===== BOQ 스플릿바 스타일 ===== */
.boq-split-bar {
    width: 4px;
    background: var(--border-color);
    cursor: col-resize;
    position: relative;
    flex-shrink: 0;
    transition: background 0.2s;
    user-select: none;
}

.boq-split-bar:hover {
    background: var(--primary-color);
}

.boq-split-bar::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 16px;
    height: 40px;
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.1);
    pointer-events: none;
}

.boq-split-bar:hover::before {
    background: rgba(0, 120, 212, 0.2);
}
```

#### 2.3 패널 접기 상태 스타일 (lines 2687-2700)

```css
/* ===== BOQ 패널 접기 상태 ===== */
.boq-container.left-panel-collapsed .boq-left-panel {
    width: 0 !important;
    min-width: 0 !important;
    overflow: hidden;
    padding: 0;
    gap: 0;
}

.boq-container.right-panel-collapsed .boq-bim-object-summary-panel {
    width: 0 !important;
    min-width: 0 !important;
    overflow: hidden;
}
```

#### 2.4 우측 패널 토글 버튼 스타일 (lines 2702-2725)

```css
/* ===== BOQ 우측 패널 토글 버튼 ===== */
#boq-right-panel-toggle-btn {
    position: absolute;
    top: 50%;
    right: 2px;
    transform: translateY(-50%);
    z-index: 10;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: 4px 0 0 4px;
    padding: 10px 5px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 12px;
}

#boq-right-panel-toggle-btn:hover {
    background: white;
    border-color: var(--primary-color);
}

.boq-container.right-panel-collapsed #boq-right-panel-toggle-btn {
    transform: translateY(-50%) rotate(180deg);
}
```

### 3. JavaScript 기능 구현 (boq_detailed_estimation_handlers.js)

**파일**: `connections/static/connections/boq_detailed_estimation_handlers.js`

#### 3.1 스플릿바 드래그 핸들러 (lines 861-938)

```javascript
/**
 * BOQ 스플릿바 드래그 리사이즈 기능 초기화
 */
function initBoqSplitBars() {
    const splitBars = document.querySelectorAll('.boq-split-bar');

    if (splitBars.length === 0) {
        console.warn('[WARN] No split bars found in BOQ container.');
        return;
    }

    splitBars.forEach(bar => {
        if (bar.dataset.listenerAttached) {
            return; // 이미 리스너가 붙어있으면 스킵
        }

        let isResizing = false;
        let startX = 0;
        let startWidth = 0;
        let targetPanel = null;

        const handleMouseDown = (e) => {
            isResizing = true;
            startX = e.clientX;

            const target = bar.dataset.target;
            if (target === 'left') {
                targetPanel = document.querySelector('.boq-left-panel');
            } else if (target === 'right') {
                targetPanel = document.querySelector('.boq-bim-object-summary-panel');
            }

            if (targetPanel) {
                startWidth = targetPanel.offsetWidth;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none'; // 드래그 중 텍스트 선택 방지
            }
            e.preventDefault();
        };

        const handleMouseMove = (e) => {
            if (!isResizing || !targetPanel) return;

            const deltaX = e.clientX - startX;
            const target = bar.dataset.target;

            let newWidth;
            if (target === 'left') {
                newWidth = startWidth + deltaX;
            } else { // target === 'right'
                newWidth = startWidth - deltaX;
            }

            const minWidth = 250;
            const maxWidth = 600;
            const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));

            targetPanel.style.width = `${constrainedWidth}px`;
        };

        const handleMouseUp = () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                console.log(`[DEBUG] Split bar resize completed. New width: ${targetPanel?.offsetWidth}px`);
            }
        };

        bar.addEventListener('mousedown', handleMouseDown);
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);

        bar.dataset.listenerAttached = 'true';
    });

    console.log(`[DEBUG] Initialized ${splitBars.length} split bar(s) for BOQ panel resizing.`);
}
```

#### 3.2 우측 패널 토글 핸들러 (lines 940-970)

```javascript
/**
 * BOQ 우측 패널 토글 버튼 초기화
 */
function initBoqRightPanelToggle() {
    const toggleBtn = document.getElementById('boq-right-panel-toggle-btn');
    const container = document.querySelector('.boq-container');

    if (!toggleBtn) {
        console.warn('[WARN] Right panel toggle button not found.');
        return;
    }

    if (!container) {
        console.warn('[WARN] BOQ container not found.');
        return;
    }

    if (toggleBtn.dataset.listenerAttached) {
        return; // 이미 리스너가 붙어있으면 스킵
    }

    toggleBtn.addEventListener('click', () => {
        container.classList.toggle('right-panel-collapsed');
        const isCollapsed = container.classList.contains('right-panel-collapsed');
        toggleBtn.textContent = isCollapsed ? '◀' : '▶';
        console.log(`[DEBUG] Right panel toggled. Collapsed: ${isCollapsed}`);
    });

    toggleBtn.dataset.listenerAttached = 'true';
    console.log('[DEBUG] Right panel toggle listener attached.');
}
```

#### 3.3 initializeBoqUI 함수에서 호출 (lines 967-971)

```javascript
// --- 4. 스플릿바 드래그 리사이즈 기능 ---
initBoqSplitBars();

// --- 5. 우측 패널 접기/펴기 기능 ---
initBoqRightPanelToggle();
```

## 기능 설명

### 1. 스플릿바 드래그 리사이즈

- **좌측 스플릿바**: 마우스를 좌우로 드래그하여 좌측 패널 너비 조정
- **우측 스플릿바**: 마우스를 좌우로 드래그하여 우측 패널 너비 조정
- **제한사항**:
  - 최소 너비: 250px
  - 최대 너비: 600px
  - 중간 메인 영역은 `flex-grow: 1`로 남은 공간 자동 차지
- **시각적 피드백**:
  - 호버 시 스플릿바 색상 변경 (회색 → 파란색)
  - 드래그 중 커서 `col-resize` 표시
  - 드래그 중 텍스트 선택 방지 (`user-select: none`)

### 2. 우측 패널 토글

- **버튼 위치**: 화면 우측 중앙 (`position: absolute`)
- **동작**:
  - 클릭 시 `.boq-container`에 `right-panel-collapsed` 클래스 토글
  - 접힌 상태: 패널 너비 0, 버튼 180도 회전 (▶ → ◀)
  - 펼친 상태: 패널 너비 320px, 원래 방향 (◀ → ▶)
- **애니메이션**: `transition: width 0.3s ease` 적용

### 3. 좌측 패널 토글 (기존 기능 유지)

- 기존 좌측 패널 토글 버튼 (`#boq-left-panel-toggle-btn`) 동작 유지
- `.boq-container`에 `left-panel-collapsed` 클래스 토글

## 사용 시나리오

1. **좌측 패널 크기 조정**:
   - 좌측 패널과 중간 영역 사이의 스플릿바를 드래그
   - 필드 선택 영역을 넓게 또는 좁게 조정

2. **우측 패널 크기 조정**:
   - 중간 영역과 우측 패널 사이의 스플릿바를 드래그
   - BIM 객체 비용 요약 패널 크기 조정

3. **좌측 패널 접기**:
   - 좌측 토글 버튼 (◀) 클릭
   - 좌측 패널 완전히 숨김
   - 중간 영역이 왼쪽으로 확장

4. **우측 패널 접기**:
   - 우측 토글 버튼 (▶) 클릭
   - 우측 패널 완전히 숨김
   - 중간 영역이 오른쪽으로 확장

5. **양쪽 패널 모두 접기**:
   - 좌측, 우측 토글 버튼 모두 클릭
   - 중간 메인 영역만 전체 화면 차지

## 기술적 특징

1. **중복 리스너 방지**: `dataset.listenerAttached` 플래그로 중복 등록 방지
2. **이벤트 위임**: 문서 레벨에서 `mousemove`, `mouseup` 이벤트 처리
3. **상태 관리**: 로컬 변수로 드래그 상태 관리 (`isResizing`, `startX`, `startWidth`)
4. **디바운싱 없음**: 실시간 리사이즈 (성능 최적화는 향후 필요 시 적용)
5. **CSS 클래스 기반 상태**: `.left-panel-collapsed`, `.right-panel-collapsed`

## 제한사항 및 향후 개선

### 현재 제한사항

1. **리사이즈 설정 저장 안 됨**: 페이지 새로고침 시 기본 너비(320px)로 복원
2. **하단 패널 리사이즈 없음**: 상하 방향 스플릿바 미구현 (계획에 없음)
3. **3D 뷰어 토글 없음**: 계획에 있었으나 이번 작업에서 제외

### 향후 개선 사항

1. **localStorage 저장**:
   - 사용자별로 패널 너비 저장
   - 페이지 로드 시 저장된 너비 복원

2. **더블클릭 리셋**:
   - 스플릿바 더블클릭 시 기본 너비로 복원

3. **최소화 상태 저장**:
   - 접기/펴기 상태를 localStorage에 저장
   - 다음 방문 시 이전 상태 유지

4. **키보드 지원**:
   - Ctrl + ← / → 로 패널 너비 조정
   - Ctrl + Shift + ← / → 로 패널 접기/펴기

## 관련 파일

- `connections/templates/revit_control.html` (lines 1640-1722)
- `connections/static/connections/style.css` (lines 1702-1720, 2622-2630, 2655-2725)
- `connections/static/connections/boq_detailed_estimation_handlers.js` (lines 861-971)

## 테스트 방법

1. 서버 실행 후 프로젝트 선택
2. **견적 > 상세견적(DD)** 탭으로 이동
3. **스플릿바 테스트**:
   - 좌측-중간 스플릿바 드래그하여 좌측 패널 크기 조정 확인
   - 중간-우측 스플릿바 드래그하여 우측 패널 크기 조정 확인
   - 최소 너비(250px) 이하로 줄어들지 않는지 확인
   - 최대 너비(600px) 이상으로 늘어나지 않는지 확인
4. **우측 패널 토글 테스트**:
   - 우측 토글 버튼 클릭하여 패널 접기 확인
   - 버튼이 180도 회전하는지 확인 (▶ → ◀)
   - 다시 클릭하여 패널 펴기 확인
5. **좌측 패널 토글 테스트** (기존 기능):
   - 좌측 토글 버튼 클릭하여 패널 접기 확인
   - 양쪽 패널 모두 접었을 때 중간 영역만 표시되는지 확인

## 참조 문서

- `workings/61_2025-11-04_DD탭_리사이즈_스플릿바_구현_계획.md` (계획 문서)
- `workings/62_2025-11-04_일일작업요약.md` (이전 작업 요약)

## 커밋 메시지

```
Add resizable split bars and right panel toggle to DD tab

- Add draggable split bars between left-middle and middle-right panels
- Implement resize constraints (250px ~ 600px)
- Add right panel collapse/expand button
- Smooth animations with CSS transitions
- Prevent duplicate event listeners with dataset flags
```
