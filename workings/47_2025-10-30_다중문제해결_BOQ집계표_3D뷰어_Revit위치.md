# ë‹¤ì¤‘ ë¬¸ì œ í•´ê²°: BOQ ì§‘ê³„í‘œ, 3D ë·°ì–´, Revit ìœ„ì¹˜ ì˜¤ë¥˜

**ë‚ ì§œ**: 2025-10-30
**ì‘ì—… ë¶„ë¥˜**: Bug Fix (Multiple Issues)

---

## ëª©ì°¨

1. [Revit ë²½ ìœ„ì¹˜ ì˜¤ë¥˜ í•´ê²°](#1-revit-ë²½-ìœ„ì¹˜-ì˜¤ë¥˜-í•´ê²°)
2. [BOQ ì§‘ê³„í‘œ URL ê¸¸ì´ ì œí•œ ë¬¸ì œ (GET â†’ POST)](#2-boq-ì§‘ê³„í‘œ-url-ê¸¸ì´-ì œí•œ-ë¬¸ì œ)
3. [CSRF í† í° ì˜¤ë¥˜ ìˆ˜ì •](#3-csrf-í† í°-ì˜¤ë¥˜-ìˆ˜ì •)
4. [êµ¬ì¡°í”„ë ˆì„ ìœ„ì¹˜ ì˜¤ë¥˜ í•´ê²°](#4-êµ¬ì¡°í”„ë ˆì„-ìœ„ì¹˜-ì˜¤ë¥˜-í•´ê²°)
5. [ë¶„í•  ê°ì²´ ë¹„ìš© ì •ë³´ ìë™ ì¬ì‹œë„](#5-ë¶„í• -ê°ì²´-ë¹„ìš©-ì •ë³´-ìë™-ì¬ì‹œë„)

---

## 1. Revit ë²½ ìœ„ì¹˜ ì˜¤ë¥˜ í•´ê²°

### ë¬¸ì œ ì¦ìƒ

- 3D ë·°ì–´ì—ì„œ ë²½(Wall)ë§Œ ë‹¤ë¥¸ ë¶€ì¬ë“¤ê³¼ ë©€ë¦¬ ë–¨ì–´ì§„ ìœ„ì¹˜ì— í‘œì‹œ
- ê¸°ë‘¥, ìŠ¬ë˜ë¸Œ ë“± ë‹¤ë¥¸ ê°ì²´ëŠ” ì •ìƒì ìœ¼ë¡œ ëª¨ì—¬ìˆìŒ

### ì›ì¸ ë¶„ì„

**íŒŒì¼**: `CostEstimator_RevitAddin_2026/MainTools/QuantityTakeoff_web/RevitDataCollector.cs`

ì´ì „ ì‘ì—…ì—ì„œ `ExtractTransformMatrix()` ë©”ì„œë“œê°€ Location ê¸°ë°˜ìœ¼ë¡œ transformì„ ìƒì„±í–ˆëŠ”ë°, ì´ê²ƒì´ ë¬¸ì œì˜€ìŠµë‹ˆë‹¤:

```csharp
// Before: Location ê¸°ë°˜ transform ìƒì„±
if (element.Location is LocationPoint locationPoint) {
    transform = Transform.CreateTranslation(locationPoint.Point);
    // ...
}
else if (element.Location is LocationCurve locationCurve) {
    var curve = locationCurve.Curve;
    var startPoint = curve.GetEndPoint(0);
    transform = Transform.CreateTranslation(startPoint);  // â† ë¬¸ì œ!
}
```

**ê·¼ë³¸ ì›ì¸:**
- Revitì˜ `element.get_Geometry()`ëŠ” **ì´ë¯¸ í”„ë¡œì íŠ¸ ì „ì—­ ì¢Œí‘œê³„ì˜ geometryë¥¼ ë°˜í™˜**
- ì¶”ê°€ë¡œ Location ê¸°ë°˜ transformì„ ì ìš© â†’ **ì´ì¤‘ ë³€í™˜(Double Transformation)** ë°œìƒ
- íŠ¹íˆ LocationCurve ìš”ì†Œ(ë²½)ëŠ” ì‹œì‘ì ë§Œ ì‚¬ìš©í•˜ì—¬ ë³€í™˜ â†’ ë”ìš± ì‹¬ê°í•œ ìœ„ì¹˜ ì˜¤ë¥˜

### í•´ê²° ë°©ë²•

**í•­ìƒ Identity transform ì‚¬ìš©:**

```csharp
// After: Identity transform ì‚¬ìš©
private static List<double> ExtractTransformMatrix(Element element)
{
    try
    {
        // Revit geometryëŠ” ì´ë¯¸ ì „ì—­ ì¢Œí‘œê³„ì— ìˆìŒ
        Transform transform = Transform.Identity;

        // 4x4 í–‰ë ¬ êµ¬ì„±...
    }
}
```

**ê¸°ìˆ ì  ë°°ê²½:**
- Revit APIì˜ `get_Geometry()` ë©”ì„œë“œëŠ” í”„ë¡œì íŠ¸ ì¢Œí‘œê³„ì˜ geometryë¥¼ ì§ì ‘ ë°˜í™˜
- `ProcessGeometryObject()` ë©”ì„œë“œê°€ GeometryInstanceì˜ ë‚´ë¶€ transformì€ ì´ë¯¸ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬
- ì¶”ê°€ì ì¸ Location ê¸°ë°˜ transformì€ ë¶ˆí•„ìš”í•˜ë©° ì˜¤íˆë ¤ ìœ„ì¹˜ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚´

### ê²°ê³¼

âœ… **ëª¨ë“  ê°ì²´(ë²½, ê¸°ë‘¥, ìŠ¬ë˜ë¸Œ ë“±)ê°€ 3D ë·°ì–´ì—ì„œ ì •í™•í•œ ìœ„ì¹˜ì— í‘œì‹œë¨**

**ì»¤ë°‹**: c7f6783

---

## 2. BOQ ì§‘ê³„í‘œ URL ê¸¸ì´ ì œí•œ ë¬¸ì œ

### ë¬¸ì œ ì¦ìƒ

ì‚¬ìš©ìê°€ "ìƒì„¸ê²¬ì (DD)" íƒ­ì—ì„œ "ì§‘ê³„í‘œ ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´:

```
net::ERR_EMPTY_RESPONSE
TypeError: Failed to fetch
```

**ì½˜ì†” ë¡œê·¸:**
```javascript
[DEBUG] í‘œì‹œ í•„ë“œ: (187ê°œ)
[DEBUG] ì„œë²„ì— ì§‘ê³„í‘œ ë°ì´í„° ìš”ì²­ ì‹œì‘... /connections/api/boq/report/...?
  group_by=...&display_by=...&display_by=... (ë§¤ìš° ê¸´ URL)
```

### ì›ì¸ ë¶„ì„

**URL ê¸¸ì´ ì´ˆê³¼:**
- 187ê°œì˜ `display_by` íŒŒë¼ë¯¸í„°ë¥¼ GET ë°©ì‹ìœ¼ë¡œ URLì— í¬í•¨
- ê° íŒŒë¼ë¯¸í„° ì´ë¦„ì´ ë§¤ìš° ê¹€: `quantity_member__raw_element__raw_data__Parameters__...`
- ê²°ê³¼ì ìœ¼ë¡œ URLì´ ìˆ˜ì²œ~ìˆ˜ë§Œ ìì— ë‹¬í•¨

**URL ê¸¸ì´ ì œí•œ:**
- ëŒ€ë¶€ë¶„ì˜ ë¸Œë¼ìš°ì €: 2,048 ~ 8,192ì
- ì›¹ ì„œë²„ (Nginx/Apache): 4,096 ~ 8,192ì
- Django ê°œë°œ ì„œë²„: ì œí•œ ì—†ì§€ë§Œ, ìš´ì˜ì²´ì œ ë ˆë²¨ì—ì„œ ì œí•œ ê°€ëŠ¥

**ì—ëŸ¬ ë¶„ì„:**
- `net::ERR_EMPTY_RESPONSE`: ì„œë²„ê°€ ìš”ì²­ì„ ë°›ì•˜ì§€ë§Œ ì²˜ë¦¬í•˜ì§€ ëª»í•˜ê³  ì—°ê²°ì„ ëŠìŒ
- Django ì„œë²„ê°€ URLì„ íŒŒì‹±í•˜ë‹¤ê°€ í¬ë˜ì‹œ

### í•´ê²° ë°©ë²•

**GET â†’ POST ë°©ì‹ ì „í™˜ (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)**

#### 1. ì„œë²„ ìˆ˜ì • (views.py)

**íŒŒì¼**: `connections/views.py:1765-1807`

```python
@require_http_methods(["GET", "POST"])  # GETê³¼ POST ëª¨ë‘ ì§€ì›
def generate_boq_report_api(request, project_id):
    print(f"[DEBUG] API ìš”ì²­ ìˆ˜ì‹  (Method: {request.method})")

    # POST ìš”ì²­: JSON bodyì—ì„œ íŒŒë¼ë¯¸í„° ì¶”ì¶œ
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            group_by_fields = data.get('group_by', [])
            display_by_fields = data.get('display_by', [])
            raw_element_ids = data.get('raw_element_ids', [])
            filter_ai = data.get('filter_ai', True)
            filter_dd = data.get('filter_dd', True)
            print(f"[DEBUG] POST body parsed - display_by: {len(display_by_fields)}")
        except json.JSONDecodeError as e:
            return JsonResponse({'status': 'error', 'message': 'Invalid JSON'}, status=400)
    else:
        # GET ìš”ì²­: URL íŒŒë¼ë¯¸í„°ì—ì„œ ì¶”ì¶œ (í•˜ìœ„ í˜¸í™˜ì„±)
        group_by_fields = request.GET.getlist('group_by')
        display_by_fields = request.GET.getlist('display_by')
        # ...
```

#### 2. í´ë¼ì´ì–¸íŠ¸ ìˆ˜ì • (boq_detailed_estimation_handlers.js)

**íŒŒì¼**: `connections/static/connections/boq_detailed_estimation_handlers.js:168-216`

```javascript
// Before: URLSearchParamsë¡œ GET ìš”ì²­
const params = new URLSearchParams();
groupBySelects.forEach(select => params.append("group_by", select.value));
displayByCheckboxes.forEach(cb => params.append("display_by", cb.value));
// ...
const response = await fetch(`/api/boq/report/${projectId}/?${params.toString()}`);

// After: JSON bodyë¡œ POST ìš”ì²­
const groupByFields = Array.from(groupBySelects).map(select => select.value);
const displayByFields = Array.from(displayByCheckboxes).map(cb => cb.value);

const requestData = {
    group_by: groupByFields,
    display_by: displayByFields,
    raw_element_ids: Array.from(boqFilteredRawElementIds),
    filter_ai: filterAiChecked,
    filter_dd: filterDdChecked
};

const response = await fetch(
    `/connections/api/boq/report/${currentProjectId}/`,
    {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(requestData)
    }
);
```

#### 3. ê°œì‚°ê²¬ì  í•¸ë“¤ëŸ¬ ìˆ˜ì • (schematic_estimation_handlers.js)

**íŒŒì¼**: `connections/static/connections/schematic_estimation_handlers.js:869-916`

ë™ì¼í•œ íŒ¨í„´ìœ¼ë¡œ POST ë°©ì‹ ì ìš©

### ê²°ê³¼

**Before:**
```
GET /api/boq/report/?group_by=...&display_by=... (187ê°œ)
â†’ URL ê¸¸ì´: ìˆ˜ì²œ~ìˆ˜ë§Œ ì
â†’ ê²°ê³¼: net::ERR_EMPTY_RESPONSE ğŸ’¥
```

**After:**
```
POST /api/boq/report/
Body: { "group_by": [...], "display_by": [...187ê°œ...] }
â†’ URL ê¸¸ì´: ì§§ìŒ
â†’ ê²°ê³¼: ì •ìƒ ì‘ë™ âœ…
```

### ì¥ì 

- âœ… **URL ê¸¸ì´ ì œí•œ ì—†ìŒ** - 500ê°œ í•„ë“œë„ ê°€ëŠ¥
- âœ… **í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€** - GETë„ ê³„ì† ì‘ë™
- âœ… **ë¸”ë Œë”/ë ˆë¹— ì˜í–¥ ì—†ìŒ** - ì´ APIë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- âœ… **ë” ë‚˜ì€ REST API ë””ìì¸** - ë³µì¡í•œ ì¿¼ë¦¬ëŠ” POST body ì‚¬ìš©

**ì»¤ë°‹**: 1d8ff11

---

## 3. CSRF í† í° ì˜¤ë¥˜ ìˆ˜ì •

### ë¬¸ì œ ì¦ìƒ

ì§‘ê³„í‘œ ìƒì„± ë²„íŠ¼ í´ë¦­ ì‹œ:

```
boq_detailed_estimation_handlers.js:211
ReferenceError: getCSRFToken is not defined
    at HTMLButtonElement.generateBoqReport
```

### ì›ì¸ ë¶„ì„

POST ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•˜ë©´ì„œ CSRF í† í°ì´ í•„ìš”í•´ì¡ŒëŠ”ë°, ì¡´ì¬í•˜ì§€ ì•ŠëŠ” `getCSRFToken()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•¨:

```javascript
// ì˜¤ë¥˜ ì½”ë“œ
headers: {
    'Content-Type': 'application/json',
    'X-CSRFToken': getCSRFToken()  // â† ì´ í•¨ìˆ˜ ì—†ìŒ!
}
```

**ê¸°ì¡´ ì½”ë“œ íŒ¨í„´ í™•ì¸:**

ë‹¤ë¥¸ íŒŒì¼ë“¤ì—ì„œëŠ” `csrftoken` ë³€ìˆ˜ë¥¼ ì§ì ‘ ì‚¬ìš©:

```javascript
// csrf_token.jsì—ì„œ ì •ì˜ëœ ì „ì—­ ë³€ìˆ˜
let csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value
    || getCookie('csrftoken');

// ë‹¤ë¥¸ íŒŒì¼ë“¤ì˜ ì‚¬ìš© ì˜ˆ
headers: { 'X-CSRFToken': csrftoken }  // â† ë³€ìˆ˜ ì§ì ‘ ì‚¬ìš©
```

### í•´ê²° ë°©ë²•

**getCSRFToken() â†’ csrftoken ë³€ê²½:**

```javascript
// After
headers: {
    'Content-Type': 'application/json',
    'X-CSRFToken': csrftoken  // â† ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©
}
```

**ìˆ˜ì • íŒŒì¼:**
1. `boq_detailed_estimation_handlers.js:211`
2. `schematic_estimation_handlers.js:911`

### ê²°ê³¼

âœ… ì§‘ê³„í‘œ ìƒì„± ì •ìƒ ì‘ë™

**ì»¤ë°‹**: 0da4f45

---

## 4. êµ¬ì¡°í”„ë ˆì„ ìœ„ì¹˜ ì˜¤ë¥˜ í•´ê²°

### ë¬¸ì œ ì¦ìƒ

- 3D ë·°ì–´ì—ì„œ êµ¬ì¡°í”„ë ˆì„(Structural Framing, ë³´)ë§Œ ì›ì  ê·¼ì²˜ë¡œ ì´ë™
- ë²½, ê¸°ë‘¥, ìŠ¬ë˜ë¸ŒëŠ” ì •ìƒ ìœ„ì¹˜

### ì›ì¸ ë¶„ì„

**íŒŒì¼**: `RevitDataCollector.cs:114-122`

```csharp
else if (geomObj is GeometryInstance instance)
{
    var instanceGeom = instance.GetInstanceGeometry();  // â† ë¬¸ì œ!
    var transform = parentTransform.Multiply(instance.Transform);
    foreach (GeometryObject instanceObj in instanceGeom)
    {
        ProcessGeometryObject(instanceObj, allVerts, allFaces, transform);
    }
}
```

**Revit API ë™ì‘:**
- `GetInstanceGeometry()`: Instanceì˜ transformì´ **ì´ë¯¸ ì ìš©ëœ** geometry ë°˜í™˜
- `GetSymbolGeometry()`: Symbolì˜ **ë¡œì»¬ ì¢Œí‘œê³„** geometry ë°˜í™˜

**ë¬¸ì œ:**
- êµ¬ì¡°í”„ë ˆì„(ë³´)ì€ GeometryInstanceë¥¼ ì‚¬ìš©
- ì´ë¯¸ transformì´ ì ìš©ëœ geometryì— ë‹¤ì‹œ `instance.Transform`ì„ ê³±í•¨
- **ì´ì¤‘ transform ì ìš©** â†’ ì›ì ìœ¼ë¡œ ì´ë™

**ì™œ ë‹¤ë¥¸ ê°ì²´ëŠ” ì •ìƒ?**
- ë²½, ê¸°ë‘¥, ìŠ¬ë˜ë¸Œ: ì§ì ‘ Solidë¥¼ ê°€ì§€ê³  ìˆì–´ì„œ GeometryInstance ì²˜ë¦¬ë¥¼ ê±°ì¹˜ì§€ ì•ŠìŒ

### í•´ê²° ë°©ë²•

**GetInstanceGeometry() â†’ GetSymbolGeometry() ë³€ê²½:**

```csharp
else if (geomObj is GeometryInstance instance)
{
    // GetSymbolGeometry()ë¡œ ë¡œì»¬ ì¢Œí‘œê³„ geometryë¥¼ ê°€ì ¸ì˜¤ê³ ,
    // instance.Transformì„ ëª…ì‹œì ìœ¼ë¡œ ì ìš©
    var instanceGeom = instance.GetSymbolGeometry();
    var transform = parentTransform.Multiply(instance.Transform);
    foreach (GeometryObject instanceObj in instanceGeom)
    {
        ProcessGeometryObject(instanceObj, allVerts, allFaces, transform);
    }
}
```

### ê¸°ìˆ ì  ë°°ê²½

**Revit APIì˜ ë‘ ê°€ì§€ ë©”ì„œë“œ:**

| ë©”ì„œë“œ | ë°˜í™˜ | Transform ì ìš© ì—¬ë¶€ |
|--------|------|-------------------|
| `GetInstanceGeometry()` | Instance ì¢Œí‘œê³„ geometry | âœ… ì´ë¯¸ ì ìš©ë¨ |
| `GetSymbolGeometry()` | Symbol ë¡œì»¬ ì¢Œí‘œê³„ geometry | âŒ ì ìš© ì•ˆ ë¨ |

**ì˜¬ë°”ë¥¸ ì‚¬ìš©:**
- Symbol geometry ê°€ì ¸ì˜¤ê¸° â†’ Transform ëª…ì‹œì ìœ¼ë¡œ ì ìš© â†’ í•œ ë²ˆë§Œ ì ìš©

### ê²°ê³¼

âœ… êµ¬ì¡°í”„ë ˆì„ì´ ë²½, ê¸°ë‘¥ ë“±ê³¼ í•¨ê»˜ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— í‘œì‹œë¨

**ì»¤ë°‹**: 0da4f45

---

## 5. ë¶„í•  ê°ì²´ ë¹„ìš© ì •ë³´ ìë™ ì¬ì‹œë„

### ë¬¸ì œ ì¦ìƒ

3D ë·°ì–´ì—ì„œ ë¶„í• ëœ ê°ì²´ë¥¼ ì„ íƒí–ˆì„ ë•Œ:

```
[3D Viewer] Split object but no QM found - auto-reload in progress
Found matching quantity members for split: []
```

í™”ë©´ì—ëŠ”: **"ë°ì´í„° ë¡œë”© ì¤‘... (ìë™ ì¬ë¡œë“œ ëŒ€ê¸°)"** ë©”ì‹œì§€ë§Œ í‘œì‹œë˜ê³  ì˜ì›íˆ ëŒ€ê¸°

**ì‚¬ìš©ì ê´€ì°°:**
- ì˜¤ë˜ ê¸°ë‹¤ë ¸ë‹¤ê°€ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ë¹„ìš© ì •ë³´ê°€ ë³´ì„
- ë¶„í•  í›„ ë°”ë¡œ í´ë¦­í•˜ë©´ ì•ˆ ë³´ì„
- ë‹¤ë¥¸ ê°ì²´ í´ë¦­í•˜ê³  ì™”ë‹¤ê°”ë‹¤ í•˜ë©´ ì €ì¥ì´ ì•ˆ ëœ ê²ƒì²˜ëŸ¼ ë³´ì„

### ì›ì¸ ë¶„ì„

**íƒ€ì´ë° ë¬¸ì œ:**

1. ì‚¬ìš©ìê°€ ê°ì²´ ë¶„í•  â†’ ì„œë²„ê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‚°ì¶œí•­ëª©(QuantityMember) ê³„ì‚° ì‹œì‘
2. ì‚¬ìš©ìê°€ **ì¦‰ì‹œ** ë¶„í• ëœ ê°ì²´ í´ë¦­ â†’ ì•„ì§ ê³„ì‚°ì´ ì™„ë£Œë˜ì§€ ì•ŠìŒ
3. ì½”ë“œê°€ "ë°ì´í„° ë¡œë”© ì¤‘..." í‘œì‹œ í›„ **ê·¸ëƒ¥ ë°˜í™˜** â†’ ì¬ì‹œë„ ì—†ìŒ!

**íŒŒì¼**: `three_d_viewer.js:1675-1680`

```javascript
// Before: ì¬ì‹œë„ ë¡œì§ ì—†ìŒ
if (quantityMembers.length === 0) {
    if (object.userData.splitElementId) {
        console.warn('Split object but no QM found - auto-reload in progress');
        tableContainer.innerHTML = 'ë°ì´í„° ë¡œë”© ì¤‘... (ìë™ ì¬ë¡œë“œ ëŒ€ê¸°)';
        return;  // â† ì—¬ê¸°ì„œ ë! ì¬ì‹œë„ ì—†ìŒ!
    }
```

**ë¹„êµ: ë‹¤ë¥¸ ê²½ìš°ëŠ” ì¬ì‹œë„ê°€ ìˆìŒ (Line 1703-1710):**

```javascript
// costItemsWithPrices ì—†ì„ ë•ŒëŠ” ì¬ì‹œë„ ë¡œì§ ìˆìŒ
const retryCount = displayCostItemsRetryCount.get(object) || 0;
if (retryCount < 8) {
    displayCostItemsRetryCount.set(object, retryCount + 1);
    setTimeout(() => {
        displayCostItems(object);
    }, 500);  // â† 500msë§ˆë‹¤ ì¬ì‹œë„ (ìµœëŒ€ 8íšŒ)
}
```

### í•´ê²° ë°©ë²•

**ìë™ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜ ì¶”ê°€:**

#### 1. Split ê°ì²´ì— ì¬ì‹œë„ ë¡œì§ ì¶”ê°€ (Line 1674-1701)

```javascript
if (quantityMembers.length === 0) {
    if (object.userData.splitElementId) {
        console.warn('[3D Viewer] Split object but no QM found - retrying...');
        tableContainer.innerHTML = '<p class="no-selection">ì‚°ì¶œí•­ëª© ê³„ì‚° ì¤‘... (ìë™ ì¬ì‹œë„)</p>';

        // ì¬ì‹œë„ (ìµœëŒ€ 10íšŒ, 1000ms ê°„ê²© - splitì€ ì‹œê°„ì´ ë” ê±¸ë¦¼)
        const retryCount = displayCostItemsRetryCount.get(object) || 0;
        if (retryCount < 10) {
            displayCostItemsRetryCount.set(object, retryCount + 1);
            console.log(`[3D Viewer] Retry ${retryCount + 1}/10 after 1000ms...`);
            setTimeout(() => {
                console.log('[3D Viewer] Retrying displayCostItems after split...');
                displayCostItems(object);
            }, 1000);
        } else {
            displayCostItemsRetryCount.delete(object);
            tableContainer.innerHTML = '<p class="no-selection">ì‚°ì¶œí•­ëª©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.</p>';
        }
        return;
    }

    // ì¼ë°˜ ê°ì²´ëŠ” ê·¸ëƒ¥ ì—†ìŒ í‘œì‹œ
    tableContainer.innerHTML = '<p class="no-selection">ì—°ê´€ëœ ìˆ˜ëŸ‰ì‚°ì¶œë¶€ì¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
    return;
}
```

#### 2. ìƒˆ ê°ì²´ ì„ íƒ ì‹œ ì¬ì‹œë„ ì¹´ìš´íŠ¸ ì´ˆê¸°í™” (Line 1119-1121)

```javascript
function selectObject(object) {
    if (selectedObject) {
        deselectObject();
    }

    selectedObject = object;

    // ìƒˆ ê°ì²´ ì„ íƒ ì‹œ ì¬ì‹œë„ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
    displayCostItemsRetryCount.delete(object);

    // ... ë‚˜ë¨¸ì§€ ì½”ë“œ
}
```

**ì™œ ì´ˆê¸°í™”ê°€ í•„ìš”í•œê°€?**
- ì‚¬ìš©ìê°€ ë‹¤ë¥¸ ê°ì²´ í´ë¦­í–ˆë‹¤ê°€ ë‹¤ì‹œ ëŒì•„ì˜¬ ìˆ˜ ìˆìŒ
- ì¬ì‹œë„ ì¹´ìš´íŠ¸ë¥¼ ë¦¬ì…‹í•´ì•¼ ë‹¤ì‹œ ì¬ì‹œë„ ê°€ëŠ¥

### ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­

**íƒ€ì„ì•„ì›ƒ ì°¨ì´:**
- **Split QM ì¬ì‹œë„**: 10íšŒ Ã— 1ì´ˆ = **10ì´ˆ ìµœëŒ€ ëŒ€ê¸°**
  - ë¶„í•  í›„ ì‚°ì¶œí•­ëª© ê³„ì‚°ì€ ì‹œê°„ì´ ë” ê±¸ë¦¼

- **Price ì¬ì‹œë„**: 8íšŒ Ã— 0.5ì´ˆ = **4ì´ˆ ìµœëŒ€ ëŒ€ê¸°**
  - ê°€ê²© ì¡°íšŒëŠ” ìƒëŒ€ì ìœ¼ë¡œ ë¹ ë¦„

**ì¬ì‹œë„ ì‹¤íŒ¨ ì‹œ:**
- 10ì´ˆ(10ë²ˆ ì¬ì‹œë„) í›„ì—ë„ ì•ˆ ë‚˜íƒ€ë‚˜ë©´: "ì‚°ì¶œí•­ëª©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”."

### ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

**Before:**
```
ë¶„í•  â†’ í´ë¦­ â†’ "ë¡œë”© ì¤‘..." â†’ ì˜ì›íˆ ëŒ€ê¸° â†’ ì‚¬ìš©ì í˜¼ë€ ğŸ˜µ
```

**After:**
```
ë¶„í•  â†’ í´ë¦­ â†’ "ê³„ì‚° ì¤‘... (ìë™ ì¬ì‹œë„)" â†’ 1ì´ˆë§ˆë‹¤ í™•ì¸ â†’ ìë™ í‘œì‹œ âœ¨
```

**ì½˜ì†” ë¡œê·¸ (ì˜ˆìƒ):**
```
[3D Viewer] Split object but no QM found - retrying...
[3D Viewer] Retry 1/10 after 1000ms...
[3D Viewer] Retrying displayCostItems after split...
[3D Viewer] Retry 2/10 after 1000ms...
[3D Viewer] Retrying displayCostItems after split...
[3D Viewer] Found matching quantity members for split: [Object, Object]
[3D Viewer] Found quantity members: 2
âœ… ë¹„ìš© ì •ë³´ í‘œì‹œ!
```

### ê²°ê³¼

âœ… ë¶„í•  í›„ ë°”ë¡œ í´ë¦­í•´ë„ 1-5ì´ˆ í›„ ìë™ìœ¼ë¡œ ë¹„ìš© ì •ë³´ í‘œì‹œ
âœ… ë‹¤ë¥¸ ê°ì²´ í´ë¦­í–ˆë‹¤ê°€ ëŒì•„ì™€ë„ ì •ìƒ ì‘ë™
âœ… ì‚¬ìš©ìê°€ ê¸°ë‹¤ë¦´ í•„ìš” ì—†ìŒ - ìë™ìœ¼ë¡œ í‘œì‹œë¨

**ì»¤ë°‹**: 844b0a6

---

## íŒŒì¼ ìˆ˜ì • ìš”ì•½

### Revit ì• ë“œì¸

1. **RevitDataCollector.cs**
   - Line 162-205: `ExtractTransformMatrix()` - Identity transform ì‚¬ìš© (ë²½ ìœ„ì¹˜ ìˆ˜ì •)
   - Line 114-126: `ProcessGeometryObject()` - GetSymbolGeometry() ì‚¬ìš© (êµ¬ì¡°í”„ë ˆì„ ìˆ˜ì •)

### ì›¹ë¸Œë¼ìš°ì € (Django ì„œë²„)

2. **connections/views.py**
   - Line 1765-1807: `generate_boq_report_api()` - GET/POST ëª¨ë‘ ì§€ì›

### ì›¹ë¸Œë¼ìš°ì € (JavaScript)

3. **connections/static/connections/boq_detailed_estimation_handlers.js**
   - Line 168-216: POST ë°©ì‹ìœ¼ë¡œ ë³€ê²½
   - Line 211: CSRF í† í° ìˆ˜ì •

4. **connections/static/connections/schematic_estimation_handlers.js**
   - Line 869-916: POST ë°©ì‹ìœ¼ë¡œ ë³€ê²½
   - Line 911: CSRF í† í° ìˆ˜ì •

5. **connections/static/connections/three_d_viewer.js**
   - Line 1119-1121: ì¬ì‹œë„ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
   - Line 1674-1701: Split ê°ì²´ ìë™ ì¬ì‹œë„ ë¡œì§

---

## ì»¤ë°‹ íˆìŠ¤í† ë¦¬

1. **c7f6783** - Fix Revit wall positioning by using Identity transform matrix
2. **e0534eb** - Document wall positioning issue and fix
3. **1d8ff11** - Fix BOQ report generation: GET to POST to solve URL length limit
4. **0da4f45** - Fix two issues: CSRF token and structural framing position
5. **844b0a6** - Fix split object cost display with auto-retry mechanism

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. Revit ìœ„ì¹˜ í…ŒìŠ¤íŠ¸

**ì¤€ë¹„:**
1. Revit ì• ë“œì¸ ì¬ë¹Œë“œ
2. ë²½, ê¸°ë‘¥, ë³´ê°€ í¬í•¨ëœ ëª¨ë¸ ì—´ê¸°

**í…ŒìŠ¤íŠ¸:**
1. Connect to Server â†’ ë°ì´í„° ì „ì†¡
2. ì›¹ë¸Œë¼ìš°ì € 3D ë·°ì–´ì—ì„œ í™•ì¸
3. **ê¸°ëŒ€ ê²°ê³¼**: ëª¨ë“  ê°ì²´ê°€ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ëª¨ì—¬ìˆìŒ

### 2. BOQ ì§‘ê³„í‘œ í…ŒìŠ¤íŠ¸

**í…ŒìŠ¤íŠ¸:**
1. "ìƒì„¸ê²¬ì (DD)" íƒ­ ì—´ê¸°
2. í‘œì‹œ í•„ë“œ ë§ì´ ì„ íƒ (100ê°œ ì´ìƒ)
3. "ì§‘ê³„í‘œ ìƒì„±" ë²„íŠ¼ í´ë¦­
4. **ê¸°ëŒ€ ê²°ê³¼**: ì˜¤ë¥˜ ì—†ì´ ì§‘ê³„í‘œ ìƒì„±ë¨

**ì½˜ì†” í™•ì¸:**
```
[DEBUG] ì„œë²„ì— ì§‘ê³„í‘œ ë°ì´í„° ìš”ì²­ ì‹œì‘ (POST)...
[DEBUG] Request data: { group_by: [...], display_by: [187ê°œ] }
```

### 3. ë¶„í•  ê°ì²´ ë¹„ìš© ì •ë³´ í…ŒìŠ¤íŠ¸

**í…ŒìŠ¤íŠ¸:**
1. 3D ë·°ì–´ì—ì„œ ê°ì²´ ë¶„í•  (Face Split ë˜ëŠ” Sketch Split)
2. **ì¦‰ì‹œ** ë¶„í• ëœ ê°ì²´ í´ë¦­
3. **ê¸°ëŒ€ ê²°ê³¼**: "ì‚°ì¶œí•­ëª© ê³„ì‚° ì¤‘... (ìë™ ì¬ì‹œë„)"
4. 1-5ì´ˆ í›„ ìë™ìœ¼ë¡œ ë¹„ìš© ì •ë³´ í‘œì‹œ

**ì½˜ì†” í™•ì¸:**
```
[3D Viewer] Retry 1/10 after 1000ms...
[3D Viewer] Found quantity members: 2
```

---

## ì˜í–¥ ë²”ìœ„

### ë³€ê²½ ì—†ìŒ
- âœ… Blender ì• ë“œì˜¨: ì˜í–¥ ì—†ìŒ
- âœ… ê¸°ì¡´ ë°ì´í„°: í˜¸í™˜ì„± ìœ ì§€
- âœ… ë‹¤ë¥¸ API: ì˜í–¥ ì—†ìŒ

### ê°œì„ ë¨
- âœ… Revit 3D í‘œì‹œ ì •í™•ë„
- âœ… BOQ ì§‘ê³„í‘œ ì•ˆì •ì„±
- âœ… ë¶„í•  ê¸°ëŠ¥ ì‚¬ìš©ì„±

---

## ê²°ë¡ 

**5ê°œì˜ ì£¼ìš” ë¬¸ì œë¥¼ í•´ê²°í•˜ì—¬ ì‹œìŠ¤í…œ ì•ˆì •ì„±ê³¼ ì‚¬ìš©ì„±ì„ í¬ê²Œ ê°œì„ í–ˆìŠµë‹ˆë‹¤.**

### í•´ê²°ëœ ë¬¸ì œ

1. âœ… **Revit ë²½ ìœ„ì¹˜ ì˜¤ë¥˜** - Identity transformìœ¼ë¡œ ì •í™•í•œ ìœ„ì¹˜ í‘œì‹œ
2. âœ… **BOQ ì§‘ê³„í‘œ URL ì œí•œ** - POST ë°©ì‹ìœ¼ë¡œ ë¬´ì œí•œ í•„ë“œ ì§€ì›
3. âœ… **CSRF í† í° ì˜¤ë¥˜** - ì˜¬ë°”ë¥¸ ë³€ìˆ˜ ì‚¬ìš©
4. âœ… **êµ¬ì¡°í”„ë ˆì„ ìœ„ì¹˜ ì˜¤ë¥˜** - GetSymbolGeometryë¡œ ì •í™•í•œ ìœ„ì¹˜
5. âœ… **ë¶„í•  ê°ì²´ ë¹„ìš© í‘œì‹œ** - ìë™ ì¬ì‹œë„ë¡œ ì¦‰ì‹œ í‘œì‹œ

### í•µì‹¬ ê°œì„  ì‚¬í•­

- **ì •í™•ì„±**: ëª¨ë“  Revit ê°ì²´ê°€ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— í‘œì‹œ
- **ì•ˆì •ì„±**: URL ê¸¸ì´ ì œí•œ ì—†ì´ ëŒ€ëŸ‰ í•„ë“œ ì²˜ë¦¬ ê°€ëŠ¥
- **ì‚¬ìš©ì„±**: ë¶„í•  í›„ ìë™ìœ¼ë¡œ ë¹„ìš© ì •ë³´ í‘œì‹œ

### ê¸°ìˆ ì  ì„±ê³¼

- Revit API ê¹Šì€ ì´í•´: Transform, GeometryInstance ì²˜ë¦¬
- REST API ê°œì„ : GET/POST í•˜ìœ„ í˜¸í™˜ì„±
- UX ê°œì„ : ìë™ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜

---

**ì‘ì—… ì™„ë£Œ**: 2025-10-30
**ì´ ì»¤ë°‹**: 5ê°œ
**ìˆ˜ì • íŒŒì¼**: 5ê°œ (Revit 2ê°œ, ì„œë²„ 1ê°œ, í´ë¼ì´ì–¸íŠ¸ 2ê°œ)
