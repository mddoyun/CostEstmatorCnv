# 2025-10-27 main.js 핵심 리팩토링 및 오류 수정 요약

## 작업 개요
`main.js` 파일의 과도한 크기로 인한 모듈화 필요성에 따라, 핵심 전역 변수 및 초기화 로직을 `app_core.js`로 분리하는 작업을 진행했습니다. 이 과정에서 발생한 스크립트 로딩 및 변수 스코프 관련 오류들을 수정했습니다.

## 문제점
1.  `main.js` 파일이 너무 커서 유지보수 및 가독성이 저하되었습니다.
2.  핵심 로직을 `app_core.js`로 분리한 후, 전역 변수 및 함수 접근 문제로 인해 `Uncaught ReferenceError`가 발생했습니다.
3.  `websocket.js`에서 `PROGRESS_TOTAL_KEYS` 식별자가 이미 선언되었다는 `Uncaught SyntaxError`가 발생했습니다.
4.  `ai_model_management.js`에서 API 호출 URL 구성 오류(불필요한 문자 포함)로 인해 `404 (Not Found)` 오류가 발생했습니다.

## 해결 과정 및 결과

### 1. `main.js` 핵심 로직 분리
-   `main.js` 파일의 최상단에 선언된 모든 전역 변수와 `DOMContentLoaded` 이벤트 리스너 전체를 새로운 파일 `connections/static/connections/app_core.js`로 이동했습니다.
-   `main.js`에서는 해당 코드 블록들을 제거했습니다.

### 2. 전역 스코프 문제 해결
-   `app_core.js` 내의 전역 변수 및 `DOMContentLoaded` 리스너를 IIFE(즉시 실행 함수 표현식)로 래핑했습니다.
-   `currentProjectId`, `csrftoken`, `activeTab` 등 다른 스크립트에서 접근해야 하는 주요 변수들을 `window` 객체에 명시적으로 연결하여 전역적으로 접근 가능하도록 했습니다.
-   `websocket.js` 파일 내의 `frontendSocket` 변수와 `setupWebSocket` 함수도 `window` 객체에 연결하여 전역적으로 접근 가능하도록 수정했습니다.

### 3. `PROGRESS_TOTAL_KEYS` 재선언 오류 해결
-   `websocket.js` 파일에서 `const PROGRESS_TOTAL_KEYS` 선언을 `var PROGRESS_TOTAL_KEYS`로 변경하여, 스크립트가 여러 번 로드되거나 다른 스크립트에서 암시적으로 포함될 때 발생할 수 있는 재선언 오류를 방지했습니다.

### 4. 스크립트 로딩 순서 및 URL 오류 수정
-   `connections/templates/revit_control.html` 파일에서 스크립트 로딩 순서를 `websocket.js` -> `app_core.js` -> `main.js` 순서로 조정하여 의존성 문제를 해결했습니다.
-   `ai_model_management.js` 파일 내의 `loadAiModels`, `uploadAiModel`, `handleAiModelListActions`, `uploadAndAnalyzeCsv`, `saveTrainedModel`, `downloadTrainedModelFile` 함수에서 `currentProjectId` 및 `csrftoken`을 사용하는 API 호출 URL 구성 오류를 수정했습니다. 특히, URL 문자열 내에 잘못 포함된 줄바꿈 문자(`
`)와 `currentProjectId`를 `window.currentProjectId`로, `csrftoken`을 `window.csrftoken`으로 변경하여 올바른 URL이 생성되도록 했습니다.

## 결론
위의 리팩토링 및 오류 수정 작업을 통해 `main.js` 파일의 핵심 초기화 로직이 `app_core.js`로 성공적으로 분리되었으며, 이 과정에서 발생한 모든 스크립트 로딩 및 변수 스코프 관련 오류, 그리고 `ai_model_management.js`의 URL 구성 오류가 해결되었습니다. 애플리케이션이 이제 정상적으로 작동합니다.

다음 단계로 `main.js`의 다른 기능 블록들을 추가적으로 분리하는 작업을 진행할 수 있습니다.
