# 50. 3D 뷰어 수량산출부재 탭 BIM 연동 및 필터링 기능 추가

**날짜**: 2025-11-02
**작업자**: Claude Code
**관련 파일**:
- `connections/templates/three_d_viewer.html`
- `connections/templates/revit_control.html`
- `connections/static/connections/three_d_viewer.js`
- `connections/static/connections/quantity_members_manager.js`
- `connections/static/connections/ui.js`
- `connections/static/connections/app_core.js`

---

## 작업 개요

3D 뷰어 탭 내부의 수량산출부재 패널에 BIM 저작도구 연동 및 3D 뷰포트 연동 기능을 추가하고, "3D 선택 객체 가져오기" 기능에서 테이블 필터링이 정상 작동하도록 구현했습니다. BIM원본데이터 탭과 동일한 사용자 경험을 제공하도록 개선했습니다.

---

## 주요 변경사항

### 1. 3D 뷰어 수량산출부재 탭에 연동 버튼 추가

**파일**: `connections/templates/three_d_viewer.html`

#### 추가된 UI 요소 (lines 87-104):
```html
<div style="padding: 10px; border-bottom: 1px solid #ddd; background: #f9f9f9;">
    <div style="margin-bottom: 8px;">
        <h4 style="margin: 0 0 5px 0; font-size: 13px; font-weight: bold;">BIM 저작도구 연동</h4>
        <div style="display: flex; gap: 5px;">
            <button id="viewer-qm-get-from-client-btn">선택 객체 가져오기</button>
            <button id="viewer-qm-select-in-client-btn">선택한 객체 확인</button>
        </div>
    </div>
    <div>
        <h4 style="margin: 0 0 5px 0; font-size: 13px; font-weight: bold;">3D 뷰포트 연동</h4>
        <div style="display: flex; gap: 5px;">
            <button id="viewer-qm-get-from-3d-viewer-btn">3D 선택 객체 가져오기</button>
            <button id="viewer-qm-select-in-3d-viewer-btn">3D에서 선택한 객체 확인</button>
        </div>
        <div style="margin-top: 5px;">
            <button id="viewer-qm-clear-selection-filter-btn">✕ 선택 필터 해제</button>
        </div>
    </div>
</div>
```

**추가된 4개 버튼**:
1. **선택 객체 가져오기**: BIM 저작도구(Revit/Blender)에서 선택된 객체 가져오기
2. **선택한 객체 확인**: 리스트에서 선택한 수량산출부재를 BIM 저작도구에서 선택
3. **3D 선택 객체 가져오기**: 3D 뷰포트에서 선택된 객체와 연관된 수량산출부재 필터링
4. **3D에서 선택한 객체 확인**: 리스트에서 선택한 수량산출부재를 3D 뷰포트에서 선택

---

### 2. 3D 뷰어 내부 버튼 기능 구현

**파일**: `connections/static/connections/three_d_viewer.js`

#### 선택 추적 변수 추가 (lines 85-88):
```javascript
let selectedQuantityMemberIdsInViewer = new Set();
let currentDisplayedQMs = []; // 현재 표시중인 수량산출부재 목록
```

#### 수량산출부재 리스트 렌더링 수정 (lines 3139-3189):
- 다중 선택 지원 (Ctrl/Cmd + Click)
- 단일 클릭: 기존 선택 해제 후 새로운 항목 선택
- Ctrl/Cmd 클릭: 기존 선택 유지하며 토글

#### 4개 버튼 핸들러 함수 구현 (lines 10065-10215):
```javascript
// 1. BIM 저작도구에서 선택 가져오기
function viewerQmGetSelectionFromClient() {
    // WebSocket을 통해 Revit/Blender에서 선택된 요소 ID 가져오기
    // 해당 요소와 연관된 수량산출부재를 selectedQuantityMemberIdsInViewer에 추가
}

// 2. BIM 저작도구에서 선택 확인
function viewerQmSelectInClient() {
    // selectedQuantityMemberIdsInViewer에 있는 수량산출부재의 raw_element_id 수집
    // WebSocket을 통해 Revit/Blender에서 해당 요소 선택
}

// 3. 3D 뷰포트에서 선택 가져오기
function viewerQmGetSelectionFrom3DViewer() {
    // selectedObjects에서 BIM ID 수집
    // 해당 BIM ID와 연관된 수량산출부재를 selectedQuantityMemberIdsInViewer에 추가
}

// 4. 3D 뷰포트에서 선택 확인
function viewerQmSelectIn3DViewer() {
    // selectedQuantityMemberIdsInViewer의 수량산출부재에서 raw_element_id 수집
    // 3D 뷰어에서 해당 객체 선택 (selectObjectsIn3DViewer 호출)
}
```

#### 이벤트 리스너 등록 (lines 10217-10248):
```javascript
function setupViewerQmButtonListeners() {
    document.getElementById('viewer-qm-get-from-client-btn')
        ?.addEventListener('click', viewerQmGetSelectionFromClient);
    document.getElementById('viewer-qm-select-in-client-btn')
        ?.addEventListener('click', viewerQmSelectInClient);
    document.getElementById('viewer-qm-get-from-3d-viewer-btn')
        ?.addEventListener('click', viewerQmGetSelectionFrom3DViewer);
    document.getElementById('viewer-qm-select-in-3d-viewer-btn')
        ?.addEventListener('click', viewerQmSelectIn3DViewer);
}
```

---

### 3. 메인 수량산출부재 탭 필터링 기능 구현

**파일**: `connections/static/connections/app_core.js`

#### 전역 필터 상태 변수 추가 (lines 57-58):
```javascript
window.isQmFilterToSelectionActive = false; // 선택 필터 활성화 여부
window.qmFilteredIds = new Set(); // 필터링할 수량산출부재 ID
```

---

**파일**: `connections/static/connections/quantity_members_manager.js`

#### "3D 선택 객체 가져오기" 함수 수정 (lines 1277-1335):

**주요 수정사항**:
1. 변수명 오류 수정: `selectedQuantityMemberIds` → `selectedQmIds`
2. 변수명 오류 수정: `allQuantityMembers` → `window.loadedQuantityMembers`
3. 데이터 구조 수정: `source_element_ids` (배열) → `raw_element_id` 또는 `split_element_id` (단일 값)
4. 필터 플래그 설정 및 필터링할 ID 저장

```javascript
function getQmSelectionFrom3DViewer() {
    // 3D 뷰포트에서 선택된 객체의 BIM ID 수집
    const selectedBimIds = new Set();
    selected3DObjects.forEach(obj => {
        const bimObjectId = obj.userData.bimObjectId || obj.userData.rawElementId;
        if (bimObjectId) selectedBimIds.add(bimObjectId);
    });

    // 기존 선택 및 필터 초기화
    selectedQmIds.clear();
    window.qmFilteredIds.clear();

    // 해당 BIM ID를 포함하는 수량산출부재 찾기
    window.loadedQuantityMembers.forEach(qm => {
        // raw_element_id 또는 split_element_id 확인
        const elementId = qm.split_element_id || qm.raw_element_id;
        if (elementId && selectedBimIds.has(elementId)) {
            selectedQmIds.add(qm.id);
            window.qmFilteredIds.add(qm.id); // 필터링용 ID도 저장
        }
    });

    // 필터 활성화 및 버튼 표시 (사이드바 버튼과 테이블 하단 버튼 모두)
    window.isQmFilterToSelectionActive = true;
    const clearBtnSidebar = document.getElementById('qm-clear-selection-filter-btn');
    const clearBtnFooter = document.getElementById('qm-clear-selection-filter-btn-footer');

    if (clearBtnSidebar) clearBtnSidebar.style.display = 'inline-block';
    if (clearBtnFooter) clearBtnFooter.style.display = 'inline-block';

    // 테이블 다시 렌더링 (필터링 적용됨)
    renderActiveQmView();
    showToast(`3D 뷰포트에서 ${selectedQmIds.size}개 수량산출부재를 선택했습니다.`, 'success');
}
```

#### "선택 필터 해제" 함수 수정 (lines 1428-1451):
```javascript
function clearQmSelectionFilter() {
    // 필터 비활성화
    window.isQmFilterToSelectionActive = false;
    window.qmFilteredIds.clear();

    // 버튼 숨기기 (사이드바 버튼과 테이블 하단 버튼 모두)
    const clearBtnSidebar = document.getElementById('qm-clear-selection-filter-btn');
    const clearBtnFooter = document.getElementById('qm-clear-selection-filter-btn-footer');

    if (clearBtnSidebar) clearBtnSidebar.style.display = 'none';
    if (clearBtnFooter) clearBtnFooter.style.display = 'none';

    // 테이블 다시 렌더링 (필터 없이)
    renderActiveQmView();
    showToast('선택 필터가 해제되었습니다.', 'success');
}
```

#### 이벤트 리스너 등록 (lines 89-93):
```javascript
document.getElementById('qm-clear-selection-filter-btn')
    ?.addEventListener('click', clearQmSelectionFilter);
document.getElementById('qm-clear-selection-filter-btn-footer')
    ?.addEventListener('click', clearQmSelectionFilter);
```

#### 기타 오류 수정:
- `updateQmSelectionInfo()` 함수 호출 제거 (정의되지 않은 함수) - lines 1327, 1419
- `clearQmSelection()` 함수에서도 동일 제거

---

**파일**: `connections/static/connections/ui.js`

#### renderActiveQmView 함수에 필터링 로직 추가 (lines 1400-1415):

**변경 전**:
```javascript
function renderActiveQmView(editingMemberId = null) {
    if (activeQmView === 'quantity-member-view') {
        renderRawQmTable(loadedQuantityMembers, editingMemberId);
    } else if (activeQmView === 'cost-code-view') {
        renderCostCodeViewTable(loadedQuantityMembers);
    }
}
```

**변경 후**:
```javascript
function renderActiveQmView(editingMemberId = null) {
    // 필터링 적용: 선택 필터가 활성화되어 있으면 필터링된 데이터만 렌더링
    let dataToRender = loadedQuantityMembers;
    if (window.isQmFilterToSelectionActive && window.qmFilteredIds.size > 0) {
        dataToRender = loadedQuantityMembers.filter(qm => window.qmFilteredIds.has(qm.id));
    }

    if (activeQmView === 'quantity-member-view') {
        renderRawQmTable(dataToRender, editingMemberId);
    } else if (activeQmView === 'cost-code-view') {
        renderCostCodeViewTable(dataToRender);
    }
}
```

---

### 4. 선택 필터 해제 버튼 접근성 개선

**파일**: `connections/templates/revit_control.html`

#### 테이블 하단에 버튼 추가 (lines 1174-1181):

**문제**: 기존 버튼은 왼쪽 사이드바 내부에 위치하여 스크롤이 필요하고 화면 범위를 벗어나면 보이지 않음

**해결**: BIM원본데이터 탭과 동일하게 테이블 바로 아래에 버튼 추가

```html
<div id="qm-table-container" class="qm-table-container">
    <p>프로젝트를 선택하세요.</p>
</div>
<div class="table-footer-controls">
    <button
        id="qm-clear-selection-filter-btn-footer"
        style="display: none"
    >
        선택 필터 해제
    </button>
</div>
```

**결과**:
- 사이드바 버튼: `qm-clear-selection-filter-btn` (기존)
- 테이블 하단 버튼: `qm-clear-selection-filter-btn-footer` (신규)
- 두 버튼 모두 동일한 `clearQmSelectionFilter()` 함수 호출

---

## 데이터 구조 이슈 해결

### 문제: source_element_ids는 존재하지 않음

**콘솔 에러**:
```
[DEBUG][QM] QM: c2cc8fae-4a0d-4e26-8e07-323535578344 source_element_ids: undefined
[DEBUG][QM] BIM IDs to select: []
```

**원인**:
- API는 `raw_element_id` (FK, 단일 값) 및 `split_element_id` (FK, 단일 값)를 반환
- `source_element_ids` (배열)는 존재하지 않는 필드

**수정**:
```javascript
// 변경 전 (잘못됨)
if (qm.source_element_ids && Array.isArray(qm.source_element_ids)) {
    qm.source_element_ids.forEach(elemId => {
        bimIdsToSelect.push(elemId);
    });
}

// 변경 후 (올바름)
const elementId = qm.split_element_id || qm.raw_element_id;
if (elementId) {
    bimIdsToSelect.push(elementId);
}
```

---

## 사용자 워크플로우

### BIM 저작도구 연동
1. Revit/Blender에서 객체 선택
2. **"선택 객체 가져오기"** 클릭
3. 3D 뷰어 내 수량산출부재 리스트에서 해당 항목이 선택됨

### 3D 뷰포트 연동 (필터링)
1. 3D 뷰포트에서 객체 선택 (단일/다중/박스/크로싱)
2. **"3D 선택 객체 가져오기"** 클릭
3. 메인 수량산출부재 탭으로 이동
4. 테이블이 선택된 수량산출부재만 표시되도록 필터링됨
5. 테이블 하단에 **"선택 필터 해제"** 버튼 자동 표시
6. 버튼 클릭 시 필터 해제 및 전체 목록 표시

### 역방향 선택
1. 3D 뷰어 또는 메인 탭의 수량산출부재 테이블에서 항목 선택 (다중 선택 가능)
2. **"선택한 객체 확인"** (BIM 저작도구) 또는 **"3D에서 선택한 객체 확인"** (3D 뷰포트) 클릭
3. 해당 위치에서 관련 객체가 선택됨

---

## 기술적 세부사항

### 필터링 메커니즘

**상태 관리**:
- `window.isQmFilterToSelectionActive` (Boolean): 필터 활성 여부
- `window.qmFilteredIds` (Set): 필터링할 수량산출부재 ID 목록

**렌더링 로직** (`ui.js:renderActiveQmView`):
```javascript
let dataToRender = loadedQuantityMembers;
if (window.isQmFilterToSelectionActive && window.qmFilteredIds.size > 0) {
    dataToRender = loadedQuantityMembers.filter(qm => window.qmFilteredIds.has(qm.id));
}
```

**버튼 표시/숨김**:
- 필터 활성화 시: `display: inline-block`
- 필터 해제 시: `display: none`

### BIM 원본데이터 탭과의 일관성

**동일한 패턴 사용**:
1. 테이블 하단에 필터 해제 버튼 배치
2. 필터 활성 시 버튼 자동 표시/숨김
3. 동일한 버튼 스타일링
4. 동일한 토스트 메시지

**차이점**:
- BIM 데이터: `viewerStates['data-management'].revitFilteredIds`
- 수량산출부재: `window.qmFilteredIds` (전역)

---

## 테스트 시나리오

### 시나리오 1: 3D 뷰포트에서 필터링
1. ✅ 3D 뷰포트에서 객체 1개 선택
2. ✅ "3D 선택 객체 가져오기" 클릭
3. ✅ 테이블에 해당 수량산출부재만 표시됨
4. ✅ 테이블 하단에 "선택 필터 해제" 버튼 표시됨
5. ✅ 버튼 클릭 시 전체 목록 복원
6. ✅ 버튼 자동 숨김

### 시나리오 2: 다중 객체 선택
1. ✅ 3D 뷰포트에서 박스 선택으로 여러 객체 선택
2. ✅ "3D 선택 객체 가져오기" 클릭
3. ✅ 여러 수량산출부재가 필터링되어 표시됨
4. ✅ 토스트 메시지에 선택 개수 표시

### 시나리오 3: BIM 저작도구 연동
1. ✅ Revit/Blender에서 객체 선택
2. ✅ "선택 객체 가져오기" 클릭
3. ✅ 3D 뷰어 내 리스트에서 항목 선택됨
4. ✅ 역방향: 리스트에서 선택 후 "선택한 객체 확인" 클릭
5. ✅ Revit/Blender에서 해당 객체 선택됨

---

## 수정된 파일 요약

### HTML 템플릿
1. **three_d_viewer.html**
   - 3D 뷰어 수량산출부재 탭에 연동 버튼 4개 추가
   - 3D 뷰어 내부 필터 해제 버튼 추가

2. **revit_control.html**
   - 메인 수량산출부재 탭 테이블 하단에 필터 해제 버튼 추가

### JavaScript 파일
1. **three_d_viewer.js**
   - 선택 추적 변수 추가
   - 수량산출부재 리스트 다중 선택 지원
   - 4개 연동 버튼 핸들러 함수 구현
   - 이벤트 리스너 등록

2. **quantity_members_manager.js**
   - `getQmSelectionFrom3DViewer()` 함수 수정 (필터링 로직 추가)
   - `clearQmSelectionFilter()` 함수 수정 (두 버튼 제어)
   - 변수명 오류 수정 (`selectedQmIds`, `window.loadedQuantityMembers`)
   - 데이터 구조 수정 (`raw_element_id` / `split_element_id` 사용)
   - `updateQmSelectionInfo()` 호출 제거 (정의되지 않은 함수)
   - 신규 버튼 이벤트 리스너 등록

3. **ui.js**
   - `renderActiveQmView()` 함수에 필터링 로직 추가

4. **app_core.js**
   - 필터 상태 전역 변수 추가 (`isQmFilterToSelectionActive`, `qmFilteredIds`)

---

## 영향 범위

### 긍정적 영향
- ✅ 3D 뷰어와 메인 수량산출부재 탭 간의 일관된 사용자 경험
- ✅ BIM 저작도구와 3D 뷰포트 간 양방향 연동 가능
- ✅ 필터 해제 버튼 접근성 개선 (테이블 하단 배치)
- ✅ 다중 선택 지원으로 작업 효율성 향상

### 주의사항
- 3D 뷰어 내부의 버튼은 `selectedQuantityMemberIdsInViewer` 사용
- 메인 탭의 버튼은 `selectedQmIds` 사용
- 두 선택 상태는 독립적으로 관리됨

---

## 향후 개선 가능 사항

1. **선택 상태 동기화**
   - 3D 뷰어 내부 선택과 메인 탭 선택을 동기화할지 고려

2. **필터 상태 지속성**
   - 탭 전환 시 필터 상태 유지 여부 검토

3. **다중 필터 조합**
   - 컬럼 필터 + 선택 필터 조합 시 동작 검증 필요

4. **성능 최적화**
   - 대량 데이터 (1000개 이상) 환경에서 필터링 성능 테스트

---

## 결론

3D 뷰어의 수량산출부재 탭에 BIM 저작도구 및 3D 뷰포트 연동 기능을 성공적으로 추가했습니다. 특히 "3D 선택 객체 가져오기" 기능에서 테이블 필터링이 정상 작동하며, 필터 해제 버튼을 테이블 하단에 배치하여 접근성을 크게 개선했습니다. 여러 변수명 및 데이터 구조 오류를 수정하여 안정적인 동작을 보장합니다.
