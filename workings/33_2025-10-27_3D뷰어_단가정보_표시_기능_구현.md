# 33. 3D 뷰어 단가 정보 표시 기능 구현

**날짜**: 2025-10-27
**작업 내용**: 3D 뷰어에서 BIM 객체 선택 시 하단 테이블에 단가 및 금액 정보 표시

## 문제 상황

3D 뷰어에서 BIM 객체를 선택하면 하단 테이블에 관련 산출항목(cost items)이 표시되지만, 단가와 금액 정보가 모두 0으로 나타나는 문제가 발생했습니다.

### 초기 문제
- 수량까지는 정상 표시
- 재료비단가, 노무비단가, 경비단가, 각종 금액이 모두 0으로 표시

## 원인 분석

### 1단계: Cost Code에서 단가 정보 부재
```javascript
// 초기 시도: Cost code에 selected_unit_price_id가 있을 것으로 예상
costCode.selected_unit_price_id  // undefined
costCode.unit_prices             // undefined
```

Cost code API(`/api/cost-codes/`)는 기본 정보만 반환하고 단가 정보는 포함하지 않음.

### 2단계: BOQ Report API 제약
BOQ report API를 사용하려 했으나 그룹핑 기준을 필수로 요구:
```
400 (Bad Request): 하나 이상의 그룹핑 기준을 선택해야 합니다.
```

### 3단계: Cost Item에 unit_price_type_id 부재
Cost items API로 직접 조회하면 `unit_price_type_id`가 없음:
```javascript
item.unit_price_type_id  // undefined
```

### 4단계: 필드명 불일치
Unit prices API에서 반환된 객체의 필드명이 예상과 다름:
```javascript
// 예상 필드명
material_unit_price, labor_unit_price, expense_unit_price

// 실제 필드명
material_cost: "100000.0000"  // 문자열 형태
labor_cost: "0.0000"
expense_cost: "500.0000"
```

## 해결 방법

### 1. 다단계 데이터 로딩 전략

`loadCostItemsWithPrices()` 함수를 구현하여 필요한 모든 데이터를 순차적으로 로드:

```javascript
// Step 1: Cost items 로드
const costItems = await fetch(`/api/cost-items/${projectId}/`);

// Step 2: Cost codes 로드
const costCodes = await fetch(`/api/cost-codes/${projectId}/`);

// Step 3: 각 cost code의 unit prices 병렬 조회
const costCodesWithPrices = await Promise.all(
    costCodes.map(async (cc) => {
        const unitPrices = await fetch(
            `/api/unit-prices/${projectId}/${cc.id}/`
        );
        return { ...cc, unit_prices: unitPrices };
    })
);
```

### 2. Cost Item Enrichment

Cost item에 단가 정보를 추가:

```javascript
costItemsWithPrices = costItems.map(item => {
    // Cost code 매칭 (cost_code_name에서 코드 추출)
    const codeMatch = item.cost_code_name.match(/^([^\s-]+)/);
    const code = codeMatch[1].trim();
    const costCode = costCodesWithPrices.find(cc => cc.code === code);

    // Unit price 선택 (첫 번째 단가 사용)
    const firstUnitPrice = costCode.unit_prices[0];

    // 올바른 필드명 사용
    const materialUnitPrice = parseFloat(firstUnitPrice.material_cost) || 0;
    const laborUnitPrice = parseFloat(firstUnitPrice.labor_cost) || 0;
    const expenseUnitPrice = parseFloat(firstUnitPrice.expense_cost) || 0;

    const quantity = parseFloat(item.quantity) || 0;

    return {
        ...item,
        cost_code_code: costCode.code,
        work_type: costCode.category,
        spec: costCode.spec,
        unit: costCode.unit,
        material_cost_unit: materialUnitPrice,
        labor_cost_unit: laborUnitPrice,
        expense_cost_unit: expenseUnitPrice,
        total_cost_unit: materialUnitPrice + laborUnitPrice + expenseUnitPrice,
        material_cost_total: materialUnitPrice * quantity,
        labor_cost_total: laborUnitPrice * quantity,
        expense_cost_total: expenseUnitPrice * quantity,
        total_cost_total: (materialUnitPrice + laborUnitPrice + expenseUnitPrice) * quantity
    };
});
```

### 3. 테이블 렌더링

Enriched cost items를 사용하여 테이블 표시:

```javascript
function displayCostItems(object) {
    // BIM object → Quantity members → Cost items 조회
    const quantityMembers = findQuantityMembersByRawElementId(bimObjectId);
    const qmIds = quantityMembers.map(qm => qm.id);

    // Enriched cost items에서 매칭되는 항목 필터링
    const matchingCostItems = costItemsWithPrices.filter(item => {
        return qmIds.some(id => id.toString() === item.quantity_member_id.toString());
    });

    // 테이블 렌더링
    matchingCostItems.forEach(item => {
        html += `<tr>`;
        html += `<td>${item.cost_code_code}</td>`;
        html += `<td>${item.work_type}</td>`;
        html += `<td>${item.cost_code_name}</td>`;
        html += `<td>${item.spec}</td>`;
        html += `<td>${item.unit}</td>`;
        html += `<td class="number">${formatNumber(item.quantity)}</td>`;
        html += `<td class="number">${formatNumber(item.material_cost_unit)}</td>`;
        html += `<td class="number">${formatNumber(item.material_cost_total)}</td>`;
        html += `<td class="number">${formatNumber(item.labor_cost_unit)}</td>`;
        html += `<td class="number">${formatNumber(item.labor_cost_total)}</td>`;
        html += `<td class="number">${formatNumber(item.expense_cost_unit)}</td>`;
        html += `<td class="number">${formatNumber(item.expense_cost_total)}</td>`;
        html += `<td class="number">${formatNumber(item.total_cost_unit)}</td>`;
        html += `<td class="number">${formatNumber(item.total_cost_total)}</td>`;
        html += `</tr>`;
    });
}
```

## 수정된 파일

### 1. `connections/static/connections/three_d_viewer.js`

**추가된 기능:**
- `window.loadCostItemsWithPrices()`: 단가 정보를 포함한 cost items 로드
- Cost items enrichment 로직
- 올바른 필드명 사용 (`material_cost`, `labor_cost`, `expense_cost`)

**수정된 함수:**
- `displayCostItems()`: Enriched cost items를 사용하도록 변경

### 2. `connections/static/connections/navigation.js`

3D viewer 탭 활성화 시 단가 정보 로드:

```javascript
case 'three-d-viewer':
    if (typeof loadQuantityMembers === 'function') {
        loadQuantityMembers();
    }
    // 단가 정보를 포함한 cost items 로드
    if (typeof window.loadCostItemsWithPrices === 'function') {
        window.loadCostItemsWithPrices();
    }
    break;
```

## 데이터 흐름

```
3D Viewer Tab 활성화
    ↓
loadCostItemsWithPrices() 실행
    ↓
1. Cost Items API 호출 (4개 항목)
    ↓
2. Cost Codes API 호출 (53개 코드)
    ↓
3. 각 Cost Code의 Unit Prices API 병렬 호출
    ↓
4. Cost Items Enrichment
   - Cost code 매칭 (코드 파싱)
   - Unit price 추출 (material_cost, labor_cost, expense_cost)
   - 금액 계산 (단가 × 수량)
    ↓
BIM 객체 선택
    ↓
Quantity Members 조회
    ↓
Enriched Cost Items 필터링
    ↓
테이블 렌더링 (단가 및 금액 포함)
```

## 주요 교훈

1. **API 응답 구조 확인**: 필드명과 데이터 타입을 반드시 확인
2. **다단계 데이터 로딩**: 여러 API를 조합하여 필요한 데이터 구성
3. **병렬 처리**: `Promise.all()`을 사용하여 성능 최적화
4. **데이터 Enrichment**: 원본 데이터에 계산된 값을 추가하여 사용
5. **Fallback 로직**: `unit_price_type_id`가 없을 때를 대비한 fallback 구현

## 결과

- ✅ 3D viewer에서 BIM 객체 선택 시 정확한 단가 정보 표시
- ✅ 재료비, 노무비, 경비 단가 및 금액 정상 계산
- ✅ 합계 금액 정상 표시
- ✅ 성능: 53개 cost code의 unit prices를 병렬로 빠르게 로드

## 참고 API 엔드포인트

- `/connections/api/cost-items/{project_id}/`
- `/connections/api/cost-codes/{project_id}/`
- `/connections/api/unit-prices/{project_id}/{cost_code_id}/`
