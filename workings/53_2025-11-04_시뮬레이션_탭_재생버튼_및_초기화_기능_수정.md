# 53. 시뮬레이션 탭 재생 버튼 및 초기화 기능 수정

**날짜**: 2025-11-04
**작업자**: Claude Code
**관련 이슈**: 시뮬레이션 탭의 재생 버튼 미작동 및 초기화 버튼의 색상 복원 실패

## 작업 개요

시뮬레이션 탭에서 공정 시뮬레이션 기능의 두 가지 주요 버그를 수정했습니다:
1. **재생 버튼 미작동**: 버튼 클릭 시 아무런 반응이 없는 문제
2. **초기화 버튼의 재질 복원 실패**: 파란색(진행중) 효과가 제거되지 않는 문제

## 문제 분석

### 1. 재생 버튼 미작동 원인

**증상**:
- 재생 버튼이 DOM에서 발견됨 (`found: true`)
- `onclick` 핸들러가 정상적으로 설정됨
- 그러나 클릭 이벤트가 전혀 발생하지 않음

**원인 분석**:
```html
<!-- 첫 번째 버튼 (viewer-schedule-controls) -->
<button id="sim-play-btn">▶ 재생</button>

<!-- 두 번째 버튼 (simulation-controls-panel in gantt chart tab) -->
<button id="sim-play-btn">▶ 재생</button>
```

- HTML에 **동일한 ID를 가진 버튼이 2개** 존재
- `document.getElementById('sim-play-btn')`는 첫 번째 버튼만 반환
- 사용자가 클릭하는 버튼은 두 번째 버튼 (간트차트 탭 내부)
- 이벤트 리스너는 첫 번째 버튼에만 연결됨
- 결과: 클릭 이벤트 발생하지 않음

### 2. 초기화 버튼의 재질 복원 실패 원인

**증상**:
```
[Simulation Scene] Saving original material for object.id: 16
[Simulation Scene] workingMaterials size after save: 1

[3D Viewer] showAll called
[3D Viewer] originalMaterials size: 0
[3D Viewer] No original material found for object
```

**원인 분석**:
```javascript
// 재질 저장 시 (applyConstructionScheduleFilterWithColors)
const workingMaterials = isSimulationScene ? simOriginalMaterials : originalMaterials;
// → 시뮬레이션 탭에서는 simOriginalMaterials에 저장 (size: 1)

// 재질 복원 시 (showAll)
if (originalMaterials.has(object.id)) { ... }
// → 항상 originalMaterials만 확인 (size: 0)
```

- 재질은 `simOriginalMaterials`에 저장되었지만
- 복원 시에는 `originalMaterials`만 확인
- 두 맵은 별개의 객체 (`originalMaterials === simOriginalMaterials: false`)
- 결과: 저장된 재질을 찾을 수 없어 파란색이 제거되지 않음

## 수정 내용

### 1. HTML: 중복된 버튼 제거

**파일**: `connections/templates/three_d_viewer.html`

**변경사항**:
```html
<!-- BEFORE: viewer-schedule-controls에 시뮬레이션 컨트롤이 중복으로 있었음 -->
<div id="viewer-schedule-controls">
    <div>
        <div>공정 기준일 선택</div>
        <div>시뮬레이션 컨트롤 (재생, 일시정지, 정지 버튼들)</div> <!-- 삭제 -->
    </div>
</div>

<!-- AFTER: 시뮬레이션 컨트롤은 간트차트 탭에만 유지 -->
<div id="viewer-schedule-controls">
    <div>
        <div>공정 기준일 선택</div>
        <!-- 시뮬레이션 컨트롤 제거 -->
    </div>
</div>

<!-- 간트차트 탭 내부의 시뮬레이션 컨트롤만 유지 -->
<div id="simulation-controls-panel">
    <div>
        <button id="sim-play-btn">▶ 재생</button>
        <button id="sim-pause-btn">⏸ 일시정지</button>
        <button id="sim-stop-btn">⏹ 정지</button>
        <!-- ... -->
    </div>
</div>
```

**효과**:
- 이제 `sim-play-btn`은 HTML에 1개만 존재
- `getElementById`가 올바른 버튼을 반환
- 이벤트 리스너가 정상적으로 작동

### 2. JavaScript: showAll() 함수 수정

**파일**: `connections/static/connections/three_d_viewer.js`

**변경 위치**: `three_d_viewer.js:7259-7318`

**변경사항**:
```javascript
// BEFORE: originalMaterials만 확인
function showAll() {
    scene.traverse((object) => {
        if (object.isMesh) {
            if (originalMaterials.has(object.id)) {
                // 재질 복원
            }
        }
    });
    hiddenObjectIds.clear();
}

// AFTER: simOriginalMaterials와 originalMaterials 둘 다 확인
function showAll() {
    scene.traverse((object) => {
        if (object.isMesh) {
            let materialRestored = false;

            // 1. 먼저 simOriginalMaterials 확인 (시뮬레이션 탭용)
            if (simOriginalMaterials.has(object.id)) {
                const originalMaterial = simOriginalMaterials.get(object.id);
                object.material = originalMaterial;
                object.material.needsUpdate = true;
                simOriginalMaterials.delete(object.id);
                materialRestored = true;
            }
            // 2. 없으면 originalMaterials 확인 (일반 뷰어용)
            else if (originalMaterials.has(object.id)) {
                const originalMaterial = originalMaterials.get(object.id);
                object.material = originalMaterial;
                object.material.needsUpdate = true;
                originalMaterials.delete(object.id);
                materialRestored = true;
            }
        }
    });

    hiddenObjectIds.clear();
    simHiddenObjectIds.clear(); // 시뮬레이션 hidden IDs도 클리어
}
```

**주요 개선사항**:
1. **두 재질 맵 모두 확인**: `simOriginalMaterials` → `originalMaterials` 순서로 확인
2. **시뮬레이션 전용 맵 우선**: 시뮬레이션 탭에서 저장된 재질을 먼저 찾음
3. **폴백 지원**: 일반 뷰어에서 저장된 재질도 복원 가능
4. **완전한 초기화**: `simHiddenObjectIds`도 함께 클리어

### 3. 디버깅 로그 추가

**파일**: `connections/static/connections/three_d_viewer.js`

**추가된 로그**:

1. **재질 저장 시 (line 8179-8187)**:
```javascript
console.log(sceneType, '[DEBUG] Reference check - workingMaterials === originalMaterials:',
    workingMaterials === originalMaterials);
console.log(sceneType, '[DEBUG] workingMaterials === simOriginalMaterials:',
    workingMaterials === simOriginalMaterials);
console.log(sceneType, '[DEBUG] workingMaterials size BEFORE clear:', workingMaterials.size);
console.log(sceneType, '[DEBUG] originalMaterials size BEFORE clear:', originalMaterials.size);
```

2. **재질 복원 시 (line 7264-7266)**:
```javascript
console.log('[3D Viewer] [DEBUG] Checking global material maps:');
console.log('[3D Viewer] [DEBUG] originalMaterials size:', originalMaterials.size);
console.log('[3D Viewer] [DEBUG] simOriginalMaterials size:', simOriginalMaterials.size);
```

3. **재질 복원 상세 로그 (line 7290, 7300)**:
```javascript
console.log('[3D Viewer] Restoring material from simOriginalMaterials for object:', objectId);
console.log('[3D Viewer] Restoring material from originalMaterials for object:', objectId);
```

## 테스트 시나리오

### 재생 버튼 테스트
1. 시뮬레이션 탭 클릭
2. 공정표 서브탭 클릭
3. 재생 버튼 클릭
4. ✅ 예상 결과: 시뮬레이션 시작 로그 출력, 날짜가 자동으로 진행됨

### 초기화 버튼 테스트
1. 시뮬레이션 탭에서 간트차트의 날짜 클릭 (예: 2025-11-05)
2. ✅ 3D 뷰포트에서 객체가 파란색으로 표시됨
3. 간트차트가 해당 날짜만 필터링되어 표시됨
4. 초기화 버튼 클릭
5. ✅ 예상 결과:
   - 파란색 효과 제거됨
   - 숨겨진 객체 다시 표시됨
   - 간트차트가 전체 일정 표시
   - BOQ 테이블 초기화
   - 로그에 "Restoring material from simOriginalMaterials" 출력

### 로그 검증
```
# 날짜 클릭 시
[Simulation Scene] [DEBUG] workingMaterials === simOriginalMaterials: true
[Simulation Scene] [DEBUG] Saving original material for object.id: 16
[Simulation Scene] [DEBUG] workingMaterials size after save: 1

# 초기화 버튼 클릭 시
[3D Viewer] [DEBUG] simOriginalMaterials size: 1
[3D Viewer] Restoring material from simOriginalMaterials for object: 3d8d9464...
[3D Viewer] Restored materials: 1 objects
```

## 영향 범위

### 수정된 파일
1. `connections/templates/three_d_viewer.html` - 중복 버튼 제거
2. `connections/static/connections/three_d_viewer.js` - showAll() 함수 수정

### 영향받는 기능
- ✅ 시뮬레이션 재생/일시정지/정지 기능
- ✅ 시뮬레이션 초기화 기능
- ✅ 3D 뷰포트의 객체 색상 관리
- ✅ 간트차트 날짜 필터링

### 호환성
- 기존 일반 3D 뷰어 기능: 영향 없음 (originalMaterials 폴백 지원)
- 데이터 관리 3D 뷰어: 영향 없음
- 다른 탭들: 영향 없음

## 기술적 세부사항

### 재질 맵 구조
```javascript
// 전역 변수
let originalMaterials = new Map();      // 일반 3D 뷰어용
let simOriginalMaterials = new Map();   // 시뮬레이션 탭용

// 객체 구조
// Map<mesh.id, THREE.Material>
// 예: Map { 16 => MeshStandardMaterial {...}, 18 => MeshStandardMaterial {...} }
```

### 재질 저장/복원 흐름
```
1. 날짜 클릭
   → applyConstructionScheduleFilterWithColors('2025-11-05')
   → workingMaterials = simOriginalMaterials (시뮬레이션 탭)
   → simOriginalMaterials.set(mesh.id, mesh.material)
   → mesh.material = blueMaterial (파란색 적용)

2. 초기화 버튼 클릭
   → showAll()
   → simOriginalMaterials.has(mesh.id) ✅
   → mesh.material = simOriginalMaterials.get(mesh.id)
   → simOriginalMaterials.delete(mesh.id)
   → 원본 재질로 복원됨
```

### 버튼 ID 정리
**제거된 버튼들** (viewer-schedule-controls 내부):
- `sim-play-btn` (중복)
- `sim-pause-btn` (중복)
- `sim-stop-btn` (중복)
- `sim-speed` (중복)
- `sim-interval` (중복)
- `sim-current-date` (중복)

**유지된 버튼들** (simulation-controls-panel 내부):
- `sim-play-btn` (유일)
- `sim-pause-btn` (유일)
- `sim-stop-btn` (유일)
- `sim-speed` (유일)
- `sim-interval` (유일)
- `sim-current-date` (유일)
- `sim-cutoff-date` (날짜 입력)
- `apply-sim-date-btn` (적용 버튼)
- `reset-sim-date-btn` (초기화 버튼)

## 관련 커밋

- 이전 작업: 52_2025-11-03_액티비티객체_연동_및_테이블_선택방식_통일.md
- 관련 기능: 공정 시뮬레이션, 간트차트, 3D 뷰어 색상 필터링

## 추가 개선 사항 제안

1. **재질 맵 통합**: `originalMaterials`와 `simOriginalMaterials`를 하나로 통합하고 scene 참조로 구분
2. **버튼 상태 관리**: 시뮬레이션 진행 중 버튼 활성화/비활성화 로직 개선
3. **에러 핸들링**: 재질 복원 실패 시 사용자에게 알림
4. **성능 최적화**: 대량의 객체가 있을 때 재질 복원 성능 개선

## 참고 사항

- 이 수정으로 시뮬레이션 탭의 핵심 기능인 재생과 초기화가 정상 작동합니다
- 디버깅 로그는 향후 제거하거나 조건부로 활성화할 수 있습니다
- HTML ID 중복은 W3C 표준 위반이므로 향후 유사한 문제 예방을 위해 코드 리뷰 시 확인 필요
