# 3D 뷰어 선택 정교화 및 호버 효과

**날짜**: 2025-10-30
**작업자**: Claude Code

## 개요

3D 뷰어의 선택 시스템을 대폭 개선하여 정확성과 사용자 경험을 향상시켰습니다.

## 구현된 개선사항

### 1. 호버 효과 (Hover Highlight)

마우스를 객체 위에 올렸을 때 시각적 피드백을 제공합니다.

**동작 방식:**
- 마우스가 객체 위로 이동하면 **라이트 시안 색상**으로 하이라이트
- 클릭하기 전에 어떤 객체가 선택될지 미리 확인 가능
- 포인터가 캔버스를 벗어나면 자동으로 호버 효과 제거
- 이미 선택된 객체는 호버 효과가 적용되지 않음

**시각적 속성:**
```javascript
const hoverMaterial = new THREE.MeshStandardMaterial({
    color: 0x4dd0e1,           // Light cyan (밝은 청록색)
    emissive: 0x00bcd4,        // Cyan glow
    emissiveIntensity: 0.3,
    metalness: 0.0,
    roughness: 1.0,
    flatShading: true,
    transparent: true,
    opacity: 0.6,
    side: THREE.DoubleSide
});
```

**상태 관리:**
```javascript
let hoveredObject = null;  // 현재 호버된 객체

// 새 객체로 호버 변경 시
if (newHoveredObject !== hoveredObject) {
    // 이전 호버 제거
    if (hoveredObject) {
        hoveredObject.material = originalMaterials.get(hoveredObject);
    }
    // 새 호버 적용
    hoveredObject = newHoveredObject;
}
```

### 2. 뷰포트 필터링 (Viewport Filtering)

화면에 실제로 보이는 객체만 선택 가능하도록 개선했습니다.

**필터 조건:**
1. `object.visible === true`: 숨겨진 객체 제외
2. `screenPos.z < 1 && screenPos.z > -1`: 카메라 뷰 범위 내
3. 카메라 뒤쪽 객체 자동 제외

**적용 범위:**
- 클릭 선택
- 박스 선택
- 호버 감지

**구현 예시:**
```javascript
scene.traverse(function(object) {
    if (object instanceof THREE.Mesh &&
        object.userData &&
        (object.userData.bimObjectId || object.userData.isSplitPart || object.userData.isSplitElement) &&
        object.visible) {  // ← 핵심: visible 체크
        bimMeshes.push(object);
    }
});

// 카메라 앞에 있는지 확인
const screenPos = worldPos.clone().project(camera);
if (screenPos.z < 1 && screenPos.z > -1) {  // ← 뷰포트 내
    // 선택 가능
}
```

### 3. 정밀한 박스 선택 (Precise Box Selection)

바운딩 박스의 모든 꼭짓점을 검사하여 정확도를 크게 향상시켰습니다.

**기존 방식의 문제:**
```javascript
// ❌ 기존: 객체 중심점만 검사
const worldPos = mesh.getWorldPosition();
if (centerIsInBox) {
    select(mesh);  // 부정확!
}
```

**개선된 방식:**
```javascript
// ✅ 개선: 바운딩 박스 8개 꼭짓점 모두 검사
const corners = [
    new THREE.Vector3(bbox.min.x, bbox.min.y, bbox.min.z),
    new THREE.Vector3(bbox.max.x, bbox.min.y, bbox.min.z),
    new THREE.Vector3(bbox.min.x, bbox.max.y, bbox.min.z),
    new THREE.Vector3(bbox.max.x, bbox.max.y, bbox.min.z),
    new THREE.Vector3(bbox.min.x, bbox.min.y, bbox.max.z),
    new THREE.Vector3(bbox.max.x, bbox.min.y, bbox.max.z),
    new THREE.Vector3(bbox.min.x, bbox.max.y, bbox.max.z),
    new THREE.Vector3(bbox.max.x, bbox.max.y, bbox.max.z)
];

for (let corner of corners) {
    const worldCorner = corner.clone().applyMatrix4(mesh.matrixWorld);
    const screenPos = worldCorner.clone().project(camera);

    // 하나라도 박스 안에 있으면 선택
    if (isInBox(screenPos)) {
        select(mesh);
        break;
    }
}
```

**개선 효과:**
- 부분적으로만 보이는 큰 객체도 정확히 선택 가능
- 객체 중심이 박스 밖에 있어도 일부가 걸치면 선택됨
- 겹쳐진 객체 선택 정확도 향상
- 작은 박스로도 큰 객체 선택 가능

## 기술적 세부사항

### 이벤트 핸들러 구조

```
onPointerDown()
    ↓
onPointerMove()  ← 드래그 중이면 박스 업데이트
    ↓              드래그 중이 아니면 호버 감지
onPointerUp()    ← 드래그면 박스 선택, 아니면 클릭 선택

onPointerLeave() ← 캔버스 벗어남, 호버 제거
```

### 호버 감지 로직

```javascript
function onPointerMove(event) {
    if (dragStart) {
        // 드래그 중: 박스 선택 UI 업데이트
        updateSelectionBoxUI();
    } else {
        // 호버 모드: raycaster로 객체 감지
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(bimMeshes, true);

        // 첫 번째 유효한 객체에 호버 효과 적용
        updateHoverState(intersects[0]);
    }
}
```

### 바운딩 박스 변환 과정

```
Local Space (객체 좌표계)
    ↓ applyMatrix4(mesh.matrixWorld)
World Space (월드 좌표계)
    ↓ clone().project(camera)
NDC Space (정규화된 장치 좌표: -1 to 1)
    ↓ 화면 좌표 변환
Screen Space (픽셀 좌표)
```

## 변경된 파일

### `connections/static/connections/three_d_viewer.js`

**추가된 변수:**
```javascript
let hoveredObject = null;  // 호버된 객체 추적
```

**추가된 함수:**
```javascript
onPointerLeave()  // 캔버스를 떠날 때 호버 제거
```

**수정된 함수:**
```javascript
onPointerMove()           // 호버 감지 로직 추가
performBoxSelection()     // 8개 꼭짓점 기반 교차 검사
performClickSelection()   // visible 필터링 추가
```

**추가된 이벤트 리스너:**
```javascript
canvas.addEventListener('pointerleave', onPointerLeave, false);
```

## 사용자 경험 개선

### Before (개선 전)

❌ 마우스를 올려도 어떤 객체가 선택될지 모름
❌ 박스 선택 시 객체 중심이 박스 밖이면 선택 안 됨
❌ 화면 밖이나 카메라 뒤의 객체도 선택됨
❌ 큰 객체는 작은 박스로 선택 불가능

### After (개선 후)

✅ 호버 시 라이트 시안 색상으로 미리 표시
✅ 객체 일부만 걸쳐도 정확히 선택됨
✅ 화면에 보이는 객체만 선택 가능
✅ 바운딩 박스 꼭짓점 기반으로 정확한 선택

## 성능 고려사항

### 호버 감지
- `pointermove` 이벤트마다 raycaster 실행
- 드래그 중에는 호버 감지 비활성화로 성능 절약
- 첫 번째 교차 객체만 확인 (break 사용)

### 박스 선택
- 각 객체당 8개 꼭짓점 검사
- 하나라도 박스 안에 있으면 즉시 break
- `computeBoundingBox()` 결과 캐싱 활용
- O(n * 8) 복잡도이지만 실용적인 성능

### 최적화 기법
```javascript
// ✅ 조기 종료로 불필요한 계산 방지
for (let corner of corners) {
    if (isInBox(corner)) {
        isInBox = true;
        break;  // ← 즉시 종료
    }
}

// ✅ visible 객체만 순회
if (object.visible) {  // ← 숨겨진 객체 스킵
    // 검사 수행
}
```

## 테스트 시나리오

### 시나리오 1: 호버 효과
1. ✅ 마우스를 객체 위로 이동 → 라이트 시안 색상 표시
2. ✅ 다른 객체로 이동 → 이전 객체 원래 색상, 새 객체 호버
3. ✅ 캔버스 밖으로 이동 → 호버 효과 제거
4. ✅ 선택된 객체는 호버 효과 없음 (주황색 유지)

### 시나리오 2: 뷰포트 필터링
1. ✅ 카메라 회전으로 객체를 화면 밖으로 → 선택 불가
2. ✅ 숨김 처리된 객체 → 호버 및 선택 불가
3. ✅ 카메라 뒤쪽 객체 → 박스 선택 시 제외

### 시나리오 3: 정밀한 박스 선택
1. ✅ 큰 객체를 작은 박스로 모서리만 선택 → 선택됨
2. ✅ 객체 중심이 박스 밖이지만 일부 걸침 → 선택됨
3. ✅ 겹쳐진 여러 객체 → 모두 정확히 선택됨
4. ✅ 박스와 전혀 안 겹치는 객체 → 선택 안 됨

### 시나리오 4: 통합 테스트
1. ✅ 호버로 객체 확인 → 클릭 선택 → 주황색 하이라이트
2. ✅ Ctrl+클릭으로 여러 객체 추가 → 모두 호버 없이 주황색
3. ✅ 박스 드래그 중 호버 효과 없음 → 박스만 표시
4. ✅ BOQ "뷰어 선택 가져오기" → 정확히 필터링

## 색상 체계

| 상태 | 색상 | 용도 |
|------|------|------|
| 호버 | Light Cyan (0x4dd0e1) | 선택 대기 상태 |
| 선택 | Orange (0xff8800) | 선택된 객체 |
| 선택 박스 | Green (0x4CAF50) | 드래그 영역 표시 |
| 기본 | 원본 재질 | 일반 상태 |

## 알려진 제한사항

1. **호버 성능**: 복잡한 씬에서 `pointermove` 이벤트가 많이 발생하면 성능 영향 가능
   - 현재는 드래그 중 호버 비활성화로 최소화

2. **바운딩 박스 정확도**: 회전된 객체의 바운딩 박스는 월드 축 정렬되어 실제보다 클 수 있음
   - 대부분의 경우 문제없이 작동

3. **투명 객체**: 완전히 투명한 객체도 선택 가능
   - `object.visible` 속성으로 제어 가능

## 향후 개선 방향

1. **호버 성능 최적화**
   - Throttle 적용 (예: 100ms마다만 호버 감지)
   - 마지막 호버 객체 캐싱으로 불필요한 재질 변경 방지

2. **선택 정확도**
   - OBB (Oriented Bounding Box) 사용 검토
   - 실제 지오메트리 교차 검사 (더 정확하지만 느림)

3. **시각적 개선**
   - 호버 시 툴팁으로 객체 이름 표시
   - 선택 박스 테두리 애니메이션

4. **접근성**
   - 키보드 단축키로 호버/선택 토글
   - 화면 리더 지원

## 커밋

- Commit: 64ba6bd
- 파일: 1개 변경 (171 insertions, 31 deletions)
- Push: origin/main

## 참고

- Three.js Raycaster: 3D 공간에서 마우스 위치의 객체 감지
- Screen Space Projection: 3D 좌표를 2D 화면 좌표로 변환
- Bounding Box: 객체를 감싸는 최소 직육면체
- NDC (Normalized Device Coordinates): -1 ~ 1 범위의 정규화된 좌표계
