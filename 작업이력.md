# 작업 이력

- **날짜 및 시간:** 2025년 10월 22일

---

## 프로그램 개요

이 프로그램은 BIM(Building Information Modeling) 데이터를 기반으로 공사 비용을 산출하고 관리하는 **BIM 기반 수량산출 및 공사비 예측 시스템**입니다.

주요 기능은 다음과 같습니다.
- Revit 등 BIM 툴과의 데이터 연동
- 사용자 정의 규칙(Ruleset) 기반의 BIM 객체 자동 분류 및 속성 부여
- 수량 산출, 집계, 내역서 생성
- AI 모델을 활용한 개략 견적(Schematic Design) 비용 예측
- 프로젝트 데이터의 가져오기/내보내기

---

## 주요 수정 및 개선 사항 (2025-10-22)

### 1. AI 모델 학습 및 예측 기능 안정화

- **`NaN` 오류 해결 (기울기 폭발 문제):**
  - **문제점:** AI 모델 학습 시, 출력값의 스케일이 너무 커서 손실(loss)이 비정상적으로 증가하며 `NaN`(Not a Number)으로 발산, 학습이 중단되는 현상이 발생했습니다.
  - **해결책:** 학습 시 출력(Target) 데이터에 대해서도 **정규화(Standard Scaling)**를 적용하고, 예측 시에는 원래 스케일로 복원하도록 수정하여 모델 학습 과정을 안정화했습니다.

- **f-string 포맷 오류 수정:**
  - **문제점:** 학습 완료 후 결과를 메시지로 만드는 과정에서 f-string 구문 오류로 인해 서버 에러가 발생했습니다.
  - **해결책:** 해당 코드의 문자열 포맷팅 구문을 올바르게 수정했습니다.

### 2. AI 예측 결과 시각화 개선

- **정규분포 그래프 데이터 추가:**
  - **요청사항:** AI 예측 결과의 신뢰도를 시각적으로 파악할 수 있도록 정규분포 그래프 표시를 요청했습니다.
  - **개선점:** 예측 API(`predict_sd_cost`)가 예측값(평균)과 테스트 오차율(표준편차)을 기반으로 **정규분포 곡선을 그리는 데 필요한 좌표 데이터**를 생성하여 API 응답에 포함하도록 수정했습니다. 이를 통해 프론트엔드에서 예측 결과와 오차 범위를 그래프로 시각화할 수 있습니다.

### 3. 대용량 데이터 처리 성능 및 안정성 향상

- **`too many SQL variables` 오류 해결:**
  - **문제점:** 수만 건 이상의 대규모 BIM 데이터를 처리하는 '룰셋 일괄적용', '일괄 자동 업데이트' 등의 기능 실행 시, 한 번의 DB 요청에 너무 많은 변수가 포함되어 데이터베이스(SQLite) 처리 한계를 초과하는 오류가 발생했습니다.
  - **해결책:** 대량의 데이터를 한 번에 처리하는 대신, **500개씩 작은 묶음(Chunk)으로 나누어 순차적으로 처리**하도록 아래의 모든 관련 함수를 수정했습니다. 이를 위해 Django의 `.iterator()` 기능을 적용하여 메모리 사용량을 최소화하고 DB 부하를 줄였습니다.
    - `apply_classification_rules_view` (룰셋 일괄적용)
    - `create_quantity_members_auto_view` (자동생성 - 분류 기준)
    - `apply_assignment_rules_view` (할당 룰셋 일괄적용)
    - `create_cost_items_auto_view` (자동생성 - 공사코드 기준)
    - `update_cost_item_unit_price_type` (일괄 자동 업데이트)
    - `generate_boq_report_api` (집계표 생성)

- **집계표 `report: null` 오류 해결:**
  - **문제점:** 상기 성능 개선 작업 중 실수로 `generate_boq_report_api` 함수의 최종 데이터 변환 로직이 누락되어 집계표 데이터가 `null`로 반환되는 문제가 발생했습니다.
  - **해결책:** 누락되었던 데이터 변환 로직을 복원하여 집계표가 정상적으로 생성되도록 수정했습니다.
