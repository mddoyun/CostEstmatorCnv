<!DOCTYPE html>
<html>
    <head>
        <title>COST ESTIMATOR(DD)</title>
        {% load static %}
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">
        <link
            rel="stylesheet"
            type="text/css"
            href="{% static 'connections/style.css' %}?v=3"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
        <!-- Three.js 글로벌 로드 (r140 - 안정적인 글로벌 스크립트 버전) -->
        <script src="https://cdn.jsdelivr.net/npm/three@0.140.0/build/three.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.140.0/examples/js/controls/OrbitControls.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.140.0/examples/js/utils/BufferGeometryUtils.js"></script>
        <!-- CSG library for geometry splitting -->
        <script src="{% static 'connections/ThreeBSP.js' %}"></script>
    </head>

    <body>
        <div id="toast-container"></div>
        <input
            type="file"
            id="csv-file-input"
            accept=".csv"
            style="display: none"
        />
        <input
            type="file"
            id="project-import-input"
            accept=".json"
            style="display: none"
        />

        <div class="app-container">
            <header class="app-header">
                <div class="header-left">
                    <h1>COST ESTIMATOR & SCHEDULER</h1>
                    <div id="connector-mode-selector">
                        <label
                            ><input
                                type="radio"
                                name="connector_mode"
                                value="revit"
                                checked
                            />
                            Revit 모드</label
                        >
                        <label
                            ><input
                                type="radio"
                                name="connector_mode"
                                value="blender"
                            />
                            Blender 모드</label
                        >
                    </div>
                </div>
                <div class="header-center">
                    {% csrf_token %}
                    <label for="project-selector">Project:</label>
                    <select id="project-selector">
                        <option value="">-- 프로젝트 선택 --</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}">
                            {{ project.name }}
                        </option>
                        {% endfor %}
                    </select>

                    <button id="project-export-btn" style="margin-left: 10px">
                        프로젝트 내보내기
                    </button>
                    <button id="project-import-btn">프로젝트 가져오기</button>
                    <input
                        type="text"
                        id="new-project-name"
                        placeholder="새 프로젝트 이름..."
                    />
                    <button id="create-project-btn">새 프로젝트</button>
                    <button
                        id="batch-auto-update-btn"
                        style="
                            margin-left: 10px;
                            background-color: #ffc107;
                            font-weight: bold;
                        "
                    >
                        일괄 자동 업데이트
                    </button>
                </div>
                <div class="header-right">
                    <div id="progress-container">
                        <progress
                            id="data-fetch-progress"
                            value="0"
                            max="100"
                        ></progress>
                        <span id="progress-status-text">대기중</span>
                    </div>
                    <div id="status-container">
                        <span id="status">서버 연결 대기중...</span>
                    </div>
                </div>
            </header>
            <nav class="main-nav">
                <button class="nav-button active" data-primary-tab="home">
                    🏠 홈
                </button>
                <button class="nav-button" data-primary-tab="management">
                    🗂️ 관리
                </button>
                <button class="nav-button" data-primary-tab="takeoff">
                    🧱 작업
                </button>
                <button class="nav-button" data-primary-tab="results">
                    📈 결과
                </button>
            </nav>
            <div class="secondary-nav-container">
                <nav id="secondary-nav-management" class="secondary-nav">
                    <button class="sub-nav-button" data-tab="tag-management">
                        🏷️ 수량산출분류 관리
                    </button>
                    <button
                        class="sub-nav-button"
                        data-tab="member-mark-management"
                    >
                        📋 일람부호 관리
                    </button>
                    <button class="sub-nav-button" data-tab="space-management">
                        🏢 공간분류 관리
                    </button>
                    <button
                        class="sub-nav-button"
                        data-tab="cost-code-management"
                    >
                        💰 공사코드 관리
                    </button>
                    <button
                        class="sub-nav-button"
                        data-tab="unit-price-management"
                    >
                        💲 단가 관리
                    </button>
                    <button class="sub-nav-button" data-tab="activity-management">
                        📅 액티비티 관리
                    </button>
                    <button
                        class="sub-nav-button"
                        data-tab="ruleset-management"
                    >
                        📜 룰셋 관리
                    </button>
                    <button class="sub-nav-button" data-tab="ai-model-manager">
                        🧠 AI 모델 관리
                    </button>
                </nav>
                <nav id="secondary-nav-takeoff" class="secondary-nav">
                    <button class="sub-nav-button" data-tab="data-management">
                        📊 BIM원본데이터
                    </button>
                    <button class="sub-nav-button" data-tab="quantity-members">
                        🧱 수량산출부재
                    </button>
                    <button
                        class="sub-nav-button"
                        data-tab="cost-item-management"
                    >
                        💰 코스트아이템
                    </button>
                    <button class="sub-nav-button" data-tab="activity-objects">
                        📅 액티비티 객체
                    </button>
                </nav>
                <nav id="secondary-nav-home" class="secondary-nav active"></nav>
                <nav id="secondary-nav-results" class="secondary-nav">
                    <button class="sub-nav-button" data-tab="schematic-estimation-sd">
                        🪙 개산견적(SD)
                    </button>
                    <button class="sub-nav-button" data-tab="detailed-estimation-dd">
                        🧾 상세견적(DD)
                    </button>
                    <button class="sub-nav-button" data-tab="gantt-chart">
                        📊 공정계획
                    </button>
                    <button class="sub-nav-button" data-tab="three-d-viewer">
                        🧊 시뮬레이션
                    </button>
                </nav>
            </div>

            <div class="main-content">
                <div id="home" class="tab-content active" style="overflow-y: auto; height: 100%;">
                    <div style="padding: 30px; max-width: 1400px; margin: 0 auto;">
                        <h1 style="font-size: 32px; margin-bottom: 10px; color: #1976d2; font-weight: bold;">
                            COST ESTIMATOR & SCHEDULER
                        </h1>
                        <p style="font-size: 16px; color: #666; margin-bottom: 30px;">
                            BIM & AI 기반 건설원가산출 및 공정계획 시스템
                        </p>

                        <!-- 프로젝트 관리 섹션 -->
                        <div style="background: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                            <h2 style="font-size: 20px; margin: 0 0 15px 0; color: #333;">프로젝트 관리</h2>

                            <!-- 프로젝트 생성 -->
                            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                                <input type="text" id="home-new-project-name" placeholder="새 프로젝트 이름..." style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <button id="home-create-project-btn" style="padding: 8px 16px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; white-space: nowrap;">
                                    ➕ 새 프로젝트
                                </button>
                            </div>

                            <!-- 프로젝트 관리 버튼 -->
                            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                                <button id="home-import-project-btn" style="padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                    📥 프로젝트 가져오기
                                </button>
                                <button id="home-export-project-btn" style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;" disabled>
                                    📤 프로젝트 내보내기
                                </button>
                                <button id="home-delete-project-btn" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: auto;" disabled>
                                    🗑️ 프로젝트 삭제
                                </button>
                            </div>

                            <div id="home-project-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; background: white;">
                                <p style="padding: 20px; text-align: center; color: #999;">프로젝트 목록을 불러오는 중...</p>
                            </div>

                            <div id="home-current-project-info" style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 4px; display: none;">
                                <strong style="color: #1976d2;">현재 선택된 프로젝트:</strong>
                                <span id="home-current-project-name" style="color: #333; margin-left: 10px;">없음</span>
                            </div>
                        </div>

                        <!-- 빠른 작업 시작 섹션 -->
                        <div style="margin-bottom: 30px;">
                            <h2 style="font-size: 20px; margin-bottom: 20px; color: #333;">🚀 빠른 작업 시작</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                                <!-- 상세내역서 카드 -->
                                <div class="quick-action-card" data-target-tab="detailed-estimation-dd" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 30px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                    <div style="font-size: 48px; margin-bottom: 15px;">🧾</div>
                                    <h3 style="font-size: 18px; margin: 0 0 10px 0; color: white; font-weight: bold;">상세내역서 보기</h3>
                                    <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 14px;">상세견적(DD) 확인 및 관리</p>
                                </div>

                                <!-- 공정표 카드 -->
                                <div class="quick-action-card" data-target-tab="gantt-chart" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; padding: 30px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                    <div style="font-size: 48px; margin-bottom: 15px;">📊</div>
                                    <h3 style="font-size: 18px; margin: 0 0 10px 0; color: white; font-weight: bold;">공정계획 확인</h3>
                                    <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 14px;">간트차트 및 공정관리</p>
                                </div>

                                <!-- 시뮬레이션 카드 -->
                                <div class="quick-action-card" data-target-tab="three-d-viewer" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 12px; padding: 30px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                    <div style="font-size: 48px; margin-bottom: 15px;">🧊</div>
                                    <h3 style="font-size: 18px; margin: 0 0 10px 0; color: white; font-weight: bold;">공정시뮬레이션</h3>
                                    <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 14px;">3D 시각화 및 시뮬레이션</p>
                                </div>

                                <!-- AI 기반 개산견적 카드 -->
                                <div class="quick-action-card" data-target-tab="schematic-estimation-sd" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-radius: 12px; padding: 30px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                    <div style="font-size: 48px; margin-bottom: 15px;">🧠</div>
                                    <h3 style="font-size: 18px; margin: 0 0 10px 0; color: white; font-weight: bold;">AI 기반 개산견적</h3>
                                    <p style="margin: 0; color: rgba(255,255,255,0.9); font-size: 14px;">인공지능 기반 개략 공사비 예측</p>
                                </div>
                            </div>
                        </div>

                        <!-- 작업 가이드 -->
                        <div style="background: #f5f5f5; border-radius: 8px; padding: 25px;">
                            <h2 style="font-size: 18px; margin: 0 0 15px 0; color: #333;">📖 작업 가이드</h2>
                            <ol style="color: #666; line-height: 2; margin: 0; padding-left: 20px;">
                                <li><strong>관리</strong> 탭에서 수량산출분류, 공사코드, 액티비티 등을 설정하세요.</li>
                                <li><strong>작업</strong> 탭에서 BIM 데이터를 불러오고 수량산출부재와 산출항목을 생성하세요.</li>
                                <li><strong>결과</strong> 탭에서 개산견적, 상세견적, 공정계획을 확인하세요.</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div id="data-management" class="tab-content">
                    <aside class="left-panel">
                        <div class="control-box">
                            <h3>BIM 저작도구 연동</h3>
                            <button id="fetchDataBtn">데이터 가져오기</button>
                            <button id="get-from-client-btn">
                                선택 객체 가져오기
                            </button>
                            <button id="select-in-client-btn">
                                선택한 객체 확인
                            </button>
                        </div>
                        <div class="control-box">
                            <h3>3D 뷰포트 연동</h3>
                            <button id="get-from-3d-viewer-btn">
                                3D 선택 객체 가져오기
                            </button>
                            <button id="select-in-3d-viewer-btn">
                                3D에서 선택한 객체 확인
                            </button>
                        </div>

                        <div class="left-panel-tab-container">
                            <div class="left-panel-tabs">
                                <button
                                    class="left-panel-tab-button active"
                                    data-tab="fields"
                                >
                                    필드 선택
                                </button>
                                <button
                                    class="left-panel-tab-button"
                                    data-tab="classification"
                                >
                                    선택항목 분류
                                </button>
                                <button
                                    class="left-panel-tab-button"
                                    data-tab="bim-properties"
                                >
                                    BIM속성
                                </button>
                            </div>

                            <div
                                id="fields"
                                class="left-panel-tab-content active"
                            >
                                <div class="control-box">
                                    <div class="field-selection-wrapper">
                                        <div class="field-container-box">
                                            <h4>시스템 필드</h4>
                                            <div
                                                id="system-field-container"
                                                class="field-container"
                                            ></div>
                                        </div>
                                        <div class="field-container-box">
                                            <h4>BIM객체 데이터 필드</h4>
                                            <div
                                                id="revit-field-container"
                                                class="field-container"
                                            ></div>
                                        </div>
                                    </div>
                                    <button id="render-table-btn">
                                        테이블에 선택 적용
                                    </button>
                                </div>
                            </div>

                            <div
                                id="classification"
                                class="left-panel-tab-content"
                            >
                                <div class="control-box">
                                    <div id="selected-tags-list">
                                        항목을 선택하세요.
                                    </div>
                                </div>
                            </div>

                            <div
                                id="bim-properties"
                                class="left-panel-tab-content"
                            >
                                <div class="control-box">
                                    <div id="selected-bim-properties-container">
                                        <p>
                                            테이블에서 항목을 선택하면 BIM
                                            속성이 여기에 표시됩니다.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <div class="panel-resizer" id="data-management-resizer"></div>

                    <main class="right-panel">
                        <div class="view-tabs">
                            <button
                                class="view-tab-button active"
                                data-view="raw-data-view"
                            >
                                Raw 데이터 뷰
                            </button>
                            <button
                                class="view-tab-button"
                                data-view="classification-view"
                            >
                                수량산출분류 뷰
                            </button>
                        </div>
                        <div class="table-controls-grid">
                            <div class="control-section">
                                <h4 class="control-section-title">그룹핑</h4>
                                <button id="add-group-level-btn" style="width: 100%; margin-bottom: 8px;">
                                    그룹핑 추가
                                </button>
                                <div id="data-management-grouping-controls" style="margin-bottom: 8px;"></div>
                                <button id="apply-grouping-btn" style="width: 100%; background-color: #28a745; color: white; border: 1px solid #28a745;">
                                    그룹핑 적용
                                </button>
                            </div>

                            <div class="control-section">
                                <h4 class="control-section-title">분류 적용</h4>
                                <select id="tag-assign-select" style="width: 100%; margin-bottom: 8px;">
                                    <option value="">-- 분류 선택 --</option>
                                </select>
                                <button id="assign-tag-btn" style="width: 100%; margin-bottom: 8px;">
                                    분류 적용
                                </button>
                                <button id="clear-tags-btn" style="width: 100%; margin-bottom: 12px;">
                                    분류 제거
                                </button>
                                <button
                                    id="apply-rules-btn"
                                    class="ruleset-apply-btn"
                                    title="룰셋을 기준으로 모든 객체에 분류를 일괄 적용합니다."
                                    style="width: 100%;"
                                >
                                    📜 룰셋 일괄적용
                                </button>
                            </div>

                            <div class="control-section">
                                <h4 class="control-section-title">필터</h4>
                                <button id="apply-filter-btn" title="입력한 필터 조건을 적용하여 테이블을 다시 표시합니다." style="width: 100%; margin-bottom: 8px;">
                                    🔍 필터 적용
                                </button>
                                <button id="clear-filter-btn" title="모든 필터 조건을 초기화합니다." style="width: 100%;">
                                    ✕ 필터 초기화
                                </button>
                            </div>
                        </div>
                        <div
                            id="data-management-data-table-container"
                            class="table-container"
                        >
                            데이터가 여기에 표시됩니다...
                        </div>
                        <div class="table-footer-controls">
                            <button
                                id="clear-selection-filter-btn"
                                style="display: none"
                            >
                                선택 필터 해제
                            </button>
                        </div>
                    </main>
                </div>

                <div id="tag-management" class="tab-content">
                    <div class="ruleset-container">
                        <main class="ruleset-main-panel" style="width: 100%">
                            <div class="ruleset-header">
                                <h2>수량산출분류 관리</h2>
                            </div>
                            <div class="tag-management-content-wrapper">
                                <div class="control-box">
                                    <h3>수량산출분류 목록</h3>
                                    <div id="tag-list">
                                        프로젝트를 선택하세요.
                                    </div>
                                </div>
                                <div class="control-box">
                                    <h3>새 분류 추가</h3>
                                    <input
                                        type="text"
                                        id="new-tag-name"
                                        placeholder="새 분류 이름..."
                                    />
                                    <button id="create-tag-btn">
                                        분류 추가
                                    </button>
                                </div>
                                <div class="control-box">
                                    <h3>가져오기 / 내보내기</h3>
                                    <div class="io-buttons">
                                        <button id="import-tags-btn">
                                            가져오기
                                        </button>
                                        <button id="export-tags-btn">
                                            내보내기
                                        </button>
                                        <input
                                            type="file"
                                            id="tag-file-input"
                                            style="display: none"
                                            accept=".csv"
                                        />
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>

                <div id="space-management" class="tab-content">
                    <div
                        class="left-panel-tab-container"
                        style="width: 300px; flex-shrink: 0"
                    >
                        <div class="left-panel-tabs">
                            <button
                                class="left-panel-tab-button active"
                                data-tab="sm-fields"
                            >
                                필드 선택
                            </button>
                            <button
                                class="left-panel-tab-button"
                                data-tab="sm-bim-properties"
                            >
                                BIM속성
                            </button>
                        </div>
                        <div
                            id="sm-fields"
                            class="left-panel-tab-content active"
                        >
                            <div class="control-box">
                                <div class="field-selection-wrapper">
                                    <div class="field-container-box">
                                        <h4>시스템 필드</h4>
                                        <div
                                            id="sm-system-field-container"
                                            class="field-container"
                                        ></div>
                                    </div>
                                    <div class="field-container-box">
                                        <h4>BIM객체 데이터 필드</h4>
                                        <div
                                            id="sm-revit-field-container"
                                            class="field-container"
                                        ></div>
                                    </div>
                                </div>
                                <button
                                    id="sm-render-table-btn"
                                    style="margin: 15px"
                                >
                                    테이블에 선택 적용
                                </button>
                            </div>
                        </div>
                        <div
                            id="sm-bim-properties"
                            class="left-panel-tab-content"
                        >
                            <div class="control-box">
                                <div id="sm-selected-bim-properties-container">
                                    <p>
                                        테이블에서 항목을 선택하면 BIM 속성이
                                        여기에 표시됩니다.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-area">
                        <div class="table-controls">
                            <div
                                id="space-management-grouping-controls-container"
                            >
                                <button
                                    id="add-space-management-group-level-btn"
                                >
                                    그룹핑 추가
                                </button>
                                <div
                                    id="space-management-grouping-controls"
                                ></div>
                            </div>
                        </div>
                        <div
                            id="space-management-data-table-container"
                            class="table-container"
                        >
                            데이터가 여기에 표시됩니다...
                        </div>
                    </div>

                    <div class="space-tree-panel">
                        <div class="ruleset-header">
                            <h2>공간분류 관리</h2>
                            <div class="ruleset-actions">
                                <button id="import-space-classifications-btn">
                                    가져오기
                                </button>
                                <button id="export-space-classifications-btn">
                                    내보내기
                                </button>
                                <button
                                    id="apply-space-rules-btn"
                                    title="정의된 룰셋을 기반으로 공간분류를 자동 생성/동기화합니다."
                                >
                                    룰셋 자동적용
                                </button>
                                <button id="add-root-space-btn">
                                    최상위 공간 추가
                                </button>
                            </div>
                        </div>
                        <div
                            id="space-tree-container"
                            class="ruleset-table-container"
                        >
                            <p>프로젝트를 선택하세요.</p>
                        </div>
                    </div>
                </div>
                <div id="ruleset-management" class="tab-content">
                    <div class="ruleset-container">
                        <nav class="ruleset-nav-horizontal">
                                <button
                                    class="ruleset-nav-button active"
                                    data-ruleset="classification-ruleset"
                                >
                                    <span class="ruleset-icon">🏷️</span>
                                    <span class="ruleset-text"
                                        ><strong>분류 할당 룰셋</strong
                                        ><small
                                            >RawElement → 수량산출분류</small
                                        ></span
                                    >
                                </button>
                                <button
                                    class="ruleset-nav-button"
                                    data-ruleset="mapping-ruleset"
                                >
                                    <span class="ruleset-icon">📐</span>
                                    <span class="ruleset-text"
                                        ><strong>속성 맵핑 룰셋</strong
                                        ><small
                                            >QuantityMember 속성 계산</small
                                        ></span
                                    >
                                </button>
                                <button
                                    class="ruleset-nav-button"
                                    data-ruleset="costcode-ruleset"
                                >
                                    <span class="ruleset-icon">💰</span>
                                    <span class="ruleset-text"
                                        ><strong>수량산출룰셋</strong
                                        ><small
                                            >CostItem 수량 산출 기준</small
                                        ></span
                                    >
                                </button>
                                <button
                                    class="ruleset-nav-button"
                                    data-ruleset="member-mark-assignment-ruleset"
                                >
                                    <span class="ruleset-icon">🏷️</span>
                                    <span class="ruleset-text"
                                        ><strong>일람부호 할당 룰셋</strong
                                        ><small
                                            >QuantityMember → MemberMark</small
                                        ></span
                                    >
                                </button>
                                <button
                                    class="ruleset-nav-button"
                                    data-ruleset="cost-code-assignment-ruleset"
                                >
                                    <span class="ruleset-icon">📎</span>
                                    <span class="ruleset-text"
                                        ><strong>공사코드 할당 룰셋</strong
                                        ><small
                                            >QuantityMember → CostCode</small
                                        ></span
                                    >
                                </button>
                                <!-- ▼▼▼ [추가] 액티비티 할당 룰셋 버튼 ▼▼▼ -->
                                <button
                                    class="ruleset-nav-button"
                                    data-ruleset="activity-assignment-ruleset"
                                >
                                    <span class="ruleset-icon">⚡</span>
                                    <span class="ruleset-text"
                                        ><strong>액티비티 할당 룰셋</strong
                                        ><small>CostItem → Activity</small></span
                                    >
                                </button>
                                <!-- ▲▲▲ [추가] 여기까지 ▲▲▲ -->
                                <button
                                    class="ruleset-nav-button"
                                    data-ruleset="space-classification-ruleset"
                                >
                                    <span class="ruleset-icon">🏗️</span>
                                    <span class="ruleset-text"
                                        ><strong>공간분류 생성 룰셋</strong
                                        ><small
                                            >BIM객체 → 공간분류 위계</small
                                        ></span
                                    >
                                </button>
                                <button
                                    class="ruleset-nav-button"
                                    data-ruleset="space-assignment-ruleset"
                                >
                                    <span class="ruleset-icon">🏢</span>
                                    <span class="ruleset-text"
                                        ><strong>공간분류 할당 룰셋</strong
                                        ><small
                                            >QuantityMember → 공간분류</small
                                        ></span
                                    >
                                </button>
                        </nav>
                            <div
                                id="classification-ruleset"
                                class="ruleset-content active"
                            >
                                <div class="ruleset-header">
                                    <h2>분류 할당 룰셋 관리</h2>
                                    <div class="ruleset-actions">
                                        <button
                                            id="import-classification-rules-btn"
                                        >
                                            가져오기
                                        </button>
                                        <button
                                            id="export-classification-rules-btn"
                                        >
                                            내보내기
                                        </button>
                                        <button
                                            id="add-classification-rule-btn"
                                        >
                                            새 규칙 추가
                                        </button>
                                    </div>
                                </div>
                                <div class="ruleset-table-container">
                                    <p>
                                        프로젝트를 선택하고 규칙을 추가하세요.
                                    </p>
                                </div>
                            </div>
                            <div id="mapping-ruleset" class="ruleset-content">
                                <div class="ruleset-header">
                                    <h2>속성 맵핑 룰셋 관리</h2>
                                    <div class="ruleset-actions">
                                        <button id="import-mapping-rules-btn">
                                            가져오기
                                        </button>
                                        <button id="export-mapping-rules-btn">
                                            내보내기
                                        </button>
                                        <button id="add-mapping-rule-btn">
                                            새 규칙 추가
                                        </button>
                                    </div>
                                </div>
                                <div
                                    class="ruleset-table-container"
                                    id="mapping-ruleset-table-container"
                                >
                                    <p>
                                        이곳에서 QuantityMember의 속성을
                                        계산하는 규칙을 관리합니다.
                                    </p>
                                </div>
                            </div>
                            <div id="costcode-ruleset" class="ruleset-content">
                                <div class="ruleset-header">
                                    <h2>수량산출룰셋 관리</h2>
                                    <div class="ruleset-actions">
                                        <button id="import-costcode-rules-btn">
                                            가져오기
                                        </button>
                                        <button id="export-costcode-rules-btn">
                                            내보내기
                                        </button>
                                        <button id="add-costcode-rule-btn">
                                            새 규칙 추가
                                        </button>
                                    </div>
                                </div>
                                <div
                                    class="ruleset-table-container"
                                    id="costcode-ruleset-table-container"
                                >
                                    <p>
                                        이곳에서 공사코드별 수량 산출 기준을
                                        관리합니다.
                                    </p>
                                </div>
                            </div>
                            <div
                                id="member-mark-assignment-ruleset"
                                class="ruleset-content"
                            >
                                <div class="ruleset-header">
                                    <h2>일람부호 할당 룰셋 관리</h2>
                                    <div class="ruleset-actions">
                                        <button
                                            id="import-member-mark-assignment-rules-btn"
                                        >
                                            가져오기
                                        </button>
                                        <button
                                            id="export-member-mark-assignment-rules-btn"
                                        >
                                            내보내기
                                        </button>
                                        <button
                                            id="add-member-mark-assignment-rule-btn"
                                        >
                                            새 규칙 추가
                                        </button>
                                    </div>
                                </div>
                                <div
                                    class="ruleset-table-container"
                                    id="member-mark-assignment-ruleset-table-container"
                                >
                                    <p>
                                        QuantityMember 속성 기반으로 일람부호를
                                        자동 할당하는 규칙을 관리합니다.
                                    </p>
                                </div>
                            </div>
                            <div
                                id="cost-code-assignment-ruleset"
                                class="ruleset-content"
                            >
                                <div class="ruleset-header">
                                    <h2>공사코드 할당 룰셋 관리</h2>
                                    <div class="ruleset-actions">
                                        <button
                                            id="import-cost-code-assignment-rules-btn"
                                        >
                                            가져오기
                                        </button>
                                        <button
                                            id="export-cost-code-assignment-rules-btn"
                                        >
                                            내보내기
                                        </button>
                                        <button
                                            id="add-cost-code-assignment-rule-btn"
                                        >
                                            새 규칙 추가
                                        </button>
                                    </div>
                                </div>
                                <div
                                    class="ruleset-table-container"
                                    id="cost-code-assignment-ruleset-table-container"
                                >
                                    <p>
                                        QuantityMember 속성 기반으로 공사코드를
                                        자동 할당/생성하는 규칙을 관리합니다.
                                    </p>
                                </div>
                            </div>
                            <!-- ▼▼▼ [추가] 액티비티 할당 룰셋 섹션 ▼▼▼ -->
                            <div
                                id="activity-assignment-ruleset"
                                class="ruleset-content"
                            >
                                <div class="ruleset-header">
                                    <h2>액티비티 할당 룰셋 관리</h2>
                                    <div class="ruleset-actions">
                                        <button
                                            id="import-activity-assignment-rules-btn"
                                        >
                                            가져오기
                                        </button>
                                        <button
                                            id="export-activity-assignment-rules-btn"
                                        >
                                            내보내기
                                        </button>
                                        <button
                                            id="add-activity-assignment-rule-btn"
                                        >
                                            새 규칙 추가
                                        </button>
                                        <button
                                            id="apply-activity-assignment-rules-btn"
                                            class="primary-btn"
                                            title="액티비티 할당 룰셋을 모든 산출항목에 일괄 적용합니다."
                                        >
                                            룰셋 일괄적용
                                        </button>
                                    </div>
                                </div>
                                <div class="ruleset-description">
                                    <p>
                                        <strong>산출항목(CostItem)</strong>에
                                        <strong>액티비티(Activity)</strong>를 자동으로
                                        할당하는 룰셋입니다.
                                    </p>
                                    <p>조건문에서 다단계 속성 접근이 가능합니다:</p>
                                    <ul>
                                        <li>
                                            <code>{property}</code> - CostItem 자체 속성
                                            (예: {quantity})
                                        </li>
                                        <li>
                                            <code>QM.{property}</code> - QuantityMember
                                            속성 (예: QM.{name})
                                        </li>
                                        <li>
                                            <code>MM.{property}</code> - MemberMark 속성
                                            (예: MM.{mark})
                                        </li>
                                        <li>
                                            <code>RE.{property}</code> - RawElement (BIM
                                            원본) 속성 (예: RE.{Category})
                                        </li>
                                    </ul>
                                </div>
                                <div
                                    class="ruleset-table-container"
                                    id="activity-assignment-ruleset-table-container"
                                >
                                    <p>
                                        CostItem 속성 기반으로 액티비티를 자동 할당하는
                                        규칙을 관리합니다.
                                    </p>
                                </div>
                            </div>
                            <!-- ▲▲▲ [추가] 여기까지 ▲▲▲ -->
                            <div
                                id="space-classification-ruleset"
                                class="ruleset-content"
                            >
                                <div class="ruleset-header">
                                    <h2>공간분류 생성 룰셋 관리</h2>
                                    <div class="ruleset-actions">
                                        <button
                                            id="import-space-classification-rules-btn"
                                        >
                                            가져오기
                                        </button>
                                        <button
                                            id="export-space-classification-rules-btn"
                                        >
                                            내보내기
                                        </button>
                                        <button
                                            id="add-space-classification-rule-btn"
                                        >
                                            새 규칙(위계) 추가
                                        </button>
                                    </div>
                                </div>
                                <div
                                    class="ruleset-table-container"
                                    id="space-classification-ruleset-table-container"
                                >
                                    <p>
                                        BIM 객체로부터 공간분류 위계를 자동으로
                                        생성하는 규칙을 관리합니다.
                                    </p>
                                </div>
                            </div>
                            <div
                                id="space-assignment-ruleset"
                                class="ruleset-content"
                            >
                                <div class="ruleset-header">
                                    <h2>공간분류 할당 룰셋 관리</h2>
                                    <div class="ruleset-actions">
                                        <button
                                            id="import-space-assignment-rules-btn"
                                        >
                                            가져오기
                                        </button>
                                        <button
                                            id="export-space-assignment-rules-btn"
                                        >
                                            내보내기
                                        </button>
                                        <button
                                            id="add-space-assignment-rule-btn"
                                        >
                                            새 규칙 추가
                                        </button>
                                    </div>
                                </div>
                                <div
                                    class="ruleset-table-container"
                                    id="space-assignment-ruleset-table-container"
                                >
                                    <p>
                                        QuantityMember 속성 기반으로 공간분류를
                                        자동 할당하는 규칙을 관리합니다.
                                    </p>
                                </div>
                            </div>
                    </div>
                </div>

                <div id="quantity-members" class="tab-content">
                    <div class="qm-container">
                        <div class="split-layout-container">
                            <aside class="left-panel">
                                <div class="control-box">
                                    <h3>BIM 저작도구 연동</h3>
                                    <button id="qm-get-from-client-btn">
                                        선택 객체 가져오기
                                    </button>
                                    <button id="qm-select-in-client-btn">
                                        선택한 객체 확인
                                    </button>
                                </div>
                                <div class="control-box">
                                    <h3>3D 뷰포트 연동</h3>
                                    <button id="qm-get-from-3d-viewer-btn">
                                        3D 선택 객체 가져오기
                                    </button>
                                    <button id="qm-select-in-3d-viewer-btn">
                                        3D에서 선택한 객체 확인
                                    </button>
                                </div>

                                <div class="left-panel-tab-container">
                                    <div class="left-panel-tabs">
                                        <button
                                            class="left-panel-tab-button active"
                                            data-tab="field-selection"
                                        >
                                            필드 선택
                                        </button>
                                        <button
                                            class="left-panel-tab-button"
                                            data-tab="qm-properties"
                                        >
                                            부재 속성
                                        </button>
                                        <button
                                            class="left-panel-tab-button"
                                            data-tab="assigned-info"
                                        >
                                            할당 정보
                                        </button>
                                    </div>

                                    <div
                                        class="left-panel-tab-content active"
                                        id="qm-field-selection-content"
                                    >
                                        <div class="control-box">
                                            <div class="field-selection-wrapper">
                                                <div class="field-container-box">
                                                    <div class="field-selection-controls">
                                                        <button
                                                            id="qm-select-all-fields-btn"
                                                            style="margin-bottom: 8px; width: 100%;"
                                                        >
                                                            모두 선택
                                                        </button>
                                                        <button
                                                            id="qm-deselect-all-fields-btn"
                                                            style="margin-bottom: 8px; width: 100%;"
                                                        >
                                                            모두 해제
                                                        </button>
                                                    </div>
                                                    <div
                                                        id="qm-field-checkboxes-container"
                                                        class="field-container"
                                                    >
                                                        <!-- 필드 체크박스가 동적으로 생성됩니다 -->
                                                    </div>
                                                </div>
                                            </div>
                                            <button id="qm-render-table-btn">
                                                테이블에 선택 적용
                                            </button>
                                        </div>
                                    </div>

                                    <div
                                        class="left-panel-tab-content"
                                        id="qm-properties-content"
                                    >
                                        <div class="control-box">
                                            <div id="qm-selected-properties-container">
                                                <p>부재를 하나만 선택하세요.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div
                                        class="left-panel-tab-content"
                                        id="qm-assigned-info-content"
                                    >
                                        <div class="control-box" style="flex: 1; min-height: 0; display: flex; flex-direction: column; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; padding: 8px;">
                                            <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: bold; color: #333;">공사코드</h4>
                                            <div id="qm-assigned-cost-codes-container" style="flex: 1; min-height: 0; overflow-y: auto; font-size: 12px; margin-bottom: 8px; padding: 4px; background: #f9f9f9; border-radius: 3px;">
                                                부재를 선택하세요.
                                            </div>
                                            <div class="assignment-controls" style="display: flex; gap: 4px; align-items: stretch;">
                                                <select
                                                    id="qm-cost-code-assign-select"
                                                    class="control-element"
                                                    style="flex: 1; height: 28px; font-size: 12px; padding: 2px 4px; margin: 0; border: 1px solid #ccc; border-radius: 3px;"
                                                >
                                                    <option value="">-- 선택 --</option>
                                                </select>
                                                <button id="qm-assign-cost-code-btn" style="height: 28px; padding: 0 10px; font-size: 12px; white-space: nowrap; margin: 0; line-height: 28px; border: 1px solid #007bff; background: #007bff; color: white; border-radius: 3px; cursor: pointer;">
                                                    할당
                                                </button>
                                                <button id="qm-clear-cost-codes-btn" style="height: 28px; padding: 0 10px; font-size: 12px; white-space: nowrap; margin: 0; line-height: 28px; border: 1px solid #dc3545; background: #dc3545; color: white; border-radius: 3px; cursor: pointer;">
                                                    제거
                                                </button>
                                            </div>
                                        </div>

                                        <div class="control-box" style="flex: 1; min-height: 0; display: flex; flex-direction: column; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; padding: 8px;">
                                            <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: bold; color: #333;">일람부호</h4>
                                            <div id="qm-assigned-member-mark-container" style="flex: 1; min-height: 0; overflow-y: auto; font-size: 12px; margin-bottom: 8px; padding: 4px; background: #f9f9f9; border-radius: 3px;">
                                                부재를 선택하세요.
                                            </div>
                                            <div class="assignment-controls" style="display: flex; gap: 4px; align-items: stretch;">
                                                <select
                                                    id="qm-member-mark-assign-select"
                                                    class="control-element"
                                                    style="flex: 1; height: 28px; font-size: 12px; padding: 2px 4px; margin: 0; border: 1px solid #ccc; border-radius: 3px;"
                                                >
                                                    <option value="">-- 선택 --</option>
                                                </select>
                                                <button id="qm-assign-member-mark-btn" style="height: 28px; padding: 0 10px; font-size: 12px; white-space: nowrap; margin: 0; line-height: 28px; border: 1px solid #007bff; background: #007bff; color: white; border-radius: 3px; cursor: pointer;">
                                                    할당
                                                </button>
                                                <button id="qm-clear-member-marks-btn" style="height: 28px; padding: 0 10px; font-size: 12px; white-space: nowrap; margin: 0; line-height: 28px; border: 1px solid #dc3545; background: #dc3545; color: white; border-radius: 3px; cursor: pointer;">
                                                    제거
                                                </button>
                                            </div>
                                        </div>

                                        <div class="control-box" style="flex: 1; min-height: 0; display: flex; flex-direction: column; border: 1px solid #ddd; border-radius: 4px; padding: 8px;">
                                            <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: bold; color: #333;">공간분류</h4>
                                            <div id="qm-assigned-spaces-container" style="flex: 1; min-height: 0; overflow-y: auto; font-size: 12px; margin-bottom: 8px; padding: 4px; background: #f9f9f9; border-radius: 3px;">
                                                부재를 선택하세요.
                                            </div>
                                            <div class="assignment-controls" style="display: flex; gap: 4px; align-items: stretch;">
                                                <select
                                                    id="qm-space-assign-select"
                                                    class="control-element"
                                                    style="flex: 1; height: 28px; font-size: 12px; padding: 2px 4px; margin: 0; border: 1px solid #ccc; border-radius: 3px;"
                                                >
                                                    <option value="">-- 선택 --</option>
                                                </select>
                                                <button id="qm-assign-space-btn" style="height: 28px; padding: 0 10px; font-size: 12px; white-space: nowrap; margin: 0; line-height: 28px; border: 1px solid #007bff; background: #007bff; color: white; border-radius: 3px; cursor: pointer;">
                                                    할당
                                                </button>
                                                <button id="qm-clear-spaces-btn" style="height: 28px; padding: 0 10px; font-size: 12px; white-space: nowrap; margin: 0; line-height: 28px; border: 1px solid #dc3545; background: #dc3545; color: white; border-radius: 3px; cursor: pointer;">
                                                    제거
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </aside>

                            <div class="qm-split-bar"></div>

                            <main class="right-panel">
                                <div class="qm-header">
                                    <h2>수량산출부재 관리</h2>
                                    <div class="qm-actions">
                                        <button id="create-qm-manual-btn">
                                            수동 생성
                                        </button>
                                        <button id="create-qm-auto-btn">
                                            자동 생성 (분류 기준)
                                        </button>
                                    </div>
                                </div>

                                <div class="view-tabs">
                                    <button
                                        class="view-tab-button active"
                                        data-view="quantity-member-view"
                                    >
                                        수량산출부재 뷰
                                    </button>
                                    <button
                                        class="view-tab-button"
                                        data-view="cost-code-view"
                                    >
                                        공사코드별 뷰
                                    </button>
                                </div>

                                <div class="table-controls-grid">
                                    <div class="control-section">
                                        <h4 class="control-section-title">그룹핑</h4>
                                        <button id="add-qm-group-level-btn" style="width: 100%; margin-bottom: 8px;">
                                            그룹핑 추가
                                        </button>
                                        <div id="qm-grouping-controls" style="margin-bottom: 8px;"></div>
                                        <button id="apply-qm-grouping-btn" style="width: 100%; background-color: #28a745; color: white; border: 1px solid #28a745;">
                                            그룹핑 적용
                                        </button>
                                    </div>

                                    <div class="control-section">
                                        <h4 class="control-section-title">필터</h4>
                                        <button id="apply-qm-filter-btn" style="width: 100%; margin-bottom: 4px;">
                                            필터 적용
                                        </button>
                                        <button id="clear-qm-filter-btn" style="width: 100%;">
                                            필터 초기화
                                        </button>
                                    </div>

                                    <div class="control-section">
                                        <h4 class="control-section-title">속성 및 할당 적용</h4>
                                        <button id="qm-apply-property-rules-btn" style="width: 100%; background-color: #ff9800; color: white; border: 1px solid #ff9800; margin-bottom: 4px;">
                                            속성 룰셋 일괄적용
                                        </button>
                                        <button
                                            id="apply-assignment-rules-btn"
                                            title="일람부호 및 공사코드 할당 룰셋을 모든 부재에 일괄 적용합니다."
                                            style="width: 100%; background-color: #17a2b8; color: white; border: 1px solid #17a2b8; margin-bottom: 4px;"
                                        >
                                            할당 룰셋 일괄적용
                                        </button>
                                        <!-- ▼▼▼ [추가] 수동 수량 산출식 업데이트 버튼 (2025-11-05) ▼▼▼ -->
                                        <button
                                            id="qm-update-formulas-btn"
                                            title="모든 부재의 XXX_산출식 필드를 재계산하여 XXX 필드에 결과값을 저장합니다."
                                            style="width: 100%; background-color: #9c27b0; color: white; border: 1px solid #9c27b0; margin-bottom: 4px;"
                                        >
                                            수동 수량 산출식 업데이트
                                        </button>
                                        <!-- ▲▲▲ [추가] 여기까지 ▲▲▲ -->
                                        <button id="qm-clear-selection-btn" style="width: 100%; margin-bottom: 4px;">
                                            선택 해제
                                        </button>
                                        <button
                                            id="qm-clear-selection-filter-btn"
                                            style="width: 100%; display: none;"
                                        >
                                            선택 필터 해제
                                        </button>
                                    </div>
                                </div>

                                <div
                                    id="qm-table-container"
                                    class="qm-table-container"
                                >
                                    <p>프로젝트를 선택하세요.</p>
                                </div>
                                <div class="table-footer-controls">
                                    <button
                                        id="qm-clear-selection-filter-btn-footer"
                                        style="display: none"
                                    >
                                        선택 필터 해제
                                    </button>
                                </div>
                            </main>
                        </div>
                    </div>
                </div>

                <div id="cost-item-management" class="tab-content">
                    <div class="qm-container">
                        <div class="split-layout-container">
                            <aside class="left-panel">
                                <div class="control-box">
                                    <h3>BIM 저작도구 연동</h3>
                                    <button id="ci-get-from-client-btn">
                                        선택 객체 가져오기
                                    </button>
                                    <button id="ci-select-in-client-btn">
                                        선택한 객체 확인
                                    </button>
                                </div>
                                <div class="control-box">
                                    <h3>3D 뷰포트 연동</h3>
                                    <button id="ci-get-from-3d-viewer-btn">
                                        3D 선택 객체 가져오기
                                    </button>
                                    <button id="ci-select-in-3d-viewer-btn">
                                        3D에서 선택한 객체 확인
                                    </button>
                                </div>

                                <div class="left-panel-tab-container">
                                    <div class="left-panel-tabs">
                                        <button
                                            class="left-panel-tab-button active"
                                            data-tab="field-selection"
                                        >
                                            필드 선택
                                        </button>
                                        <button
                                            class="left-panel-tab-button"
                                            data-tab="ci-properties"
                                        >
                                            산출항목 속성
                                        </button>
                                        <button
                                            class="left-panel-tab-button"
                                            data-tab="assigned-info"
                                        >
                                            할당 정보
                                        </button>
                                    </div>

                                    <div
                                        class="left-panel-tab-content active"
                                        id="ci-field-selection-content"
                                    >
                                        <div class="control-box">
                                            <div class="field-selection-wrapper">
                                                <div class="field-container-box">
                                                    <div class="field-selection-controls">
                                                        <button
                                                            id="ci-select-all-fields-btn"
                                                            style="margin-bottom: 8px; width: 100%;"
                                                        >
                                                            모두 선택
                                                        </button>
                                                        <button
                                                            id="ci-deselect-all-fields-btn"
                                                            style="margin-bottom: 8px; width: 100%;"
                                                        >
                                                            모두 해제
                                                        </button>
                                                    </div>
                                                    <div
                                                        id="ci-field-checkboxes-container"
                                                        class="field-container"
                                                    >
                                                        <!-- 필드 체크박스가 동적으로 생성됩니다 -->
                                                    </div>
                                                </div>
                                            </div>
                                            <button id="ci-render-table-btn">
                                                테이블에 선택 적용
                                            </button>
                                        </div>
                                    </div>

                                    <div
                                        class="left-panel-tab-content"
                                        id="ci-properties-content"
                                    >
                                        <div class="control-box">
                                            <div id="ci-selected-properties-container">
                                                <p>산출항목을 하나만 선택하세요.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div
                                        class="left-panel-tab-content"
                                        id="ci-assigned-info-content"
                                    >
                                        <div class="control-box" style="flex: 1; min-height: 0; display: flex; flex-direction: column; border: 1px solid #ddd; border-radius: 4px; padding: 8px;">
                                            <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: bold; color: #333;">액티비티 (공정)</h4>
                                            <div id="ci-assigned-activities-container" style="flex: 1; min-height: 0; overflow-y: auto; font-size: 12px; margin-bottom: 8px; padding: 4px; background: #f9f9f9; border-radius: 3px;">
                                                산출항목을 선택하세요.
                                            </div>
                                            <div class="assignment-controls" style="display: flex; gap: 4px; align-items: stretch;">
                                                <select
                                                    id="ci-activity-assign-select"
                                                    class="control-element"
                                                    style="flex: 1; height: 28px; font-size: 12px; padding: 2px 4px; margin: 0; border: 1px solid #ccc; border-radius: 3px;"
                                                >
                                                    <option value="">-- 선택 --</option>
                                                </select>
                                                <button id="ci-assign-activity-btn" style="height: 28px; padding: 0 10px; font-size: 12px; white-space: nowrap; margin: 0; line-height: 28px; border: 1px solid #007bff; background: #007bff; color: white; border-radius: 3px; cursor: pointer;">
                                                    할당
                                                </button>
                                                <button id="ci-clear-activities-btn" style="height: 28px; padding: 0 10px; font-size: 12px; white-space: nowrap; margin: 0; line-height: 28px; border: 1px solid #dc3545; background: #dc3545; color: white; border-radius: 3px; cursor: pointer;">
                                                    제거
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </aside>

                            <div class="ci-split-bar"></div>

                            <main class="right-panel">
                                <div class="qm-header">
                                    <h2>산출항목 관리</h2>
                                    <div class="qm-actions">
                                        <button id="create-ci-manual-btn">
                                            수동 생성
                                        </button>
                                        <button id="create-ci-auto-btn">
                                            자동 생성 (공사코드 기준)
                                        </button>
                                    </div>
                                </div>

                                <div class="view-tabs">
                                    <button
                                        class="view-tab-button active"
                                        data-view="cost-item-view"
                                    >
                                        코스트아이템 뷰
                                    </button>
                                    <button
                                        class="view-tab-button"
                                        data-view="activity-view"
                                    >
                                        액티비티별 뷰
                                    </button>
                                </div>

                                <div class="table-controls-grid">
                                    <div class="control-section">
                                        <h4 class="control-section-title">그룹핑</h4>
                                        <button id="add-ci-group-level-btn" style="width: 100%; margin-bottom: 8px;">
                                            그룹핑 추가
                                        </button>
                                        <div id="ci-grouping-controls" style="margin-bottom: 8px;"></div>
                                        <button id="apply-ci-grouping-btn" style="width: 100%; background-color: #28a745; color: white; border: 1px solid #28a745;">
                                            그룹핑 적용
                                        </button>
                                    </div>

                                    <div class="control-section">
                                        <h4 class="control-section-title">필터</h4>
                                        <button id="apply-ci-filter-btn" style="width: 100%; margin-bottom: 4px;">
                                            필터 적용
                                        </button>
                                        <button id="clear-ci-filter-btn" style="width: 100%;">
                                            필터 초기화
                                        </button>
                                    </div>

                                    <div class="control-section">
                                        <h4 class="control-section-title">수량속성 할당</h4>
                                        <button id="ci-apply-quantity-rules-btn" style="width: 100%; margin-bottom: 4px; background-color: #007bff; color: white; border: 1px solid #007bff;">
                                            룰셋수량계산 (전체)
                                        </button>
                                        <button id="ci-apply-quantity-rules-selected-btn" style="width: 100%; margin-bottom: 4px; background-color: #17a2b8; color: white; border: 1px solid #17a2b8;">
                                            룰셋수량계산 (선택)
                                        </button>
                                        <button id="ci-manual-quantity-input-btn" style="width: 100%; margin-bottom: 4px; background-color: #28a745; color: white; border: 1px solid #28a745;">
                                            수동 수량입력
                                        </button>
                                        <button id="ci-apply-activity-rules-btn" style="width: 100%; margin-bottom: 4px; background-color: #6f42c1; color: white; border: 1px solid #6f42c1;">
                                            액티비티 룰셋 적용
                                        </button>
                                        <button id="ci-clear-selection-filter-btn" style="width: 100%; display: none; background-color: #dc3545; color: white; border: 1px solid #dc3545;">
                                            선택 필터 해제
                                        </button>
                                    </div>
                                </div>

                                <div
                                    id="ci-table-container"
                                    class="qm-table-container"
                                >
                                    <p>프로젝트를 선택하세요.</p>
                                </div>
                                <div class="table-footer-controls">
                                    <button
                                        id="ci-clear-selection-filter-btn-footer"
                                        style="display: none"
                                    >
                                        선택 필터 해제
                                    </button>
                                </div>
                            </main>
                        </div>
                    </div>
                </div>

                <div id="member-mark-management" class="tab-content">
                    <div class="ruleset-container">
                        <main class="ruleset-main-panel" style="width: 100%">
                            <div class="ruleset-header">
                                <h2>일람부호(Member Mark) 관리</h2>
                                <div class="ruleset-actions">
                                    <button id="import-member-marks-btn">
                                        가져오기
                                    </button>
                                    <button id="export-member-marks-btn">
                                        내보내기
                                    </button>
                                    <button id="add-member-mark-btn">
                                        새 일람부호 추가
                                    </button>
                                </div>
                            </div>
                            <div
                                id="member-marks-table-container"
                                class="ruleset-table-container"
                            >
                                <p>프로젝트를 선택하세요.</p>
                            </div>
                        </main>
                    </div>
                </div>

                <div id="cost-code-management" class="tab-content">
                    <div class="ruleset-container">
                        <main class="ruleset-main-panel" style="width: 100%">
                            <div class="ruleset-header">
                                <h2>공사코드(Cost Code) 관리</h2>
                                <div class="ruleset-actions">
                                    <button id="import-cost-codes-btn">
                                        가져오기
                                    </button>
                                    <button id="export-cost-codes-btn">
                                        내보내기
                                    </button>
                                    <button id="add-cost-code-btn">
                                        새 공사코드 추가
                                    </button>
                                </div>
                            </div>
                            <div
                                id="cost-codes-table-container"
                                class="ruleset-table-container"
                            >
                                <p>프로젝트를 선택하세요.</p>
                            </div>
                        </main>
                    </div>
                </div>

                <div id="detailed-estimation-dd" class="tab-content">
                    <div class="boq-container">
                        <button
                            id="boq-left-panel-toggle-btn"
                            class="panel-toggle-btn"
                            title="왼쪽 패널 접기/펴기"
                        >
                            ◀
                        </button>

                        <aside class="boq-left-panel">
                            <div class="control-box">
                                <button
                                    id="generate-boq-btn"
                                    style="width: 100%"
                                >
                                    📈 집계표 생성
                                </button>
                                <button
                                    id="boq-reset-columns-btn"
                                    style="width: 100%; margin-top: 10px"
                                >
                                    🔄 열 순서/이름 초기화
                                </button>
                                <button
                                    id="export-boq-btn"
                                    style="width: 100%; margin-top: 10px"
                                >
                                    📄 Excel 내보내기
                                </button>
                            </div>
                            <div class="control-box">
                                <h3>프로그램 연동</h3>
                                <div class="io-buttons">
                                    <button id="boq-get-from-client-btn">
                                        선택 객체 가져오기
                                    </button>
                                    <button id="boq-select-in-client-btn">
                                        연동 프로그램에서 선택 확인
                                    </button>
                                </div>
                                <button
                                    id="boq-clear-selection-filter-btn"
                                    style="display: none; margin-top: 10px"
                                >
                                    선택 필터 해제
                                </button>
                            </div>
                            <div class="control-box">
                                <h3>3D 뷰어 연동</h3>
                                <div class="io-buttons">
                                    <button id="boq-get-from-viewer-btn">
                                        🎯 뷰어 선택 가져오기
                                    </button>
                                    <button id="boq-select-in-viewer-btn">
                                        👁️ 뷰어에서 선택 확인
                                    </button>
                                </div>
                            </div>
                            <!-- ▼▼▼ [수정] 코스트아이템 스타일의 탭 구조로 변경 ▼▼▼ -->
                            <div class="left-panel-tab-container">
                                <div class="left-panel-tabs">
                                    <button
                                        class="left-panel-tab-button active"
                                        data-tab="boq-field-selection"
                                    >
                                        필드 선택
                                    </button>
                                    <button
                                        class="left-panel-tab-button"
                                        data-tab="boq-properties"
                                    >
                                        산출항목 속성
                                    </button>
                                </div>

                                <!-- 필드 선택 탭 -->
                                <div
                                    class="left-panel-tab-content active"
                                    id="boq-field-selection-content"
                                >
                                    <div class="control-box">
                                        <div
                                            id="boq-display-fields-container"
                                            style="
                                                max-height: 400px;
                                                overflow-y: auto;
                                                overflow-x: auto;
                                            "
                                        >
                                            <small
                                                >그룹핑 필드 목록을 먼저
                                                불러옵니다...</small
                                            >
                                        </div>
                                    </div>
                                </div>

                                <!-- 산출항목 속성 탭 -->
                                <div
                                    class="left-panel-tab-content"
                                    id="boq-properties-content"
                                >
                                    <div class="control-box">
                                        <div id="boq-selected-properties-container">
                                            <!-- 부재속성, 일람부호, BIM원본이 모두 여기에 그룹으로 표시됨 -->
                                            <p>집계표 행을 하나만 선택하세요.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- ▲▲▲ [수정] 여기까지 ▲▲▲ -->
                        </aside>

                        <!-- 좌측-중간 스플릿바 -->
                        <div class="boq-split-bar" data-target="left"></div>

                        <main class="boq-main-content">
                            <div class="control-box">
                                <div id="boq-grouping-controls-wrapper">
                                    <button id="add-boq-group-level-btn">
                                        + 그룹핑 추가
                                    </button>
                                    <div id="boq-grouping-controls"></div>
                                </div>
                            </div>
                            <div
                                id="boq-table-container"
                                class="boq-table-wrapper"
                            >
                                <p style="padding: 20px">
                                    집계 기준을 설정하고 '집계표 생성' 버튼을
                                    눌러주세요.
                                </p>
                            </div>
                            <div id="boq-details-toolbar">
                                <button
                                    id="boq-bottom-panel-toggle-btn"
                                    class="panel-toggle-btn"
                                    title="하단 패널 접기/펴기"
                                >
                                    ▼
                                </button>
                            </div>
                            <div
                                id="boq-item-list-wrapper"
                                class="boq-details-wrapper"
                            >
                                <div
                                    class="control-box"
                                    style="
                                        height: 100%;
                                        display: flex;
                                        flex-direction: column;
                                    "
                                >
                                    <div class="boq-details-header">
                                        <h4 style="margin: 0">
                                            포함된 산출항목
                                        </h4>
                                    </div>
                                    <div
                                        id="boq-item-list-container"
                                        style="flex-grow: 1; overflow-y: auto"
                                    >
                                        <p style="padding: 10px">
                                            상단 집계표의 행을 선택하세요.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </main>

                        <!-- 중간-우측 스플릿바 -->
                        <div class="boq-split-bar" data-target="right"></div>

                        <aside class="boq-bim-object-summary-panel">
                            <div class="control-box">
                                <h4 id="boq-bim-object-summary-header">
                                    BIM 객체 비용 요약
                                </h4>
                                <div id="boq-bim-object-cost-summary">
                                    <p style="padding: 10px">
                                        하단 목록에서 산출항목을 선택하면 연관된
                                        BIM 객체의 비용 요약이 표시됩니다.
                                    </p>
                                </div>
                            </div>
                        </aside>

                        <button
                            id="boq-right-panel-toggle-btn"
                            class="panel-toggle-btn"
                            title="오른쪽 패널 접기/펴기"
                        >
                            ▶
                        </button>
                    </div>
                </div>
                <div id="schematic-estimation-sd" class="tab-content">
                    <div class="sd-container">
                        <div class="sd-top-panel">
                            <div class="sd-input-section panel-box">
                                <div class="panel-header">
                                    <h4>개산견적 입력</h4>
                                </div>
                                <div class="panel-content sd-input-content">
                                    <div class="sd-model-selector">
                                        <label for="sd-model-select"
                                            >AI 모델 선택:</label
                                        >
                                        <select id="sd-model-select">
                                            <option value="">
                                                -- 모델 선택 --
                                            </option>
                                        </select>
                                    </div>
                                    <div
                                        id="sd-input-fields"
                                        class="sd-input-fields"
                                    >
                                        <p>
                                            모델을 선택하면 입력 항목이
                                            표시됩니다.
                                        </p>
                                    </div>
                                    <button id="sd-predict-btn" disabled>
                                        📈 예측 실행
                                    </button>
                                </div>
                            </div>
                            <div class="sd-output-section panel-box">
                                <div class="panel-header">
                                    <h4>예측 결과</h4>
                                </div>
                                <div class="panel-content sd-output-content">
                                    <div id="sd-prediction-results-table">
                                        <p>예측 결과가 여기에 표시됩니다.</p>
                                    </div>
                                    <canvas
                                        id="sd-prediction-chart"
                                        height="150"
                                    ></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="sd-bottom-panel three-column-layout">
                            <div class="left-column panel-box">
                                <div class="panel-header">
                                    <h4>개산견적(SD) 대상 항목</h4>
                                    <button id="sd-select-in-client-btn">
                                        👁️ 연동 프로그램에서 선택 확인
                                    </button>
                                </div>
                                <div
                                    class="panel-content sd-table-content"
                                    style="
                                        display: flex;
                                        flex-direction: column;
                                    "
                                >
                                    <div
                                        class="control-box"
                                        style="
                                            flex-shrink: 0;
                                            border: none;
                                            border-bottom: 1px solid
                                                var(--border-color);
                                            padding-bottom: 10px;
                                            margin-bottom: 10px;
                                        "
                                    >
                                        <div
                                            id="sd-grouping-controls-wrapper"
                                            style="
                                                display: flex;
                                                align-items: center;
                                                gap: 15px;
                                            "
                                        >
                                            <button id="add-sd-group-level-btn">
                                                + 그룹핑 추가
                                            </button>
                                            <div
                                                id="sd-grouping-controls"
                                                style="
                                                    display: flex;
                                                    flex-wrap: nowrap;
                                                    overflow-x: auto;
                                                    gap: 10px;
                                                    align-items: center;
                                                    padding-bottom: 5px;
                                                    min-width: 0;
                                                    flex-grow: 1;
                                                "
                                            ></div>
                                        </div>
                                        <div
                                            id="sd-display-fields-wrapper"
                                            style="
                                                display: none;
                                                align-items: center;
                                                gap: 10px;
                                                padding-top: 10px;
                                                border-top: 1px dashed #e0e0e0;
                                                margin-top: 10px;
                                            "
                                        >
                                            <span>표시 필드:</span>
                                            <div
                                                id="sd-display-fields-container"
                                                style="
                                                    flex-grow: 1;
                                                    max-height: 80px;
                                                    overflow: auto;
                                                    border: 1px solid
                                                        var(--border-color);
                                                    padding: 5px;
                                                    background-color: #fff;
                                                    border-radius: 4px;
                                                "
                                            >
                                                <small>필드 로딩 중...</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        id="sd-table-container"
                                        class="table-container"
                                        style="flex-grow: 1; overflow: auto"
                                    >
                                        <p style="padding: 20px">
                                            개산견적(SD)에 사용되는 산출항목
                                            목록이 여기에 표시됩니다.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="middle-column panel-box">
                                <div class="panel-header">
                                    <h4>연관 산출항목</h4>
                                </div>
                                <div
                                    id="sd-item-list-container"
                                    class="panel-content"
                                >
                                    <p style="padding: 15px">
                                        왼쪽 테이블에서 그룹 행을 선택하세요.
                                    </p>
                                </div>
                            </div>

                            <div
                                id="sd-item-details-panel"
                                class="right-column panel-box"
                            >
                                <div class="details-panel-tabs">
                                    <button
                                        class="detail-tab-button active"
                                        data-tab="sd-member-prop"
                                    >
                                        부재 속성
                                    </button>
                                    <button
                                        class="detail-tab-button"
                                        data-tab="sd-mark-prop"
                                    >
                                        일람부호
                                    </button>
                                    <button
                                        class="detail-tab-button"
                                        data-tab="sd-raw-prop"
                                    >
                                        BIM 원본
                                    </button>
                                </div>
                                <div
                                    class="detail-tab-content active"
                                    data-tab="sd-member-prop"
                                >
                                    <div
                                        id="sd-details-member-container"
                                        class="panel-content properties-sub-container"
                                    >
                                        <p style="padding: 15px">
                                            중간 목록에서 항목을 선택하세요.
                                        </p>
                                    </div>
                                </div>
                                <div
                                    class="detail-tab-content"
                                    data-tab="sd-mark-prop"
                                >
                                    <div
                                        id="sd-details-mark-container"
                                        class="panel-content properties-sub-container"
                                    >
                                        <p style="padding: 15px">
                                            중간 목록에서 항목을 선택하세요.
                                        </p>
                                    </div>
                                </div>
                                <div
                                    class="detail-tab-content"
                                    data-tab="sd-raw-prop"
                                >
                                    <div
                                        id="sd-details-raw-container"
                                        class="panel-content properties-sub-container"
                                    >
                                        <p style="padding: 15px">
                                            중간 목록에서 항목을 선택하세요.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="gantt-chart" class="tab-content">
                    <div class="gantt-container" style="display: flex; flex-direction: column; height: calc(100vh - 120px); overflow: hidden;">
                        <div class="gantt-header" style="flex-shrink: 0;">
                            <h2>공정표 (간트차트)</h2>
                            <div class="gantt-controls" style="display: flex; align-items: center; gap: 15px; margin-top: 15px; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label for="project-start-date">프로젝트 시작일:</label>
                                    <input type="date" id="project-start-date" style="padding: 5px;">
                                    <button id="refresh-gantt-btn" class="btn-save">간트차트 새로고침</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label for="cost-cutoff-date">내역집계 기준일:</label>
                                    <input type="date" id="cost-cutoff-date" style="padding: 5px;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-left: auto;">
                                    <label for="gantt-view-mode">표시 모드:</label>
                                    <select id="gantt-view-mode" style="padding: 5px;">
                                        <option value="Day" selected>일</option>
                                        <option value="Week">주</option>
                                        <option value="Month">월</option>
                                    </select>
                                </div>
                            </div>
                            <!-- 액티비티 단위 3D 연동 버튼 -->
                            <div id="gantt-activity-3d-controls" style="display: none; margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 4px; border: 1px solid #4caf50;">
                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                    <span style="font-weight: bold; color: #2e7d32;">선택한 액티비티:</span>
                                    <span id="selected-activity-name" style="color: #2e7d32;"></span>
                                    <div style="margin-left: auto; display: flex; gap: 8px;">
                                        <button id="gantt-activity-select-in-client-btn" style="padding: 6px 12px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">BIM 저작도구에서 확인</button>
                                        <button id="gantt-activity-select-in-3d-btn" style="padding: 6px 12px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">3D 뷰포트에서 확인</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 상단: 공정표 -->
                        <div id="gantt-top-section" style="display: flex; flex-direction: column; flex: 1 1 auto; min-height: 200px;">
                            <div id="gantt-chart-container" style="flex: 1; min-height: 0; overflow-y: auto; overflow-x: auto; margin-top: 20px;">
                                <p style="padding: 20px; text-align: center; color: #999;">로딩 중...</p>
                            </div>
                        </div>
                        <!-- 스플릿바 -->
                        <div id="gantt-resize-handle" style="height: 8px; background: #ddd; cursor: ns-resize; display: flex; align-items: center; justify-content: center; border-top: 1px solid #bbb; border-bottom: 1px solid #bbb; flex: 0 0 8px;">
                            <div style="width: 60px; height: 4px; background: #999; border-radius: 2px;"></div>
                        </div>
                        <!-- 하단: 상세정보 (접기/펼치기 가능) -->
                        <div id="gantt-bottom-section" style="border-top: 2px solid #ddd; background: #fafafa; flex: 1 1 300px; display: flex; flex-direction: column; min-height: 50px;">
                            <!-- 토글 헤더 -->
                            <div id="gantt-bottom-toggle-header" style="padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #e3f2fd; border-bottom: 1px solid #1976d2; flex: 0 0 auto;">
                                <h3 style="margin: 0; color: #1976d2; font-size: 15px; font-weight: bold;">📊 상세 정보 / 내역집계표</h3>
                                <span id="gantt-bottom-toggle-icon" style="font-size: 18px; color: #1976d2; font-weight: bold;">▲</span>
                            </div>
                            <!-- 하단 컨텐츠 -->
                            <div id="gantt-bottom-content" style="display: flex; background: white; flex: 1 1 auto; overflow: hidden; min-height: 0; flex-direction: column;">
                                <!-- 탭 헤더 -->
                                <div style="display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; flex-shrink: 0; padding: 0 20px;">
                                    <button class="gantt-bottom-tab-btn active" data-tab="detail" style="padding: 12px 24px; border: none; background: #1976d2; color: white; cursor: pointer; font-size: 14px; font-weight: bold; border-radius: 4px 4px 0 0; margin-right: 2px;">
                                        상세 정보
                                    </button>
                                    <button class="gantt-bottom-tab-btn" data-tab="boq" style="padding: 12px 24px; border: none; background: #f5f5f5; color: #666; cursor: pointer; font-size: 14px; border-radius: 4px 4px 0 0; margin-right: 2px;">
                                        내역집계표
                                    </button>
                                </div>
                                <!-- 탭 내용 -->
                                <div style="flex: 1; min-height: 0; overflow: hidden; padding: 0 20px 20px 20px;">
                                    <!-- 상세 정보 탭 -->
                                    <div id="gantt-detail-container" class="gantt-bottom-tab-content active" data-tab="detail" style="height: 100%; overflow-y: auto; overflow-x: hidden;">
                                    </div>
                                    <!-- 내역집계표 탭 -->
                                    <div id="gantt-boq-container" class="gantt-bottom-tab-content" data-tab="boq" style="display: none; height: 100%; overflow-y: auto; overflow-x: hidden;">
                                        <p style="padding: 20px; text-align: center; color: #999;">기준일을 선택하면 해당 일자까지의 내역집계표가 표시됩니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="three-d-viewer" class="tab-content">
                    {% include 'three_d_viewer.html' %}
                </div>

                <div id="unit-price-management" class="tab-content">
                    <div class="unit-price-container">
                        <aside class="unit-price-left-panel">
                            <div class="panel-header">
                                <h3>공사코드 목록</h3>
                                <input
                                    type="text"
                                    id="unit-price-cost-code-search"
                                    placeholder="코드/이름 검색..."
                                    style="width: 100%"
                                />
                            </div>
                            <div
                                id="unit-price-cost-code-list"
                                class="panel-content cost-code-list-container"
                            >
                                <p>
                                    프로젝트를 선택하면 공사코드가 표시됩니다.
                                </p>
                            </div>
                        </aside>

                        <main class="unit-price-right-panel">
                            <section class="unit-price-type-section">
                                <div class="panel-header">
                                    <h4>단가 구분 관리</h4>
                                    <button id="add-unit-price-type-btn">
                                        새 구분 추가
                                    </button>
                                </div>
                                <div
                                    id="unit-price-type-table-container"
                                    class="panel-content type-table-container"
                                >
                                    <p>단가 구분을 추가하세요.</p>
                                </div>
                            </section>

                            <section class="unit-price-list-section">
                                <div class="panel-header">
                                    <h4 id="unit-price-list-header">
                                        단가 리스트 (공사코드를 선택하세요)
                                    </h4>
                                    <button id="add-unit-price-btn" disabled>
                                        새 단가 추가
                                    </button>
                                </div>
                                <div
                                    id="unit-price-table-container"
                                    class="panel-content price-table-container"
                                >
                                    <p>왼쪽에서 공사코드를 선택하세요.</p>
                                </div>
                            </section>
                        </main>
                    </div>
                </div>
                <div id="ai-model-manager" class="tab-content">
                    <nav class="inner-tab-nav">
                        <button
                            class="inner-tab-button active"
                            data-inner-tab="ai-model-list"
                        >
                            📊 모델 목록/업로드
                        </button>
                        <button
                            class="inner-tab-button"
                            data-inner-tab="ai-model-training"
                        >
                            🎓 모델 학습
                        </button>
                    </nav>

                    <div class="inner-tab-content-container">
                        <div
                            id="ai-model-list"
                            class="inner-tab-content active"
                        >
                            <div class="ai-model-list-section panel-box">
                                <div class="panel-header">
                                    <h3>AI 모델 목록</h3>
                                    <div class="ai-model-actions">
                                        <input
                                            type="file"
                                            id="ai-model-h5-input"
                                            accept=".h5"
                                            style="display: none"
                                        />
                                        <input
                                            type="file"
                                            id="ai-model-json-input"
                                            accept=".json"
                                            style="display: none"
                                        />
                                        <input
                                            type="text"
                                            id="new-ai-model-name"
                                            placeholder="새 모델 이름"
                                        />
                                        <button
                                            id="upload-ai-model-files-btn"
                                            title="모델 파일(.h5)과 메타데이터 파일(.json) 선택"
                                        >
                                            파일 선택
                                        </button>
                                        <textarea
                                            id="ai-model-metadata-manual"
                                            placeholder="메타데이터(.json) 파일 대신 직접 입력 (JSON 형식)"
                                            rows="3"
                                            style="
                                                display: none;
                                                width: 100%;
                                                margin-top: 5px;
                                            "
                                        ></textarea>
                                        <button
                                            id="confirm-upload-ai-model-btn"
                                        >
                                            모델 업로드
                                        </button>
                                    </div>
                                </div>
                                <div
                                    id="ai-model-list-container"
                                    class="panel-content"
                                >
                                    <p>
                                        프로젝트를 선택하면 AI 모델 목록이
                                        표시됩니다.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div id="ai-model-training" class="inner-tab-content">
                            <div class="ai-model-training-section panel-box">
                                <div class="panel-header">
                                    <h3>AI 모델 학습</h3>
                                </div>
                                <div class="panel-content ai-training-content">
                                    <div
                                        class="training-step"
                                        id="training-step-1"
                                    >
                                        <h4>1단계: 학습 데이터 업로드 (CSV)</h4>
                                        <input
                                            type="file"
                                            id="training-csv-input"
                                            accept=".csv"
                                        />
                                        <button id="upload-csv-btn">
                                            CSV 업로드 및 분석
                                        </button>
                                        <div
                                            id="csv-info"
                                            style="margin-top: 10px"
                                        ></div>
                                    </div>

                                    <div
                                        class="training-step"
                                        id="training-step-2"
                                        style="display: none"
                                    >
                                        <h4>
                                            2단계: 모델 구조, 파라미터, 데이터
                                            분할 설정
                                        </h4>

                                        <div
                                            class="feature-selection-container"
                                        >
                                            <div class="feature-box">
                                                <label
                                                    >입력 피처 (Input
                                                    Features):</label
                                                >
                                                <div
                                                    id="input-feature-list"
                                                    class="feature-list"
                                                ></div>
                                            </div>
                                            <div class="feature-box">
                                                <label
                                                    >출력 피처 (Output
                                                    Features):</label
                                                >
                                                <div
                                                    id="output-feature-list"
                                                    class="feature-list"
                                                ></div>
                                            </div>
                                        </div>

                                        <label style="margin-bottom: 15px"
                                            >모델 이름:
                                            <input
                                                type="text"
                                                id="training-model-name"
                                                placeholder="학습 완료 후 저장될 모델 이름"
                                            />
                                        </label>

                                        <fieldset
                                            style="
                                                border: 1px solid #ccc;
                                                padding: 10px;
                                                margin-bottom: 15px;
                                            "
                                        >
                                            <legend>모델 구조 (은닉층)</legend>
                                            <div id="hidden-layers-config">
                                                <div
                                                    class="layer-config-row"
                                                    data-layer-index="0"
                                                >
                                                    <span>Layer 1:</span>
                                                    <input
                                                        type="number"
                                                        class="nodes-input"
                                                        value="64"
                                                        min="1"
                                                        title="노드 수"
                                                    />
                                                    <select
                                                        class="activation-select"
                                                        title="활성화 함수"
                                                    >
                                                        <option
                                                            value="relu"
                                                            selected
                                                        >
                                                            relu
                                                        </option>
                                                        <option value="sigmoid">
                                                            sigmoid
                                                        </option>
                                                        <option value="tanh">
                                                            tanh
                                                        </option>
                                                        <option value="elu">
                                                            elu
                                                        </option>
                                                        <option value="selu">
                                                            selu
                                                        </option>
                                                        <option value="swish">
                                                            swish
                                                        </option>
                                                    </select>
                                                    <button
                                                        class="remove-layer-btn"
                                                        style="
                                                            padding: 2px 5px;
                                                            font-size: 10px;
                                                        "
                                                    >
                                                        -
                                                    </button>
                                                </div>
                                            </div>
                                            <button
                                                id="add-hidden-layer-btn"
                                                style="margin-top: 5px"
                                            >
                                                + 은닉층 추가
                                            </button>
                                        </fieldset>

                                        <fieldset
                                            style="
                                                border: 1px solid #ccc;
                                                padding: 10px;
                                                margin-bottom: 15px;
                                            "
                                        >
                                            <legend>학습 파라미터</legend>
                                            <div class="model-config-container">
                                                <label
                                                    >Loss 함수:
                                                    <select id="loss-function">
                                                        <option
                                                            value="mse"
                                                            selected
                                                        >
                                                            mse (Mean Squared
                                                            Error)
                                                        </option>
                                                        <option value="mae">
                                                            mae (Mean Absolute
                                                            Error)
                                                        </option>
                                                    </select>
                                                </label>
                                                <label
                                                    >Optimizer:
                                                    <select id="optimizer">
                                                        <option
                                                            value="adam"
                                                            selected
                                                        >
                                                            Adam
                                                        </option>
                                                        <option value="sgd">
                                                            SGD
                                                        </option>
                                                        <option value="rmsprop">
                                                            RMSprop
                                                        </option>
                                                    </select>
                                                </label>
                                                <label
                                                    >Metrics:
                                                    <select
                                                        id="metrics"
                                                        multiple
                                                        size="3"
                                                    >
                                                        <option
                                                            value="mae"
                                                            selected
                                                        >
                                                            mae
                                                        </option>
                                                        <option value="mse">
                                                            mse
                                                        </option>
                                                        <option value="mape">
                                                            mape (Mean Absolute
                                                            Percentage Error)
                                                        </option>
                                                    </select>
                                                    <small
                                                        >(Ctrl/Cmd 클릭으로 다중
                                                        선택)</small
                                                    >
                                                </label>
                                                <label
                                                    >학습률(Learning Rate):
                                                    <input
                                                        type="number"
                                                        id="learning-rate"
                                                        value="0.001"
                                                        step="0.0001"
                                                /></label>
                                                <label
                                                    >에포크(Epochs):
                                                    <input
                                                        type="number"
                                                        id="epochs"
                                                        value="50"
                                                        min="1"
                                                /></label>
                                                <label
                                                    ><input
                                                        type="checkbox"
                                                        id="normalize-inputs"
                                                        checked
                                                    />
                                                    입력값
                                                    정규화(StandardScaler)</label
                                                >
                                            </div>
                                        </fieldset>

                                        <fieldset
                                            style="
                                                border: 1px solid #ccc;
                                                padding: 10px;
                                                margin-bottom: 15px;
                                            "
                                        >
                                            <legend>데이터 분할</legend>
                                            <div
                                                style="
                                                    display: flex;
                                                    gap: 15px;
                                                    align-items: center;
                                                "
                                            >
                                                <label
                                                    >Train 비율(%):
                                                    <input
                                                        type="number"
                                                        id="train-ratio"
                                                        value="70"
                                                        min="1"
                                                        max="98"
                                                /></label>
                                                <label
                                                    >Validation 비율(%):
                                                    <input
                                                        type="number"
                                                        id="val-ratio"
                                                        value="15"
                                                        min="1"
                                                        max="98"
                                                /></label>
                                                <span id="test-ratio-display"
                                                    >Test 비율(%): 15</span
                                                >
                                                <label
                                                    ><input
                                                        type="checkbox"
                                                        id="use-random-seed"
                                                    />
                                                    랜덤 시드 고정</label
                                                >
                                                <input
                                                    type="number"
                                                    id="random-seed-value"
                                                    value="42"
                                                    min="0"
                                                    style="
                                                        width: 60px;
                                                        display: none;
                                                    "
                                                />
                                            </div>
                                        </fieldset>

                                        <button id="start-training-btn">
                                            학습 시작
                                        </button>
                                        <button
                                            id="reset-training-config-btn"
                                            style="margin-left: 10px"
                                        >
                                            설정 초기화
                                        </button>
                                    </div>
                                    <div
                                        class="training-step"
                                        id="training-step-3"
                                        style="display: none"
                                    >
                                        <h4>3단계: 학습 진행률 및 결과</h4>
                                        <div id="training-progress-info">
                                            학습 대기 중...
                                        </div>
                                        <canvas
                                            id="training-progress-chart"
                                            width="400"
                                            height="200"
                                        ></canvas>
                                        <div
                                            id="training-results"
                                            style="margin-top: 15px"
                                        ></div>
                                        <div
                                            id="test-set-evaluation-results"
                                            style="
                                                margin-top: 20px;
                                                border-top: 1px dashed #ccc;
                                                padding-top: 15px;
                                            "
                                        >
                                            <h4>Test Set 평가 결과</h4>
                                            <p>
                                                Test 데이터셋을 사용한 최종 모델
                                                성능 평가 결과입니다.
                                            </p>
                                        </div>
                                        <div
                                            id="training-actions"
                                            style="
                                                margin-top: 10px;
                                                display: none;
                                            "
                                        >
                                            <button id="save-trained-model-btn">
                                                학습된 모델 저장
                                            </button>
                                            <button
                                                id="download-trained-model-h5-btn"
                                            >
                                                모델 파일(.h5) 다운로드
                                            </button>
                                            <button
                                                id="download-trained-model-json-btn"
                                            >
                                                메타데이터(.json) 다운로드
                                            </button>
                                            <button id="reset-training-btn">
                                                새 학습 시작
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ▼▼▼ [추가] 액티비티 관리 탭 ▼▼▼ -->
                <div id="activity-management" class="tab-content">
                    <nav class="inner-tab-nav">
                        <button class="inner-tab-button active" data-inner-tab="activity-list">
                            📋 액티비티 목록
                        </button>
                        <button class="inner-tab-button" data-inner-tab="activity-dependency">
                            🔗 선후행 관계
                        </button>
                        <button class="inner-tab-button" data-inner-tab="calendar-management">
                            📆 캘린더 관리
                        </button>
                    </nav>

                    <div class="inner-tab-content-container">
                        <!-- 액티비티 목록 -->
                        <div id="activity-list" class="inner-tab-content active">
                            <div class="activity-list-section panel-box">
                                <div class="panel-header">
                                    <h3>액티비티 목록</h3>
                                    <button id="add-activity-btn" class="primary-button">
                                        ➕ 새 액티비티 추가
                                    </button>
                                </div>
                                <div class="panel-content">
                                    <div id="activity-table-container" class="table-container">
                                        <p>프로젝트를 선택하면 액티비티 목록이 표시됩니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 선후행 관계 -->
                        <div id="activity-dependency" class="inner-tab-content">
                            <div class="dependency-section panel-box">
                                <div class="panel-header">
                                    <h3>선후행 관계 관리</h3>
                                    <button id="add-dependency-btn" class="primary-button">
                                        ➕ 관계 추가
                                    </button>
                                </div>
                                <div class="panel-content">
                                    <div id="dependency-table-container" class="table-container">
                                        <p>프로젝트를 선택하면 선후행 관계 목록이 표시됩니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 캘린더 관리 -->
                        <div id="calendar-management" class="inner-tab-content">
                            <div style="display: flex; gap: 20px; height: 100%;">
                                <!-- 왼쪽: 캘린더 리스트 -->
                                <div class="calendar-list-panel" style="flex: 0 0 300px; display: flex; flex-direction: column;">
                                    <div class="panel-box" style="display: flex; flex-direction: column; height: 100%;">
                                        <div class="panel-header">
                                            <h3>캘린더 목록</h3>
                                            <button id="add-calendar-btn" class="primary-button">
                                                ➕ 새 캘린더
                                            </button>
                                        </div>
                                        <div class="panel-content" style="flex: 1; overflow-y: auto;">
                                            <div id="calendars-list-container">
                                                <p style="text-align: center; color: #999; padding: 20px;">프로젝트를 선택하면 캘린더 목록이 표시됩니다.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 오른쪽: 캘린더 상세 -->
                                <div class="calendar-detail-panel" style="flex: 1; display: flex; flex-direction: column;">
                                    <div class="panel-box" style="display: flex; flex-direction: column; height: 100%;">
                                        <div class="panel-header">
                                            <h3 id="calendar-detail-title">캘린더 상세</h3>
                                            <div style="display: flex; gap: 10px;">
                                                <button id="set-main-calendar-btn" class="secondary-button" style="display: none;">
                                                    ⭐ 메인으로 설정
                                                </button>
                                                <button id="save-calendar-btn" class="primary-button" style="display: none;">
                                                    💾 저장
                                                </button>
                                                <button id="delete-calendar-btn" class="danger-button" style="display: none; background: #dc3545;">
                                                    🗑️ 삭제
                                                </button>
                                            </div>
                                        </div>
                                        <div class="panel-content" style="flex: 1; overflow-y: auto;">
                                            <div id="calendar-detail-container">
                                                <p style="text-align: center; color: #999; padding: 20px;">캘린더를 선택하거나 새로 만들어주세요.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ▲▲▲ [추가] 액티비티 관리 탭 끝 ▲▲▲ -->

                <!-- ▼▼▼ [추가] 액티비티 객체 탭 ▼▼▼ -->
                <div id="activity-objects" class="tab-content">
                    <div class="qm-container">
                        <div class="split-layout-container">
                            <aside class="left-panel">
                                <div class="control-box">
                                    <h3>BIM 저작도구 연동</h3>
                                    <button id="ao-get-from-client-btn">
                                        선택 객체 가져오기
                                    </button>
                                    <button id="ao-select-in-client-btn">
                                        선택한 객체 확인
                                    </button>
                                </div>
                                <div class="control-box">
                                    <h3>3D 뷰포트 연동</h3>
                                    <button id="ao-get-from-3d-viewer-btn">
                                        3D 선택 객체 가져오기
                                    </button>
                                    <button id="ao-select-in-3d-viewer-btn">
                                        3D에서 선택한 객체 확인
                                    </button>
                                </div>

                                <div class="left-panel-tab-container">
                                    <div class="left-panel-tabs">
                                        <button
                                            class="left-panel-tab-button active"
                                            data-tab="ao-field-selection"
                                        >
                                            필드 선택
                                        </button>
                                        <button
                                            class="left-panel-tab-button"
                                            data-tab="ao-properties"
                                        >
                                            액티비티 객체 속성
                                        </button>
                                    </div>

                                    <div
                                        class="left-panel-tab-content active"
                                        id="ao-field-selection-content"
                                    >
                                        <div class="control-box">
                                            <div class="field-selection-wrapper">
                                                <div class="field-container-box">
                                                    <div class="field-selection-controls">
                                                        <button
                                                            id="ao-select-all-fields-btn"
                                                            style="margin-bottom: 8px; width: 100%;"
                                                        >
                                                            모두 선택
                                                        </button>
                                                        <button
                                                            id="ao-deselect-all-fields-btn"
                                                            style="margin-bottom: 8px; width: 100%;"
                                                        >
                                                            모두 해제
                                                        </button>
                                                    </div>
                                                    <div
                                                        id="ao-field-checkboxes-container"
                                                        class="field-container"
                                                    >
                                                        <!-- 필드 체크박스가 동적으로 생성됩니다 -->
                                                    </div>
                                                </div>
                                            </div>
                                            <button id="ao-render-table-btn">
                                                테이블에 선택 적용
                                            </button>
                                        </div>
                                    </div>

                                    <div
                                        class="left-panel-tab-content"
                                        id="ao-properties-content"
                                    >
                                        <div class="control-box">
                                            <div id="ao-selected-properties-container">
                                                <p>액티비티 객체를 하나만 선택하세요.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </aside>

                            <div class="ao-split-bar"></div>

                            <main class="right-panel">
                                <div class="qm-header">
                                    <h2>액티비티 객체 관리</h2>
                                    <div class="qm-actions">
                                        <button id="create-ao-manual-btn">
                                            수동 생성
                                        </button>
                                        <button id="create-ao-auto-btn">
                                            자동 생성 (액티비티코드 기준)
                                        </button>
                                    </div>
                                </div>

                                <div class="table-controls-grid">
                                    <div class="control-section">
                                        <h4 class="control-section-title">그룹핑</h4>
                                        <button id="add-ao-group-level-btn" style="width: 100%; margin-bottom: 8px;">
                                            그룹핑 추가
                                        </button>
                                        <div id="ao-grouping-controls" style="margin-bottom: 8px;"></div>
                                        <button id="apply-ao-grouping-btn" style="width: 100%; background-color: #28a745; color: white; border: 1px solid #28a745;">
                                            그룹핑 적용
                                        </button>
                                    </div>

                                    <div class="control-section">
                                        <h4 class="control-section-title">필터</h4>
                                        <button id="apply-ao-filter-btn" style="width: 100%; margin-bottom: 4px;">
                                            필터 적용
                                        </button>
                                        <button id="clear-ao-filter-btn" style="width: 100%;">
                                            필터 초기화
                                        </button>
                                    </div>

                                    <div class="control-section">
                                        <h4 class="control-section-title">수량속성 할당</h4>
                                        <button id="ao-auto-quantity-calc-btn" style="width: 100%; margin-bottom: 4px; background-color: #007bff; color: white; border: 1px solid #007bff;">
                                            자동 수량계산
                                        </button>
                                        <button id="ao-manual-quantity-input-btn" style="width: 100%; margin-bottom: 4px; background-color: #28a745; color: white; border: 1px solid #28a745;">
                                            수동 수량입력
                                        </button>
                                        <button id="ao-reset-manual-btn" style="width: 100%; margin-bottom: 4px; background-color: #ffc107; color: #212529; border: 1px solid #ffc107;">
                                            수동입력 해제
                                        </button>
                                        <button id="ao-clear-selection-filter-btn" style="width: 100%; display: none; background-color: #dc3545; color: white; border: 1px solid #dc3545;">
                                            선택 필터 해제
                                        </button>
                                    </div>
                                </div>

                                <div
                                    id="ao-table-container"
                                    class="qm-table-container"
                                >
                                    <p>프로젝트를 선택하세요.</p>
                                </div>
                                <div class="table-footer-controls">
                                    <button
                                        id="ao-clear-selection-filter-btn-footer"
                                        style="display: none"
                                    >
                                        선택 필터 해제
                                    </button>
                                </div>
                            </main>
                        </div>
                    </div>
                </div>
                <!-- ▲▲▲ [추가] 액티비티 객체 탭 끝 ▲▲▲ -->
                <div id="schematic-estimation-sd" class="tab-content">
                    <div class="sd-container">
                        <div class="sd-top-panel">
                            <div class="sd-input-section panel-box">
                                <div class="panel-header">
                                    <h4>개산견적 입력</h4>
                                </div>
                                <div class="panel-content sd-input-content">
                                    <div class="sd-model-selector">
                                        <label for="sd-model-select"
                                            >AI 모델 선택:</label
                                        >
                                        <select id="sd-model-select">
                                            <option value="">
                                                -- 모델 선택 --
                                            </option>
                                        </select>
                                    </div>
                                    <div
                                        id="sd-input-fields"
                                        class="sd-input-fields"
                                    >
                                        <p>
                                            모델을 선택하면 입력 항목이
                                            표시됩니다.
                                        </p>
                                    </div>
                                    <button id="sd-predict-btn" disabled>
                                        예측 실행
                                    </button>
                                </div>
                            </div>
                            <div class="sd-output-section panel-box">
                                <div class="panel-header">
                                    <h4>예측 결과</h4>
                                </div>
                                <div class="panel-content sd-output-content">
                                    <div id="sd-prediction-results-table">
                                        <p>예측 결과가 여기에 표시됩니다.</p>
                                    </div>
                                    <canvas
                                        id="sd-prediction-chart"
                                        height="150"
                                    ></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="sd-bottom-panel panel-box">
                            <div class="panel-header">
                                <h4>개산견적(SD) 대상 산출항목</h4>
                                <button id="sd-select-in-client-btn">
                                    연동 프로그램에서 선택 확인
                                </button>
                            </div>
                            <div class="panel-content sd-table-content">
                                <div
                                    id="sd-cost-item-table-container"
                                    class="table-container"
                                >
                                    <p>
                                        개산견적(SD)에 사용되는 산출항목 목록이
                                        여기에 표시됩니다.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div
            id="cost-code-selection-modal"
            class="modal-overlay"
            style="display: none"
        >
            <div class="modal-content">
                <div class="modal-header">
                    <h2>공사코드 선택</h2>
                    <button class="modal-close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <input
                        type="text"
                        id="cost-code-search-input"
                        placeholder="코드로 검색..."
                        style="margin-bottom: 15px"
                    />
                    <div id="cost-code-list-container" class="modal-list"></div>
                </div>
                <div class="modal-footer">
                    <button
                        id="modal-cancel-btn"
                        class="modal-button-secondary"
                    >
                        취소
                    </button>
                    <button
                        id="modal-confirm-btn"
                        class="modal-button-primary"
                        disabled
                    >
                        선택 완료
                    </button>
                </div>
            </div>
        </div>

        <div
            id="assigned-elements-modal"
            class="modal-overlay"
            style="display: none"
        >
            <div class="modal-content" style="width: 80%; max-width: 1200px">
                <div class="modal-header">
                    <h2 id="assigned-elements-modal-title">할당된 BIM 객체</h2>
                    <button class="modal-close-btn">&times;</button>
                </div>
                <div class="modal-body">
                    <div
                        id="assigned-elements-table-container"
                        class="table-container"
                        style="height: 60vh"
                    ></div>
                </div>
                <div class="modal-footer">
                    <button
                        id="modal-unassign-btn"
                        class="modal-button-secondary"
                    >
                        선택 항목 할당 해제
                    </button>
                    <button
                        id="modal-close-assigned-elements"
                        class="modal-button-secondary"
                    >
                        닫기
                    </button>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="{% static 'connections/ui.js' %}"></script>
        <script src="{% static 'connections/websocket.js' %}"></script>
        <script src="{% static 'connections/ruleset_classification_handlers.js' %}"></script>
        <script src="{% static 'connections/ruleset_property_mapping_handlers.js' %}"></script>
        <script src="{% static 'connections/ruleset_cost_code_handlers.js' %}"></script>
        <script src="{% static 'connections/ruleset_member_mark_assignment_handlers.js' %}"></script>
        <script src="{% static 'connections/ruleset_cost_code_assignment_handlers.js' %}"></script>
        <script src="{% static 'connections/ruleset_space_classification_handlers.js' %}"></script>
        <script src="{% static 'connections/ruleset_space_assignment_handlers.js' %}"></script>
        <script src="{% static 'connections/ruleset_activity_assignment_handlers.js' %}?v=1"></script>
        <script src="{% static 'connections/cost_code_management_handlers.js' %}"></script>
        <script src="{% static 'connections/member_mark_management_handlers.js' %}"></script>
        <script src="{% static 'connections/tag_management_handlers.js' %}"></script>
        <script src="{% static 'connections/csrf_token.js' %}?v=2"></script>
        <script src="{% static 'connections/activity_management_handlers.js' %}?v=6"></script>
        <script src="{% static 'connections/calendar_management_handlers.js' %}?v=2"></script>
        <script src="{% static 'connections/activity_assignment_handlers.js' %}?v=9"></script>
        <script src="{% static 'connections/gantt_chart_handlers.js' %}?v=23"></script>
        <script src="{% static 'connections/data_management_handlers.js' %}"></script>
        <script src="{% static 'connections/space_management_handlers.js' %}"></script>
        <script src="{% static 'connections/project_management_handlers.js' %}?v=2"></script>
        <script src="{% static 'connections/three_d_viewer.js' %}?v=50"></script>
        <script src="{% static 'connections/navigation.js' %}?v=3"></script>
        <script src="{% static 'connections/ai_model_management.js' %}?v=2"></script>
        <script src="{% static 'connections/unit_price_management.js' %}"></script>
        <script src="{% static 'connections/schematic_estimation_handlers.js' %}"></script>
        <script src="{% static 'connections/websocket.js' %}"></script>

        <!-- Left-Right Split Layout with Draggable Splitter -->
        <script>
        (function() {
            console.log('[Layout] Creating left-right split with 3D viewport on left...');

            const appContainer = document.querySelector('.app-container');
            const header = document.querySelector('.app-header');
            const mainNav = document.querySelector('.main-nav');
            const secondaryNavContainer = document.querySelector('.secondary-nav-container');
            const mainContent = document.querySelector('.main-content');
            const threeDViewerTab = document.getElementById('three-d-viewer');

            if (!appContainer || !threeDViewerTab) {
                console.error('[Layout] Required elements not found');
                return;
            }

            // Create split layout wrapper
            const splitWrapper = document.createElement('div');
            splitWrapper.id = 'split-wrapper';
            splitWrapper.style.cssText = 'display: flex; flex-direction: row; flex: 1; min-height: 0; overflow: hidden;';

            // ▼▼▼ [NEW] Create CHAT panel (leftmost) ▼▼▼
            const chatPanel = document.createElement('div');
            chatPanel.id = 'chat-panel';
            chatPanel.style.cssText = 'flex: 0 0 20%; min-width: 250px; max-width: 500px; display: flex; flex-direction: column; overflow: hidden; background: #fff; border-right: 1px solid #ddd;';

            // Chat header
            const chatHeader = document.createElement('div');
            chatHeader.className = 'chat-header';
            chatHeader.style.cssText = 'padding: 12px 15px; background: #1976d2; color: white; font-weight: bold; border-bottom: 1px solid #1565c0; display: flex; align-items: center; justify-content: space-between;';
            chatHeader.innerHTML = '<span>💬 AI Assistant</span><button id="chat-toggle-btn" style="background: transparent; border: none; color: white; cursor: pointer; font-size: 18px; transition: all 0.3s;">◀</button>';

            // Chat messages area
            const chatMessages = document.createElement('div');
            chatMessages.id = 'chat-messages';
            chatMessages.style.cssText = 'flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #f5f5f5;';
            // 초기 메시지는 제거 (필요시 나중에 추가 가능)

            // Chat input area
            const chatInputArea = document.createElement('div');
            chatInputArea.className = 'chat-input-area';
            chatInputArea.style.cssText = 'padding: 12px 15px; background: white; border-top: 1px solid #ddd; display: flex; gap: 8px;';
            chatInputArea.innerHTML = `
                <input type="text" id="chat-input" placeholder="메시지를 입력하세요..." style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; outline: none;" />
                <button id="chat-send-btn" style="padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">전송</button>
            `;

            // Assemble chat panel
            chatPanel.appendChild(chatHeader);
            chatPanel.appendChild(chatMessages);
            chatPanel.appendChild(chatInputArea);
            // ▲▲▲ [NEW] Chat panel created ▲▲▲

            // ▼▼▼ [NEW] Create SPLITTER between chat and viewport ▼▼▼
            const chatSplitter = document.createElement('div');
            chatSplitter.id = 'chat-split-bar';
            chatSplitter.style.cssText = 'flex: 0 0 8px; background: #ddd; cursor: ew-resize; display: flex; align-items: center; justify-content: center; border-left: 1px solid #bbb; border-right: 1px solid #bbb; user-select: none;';
            const chatSplitterHandle = document.createElement('div');
            chatSplitterHandle.style.cssText = 'width: 4px; height: 60px; background: #999; border-radius: 2px;';
            chatSplitter.appendChild(chatSplitterHandle);
            // ▲▲▲ [NEW] Chat splitter created ▲▲▲

            // Create MIDDLE panel (3D Viewport) - renamed from leftPanel
            const middlePanel = document.createElement('div');
            middlePanel.id = 'split-middle-panel';
            middlePanel.style.cssText = 'flex: 0 0 25%; min-width: 300px; display: flex; flex-direction: column; overflow: hidden; background: #f0f0f0;';

            // Create SPLITTER bar (between viewport and right panel)
            const splitter = document.createElement('div');
            splitter.id = 'split-bar';
            splitter.style.cssText = 'flex: 0 0 8px; background: #ddd; cursor: ew-resize; display: flex; align-items: center; justify-content: center; border-left: 1px solid #bbb; border-right: 1px solid #bbb; user-select: none;';
            const splitterHandle = document.createElement('div');
            splitterHandle.style.cssText = 'width: 4px; height: 60px; background: #999; border-radius: 2px;';
            splitter.appendChild(splitterHandle);

            // Create RIGHT panel (Navigation + Tabs)
            const rightPanel = document.createElement('div');
            rightPanel.id = 'split-right-panel';
            rightPanel.style.cssText = 'flex: 1; min-width: 300px; display: flex; flex-direction: column; overflow: hidden;';

            // Split left panel into top (viewport) and bottom (properties)
            const leftTop = document.createElement('div');
            leftTop.id = 'split-left-top';
            leftTop.style.cssText = 'flex: 1; min-height: 300px; display: flex; flex-direction: column; overflow: hidden;';

            const leftBottom = document.createElement('div');
            leftBottom.id = 'split-left-bottom';
            leftBottom.style.cssText = 'flex: 1; min-height: 150px; display: flex; flex-direction: column; overflow: hidden;';

            // Create vertical splitter between top and bottom
            const verticalSplitter = document.createElement('div');
            verticalSplitter.id = 'vertical-splitter';
            verticalSplitter.style.cssText = 'height: 8px; background: linear-gradient(to bottom, #ddd 0%, #bbb 50%, #ddd 100%); cursor: ns-resize; flex-shrink: 0; position: relative; z-index: 10;';
            verticalSplitter.innerHTML = '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 4px; background: rgba(0,0,0,0.2); border-radius: 2px;"></div>';

            // Move 3D canvas container to LEFT TOP
            const threeDContainer = document.querySelector('.three-d-viewer-container');
            if (threeDContainer) {
                leftTop.appendChild(threeDContainer);
                console.log('[Layout] Moved 3D canvas container to left top');
            }

            // Move properties panel to LEFT BOTTOM
            const propertiesPanel = document.querySelector('.three-d-properties-panel');
            if (propertiesPanel) {
                leftBottom.appendChild(propertiesPanel);
                console.log('[Layout] Moved properties panel to left bottom');
            }

            // Assemble middle panel (renamed from leftPanel)
            middlePanel.style.cssText = 'flex: 0 0 25%; min-width: 300px; display: flex; flex-direction: column; overflow: hidden; background: #f0f0f0;';
            middlePanel.appendChild(leftTop);
            middlePanel.appendChild(verticalSplitter);
            middlePanel.appendChild(leftBottom);

            // Move navigation and tabs to RIGHT panel
            if (mainNav) rightPanel.appendChild(mainNav);
            if (secondaryNavContainer) rightPanel.appendChild(secondaryNavContainer);
            if (mainContent) rightPanel.appendChild(mainContent);

            // The 3D viewer tab still exists in mainContent and now contains:
            // - Properties panel
            // - Schedule controls
            // - Cost items table
            // - Gantt chart
            // - BOQ table
            console.log('[Layout] 3D viewer tab remains in right panel with all other content');

            // ▼▼▼ [MODIFIED] Assemble layout with chat panel ▼▼▼
            splitWrapper.appendChild(chatPanel);
            splitWrapper.appendChild(chatSplitter);
            splitWrapper.appendChild(middlePanel);
            splitWrapper.appendChild(splitter);
            splitWrapper.appendChild(rightPanel);
            appContainer.insertBefore(splitWrapper, header.nextSibling);
            // ▲▲▲ [MODIFIED] Layout assembly complete ▲▲▲

            // Initialize 3D viewer immediately after layout is created
            setTimeout(() => {
                if (typeof window.initThreeDViewer === 'function') {
                    console.log('[Layout] Initializing 3D viewer on page load...');
                    window.initThreeDViewer();

                    // Initial resize after viewer is initialized
                    setTimeout(() => {
                        resize3DCanvas();
                    }, 100);
                } else {
                    console.warn('[Layout] initThreeDViewer not yet available, will retry...');
                    // Retry after a short delay if not loaded yet
                    setTimeout(() => {
                        if (typeof window.initThreeDViewer === 'function') {
                            console.log('[Layout] Initializing 3D viewer (retry)...');
                            window.initThreeDViewer();

                            // Initial resize after viewer is initialized
                            setTimeout(() => {
                                resize3DCanvas();
                            }, 100);
                        }
                    }, 500);
                }
            }, 100);

            // Make splitter draggable
            let isDragging = false;
            let startX = 0;
            let startLeftWidth = 0;
            let resizeFrame = null;

            // Function to properly resize 3D canvas
            function resize3DCanvas() {
                console.log('[Layout] resize3DCanvas called');
                console.log('[Layout] window.camera:', !!window.camera);
                console.log('[Layout] window.renderer:', !!window.renderer);

                if (window.camera && window.renderer) {
                    const canvas = document.getElementById('three-d-canvas');
                    const viewportTop = document.getElementById('split-left-top');
                    console.log('[Layout] canvas found:', !!canvas);
                    console.log('[Layout] viewportTop found:', !!viewportTop);

                    if (canvas && viewportTop) {
                        const width = viewportTop.clientWidth;
                        const height = viewportTop.clientHeight;
                        console.log(`[Layout] Container size: ${width}x${height}`);

                        // Update renderer size (updateStyle: true to also update CSS)
                        window.renderer.setSize(width, height, true);

                        // 카메라 타입에 따라 다르게 처리
                        if (window.camera.isPerspectiveCamera) {
                            // Update camera aspect ratio to prevent distortion
                            window.camera.aspect = width / height;
                            window.camera.updateProjectionMatrix();
                            console.log(`[Layout] Resized 3D canvas to ${width}x${height}, aspect: ${window.camera.aspect.toFixed(2)}`);
                        } else if (window.camera.isOrthographicCamera) {
                            // Update orthographic camera frustum
                            const aspect = width / height;
                            const frustumSize = 20;
                            window.camera.left = frustumSize * aspect / -2;
                            window.camera.right = frustumSize * aspect / 2;
                            window.camera.top = frustumSize / 2;
                            window.camera.bottom = frustumSize / -2;
                            window.camera.updateProjectionMatrix();
                            console.log(`[Layout] Resized 3D canvas to ${width}x${height} (orthographic)`);
                        }

                        // Update OrbitControls if it exists
                        if (window.controls && window.controls.update) {
                            window.controls.update();
                        }
                    }
                }
            }

            // ▼▼▼ [NEW] Chat splitter drag handler ▼▼▼
            let isChatDragging = false;
            let chatStartX = 0;
            let chatStartWidth = 0;

            chatSplitter.addEventListener('mousedown', (e) => {
                isChatDragging = true;
                chatStartX = e.clientX;
                chatStartWidth = chatPanel.offsetWidth;
                document.body.style.cursor = 'ew-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });
            // ▲▲▲ [NEW] Chat splitter mousedown ▲▲▲

            splitter.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startLeftWidth = middlePanel.offsetWidth;
                document.body.style.cursor = 'ew-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                // ▼▼▼ [NEW] Handle chat splitter drag ▼▼▼
                if (isChatDragging) {
                    const delta = e.clientX - chatStartX;
                    const newChatWidth = chatStartWidth + delta;
                    const minChatWidth = 250;
                    const maxChatWidth = 500;

                    if (newChatWidth >= minChatWidth && newChatWidth <= maxChatWidth) {
                        const totalWidth = splitWrapper.offsetWidth;
                        const percentage = (newChatWidth / totalWidth) * 100;
                        chatPanel.style.flex = `0 0 ${percentage}%`;
                    }
                    return;
                }
                // ▲▲▲ [NEW] Chat drag handling ▲▲▲

                if (!isDragging) return;

                const delta = e.clientX - startX;
                const newLeftWidth = startLeftWidth + delta;
                const totalWidth = splitWrapper.offsetWidth;
                const minWidth = 300;
                const maxWidth = totalWidth - minWidth - 8; // 8px for splitter

                if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
                    const percentage = (newLeftWidth / totalWidth) * 100;
                    middlePanel.style.flex = `0 0 ${percentage}%`;

                    // ▼▼▼ [수정] setTimeout으로 DOM 업데이트 후 리사이즈 ▼▼▼
                    if (resizeFrame) {
                        clearTimeout(resizeFrame);
                    }
                    resizeFrame = setTimeout(() => {
                        resize3DCanvas();
                    }, 0);
                    // ▲▲▲ [수정] 여기까지 ▲▲▲
                }
            });

            document.addEventListener('mouseup', () => {
                // ▼▼▼ [NEW] Handle chat drag end ▼▼▼
                if (isChatDragging) {
                    isChatDragging = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
                // ▲▲▲ [NEW] Chat drag end ▲▲▲

                if (isDragging) {
                    isDragging = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';

                    // ▼▼▼ [수정] setTimeout으로 DOM 업데이트 후 리사이즈 ▼▼▼
                    if (resizeFrame) {
                        clearTimeout(resizeFrame);
                    }
                    setTimeout(() => {
                        resize3DCanvas();
                    }, 0);
                    // ▲▲▲ [수정] 여기까지 ▲▲▲
                }
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                resize3DCanvas();
            });

            // --- Vertical splitter drag handler (between 3D viewport and properties) ---
            let isVerticalDragging = false;
            let startY = 0;
            let startTopHeight = 0;
            let startBottomHeight = 0;

            verticalSplitter.addEventListener('mousedown', (e) => {
                isVerticalDragging = true;
                startY = e.clientY;
                startTopHeight = leftTop.offsetHeight;
                startBottomHeight = leftBottom.offsetHeight;
                document.body.style.cursor = 'ns-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isVerticalDragging) return;

                const delta = e.clientY - startY;
                const newTopHeight = startTopHeight + delta;
                const newBottomHeight = startBottomHeight - delta;
                const minHeight = 150;

                if (newTopHeight >= minHeight && newBottomHeight >= minHeight) {
                    leftTop.style.flex = `0 0 ${newTopHeight}px`;
                    leftBottom.style.flex = `0 0 ${newBottomHeight}px`;

                    // ▼▼▼ [수정] setTimeout으로 DOM 업데이트 후 리사이즈 ▼▼▼
                    if (resizeFrame) {
                        clearTimeout(resizeFrame);
                    }
                    resizeFrame = setTimeout(() => {
                        resize3DCanvas();
                    }, 0);
                    // ▲▲▲ [수정] 여기까지 ▲▲▲
                }
            });

            document.addEventListener('mouseup', () => {
                if (isVerticalDragging) {
                    isVerticalDragging = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';

                    // ▼▼▼ [수정] setTimeout으로 DOM 업데이트 후 리사이즈 ▼▼▼
                    if (resizeFrame) {
                        clearTimeout(resizeFrame);
                    }
                    setTimeout(() => {
                        resize3DCanvas();
                    }, 0);
                    // ▲▲▲ [수정] 여기까지 ▲▲▲
                }
            });

            console.log('[Layout] Left-right split layout created successfully');

            // ▼▼▼ [NEW] Chat Panel Toggle Functionality ▼▼▼
            const chatToggleBtn = document.getElementById('chat-toggle-btn');
            let chatPanelCollapsed = false;

            if (chatToggleBtn) {
                chatToggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // 이벤트 버블링 방지
                    chatPanelCollapsed = !chatPanelCollapsed;

                    if (chatPanelCollapsed) {
                        // Collapse chat panel - 깔끔한 세로 바로 변경
                        chatPanel.style.flex = '0 0 40px';
                        chatPanel.style.minWidth = '40px';
                        chatPanel.style.maxWidth = '40px';
                        chatPanel.classList.add('collapsed');
                        chatToggleBtn.innerHTML = '▶';
                        chatToggleBtn.title = '채팅 패널 펼치기';
                        console.log('[Chat] Panel collapsed');
                    } else {
                        // Expand chat panel
                        chatPanel.style.flex = '0 0 20%';
                        chatPanel.style.minWidth = '250px';
                        chatPanel.style.maxWidth = '500px';
                        chatPanel.classList.remove('collapsed');
                        chatToggleBtn.innerHTML = '◀';
                        chatToggleBtn.title = '채팅 패널 접기';
                        console.log('[Chat] Panel expanded');
                    }
                });

                // 접힌 상태에서 패널 클릭 시 펼치기
                chatPanel.addEventListener('click', () => {
                    if (chatPanelCollapsed) {
                        chatToggleBtn.click();
                    }
                });
            }
            // ▲▲▲ [NEW] Chat Panel Toggle End ▲▲▲
        })();
        </script>

        <!-- ▼▼▼ [NEW] Chat Command Handler Script ▼▼▼ -->
        <script src="{% static 'connections/chat_command_handler.js' %}"></script>
        <!-- ▲▲▲ [NEW] Chat Command Handler Script ▲▲▲ -->

        <script src="{% static 'connections/app_core.js' %}?v=2"></script>
        <script src="{% static 'connections/boq_detailed_estimation_handlers.js' %}"></script>
        <script src="{% static 'connections/quantity_members_manager.js' %}"></script>
        <script src="{% static 'connections/cost_item_manager.js' %}"></script>
        <script src="{% static 'connections/activity_object_manager.js' %}"></script>
        <script src="{% static 'connections/home_tab_handlers.js' %}"></script>
        <script>
            // Initialize home tab listeners and load project list on page load
            console.log('[HTML] Initializing home tab...');

            // Call setup function after a short delay to ensure DOM is ready
            setTimeout(() => {
                if (typeof window.setupHomeTabListeners === 'function') {
                    console.log('[HTML] Calling setupHomeTabListeners...');
                    window.setupHomeTabListeners();
                } else {
                    console.error('[HTML] setupHomeTabListeners function not found!');
                }

                // Load home project list if home tab is active
                if (window.activeTab === 'home') {
                    console.log('[HTML] Home tab is active, loading project list...');
                    if (typeof window.loadHomeProjectList === 'function') {
                        window.loadHomeProjectList();
                    } else {
                        console.error('[HTML] loadHomeProjectList function not found!');
                    }
                }
            }, 100);
        </script>
        <script src="{% static 'connections/app.js' %}"></script>
        <!-- Chart.js 라이브러리 (소스맵 에러 방지를 위해 동적 로드) -->
        <script>
            // 소스맵 에러를 방지하기 위한 Chart.js 동적 로드
            (function() {
                const chartScript = document.createElement('script');
                chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
                chartScript.async = false;
                document.body.appendChild(chartScript);

                const annotationScript = document.createElement('script');
                annotationScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js';
                annotationScript.integrity = 'sha512-Hn1w6YiiFw6p6S2lXv6yKeqTk0PLVzeCwWY9n32beuPjQ5HLcvz5l2QsP+KilEr1ws37rCTw3bZpvfvVIeTh0Q==';
                annotationScript.crossOrigin = 'anonymous';
                annotationScript.referrerPolicy = 'no-referrer';
                annotationScript.async = false;
                document.body.appendChild(annotationScript);
            })();
        </script>
    </body>
</html>
